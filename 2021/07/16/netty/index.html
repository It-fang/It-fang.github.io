<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>netty | It-fang</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Netty[TOC] 一，netty概述1，netty的介绍： Netty是由JBOSS提供的一个Java开源框架，现为Github上的独立项目  Netty是一个异步的，基于事件驱动的网络应用框架，用以快速开发高性能，高可靠性的网络IO程序  Netty只要针对在TCP协议下，面向Client端的高并发应用，或者peer-to-peer场景下的大量数据持续传输的应用  Netty本质是一个NIO">
<meta property="og:type" content="article">
<meta property="og:title" content="netty">
<meta property="og:url" content="http://yoursite.com/2021/07/16/netty/index.html">
<meta property="og:site_name" content="It-fang">
<meta property="og:description" content="Netty[TOC] 一，netty概述1，netty的介绍： Netty是由JBOSS提供的一个Java开源框架，现为Github上的独立项目  Netty是一个异步的，基于事件驱动的网络应用框架，用以快速开发高性能，高可靠性的网络IO程序  Netty只要针对在TCP协议下，面向Client端的高并发应用，或者peer-to-peer场景下的大量数据持续传输的应用  Netty本质是一个NIO">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/1.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/2.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/3.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/4.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/5.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/6.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/7.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/8.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/9.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/10.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/11.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/12.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/13.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/14.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/7.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/15.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/16.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/17.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/18.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/19.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/20.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/21.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/22.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/23.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/24.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/25.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/26.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/27.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/28.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/29.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/30.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/31.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/32.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/33.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/34.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/35.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/36.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/37.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/38.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/39.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/40.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/41.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/42.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/43.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/44.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/45.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/46.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/47.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/48.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/49.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/50.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/51.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/52.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/53.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/54.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/55.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/56.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/57.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/58.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/59.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/60.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/61.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/62.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/63.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/64.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/65.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/66.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/67.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/68.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/69.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/70.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/71.png">
<meta property="og:image" content="http://yoursite.com/2021/07/16/netty/72.png">
<meta property="article:published_time" content="2021-07-16T05:13:00.000Z">
<meta property="article:modified_time" content="2021-07-25T17:52:06.107Z">
<meta property="article:author" content="It-fang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/07/16/netty/1.png">
  
    <link rel="alternate" href="/atom.xml" title="It-fang" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">It-fang</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">It-fang</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-netty" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/16/netty/" class="article-date">
  <time datetime="2021-07-16T05:13:00.000Z" itemprop="datePublished">2021-07-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      netty
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h1><p>[TOC]</p>
<h3 id="一，netty概述"><a href="#一，netty概述" class="headerlink" title="一，netty概述"></a>一，netty概述</h3><h4 id="1，netty的介绍："><a href="#1，netty的介绍：" class="headerlink" title="1，netty的介绍："></a>1，netty的介绍：</h4><ul>
<li><p>Netty是由JBOSS提供的一个Java开源框架，现为Github上的独立项目</p>
</li>
<li><p>Netty是一个异步的，基于事件驱动的网络应用框架，用以快速开发高性能，高可靠性的网络IO程序</p>
</li>
<li><p>Netty只要针对在TCP协议下，面向Client端的高并发应用，或者peer-to-peer场景下的大量数据持续传输的应用</p>
</li>
<li><p>Netty本质是一个NIO框架，适用于服务器通讯相关的多种应用场景</p>
<p><img src="/2021/07/16/netty/1.png" alt="image-20210716192743873"></p>
</li>
<li><p>要透彻理解Netty，需要先学习NIO，这样我们才能阅读Netty的源码</p>
</li>
</ul>
<h4 id="2，netty的应用场景"><a href="#2，netty的应用场景" class="headerlink" title="2，netty的应用场景"></a>2，netty的应用场景</h4><ul>
<li><p><strong>互联网行业</strong></p>
<ul>
<li>互联网行业：在分布式系统中，各个节点之间需要远程服务调用，高性能的RPC框架必不可少，Netty作为高性能的通信框架，往往作为基础通信巨剑被这些RPC框架使用</li>
<li>典型的应用有：阿里分布式服务框架Dubbo的RPC框架使用Dubbo协议进行节点间通信，Dubbo协议默认使用Netty作为基础通信组件，用于实现各进程节点之间的内部通信</li>
<li><img src="/2021/07/16/netty/2.png" alt="image-20210716193421590"></li>
</ul>
</li>
<li><p><strong>游戏行业</strong>：</p>
<ul>
<li>无论是手游服务端还是大型的网络游戏，Java语言得到了越来越广泛的应用</li>
<li>Netty作为高性能的基础通信组件，提供了TCP/UDP和HTTP协议栈，方便定制和开发私有协议栈，账号登陆服务器</li>
<li>地图服务器之间可以方便的通过Netty进行高性能的通信</li>
</ul>
</li>
<li><p><strong>大数据领域</strong></p>
<ul>
<li>经典的Hadoop的高性能通信和序列化组件（AVRO实现数据文件共享）的RPC框架，默认采用Netty进行跨界点通信</li>
<li>它的Netty Service基于Netty框架二次封装实现</li>
<li><img src="/2021/07/16/netty/3.png" alt="image-20210716193857780"></li>
</ul>
</li>
<li><p>其他开源项目使用到Netty</p>
<ul>
<li><a href="https://netty.io/wiki/related-projects.html" target="_blank" rel="noopener">相关项目</a></li>
</ul>
</li>
</ul>
<h4 id="3，I-O模型"><a href="#3，I-O模型" class="headerlink" title="3，I/O模型"></a>3，I/O模型</h4><ul>
<li><p><strong>I/O模型基本说明</strong>：</p>
<ul>
<li><p>I/O模型简单的理解：就是用什么样的通道进行数据的发送和接收，很大程度上决定了程序通信的性能</p>
</li>
<li><p>Java共支持3中网络编程模型I/O模型：BIO，NIO，AIO</p>
</li>
<li><p>Java BIO：同步并阻塞（传统阻塞型），服务器实现模式为一个连接一个线程，即客户端有连接请求时服务器端就需要启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销</p>
<p><img src="/2021/07/16/netty/4.png" alt="image-20210716195356719"></p>
</li>
<li><p>Java NIO：同步非阻塞，服务器实现模式为一个线程处理多个请求（连接），即客户端发送的连接请求都会注册到多路复用器上，多路复用器轮询到连接有I/O请求就进行处理</p>
<p><img src="/2021/07/16/netty/5.png" alt="image-20210716195917692"></p>
</li>
<li><p>Java AIO（NIO2.0）：异步非阻塞，AIO引入异步通道的概念，采用了Proactor模式，简化了程序编写，有效的请求才启动线程，他的特点是先由操作系统完成后才通知服务端程序启动线程去处理，一般适用于连接数较多且连接时间较长的应用</p>
</li>
</ul>
</li>
<li><p><strong>BIO，NIO，AIO适用场景分析：</strong></p>
<ul>
<li>BIO方式适用于连接数目比较小且固定的架构，这种方式对服务器资源要求比较高，并发局限于应用中，JDK1.4以前的唯一选择，但程序简单理解</li>
<li>NIO方式适用于<strong>连接数目多且连接比较短（轻操作）的架构</strong>，比如聊天服务器，弹幕系统，服务器间通讯等，编程比较复杂，JDK1.4开始支持</li>
<li>AIO方式使用于连接<strong>数目多且连接比较长（重操作）的架构</strong>，比如相册服务器，充分调用OS参与并发操作，编程比较复杂，JDK7开始支持</li>
</ul>
</li>
</ul>
<h3 id="二，BIO"><a href="#二，BIO" class="headerlink" title="二，BIO"></a>二，BIO</h3><h4 id="1，BIO的基本介绍"><a href="#1，BIO的基本介绍" class="headerlink" title="1，BIO的基本介绍"></a>1，BIO的基本介绍</h4><ul>
<li><p>Java BIO就是传统的java io编程，其相关的类和接口在java.io</p>
</li>
<li><p>BIO（blocking I/O）：<strong>同步阻塞</strong>，服务器实现模式为一个连接一个线程，即客户端有连接请求时服务器端就需要启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销，可以通过<strong>线程池机制改善</strong>（实现多个客户连接服务器）</p>
</li>
<li><p>BIO方式适用于连接数目比较小且固定的架构，这种方式对服务器资源要求比较高，并发局限于应用中，JDK1.4以前的唯一选择，程序简单易理解</p>
</li>
</ul>
<h4 id="2，BIO工作机制"><a href="#2，BIO工作机制" class="headerlink" title="2，BIO工作机制"></a>2，BIO工作机制</h4><ul>
<li><strong>工作原理图</strong></li>
</ul>
<p><img src="/2021/07/16/netty/6.png" alt="image-20210716200900153"></p>
<ul>
<li><strong>BIO编程简单流程</strong>：<ul>
<li>服务端启动一个ServerSocket</li>
<li>客户端启动Socket对服务器进行通信，默认情况下服务器端需要对每个客户建立一个线程与之通讯</li>
<li>客户端发出请求后，先咨询服务器是否有线程响应，如果没有则会等待，或者被拒绝</li>
<li>如果有响应，客户端线程会等待请求结束后，在继续执行</li>
</ul>
</li>
</ul>
<h4 id="3，BIO应用实例"><a href="#3，BIO应用实例" class="headerlink" title="3，BIO应用实例"></a>3，BIO应用实例</h4><ul>
<li><p><strong>实例说明</strong>：</p>
<blockquote>
<p>使用BIO模型编写一个服务器端，监听6666端口，当有客户端连接时，就启动一个线程与之通讯</p>
<p>要求使用线程池机制改善，可以连接多个客户端</p>
<p>服务器端可以接收客户端发送的数据（telnet方式即可）</p>
</blockquote>
</li>
<li><p>代码展示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BIOServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//线程池机制</span></span><br><span class="line">        <span class="comment">//思路</span></span><br><span class="line">        <span class="comment">//1. 创建一个线程池</span></span><br><span class="line">        <span class="comment">//2. 如果有客户端连接，就创建一个线程，与之通讯(单独写一个方法)</span></span><br><span class="line">        ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//创建ServerSocket</span></span><br><span class="line">        ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">6666</span>);</span><br><span class="line">        System.out.println(<span class="string">"服务器启动了"</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"线程信息 id ="</span> + Thread.currentThread().getId() + <span class="string">" 名字="</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="comment">//监听，等待客户端连接</span></span><br><span class="line">            System.out.println(<span class="string">"等待连接...."</span>);</span><br><span class="line">            <span class="keyword">final</span> Socket socket = serverSocket.accept();</span><br><span class="line">            System.out.println(<span class="string">"连接到一个客户端"</span>);</span><br><span class="line">            <span class="comment">//就创建一个线程，与之通讯(单独写一个方法)</span></span><br><span class="line">            newCachedThreadPool.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">//我们重写</span></span><br><span class="line">                    <span class="comment">//可以和客户端通讯</span></span><br><span class="line">                    handler(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//编写一个handler方法，和客户端通讯</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"线程信息 id ="</span> + Thread.currentThread().getId() + <span class="string">" 名字="</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="comment">//通过socket 获取输入流</span></span><br><span class="line">            InputStream inputStream = socket.getInputStream();</span><br><span class="line">            <span class="comment">//循环的读取客户端发送的数据</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"线程信息 id ="</span> + Thread.currentThread().getId() + <span class="string">" 名字="</span> + Thread.currentThread().getName());</span><br><span class="line">                System.out.println(<span class="string">"read...."</span>);</span><br><span class="line">               <span class="keyword">int</span> read =  inputStream.read(bytes);</span><br><span class="line">               <span class="keyword">if</span>(read != -<span class="number">1</span>) &#123;</span><br><span class="line">                   System.out.println(<span class="keyword">new</span> String(bytes, <span class="number">0</span>, read</span><br><span class="line">                   )); <span class="comment">//输出客户端发送的数据</span></span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"关闭和client的连接"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BIO问题分析：</p>
<ul>
<li>每个请求都需要创建独立的线程，与对应的客户端进行数据Read，业务处理，数据Write</li>
<li>当并发数较大时，需要创建大量线程来处理连接，系统资源占用较大</li>
<li>连接建立后，如果当前线程暂时没有数据可读，则线程就阻塞在Read操作上，造成线程资源浪费</li>
</ul>
</li>
</ul>
<h3 id="三，NIO"><a href="#三，NIO" class="headerlink" title="三，NIO"></a>三，NIO</h3><h4 id="1，NIO的基本介绍"><a href="#1，NIO的基本介绍" class="headerlink" title="1，NIO的基本介绍"></a>1，NIO的基本介绍</h4><ul>
<li><p>JavaNIO 全称java non-blocking IO，是指JDK提供的新API，从JDK1.4开始，Java提供了一系列改进的输入/输出的新特性，被统称为NIO（即New IO），是<strong>同步非阻塞</strong>的</p>
</li>
<li><p>NIO相关类都被放在java.nio包及子包下，并且对原java.io包中的很多类进行改写</p>
</li>
<li><p>NIO有三大核心部分：<strong>Channel（通道），Buffer（缓冲区），Selector（选择器）</strong></p>
</li>
<li><p>NIO是面向<strong>缓冲区，或者面向块</strong>编程的，数据读取到一个它稍后处理的缓冲区，需要时可在缓冲区前后移动，这就增加了处理过程中的灵活性，使用它可以提供非阻塞式的高伸缩性网络</p>
</li>
<li><p>JavaNIO的非阻塞模式，使一个线程从某通道发送请求或者读取数据，但是它仅能得到目前可用的数据，如果目前没有数据可用时，就什么都不会获取，而不是保持线程阻塞，所以直至数据变的可以读取之前，该线程可以继续做其他的事情，非阻塞写也是如此，一个线程请求希尔一些数据到某通道，但不需要等待它完全写入，这个线程同时可以去做别的事情</p>
</li>
<li><p>通俗理解：NIO是可以做到用一个线程来处理多个操作的，假设有10000个请求过来，根据实际情况，可以分配50或者100个线程来处理，不像之前的阻塞IO那样，非得分配10000个</p>
</li>
<li><p>HTTP2.0使用了多路复用的技术，做到同一个连接并发处理多个请求，而且并发请求的数量比HTTP1.1大了好几个数量级</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicBuffer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//举例说明Buffer 的使用 (简单说明)</span></span><br><span class="line">        <span class="comment">//创建一个Buffer, 大小为 5, 即可以存放5个int</span></span><br><span class="line">        IntBuffer intBuffer = IntBuffer.allocate(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向buffer 存放数据</span></span><br><span class="line"><span class="comment">//        intBuffer.put(10);</span></span><br><span class="line"><span class="comment">//        intBuffer.put(11);</span></span><br><span class="line"><span class="comment">//        intBuffer.put(12);</span></span><br><span class="line"><span class="comment">//        intBuffer.put(13);</span></span><br><span class="line"><span class="comment">//        intBuffer.put(14);</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; intBuffer.capacity(); i++) &#123;</span><br><span class="line">            intBuffer.put( i * <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如何从buffer读取数据</span></span><br><span class="line">        <span class="comment">//将buffer转换，读写切换(!!!)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        public final Buffer flip() &#123;</span></span><br><span class="line"><span class="comment">        limit = position; //读数据不能超过5</span></span><br><span class="line"><span class="comment">        position = 0;</span></span><br><span class="line"><span class="comment">        mark = -1;</span></span><br><span class="line"><span class="comment">        return this;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        intBuffer.flip();</span><br><span class="line">        intBuffer.position(<span class="number">1</span>);<span class="comment">//1,2</span></span><br><span class="line">        System.out.println(intBuffer.get());</span><br><span class="line">        intBuffer.limit(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">while</span> (intBuffer.hasRemaining()) &#123;</span><br><span class="line">            System.out.println(intBuffer.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="2，NIO和BIO的比较"><a href="#2，NIO和BIO的比较" class="headerlink" title="2，NIO和BIO的比较"></a>2，NIO和BIO的比较</h4><ul>
<li>BIO以流的方式处理数据，而NIO以块的方式处理数据，块I/O的效率比流I/O高很多</li>
<li>BIO是阻塞的，NIO则是非阻塞</li>
<li>BIO基于字节流和字符流进行操作，而NIO基于Channel（通道）和Buffer（缓冲区）进行操作，数据总是从通道读取到缓冲区，或者从缓冲区写入到通道中。Selector（选择器）用于监听多个通道的事件（比如：连接请求，数据到达等），因此使用单个线程就可以监听多个客户端通道</li>
</ul>
<h4 id="3，NIO三大核心原理示意图"><a href="#3，NIO三大核心原理示意图" class="headerlink" title="3，NIO三大核心原理示意图"></a>3，NIO三大核心原理示意图</h4><p><img src="/2021/07/16/netty/7.png" alt="image-20210717100349511"></p>
<ul>
<li>每个channel都会对应一个Buffer</li>
<li>Selector对应一个线程，一个线程对应多个channel（连接）</li>
<li>该图反应了有三个channel注册到该selector // 程序</li>
<li>程序切换到哪个channel是有事件决定，Event就是一个重要概念</li>
<li>Selector会根据不同的事件，在各个通道上切换</li>
<li>Buffer就是一个内存块，底层是有一个数组</li>
<li>数据的读取写入是通过Buffer，这个和BIO，BIO中要么是输入流，或者是输出流，不能双向，但是NIO的Buffer是可以读也可以写，需要flip方法切换</li>
<li>channel是双向的，可以返回底层操作系统的情况，比如Linux，底层的操作系统通道就是双向的</li>
</ul>
<h4 id="4，缓冲区（Buffer）"><a href="#4，缓冲区（Buffer）" class="headerlink" title="4，缓冲区（Buffer）"></a>4，缓冲区（Buffer）</h4><h5 id="a，基本介绍："><a href="#a，基本介绍：" class="headerlink" title="a，基本介绍："></a>a，基本介绍：</h5><ul>
<li><p>​    缓冲区（Buffer）：缓冲区本质上是一个可以读写数据的内存块，可以理解成是一个容器对象（含数组），该对象提供了一组方法，可以更轻松地使用内存块，缓冲区对象内置了一些机制，能够跟踪和记录缓冲区的状态变化情况，Channel提供从文件，网络读取数据的渠道，但是读取或写入的数据都必须经由Buffer</p>
<p><img src="/2021/07/16/netty/8.png" alt="image-20210717101202057"></p>
</li>
</ul>
<h5 id="b，Buffer类及其子类"><a href="#b，Buffer类及其子类" class="headerlink" title="b，Buffer类及其子类"></a>b，Buffer类及其子类</h5><ul>
<li><p>在NIO中，Buffer是一个顶层子类，它是一个抽象类，类的层级关系图：</p>
<p><img src="/2021/07/16/netty/9.png" alt="image-20210717101431071"></p>
</li>
<li><p>Buffer类定义了所有的缓冲区都具有的四个属性来提供关于其所包含的数据元素的信息</p>
<p><img src="/2021/07/16/netty/10.png" alt="image-20210717101539242"></p>
</li>
<li><p>Buffer类相关方法：</p>
<p><img src="/2021/07/16/netty/11.png" alt="image-20210717101647680"></p>
<h5 id="c，ByteBuffer"><a href="#c，ByteBuffer" class="headerlink" title="c，ByteBuffer"></a>c，ByteBuffer</h5></li>
<li><p>从前面可以看出对于Java中的基本数据类型（boolean除外），都有一个Buffer类型与之相对应，最常用的自然是ByteBuffer类（二进制数据），该类的主要方法如下：</p>
<p><img src="/2021/07/16/netty/12.png" alt="image-20210717101844528"></p>
</li>
</ul>
<h4 id="5，通道（Channel）"><a href="#5，通道（Channel）" class="headerlink" title="5，通道（Channel）"></a>5，通道（Channel）</h4><h5 id="a，基本介绍：-1"><a href="#a，基本介绍：-1" class="headerlink" title="a，基本介绍："></a>a，基本介绍：</h5><ul>
<li><p>NIO的通道类似于流，但有些区别如下：</p>
<ul>
<li>通道可以同时进行读写，而流只能读或者只能写</li>
<li>通道可以实现异步读写数据</li>
<li>通道可以从缓冲读数据，也可以写数据到缓冲</li>
</ul>
</li>
<li><p>BIO中的stream是单向的，例如FileInputStream对象只能进行读取数据的操作，而NIO中的通道（Channel）是双向的，可以读操作，也可以写操作</p>
</li>
<li><p>Channel在NIO中是一个接口<code>public interface Channel extends Closealbe{}</code></p>
</li>
<li><p>常用的Channel类有：FileChannel，DatagramChannel，ServerSocketChannel和SocketChannel【ServerSocketChannel类似ServerSocket，SocketChannel类似Socket】</p>
</li>
<li><p>FileChannel用于文件的数据读写，DatagramChannel用于UDP的数据读写，ServerSocketChannel和SocketChannel用于TCP的数据读写</p>
</li>
<li><p><img src="/2021/07/16/netty/13.png" alt="image-20210717181413047"></p>
</li>
</ul>
<h5 id="b，FileChannel"><a href="#b，FileChannel" class="headerlink" title="b，FileChannel"></a>b，FileChannel</h5><p>FileChannel主要用来对本地文件进行IO操作，常见的方法有：</p>
<ul>
<li><code>public int read(ByteBuffer dst)</code>：从通道读取数据并放到缓冲区中</li>
<li><code>public int write(ByteBUffer src)</code>：把缓冲区的数据写到通道中</li>
<li><code>public long transferFrom(ReadableByteChannel src,long position,long count)</code>：把目标通道中复制数据都当前通道</li>
<li><code>public long transferTo(long position,long count,WritableByteChannel target)</code>：把数据从当前通道复制给目标通道</li>
</ul>
<h5 id="c，应用案例1——本地文件写数据"><a href="#c，应用案例1——本地文件写数据" class="headerlink" title="c，应用案例1——本地文件写数据"></a>c，应用案例1——本地文件写数据</h5><p>实例要求：</p>
<ul>
<li><p>使用前面学习后的ByteBuffer（缓冲）和FileChannel（通道），将“hello,尚硅谷”写入到file01.txt中</p>
</li>
<li><p>文件不存在就创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOFileChannel01</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String str = <span class="string">"hello,nihao"</span>;</span><br><span class="line">        <span class="comment">//创建一个输出流-&gt;channel</span></span><br><span class="line">        FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"d:\\file01.txt"</span>);</span><br><span class="line">        <span class="comment">//通过 fileOutputStream 获取 对应的 FileChannel</span></span><br><span class="line">        <span class="comment">//这个 fileChannel 真实 类型是  FileChannelImpl</span></span><br><span class="line">        FileChannel fileChannel = fileOutputStream.getChannel();</span><br><span class="line">        <span class="comment">//创建一个缓冲区 ByteBuffer</span></span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">//将 str 放入 byteBuffer</span></span><br><span class="line">        byteBuffer.put(str.getBytes());</span><br><span class="line">        <span class="comment">//对byteBuffer 进行flip</span></span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        <span class="comment">//将byteBuffer 数据写入到 fileChannel</span></span><br><span class="line">        fileChannel.write(byteBuffer);</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h5 id="d，应用案例2——本地文件读数据"><a href="#d，应用案例2——本地文件读数据" class="headerlink" title="d，应用案例2——本地文件读数据"></a>d，应用案例2——本地文件读数据</h5><p>实例要求：</p>
<ul>
<li><p>使用前面学习后的ByteBuffer（缓冲）和FileChannel（通道），将file01.txt中的数据读入到程序，并显示在控制台屏幕</p>
</li>
<li><p>假定文件已经存在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOFileChannel02</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建文件的输入流</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"d:\\file01.txt"</span>);</span><br><span class="line">        FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        <span class="comment">//通过fileInputStream 获取对应的FileChannel -&gt; 实际类型  FileChannelImpl</span></span><br><span class="line">        FileChannel fileChannel = fileInputStream.getChannel();</span><br><span class="line">        <span class="comment">//创建缓冲区</span></span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate((<span class="keyword">int</span>) file.length());</span><br><span class="line">        <span class="comment">//将 通道的数据读入到Buffer</span></span><br><span class="line">        fileChannel.read(byteBuffer);</span><br><span class="line">        <span class="comment">//将byteBuffer 的 字节数据 转成String</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(byteBuffer.array()));</span><br><span class="line">        fileInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h5 id="e，应用实例3——使用一个Buffer完成文件读取，写入"><a href="#e，应用实例3——使用一个Buffer完成文件读取，写入" class="headerlink" title="e，应用实例3——使用一个Buffer完成文件读取，写入"></a>e，应用实例3——使用一个Buffer完成文件读取，写入</h5><p>实例要求：</p>
<ul>
<li><p>使用FileChannel（通道）和方法read，write，完成文件的拷贝</p>
</li>
<li><p>考本一个文件1.txt，放在项目下即可</p>
<p><img src="/2021/07/16/netty/14.png" alt="image-20210717201552136"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOFileChannel03</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(<span class="string">"1.txt"</span>);</span><br><span class="line">        FileChannel fileChannel01 = fileInputStream.getChannel();</span><br><span class="line">        FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"2.txt"</span>);</span><br><span class="line">        FileChannel fileChannel02 = fileOutputStream.getChannel();</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">512</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; <span class="comment">//循环读取</span></span><br><span class="line">            <span class="comment">//这里有一个重要的操作，一定不要忘了</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             public final Buffer clear() &#123;</span></span><br><span class="line"><span class="comment">                position = 0;</span></span><br><span class="line"><span class="comment">                limit = capacity;</span></span><br><span class="line"><span class="comment">                mark = -1;</span></span><br><span class="line"><span class="comment">                return this;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            byteBuffer.clear(); <span class="comment">//清空buffer</span></span><br><span class="line">            <span class="keyword">int</span> read = fileChannel01.read(byteBuffer);</span><br><span class="line">            System.out.println(<span class="string">"read ="</span> + read);</span><br><span class="line">            <span class="keyword">if</span>(read == -<span class="number">1</span>) &#123; <span class="comment">//表示读完</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将buffer 中的数据写入到 fileChannel02 -- 2.txt</span></span><br><span class="line">            byteBuffer.flip();</span><br><span class="line">            fileChannel02.write(byteBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭相关的流</span></span><br><span class="line">        fileInputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="f，应用案例4——拷贝文件transferFrom方法"><a href="#f，应用案例4——拷贝文件transferFrom方法" class="headerlink" title="f，应用案例4——拷贝文件transferFrom方法"></a>f，应用案例4——拷贝文件transferFrom方法</h5><p>实例要求：</p>
<ul>
<li><p>使用FileChannel（通道）和方法transferFrom，完成文件的拷贝</p>
</li>
<li><p>拷贝一张图片</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOFileChannel04</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建相关流</span></span><br><span class="line">        FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(<span class="string">"d:\\a.jpg"</span>);</span><br><span class="line">        FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"d:\\a2.jpg"</span>);</span><br><span class="line">        <span class="comment">//获取各个流对应的filechannel</span></span><br><span class="line">        FileChannel sourceCh = fileInputStream.getChannel();</span><br><span class="line">        FileChannel destCh = fileOutputStream.getChannel();</span><br><span class="line">        <span class="comment">//使用transferForm完成拷贝</span></span><br><span class="line">        destCh.transferFrom(sourceCh,<span class="number">0</span>,sourceCh.size());</span><br><span class="line">        <span class="comment">//关闭相关通道和流</span></span><br><span class="line">        sourceCh.close();</span><br><span class="line">        destCh.close();</span><br><span class="line">        fileInputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="6，关于Buffer和Channel的注意事项："><a href="#6，关于Buffer和Channel的注意事项：" class="headerlink" title="6，关于Buffer和Channel的注意事项："></a>6，关于Buffer和Channel的注意事项：</h4><ul>
<li><p>ByteBuffer支持类型化的put和get，put放入的是什么数据类型，get就应该使用相应的数据类型出去，否则可能有<code>BufferUnderflowException</code>异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOByteBufferPutGet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个Buffer</span></span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">64</span>);</span><br><span class="line">        <span class="comment">//类型化方式放入数据</span></span><br><span class="line">        buffer.putInt(<span class="number">100</span>);</span><br><span class="line">        buffer.putLong(<span class="number">9</span>);</span><br><span class="line">        buffer.putChar(<span class="string">'尚'</span>);</span><br><span class="line">        buffer.putShort((<span class="keyword">short</span>) <span class="number">4</span>);</span><br><span class="line">        <span class="comment">//取出</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(buffer.getInt());</span><br><span class="line">        System.out.println(buffer.getLong());</span><br><span class="line">        System.out.println(buffer.getChar());</span><br><span class="line">        System.out.println(buffer.getShort());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以将一个普通的buffer转成只读buffer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadOnlyBuffer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个buffer</span></span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">64</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++) &#123;</span><br><span class="line">            buffer.put((<span class="keyword">byte</span>)i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//读取</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        <span class="comment">//得到一个只读的Buffer</span></span><br><span class="line">        ByteBuffer readOnlyBuffer = buffer.asReadOnlyBuffer();</span><br><span class="line">        System.out.println(readOnlyBuffer.getClass());</span><br><span class="line">        <span class="comment">//读取</span></span><br><span class="line">        <span class="keyword">while</span> (readOnlyBuffer.hasRemaining()) &#123;</span><br><span class="line">            System.out.println(readOnlyBuffer.get());</span><br><span class="line">        &#125;</span><br><span class="line">        readOnlyBuffer.put((<span class="keyword">byte</span>)<span class="number">100</span>); <span class="comment">//ReadOnlyBufferException</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>NIO还提供了MappedByteBuffer，可以让文件直接在内存（堆外的内存）中进行修改，而如何同步到文件由NIO来完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*说明1. MappedByteBuffer 可让文件直接在内存(堆外内存)修改, 操作系统不需要拷贝一次 */</span><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MappedByteBufferTest</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;        RandomAccessFile randomAccessFile = <span class="keyword">new</span> RandomAccessFile(<span class="string">"1.txt"</span>, <span class="string">"rw"</span>);        <span class="comment">//获取对应的通道        FileChannel channel = randomAccessFile.getChannel();        /**         * 参数1: FileChannel.MapMode.READ_WRITE 使用的读写模式         * 参数2： 0 ： 可以直接修改的起始位置         * 参数3:  5: 是映射到内存的大小(不是索引位置) ,即将 1.txt 的多少个字节映射到内存         * 可以直接修改的范围就是 0-5         * 实际类型 DirectByteBuffer         */        MappedByteBuffer mappedByteBuffer = channel.map(FileChannel.MapMode.READ_WRITE, 0, 5);        mappedByteBuffer.put(0, (byte) 'H');        mappedByteBuffer.put(3, (byte) '9');        mappedByteBuffer.put(5, (byte) 'Y');//IndexOutOfBoundsException        randomAccessFile.close();        System.out.println("修改成功~~");    &#125;&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>前面我们讲的读写操作，都是通过一个Buffer完成的，NIO还<strong>支持通过多个Buffer（即Buffer数组）完成读写操作</strong>，即Scattering和Gathering</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * Scattering：将数据写入到buffer时，可以采用buffer数组，依次写入  [分散] * Gathering: 从buffer读取数据时，可以采用buffer数组，依次读 */</span><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScatteringAndGatheringTest</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;        <span class="comment">//使用 ServerSocketChannel 和 SocketChannel 网络        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();        InetSocketAddress inetSocketAddress = new InetSocketAddress(7000);        //绑定端口到socket ，并启动        serverSocketChannel.socket().bind(inetSocketAddress);        //创建buffer数组        ByteBuffer[] byteBuffers = new ByteBuffer[2];        byteBuffers[0] = ByteBuffer.allocate(5);        byteBuffers[1] = ByteBuffer.allocate(3);        //等客户端连接(telnet)        SocketChannel socketChannel = serverSocketChannel.accept();        int messageLength = 8;   //假定从客户端接收8个字节        //循环的读取        while (true) &#123;            int byteRead = 0;            while (byteRead &lt; messageLength ) &#123;                long l = socketChannel.read(byteBuffers);                byteRead += l; //累计读取的字节数                System.out.println("byteRead=" + byteRead);                //使用流打印, 看看当前的这个buffer的position 和 limit                Arrays.asList(byteBuffers).stream().map(buffer -&gt; "postion=" + buffer.position() + ", limit=" + buffer.limit()).forEach(System.out::println);            &#125;            //将所有的buffer进行flip            Arrays.asList(byteBuffers).forEach(buffer -&gt; buffer.flip());            //将数据读出显示到客户端            long byteWirte = 0;            while (byteWirte &lt; messageLength) &#123;                long l = socketChannel.write(byteBuffers); //                byteWirte += l;            &#125;            //将所有的buffer 进行clear            Arrays.asList(byteBuffers).forEach(buffer-&gt; &#123;                buffer.clear();            &#125;);            System.out.println("byteRead:=" + byteRead + " byteWrite=" + byteWirte + ", messagelength" + messageLength);        &#125;    &#125;&#125;</span></span><br></pre></td></tr></table></figure>







</li>
</ul>
<h4 id="7，选择器（Selector）"><a href="#7，选择器（Selector）" class="headerlink" title="7，选择器（Selector）"></a>7，选择器（Selector）</h4><h5 id="a，基本介绍：-2"><a href="#a，基本介绍：-2" class="headerlink" title="a，基本介绍："></a>a，基本介绍：</h5><ul>
<li><p>Java的NIO，用非阻塞的IO方式，可以用一个线程，处理多个的客户端连接，就会使用到Selector(选择器)</p>
</li>
<li><p>Selector能够检测多个注册的通道上是否有事件发生（注意：多个Channel以事件的方式可以注册到同一个Selector），如果有事发生，便获取事件然后针对每个事件进行相应的处理，这样就可以只用一个单线程去管理多个通道，也就是管理多个连接和请求</p>
<p><img src="/2021/07/16/netty/7.png" alt></p>
</li>
<li><p>只有在连接/通道真正有读写事件发生时，才会进行读写，就大大地减少了系统开销，并且不必为每个连接都创建一个线程，不用去维护多个线程</p>
</li>
<li><p>避免了多线程之间的上下文的切换导致的开销</p>
</li>
</ul>
<h5 id="b，Selector特点说明："><a href="#b，Selector特点说明：" class="headerlink" title="b，Selector特点说明："></a>b，Selector特点说明：</h5><ul>
<li>Netty的IO线程NIOEventLoop聚合Selector（选择器，也叫多路复用器），可以同时并发处理成百上千个客户端连接</li>
<li>当线程从某客户端Socket通道进行读写数据时，若没有数据可用时，该线程可以进行其他任务</li>
<li>线程通常将非阻塞IO的空闲时间用于在其他通道上执行IO操作，所以单独的线程可以管理多个输入和输出通道</li>
<li>由于读写操作都是非阻塞的，这就可以充分提升IO线程的运行效率，避免由于频繁的I/O阻塞导致的线程挂起</li>
<li>一个I/O线程可以并发处理N个客户端连接和读写操作，这从根本上解决了传统同步阻塞I/O一连接一线模型，架构的性能，弹性伸缩能力和可靠性都得到了极大的提升</li>
</ul>
<h5 id="c，Selector类相关方法"><a href="#c，Selector类相关方法" class="headerlink" title="c，Selector类相关方法"></a>c，Selector类相关方法</h5><p>Selector类是一个抽象类，常用方法和说明如下；</p>
<p><img src="/2021/07/16/netty/15.png" alt="image-20210717233738946"></p>
<h5 id="d，注意事项"><a href="#d，注意事项" class="headerlink" title="d，注意事项"></a>d，注意事项</h5><ul>
<li>NIO中的ServerSocketChannel功能类似ServerSocket，SocketChannel功能类似Socket</li>
<li>selector相关方法说明：<ul>
<li>selector.select（）：阻塞</li>
<li>selector.select（1000）：阻塞1000毫秒，在1000毫秒后返回</li>
<li>selector.wakeup（）：唤醒selector</li>
<li>selector.selectNow（）：不阻塞，立马返还</li>
</ul>
</li>
</ul>
<h5 id="e，NIO非阻塞网络编程原理分析图"><a href="#e，NIO非阻塞网络编程原理分析图" class="headerlink" title="e，NIO非阻塞网络编程原理分析图"></a>e，NIO非阻塞网络编程原理分析图</h5><p>NIO非阻塞网络编程相关的（Selector，SelectionKey，ServerSocketChannel和SocketChannel）关系梳理图</p>
<p><img src="/2021/07/16/netty/16.png" alt="image-20210717234926126"></p>
<ul>
<li><p>当客户端连接时，会通过ServerSocketChannel得到SocketChannel</p>
</li>
<li><p>Selector进行监听，select方法，返回有事件发生的通道的个数</p>
</li>
<li><p>将socketChannel注册到Selector上，register（Selector sel，int ops），一个selector上可以注册多个SocketChannel</p>
</li>
<li><p>注册后返回一个SelectionKey，会和该Selector关联（集合）</p>
</li>
<li><p>进一步得到各个SelectionKey（有事件发生）</p>
</li>
<li><p>在通过SelectionKey反向获取SocketChannel，方法channel（）</p>
</li>
<li><p>可以通过得到的channel完成业务处理</p>
</li>
<li><p>编写一个NIO入门案例，实现服务器端和客户端之间的数据简单通讯（非阻塞）；目的：理解NIO非阻塞网络编程机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOServer</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;        <span class="comment">//创建ServerSocketChannel -&gt; ServerSocket        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();        //得到一个Selecor对象        Selector selector = Selector.open();        //绑定一个端口6666, 在服务器端监听        serverSocketChannel.socket().bind(new InetSocketAddress(6666));        //设置为非阻塞        serverSocketChannel.configureBlocking(false);        //把 serverSocketChannel 注册到  selector 关心 事件为 OP_ACCEPT        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);        System.out.println("注册后的selectionkey 数量=" + selector.keys().size()); // 1        //循环等待客户端连接        while (true) &#123;            //这里我们等待1秒，如果没有事件发生, 返回            if(selector.select(1000) == 0) &#123; //没有事件发生                System.out.println("服务器等待了1秒，无连接");                continue;            &#125;            //如果返回的&gt;0, 就获取到相关的 selectionKey集合            //1.如果返回的&gt;0， 表示已经获取到关注的事件            //2. selector.selectedKeys() 返回关注事件的集合            //   通过 selectionKeys 反向获取通道            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();            System.out.println("selectionKeys 数量 = " + selectionKeys.size());            //遍历 Set&lt;SelectionKey&gt;, 使用迭代器遍历            Iterator&lt;SelectionKey&gt; keyIterator = selectionKeys.iterator();            while (keyIterator.hasNext()) &#123;                //获取到SelectionKey                SelectionKey key = keyIterator.next();                //根据key 对应的通道发生的事件做相应处理                if(key.isAcceptable()) &#123; //如果是 OP_ACCEPT, 有新的客户端连接                    //该该客户端生成一个 SocketChannel                    SocketChannel socketChannel = serverSocketChannel.accept();                    System.out.println("客户端连接成功 生成了一个 socketChannel " + socketChannel.hashCode());                    //将  SocketChannel 设置为非阻塞                    socketChannel.configureBlocking(false);                    //将socketChannel 注册到selector, 关注事件为 OP_READ， 同时给socketChannel                    //关联一个Buffer                    socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024));                    System.out.println("客户端连接后 ，注册的selectionkey 数量=" + selector.keys().size()); //2,3,4..                &#125;                if(key.isReadable()) &#123;  //发生 OP_READ                    //通过key 反向获取到对应channel                    SocketChannel channel = (SocketChannel)key.channel();                    //获取到该channel关联的buffer                    ByteBuffer buffer = (ByteBuffer)key.attachment();                    channel.read(buffer);                    System.out.println("form 客户端 " + new String(buffer.array()));                &#125;                //手动从集合中移动当前的selectionKey, 防止重复操作                keyIterator.remove();            &#125;        &#125;    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOClient</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;        <span class="comment">//得到一个网络通道        SocketChannel socketChannel = SocketChannel.open();        //设置非阻塞        socketChannel.configureBlocking(false);        //提供服务器端的ip 和 端口        InetSocketAddress inetSocketAddress = new InetSocketAddress("127.0.0.1", 6666);        //连接服务器        if (!socketChannel.connect(inetSocketAddress)) &#123;            while (!socketChannel.finishConnect()) &#123;                System.out.println("因为连接需要时间，客户端不会阻塞，可以做其它工作..");            &#125;        &#125;        //...如果连接成功，就发送数据        String str = "hello, 尚硅谷~";        //Wraps a byte array into a buffer        ByteBuffer buffer = ByteBuffer.wrap(str.getBytes());        //发送数据，将 buffer 数据写入 channel        socketChannel.write(buffer);        System.in.read();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h5 id="f，SelectionKey"><a href="#f，SelectionKey" class="headerlink" title="f，SelectionKey"></a>f，SelectionKey</h5><ul>
<li><p><strong>SelectionKey，表示Selector和网络通道的注册关系</strong>，共四种：</p>
<ul>
<li><code>int OP_ACCEPT</code>：有新的网络连接可以accept，值为16</li>
<li><code>int OP_COUNNECT</code>：代表连接已经建立你，值为8</li>
<li><code>int OP_READ</code>：代表读操作，值为1</li>
<li><code>int OP_WRITE</code>：代表写操作，值为4</li>
</ul>
</li>
<li><p>SelectionKey的相关方法：</p>
<p><img src="/2021/07/16/netty/17.png" alt="image-20210718000147479"></p>
</li>
</ul>
<h5 id="g，ServerSocketChannel"><a href="#g，ServerSocketChannel" class="headerlink" title="g，ServerSocketChannel"></a>g，ServerSocketChannel</h5><ul>
<li><p>ServerSockeyChannel在服务器端监听新的客户端Socket连接</p>
</li>
<li><p>相关方法如下：</p>
<p><img src="/2021/07/16/netty/18.png" alt="image-20210718000254480"></p>
</li>
</ul>
<h5 id="h，SockeyChannel"><a href="#h，SockeyChannel" class="headerlink" title="h，SockeyChannel"></a>h，SockeyChannel</h5><ul>
<li><p>SocketChannel，网络IO通道，具体负责进行读写操作，NIO把缓冲区的数据写入通道，或者把通道里的数据读到缓冲区</p>
</li>
<li><p>相关方法：</p>
<p><img src="/2021/07/16/netty/19.png" alt="image-20210718000413676"></p>
</li>
</ul>
<h4 id="8，零拷贝"><a href="#8，零拷贝" class="headerlink" title="8，零拷贝"></a>8，零拷贝</h4><h5 id="a，基本介绍：-3"><a href="#a，基本介绍：-3" class="headerlink" title="a，基本介绍："></a>a，基本介绍：</h5><ul>
<li>零拷贝是网络编程的关键，很多性能优化都离不开</li>
<li>在Java程序中，常用的零拷贝有mmap（内存映射）和sendFile</li>
</ul>
<h5 id="b，传统IO的数据读写"><a href="#b，传统IO的数据读写" class="headerlink" title="b，传统IO的数据读写"></a>b，传统IO的数据读写</h5><p><img src="/2021/07/16/netty/20.png" alt="image-20210718132951690"></p>
<h5 id="c，传统IO模型"><a href="#c，传统IO模型" class="headerlink" title="c，传统IO模型"></a>c，传统IO模型</h5><p><img src="/2021/07/16/netty/21.png" alt="image-20210718133032199"></p>
<p>DMA：direct memory access：直接内存拷贝（不使用CPU）</p>
<h5 id="d，mmap优化"><a href="#d，mmap优化" class="headerlink" title="d，mmap优化"></a>d，mmap优化</h5><ul>
<li><p>mmap通过内存映射，将文件映射到内核缓冲区，同时，用户空间可以共享内核空间的数据，这样，在进行网络传输时，就可以减少内核空间到用户空间的拷贝次数，</p>
<p><img src="/2021/07/16/netty/22.png" alt="image-20210718133243549"></p>
</li>
</ul>
<h5 id="e，sendFile优化"><a href="#e，sendFile优化" class="headerlink" title="e，sendFile优化"></a>e，sendFile优化</h5><ul>
<li><p>Linux2.1版本提供了sendFile函数，其基本原理如下：数据根本不经过用户态，直接从内核缓冲区进入到Socket Buffer，同时，由于和用户态完全无关，就减少了一次上下文切换</p>
<p><img src="/2021/07/16/netty/23.png" alt="image-20210718133437403"></p>
</li>
<li><p>提示：零拷贝从操作系统角度，就是没有CPU拷贝</p>
</li>
<li><p>Linux在2.4版本中，做了一些修改，避免了从内核缓冲区拷贝到Socket buffer的操作，直接拷贝到协议栈，从而再一次减少了数据考本，</p>
<p><img src="/2021/07/16/netty/24.png" alt="image-20210718133614371"></p>
</li>
<li><p>这里其实有一次CPU拷贝 kemel buffer –&gt; socket buffer，但是，拷贝的信息很少，比如length，offset，消耗低，可以忽略</p>
</li>
</ul>
<h5 id="f，零拷贝的再次理解"><a href="#f，零拷贝的再次理解" class="headerlink" title="f，零拷贝的再次理解"></a>f，零拷贝的再次理解</h5><ul>
<li>我们说零拷贝，是从操作系统的角度来说的，因为内核缓冲区之间，没有数据是重复的（只有kemel buffer有一份数据）</li>
<li>零拷贝不仅仅带来更少的数据复制，还能带来其他的性能优势，例如更少的上下文切换，更少的CPU缓存伪共享以及无CPU校验的计算</li>
</ul>
<h5 id="g，mmap和sendFile的区别"><a href="#g，mmap和sendFile的区别" class="headerlink" title="g，mmap和sendFile的区别"></a>g，mmap和sendFile的区别</h5><ul>
<li>mmap适合小数据量读写，sendFile适合大文件传输</li>
<li>mmap需要4次上下文切换，3次数据拷贝；sendFile需要3次上下文切换，最少2次数据拷贝</li>
<li>sendFile可以利用DMA方式，减少CPU拷贝，mmap则不能（必须从内核考本到Socket缓冲区）</li>
</ul>
<h5 id="h，NIO零拷贝案例"><a href="#h，NIO零拷贝案例" class="headerlink" title="h，NIO零拷贝案例"></a>h，NIO零拷贝案例</h5><ul>
<li><p>使用传统的IO方法传递一个大文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//java IO 的服务器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OldIOServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">7001</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Socket socket = serverSocket.accept();</span><br><span class="line">            DataInputStream dataInputStream = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] byteArray = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> readCount = dataInputStream.read(byteArray, <span class="number">0</span>, byteArray.length);</span><br><span class="line">                    <span class="keyword">if</span> (-<span class="number">1</span> == readCount) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OldIOClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket(<span class="string">"localhost"</span>, <span class="number">7001</span>);</span><br><span class="line">        String fileName = <span class="string">"protoc-3.6.1-win32.zip"</span>;</span><br><span class="line">        InputStream inputStream = <span class="keyword">new</span> FileInputStream(fileName);</span><br><span class="line">        DataOutputStream dataOutputStream = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">        <span class="keyword">long</span> readCount;</span><br><span class="line">        <span class="keyword">long</span> total = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">while</span> ((readCount = inputStream.read(buffer)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            total += readCount;</span><br><span class="line">            dataOutputStream.write(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"发送总字节数： "</span> + total + <span class="string">", 耗时： "</span> + (System.currentTimeMillis() - startTime));</span><br><span class="line">        dataOutputStream.close();</span><br><span class="line">        socket.close();</span><br><span class="line">        inputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>使用NIO零拷贝方式传递（transferTO）一个大文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务器public class NewIOServer &#123;    public static void main(String[] args) throws Exception &#123;        InetSocketAddress address = new InetSocketAddress(7001);        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();        ServerSocket serverSocket = serverSocketChannel.socket();        serverSocket.bind(address);        //创建buffer        ByteBuffer byteBuffer = ByteBuffer.allocate(4096);        while (true) &#123;            SocketChannel socketChannel = serverSocketChannel.accept();            int readcount = 0;            while (-1 != readcount) &#123;                try &#123;                    readcount = socketChannel.read(byteBuffer);                &#125;catch (Exception ex) &#123;                   // ex.printStackTrace();                    break;                &#125;                //                byteBuffer.rewind(); //倒带 position = 0 mark 作废            &#125;        &#125;    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewIOClient</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;        SocketChannel socketChannel = SocketChannel.open();        socketChannel.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">7001</span>));        String filename = <span class="string">"protoc-3.6.1-win32.zip"</span>;        <span class="comment">//得到一个文件channel        FileChannel fileChannel = new FileInputStream(filename).getChannel();        //准备发送        long startTime = System.currentTimeMillis();        //在linux下一个transferTo 方法就可以完成传输        //在windows 下 一次调用 transferTo 只能发送8m , 就需要分段传输文件, 而且要主要        //传输时的位置 =》 课后思考...        //transferTo 底层使用到零拷贝        long transferCount = fileChannel.transferTo(0, fileChannel.size(), socketChannel);        System.out.println("发送的总的字节数 =" + transferCount + " 耗时:" + (System.currentTimeMillis() - startTime));        //关闭        fileChannel.close();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="9，AIO"><a href="#9，AIO" class="headerlink" title="9，AIO"></a>9，AIO</h4><h5 id="a，基本介绍：-4"><a href="#a，基本介绍：-4" class="headerlink" title="a，基本介绍："></a>a，基本介绍：</h5><ul>
<li>JDK7引入了Asynchronous I/O，即AIO。在进行I/O编程中，常用的两种模式：Reactor和Practor。Java的NIO就是Reactor，当有事件触发时，服务器端得到通知，进行相应的处理</li>
<li>AIO即NIO2.0，叫异步不阻塞的IO，AIO引入异步通道的概念，采用了Proacotr模式，简化了程序编写，有效的请求才启动线程，它的特点是先由操作系统完成后才通知服务端程序启动线程去处理，一般适用于连接数较多且连接时间较长的应用</li>
<li>目前AIO还没有广泛应用，Netty也是基于NIO，而不是AIO</li>
</ul>
<h4 id="10，BIO，NIO，AIO对比表"><a href="#10，BIO，NIO，AIO对比表" class="headerlink" title="10，BIO，NIO，AIO对比表"></a>10，BIO，NIO，AIO对比表</h4><p><img src="/2021/07/16/netty/25.png" alt="image-20210718135117934"></p>
<h3 id="四，netty高性能架构"><a href="#四，netty高性能架构" class="headerlink" title="四，netty高性能架构"></a>四，netty高性能架构</h3><h4 id="1，原生NIO存在的问题"><a href="#1，原生NIO存在的问题" class="headerlink" title="1，原生NIO存在的问题"></a>1，原生NIO存在的问题</h4><ul>
<li>NIO的类库和API繁杂，使用麻烦；需要熟练掌握Selector，ServerSocketChannel，SocketChannel，ByteBuffer等</li>
<li>需要具备其他的额外技能：要熟悉Java多线程编程，因为NIO编程涉及到Reactor模式，你必须对多线程好网络编程非常熟悉，才能编写出高质量的NIO程序</li>
<li>开发工作量和难度都非常大：例如客户端面临断链重连，网络闪断，半包读写，失败缓存，网络拥塞和异常流的处理等等</li>
<li>JDK NIO的Bug：例如臭名昭著的Epoll Bug，它会导致Selector空轮询，最终导致CPU100%，知道JDK1.7版本该问题仍旧存在，没有被根本解决</li>
</ul>
<h5 id="2，Netty官网说明："><a href="#2，Netty官网说明：" class="headerlink" title="2，Netty官网说明："></a>2，Netty官网说明：</h5><p><a href="https://netty.io" target="_blank" rel="noopener">netty官网</a></p>
<p><img src="/2021/07/16/netty/26.png" alt="image-20210719173737768"></p>
<h4 id="3，Netty的优点"><a href="#3，Netty的优点" class="headerlink" title="3，Netty的优点"></a>3，Netty的优点</h4><p>Netty对JDK自带的NIO的API进行了封装，解决了上述问题</p>
<ul>
<li><strong>设计优雅</strong>：适用于各种传输类型的统一API阻塞和非阻塞Socket；基于灵活且可扩展的事件模型，可以清晰地分离关注点；高度可定制的线程模型 - 单线程，一个或多个线程池</li>
<li><strong>使用方便</strong>：详细记录的Javadoc，用户指南和示例；没有其他依赖项，JDK5（Netty3.x）或JDK6（Netty4.x）就足够了</li>
<li><strong>高性能，吞吐量更高</strong>；延迟更低；减少资源消耗；最小化不必要的内存复制</li>
<li><strong>安全</strong>：完整的SSL/TLS和StartTLS支持</li>
<li><strong>社区活跃</strong>，不断更新：社区活跃，版本迭代周期短，发现的Bug可以被及时修复，同时，更多的新功能会被加入</li>
</ul>
<h4 id="4，Netty版本说明："><a href="#4，Netty版本说明：" class="headerlink" title="4，Netty版本说明："></a>4，Netty版本说明：</h4><ul>
<li>netty的版本为netty3.x，netty4.x，netty5.x</li>
<li>因为netty5出现重大bug，已经被官网废弃了，目前推荐使用的是netty4.x的稳定版本</li>
</ul>
<h4 id="5，线程模型基本介绍"><a href="#5，线程模型基本介绍" class="headerlink" title="5，线程模型基本介绍"></a>5，线程模型基本介绍</h4><h5 id="a，线程模型类型："><a href="#a，线程模型类型：" class="headerlink" title="a，线程模型类型："></a>a，线程模型类型：</h5><ul>
<li>目前存在的线程模型有；<ul>
<li>传统阻塞I/O服务模型</li>
<li>Reactor模式</li>
</ul>
</li>
<li>根据Reactor的数量和处理资源池线程的数量不同，有3种典型的实现；<ul>
<li>单Reactor单线程；</li>
<li>单Reactor多线程；</li>
<li>主从Reactor多线程</li>
</ul>
</li>
<li>Netty线程模式（Netty主要基于主从Reactor多线程模型做了一定的改进，其中主从Reactor多线程模型有多个Reactor）</li>
</ul>
<h5 id="b，传统阻塞I-O服务模型"><a href="#b，传统阻塞I-O服务模型" class="headerlink" title="b，传统阻塞I/O服务模型"></a>b，传统阻塞I/O服务模型</h5><ul>
<li><p><strong>工作原理图</strong>：</p>
<ul>
<li><p>黄色的框表示对象，蓝色的框表示线程</p>
</li>
<li><p>白色的框表示方法（API）</p>
<p><img src="/2021/07/16/netty/27.png" alt="image-20210719175259396"></p>
</li>
</ul>
</li>
<li><p><strong>模型特点</strong></p>
<ul>
<li>采用阻塞I/O模式获取输入的数据</li>
<li>每个连接都需要独立的线程完成数据的输入，业务处理，数据返回</li>
</ul>
</li>
<li><p><strong>问题分析</strong>：</p>
<ul>
<li>当并发数很大，就会创建大量的线程，占用很大系统资源</li>
<li>连接创建后，如果当前线程暂时没有数据可读，该线程会阻塞在read操作，造成线程资源浪费</li>
</ul>
</li>
</ul>
<h5 id="c，Reactor模式介绍；"><a href="#c，Reactor模式介绍；" class="headerlink" title="c，Reactor模式介绍；"></a>c，Reactor模式介绍；</h5><ul>
<li><p>针对传统阻塞I/O服务模型的2个缺点，解决方案：</p>
<ul>
<li><p>基于I/O复用模型：多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象等待，无需阻塞等待所有连接。当某个连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理Reactor对应的叫法：反应器模式，分发者模式（Dispatcher），通知者模式（notifier）</p>
</li>
<li><p>基于线程池复用线程资源：不必再为每个连接创建线程，将连接完成后的业务处理任务分配给线程进行处理，一个线程可以处理多个连接业务</p>
<p><img src="/2021/07/16/netty/28.png" alt="image-20210719180122081"></p>
</li>
</ul>
</li>
</ul>
<p>​    </p>
<ul>
<li><p>I/O复用结合线程池，就是Reactor模式基本设计思想</p>
<p><img src="/2021/07/16/netty/29.png" alt="image-20210719180315916"></p>
<ul>
<li>Reactor模式，通过一个或多个输入同时传递给服务处理器的模式（基于事件驱动）</li>
<li>服务器端程序处理传入的多个请求，并将它们同步分派到相应的处理线程，因此Reactor模式也叫Dispatcher模式</li>
<li>Reactor模式使用IO复用监听时间，收到事件后，分发给某个线程（进程），这点就是网络服务器高并发处理关键</li>
</ul>
</li>
</ul>
<h5 id="d，Reactor模式中核心组成"><a href="#d，Reactor模式中核心组成" class="headerlink" title="d，Reactor模式中核心组成"></a>d，Reactor模式中核心组成</h5><ul>
<li>Reactor：Reactor在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序来对IO事件做出反应，它就像公司的电话接线员，它接听来自客户的电话并将线路转移到适当的联系人</li>
<li>Handlers：处理程序执行I/O事件要完成的实际事件，类似于客户想要与之交谈的公司中的实际官员，Reactor通过调度适当的处理程序来响应IO事件，处理程序执行非阻塞操作</li>
</ul>
<h4 id="6，单Reactor单线程"><a href="#6，单Reactor单线程" class="headerlink" title="6，单Reactor单线程"></a>6，单Reactor单线程</h4><ul>
<li><p><strong>工作原理</strong></p>
<p><img src="/2021/07/16/netty/30.png" alt="image-20210719180919120"></p>
<ul>
<li>Select是前面I/O复用模型介绍的标准网络编程API，可以实现应用程序通过一个阻塞对象监听多路连接请求</li>
<li>Reactor对象通过Select监控客户端请求事件，收到事件后通过Dispatch进行分发</li>
<li>如果是建立连接请求事件，则有Acceptor通过Accept处理连接请求，然后创建一个Handler对象处理连接完成后的后续业务处理</li>
<li>如果不是建立连接事件，则Reactor会分发调用连接对应的Handler来响应</li>
<li>Handler会完成Read ——》 业务处理 ——》Send的完整业务流程</li>
</ul>
<p>结合实例：服务器端用一个线程通过多路复用搞定所有的IO操作（包括连接，读，写等），编码简单，清晰明了，但是如果客户端连接数量较多，将无法支撑，前面的NIO案例就属于这种模型</p>
</li>
<li><p><strong>方案优缺点分析</strong>：</p>
<ul>
<li>优点：<ul>
<li>模型简单，没有多线程，进程通信，竞争的问题，全部都在一个线程中完成</li>
</ul>
</li>
<li>缺点：<ul>
<li>性能问题，只有一个线程，无法完全发挥多核CPU的性能，Handler在处理某个连接上的业务时，整个进程无法处理其他连接事件，很容易导致性能瓶颈</li>
<li>可靠性问题，线程意外终止，或者进入死循环，会导致整个系统通信模块不可用，不能接收和处理外部消息，造成节点故障</li>
</ul>
</li>
<li>使用场景：<ul>
<li>客户端的数量有限，业务处理非常快速，比如Redis在业务处理的时间复杂度O（1）的情况</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7，单Reactor多线程"><a href="#7，单Reactor多线程" class="headerlink" title="7，单Reactor多线程"></a>7，单Reactor多线程</h4><ul>
<li><p>工作原理图</p>
<p><img src="/2021/07/16/netty/31.png" alt="image-20210719182209529"></p>
<ul>
<li>Reactor对象通过select监控客户端请求事件，收到事件后，通过dispatch进行分发</li>
<li>如果建立连接请求，则由Acceptor通过accept处理连接请求，然后创建一个Handler对象处理完成连接后的各种事件</li>
<li>如果不是连接请求，则由reactor分发调用连接对应的handler来处理</li>
<li>handler只负责响应事件，不做具体的业务处理，通过read读取数据后，会分发给后面的worker线程池的某个线程处理业务</li>
<li>worker线程池分配独立线程完成真正的业务，并将结果返回给handler</li>
<li>handler收到响应后，通过send将结果返回给client</li>
</ul>
</li>
<li><p>方案优缺点：</p>
<ul>
<li>优点：<ul>
<li>可以充分利用多核CPU的处理能力</li>
</ul>
</li>
<li>缺点：<ul>
<li>多线程数据共享和访问比较复杂，reactor处理所有的事件的监听和响应，在单线程运行，在高并发场景容易出现性能瓶颈</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="8，主从Reactor多线程"><a href="#8，主从Reactor多线程" class="headerlink" title="8，主从Reactor多线程"></a>8，主从Reactor多线程</h4><ul>
<li><p>工作原理图：</p>
<blockquote>
<p>针对单Reactor多线程模型中，Reactor在单线程中运行，高并发场景下容易成为性能瓶颈，可以让Reactor在多线程中运行</p>
</blockquote>
<p><img src="/2021/07/16/netty/32.png" alt="image-20210719193731624"></p>
<p><img src="/2021/07/16/netty/33.png" alt="image-20210719201808800"></p>
<ul>
<li>Reactor主线程MainReactor对象通过select监听line接事件，收到事件后，通过Acceptor处理连接事件</li>
<li>当Acceptor处理连接事件后，MainReactor将连接分配给SubReactor</li>
<li>subreactor将连接加入到连接队列进行监听，并创建handler进行各种事件处理</li>
<li>当有新事件发生时，subreactor就会调用对应的handler处理</li>
<li>handler通过read读取数据，分发给后面的worker线程处理</li>
<li>worker线程池分配独立的worker线程进行业务处理，并返回结果</li>
<li>handler收到响应的结果后，再通过send将结果返回给client</li>
<li>Reactor主线程可以对应多个Reactor子线程，即MainReactor可以关联多个SubReactor</li>
</ul>
</li>
<li><p>方案优缺点：</p>
<ul>
<li>优点：<ul>
<li>父线程与子线程的数据交互简单职责明确，父线程只需要接收新连接，子线程完成后续的业务处理</li>
<li>父线程与子线程的数据交互简单，Reactor主线程只需要把新连接传给子线程，子线程无需返回数据</li>
</ul>
</li>
<li>缺点：<ul>
<li>编程复杂度较高</li>
</ul>
</li>
</ul>
<p>结合实例：这种模型在许多项目中广泛使用，包括Nginx主从Reactor多进程模型，Memcached主从多线程，Netty主从多线程模型的支持</p>
</li>
</ul>
<h4 id="9，Reactor模型小结："><a href="#9，Reactor模型小结：" class="headerlink" title="9，Reactor模型小结："></a>9，Reactor模型小结：</h4><ul>
<li>reactor模式具有如下的优点：<ul>
<li>响应快，不必为单个同步时间所阻塞，虽然Reactor本身依然是同步的</li>
<li>可以最大程度的避免复杂的多线程及同步问题，并且避免了多线程/进程的切换开销</li>
<li>扩展性好，可以方便的通过增加Reactor实例个数来充分利用CPU资源</li>
<li>复用性好，Reactor模型本身与具体时间处理逻辑无关，具有很高的复用性</li>
</ul>
</li>
</ul>
<h4 id="10，Netty模型"><a href="#10，Netty模型" class="headerlink" title="10，Netty模型"></a>10，Netty模型</h4><h5 id="a，工作原理示意图——简单版"><a href="#a，工作原理示意图——简单版" class="headerlink" title="a，工作原理示意图——简单版"></a>a，工作原理示意图——简单版</h5><blockquote>
<p>Netty主要基于主从Reactor多线程模型做了一定的改进，其中主从Reactor多线程模型有多个Reactor</p>
</blockquote>
<p><img src="/2021/07/16/netty/34.png" alt="image-20210719202708542"></p>
<ul>
<li>BossGroup线程维护Selector，只关注Accept</li>
<li>当接收到Accept事件，获取到对应的SocketChannel，封装成NIOSocketChannel并注册到Worker线程（事件循环），并进行维护</li>
<li>当Worker线程监听到selector中通道发生自己感兴趣的事件后，就进行处理（由handler），注意handler已经加入到通道</li>
</ul>
<h5 id="b，工作原理示意图——进阶版"><a href="#b，工作原理示意图——进阶版" class="headerlink" title="b，工作原理示意图——进阶版"></a>b，工作原理示意图——进阶版</h5><p><img src="/2021/07/16/netty/35.png" alt="image-20210719203003988"></p>
<h5 id="c，工作原理示意图——详细版"><a href="#c，工作原理示意图——详细版" class="headerlink" title="c，工作原理示意图——详细版"></a>c，工作原理示意图——详细版</h5><p><img src="/2021/07/16/netty/36.png" alt="image-20210719203247068"></p>
<ul>
<li>Netty抽象出两组线程池BossGroup专门负责接收客户端的连接，WorkerGroup专门负责网络的读写</li>
<li>BossGroup和WorkerGroup类型都是NioEventLoopGroup</li>
<li>NioEventLoopGroup相当于一个事件循环组，这个组中含有多个事件循环，每一个事件循环是NioEventLoop</li>
<li>NioEventLoop表示一个不断循环的执行处理任务的线程，每个NioEventLoop都有一个selector，用于监听绑定在其上的socket的网络通讯</li>
<li>NioEventLoopGroup可以有多个线程，即可以含有多个NioEvenetLoop</li>
<li>每个Boss NioEventLoop循环执行的步骤有3步：<ul>
<li>轮询accept事件</li>
<li>处理accept事件，与client建立连接，生成NioSocketChannel，并将其注册到某个worker NioEventLoop上的selector</li>
<li>处理任务队列的任务，即runAllTasks</li>
</ul>
</li>
<li>每个worker NioEventLoop循环执行的步骤<ul>
<li>轮询read，write事件</li>
<li>处理I/O事件，即read，write事件，在对应NioSocketChannel处理</li>
<li>处理任务队列的任务，即runAllTasks</li>
</ul>
</li>
<li>每个worker NioEventLoop处理业务时，会使用pipeline（管道），pipeline中包含了channel，即通过pipeline可以获取到对应通道，管道中维护了很多的处理器</li>
</ul>
<h5 id="d，Netty快速入门实例——TCP服务"><a href="#d，Netty快速入门实例——TCP服务" class="headerlink" title="d，Netty快速入门实例——TCP服务"></a>d，Netty快速入门实例——TCP服务</h5><ul>
<li>Netty服务器在6668端口监听，客户端能发送消息给服务器“hello，服务器~”</li>
<li>服务器可以回复消息给客户端“hello，客户端~”</li>
<li>目的：对Netty线程模型有一个初步认识，便于理解Netty模型理论</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;        <span class="comment">//创建BossGroup 和 WorkerGroup        //说明        //1. 创建两个线程组 bossGroup 和 workerGroup        //2. bossGroup 只是处理连接请求 , 真正的和客户端业务处理，会交给 workerGroup完成        //3. 两个都是无限循环        //4. bossGroup 和 workerGroup 含有的子线程(NioEventLoop)的个数        //   默认实际 cpu核数 * 2        EventLoopGroup bossGroup = new NioEventLoopGroup(1);        EventLoopGroup workerGroup = new NioEventLoopGroup(); //8        try &#123;            //创建服务器端的启动对象，配置参数            ServerBootstrap bootstrap = new ServerBootstrap();            //使用链式编程来进行设置            bootstrap.group(bossGroup, workerGroup) //设置两个线程组                    .channel(NioServerSocketChannel.class) //使用NioSocketChannel 作为服务器的通道实现                    .option(ChannelOption.SO_BACKLOG, 128) // 设置线程队列得到连接个数                    .childOption(ChannelOption.SO_KEEPALIVE, true) //设置保持活动连接状态//                    .handler(null) // 该 handler对应 bossGroup , childHandler 对应 workerGroup                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;//创建一个通道初始化对象(匿名对象)                        //给pipeline 设置处理器                        @Override                        protected void initChannel(SocketChannel ch) throws Exception &#123;                            System.out.println("客户socketchannel hashcode=" + ch.hashCode()); //可以使用一个集合管理 SocketChannel， 再推送消息时，可以将业务加入到各个channel 对应的 NIOEventLoop 的 taskQueue 或者 scheduleTaskQueue                            ch.pipeline().addLast(new NettyServerHandler());                        &#125;                    &#125;); // 给我们的workerGroup 的 EventLoop 对应的管道设置处理器            System.out.println(".....服务器 is ready...");            //绑定一个端口并且同步, 生成了一个 ChannelFuture 对象            //启动服务器(并绑定端口)            ChannelFuture cf = bootstrap.bind(6668).sync();            //给cf 注册监听器，监控我们关心的事件            cf.addListener(new ChannelFutureListener() &#123;                @Override                public void operationComplete(ChannelFuture future) throws Exception &#123;                    if (cf.isSuccess()) &#123;                        System.out.println("监听端口 6668 成功");                    &#125; else &#123;                        System.out.println("监听端口 6668 失败");                    &#125;                &#125;            &#125;);            //对关闭通道进行监听            cf.channel().closeFuture().sync();        &#125;finally &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*说明1. 我们自定义一个Handler 需要继续netty 规定好的某个HandlerAdapter(规范)2. 这时我们自定义一个Handler , 才能称为一个handler */</span><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;    <span class="comment">//读取数据实际(这里我们可以读取客户端发送的消息)    /*    1. ChannelHandlerContext ctx:上下文对象, 含有 管道pipeline , 通道channel, 地址    2. Object msg: 就是客户端发送的数据 默认Object     */    @Override    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;/*        //比如这里我们有一个非常耗时长的业务-&gt; 异步执行 -&gt; 提交该channel 对应的        //NIOEventLoop 的 taskQueue中,        //解决方案1 用户程序自定义的普通任务        ctx.channel().eventLoop().execute(new Runnable() &#123;            @Override            public void run() &#123;                try &#123;                    Thread.sleep(5 * 1000);                    ctx.writeAndFlush(Unpooled.copiedBuffer("hello, 客户端~(&gt;^ω^&lt;)喵2", CharsetUtil.UTF_8));                    System.out.println("channel code=" + ctx.channel().hashCode());                &#125; catch (Exception ex) &#123;                    System.out.println("发生异常" + ex.getMessage());                &#125;            &#125;        &#125;);        ctx.channel().eventLoop().execute(new Runnable() &#123;            @Override            public void run() &#123;                try &#123;                    Thread.sleep(5 * 1000);                    ctx.writeAndFlush(Unpooled.copiedBuffer("hello, 客户端~(&gt;^ω^&lt;)喵3", CharsetUtil.UTF_8));                    System.out.println("channel code=" + ctx.channel().hashCode());                &#125; catch (Exception ex) &#123;                    System.out.println("发生异常" + ex.getMessage());                &#125;            &#125;        &#125;);        //解决方案2 : 用户自定义定时任务 -》 该任务是提交到 scheduleTaskQueue中        ctx.channel().eventLoop().schedule(new Runnable() &#123;            @Override            public void run() &#123;                try &#123;                    Thread.sleep(5 * 1000);                    ctx.writeAndFlush(Unpooled.copiedBuffer("hello, 客户端~(&gt;^ω^&lt;)喵4", CharsetUtil.UTF_8));                    System.out.println("channel code=" + ctx.channel().hashCode());                &#125; catch (Exception ex) &#123;                    System.out.println("发生异常" + ex.getMessage());                &#125;            &#125;        &#125;, 5, TimeUnit.SECONDS);        System.out.println("go on ...");*/        System.out.println("服务器读取线程 " + Thread.currentThread().getName() + " channle =" + ctx.channel());        System.out.println("server ctx =" + ctx);        System.out.println("看看channel 和 pipeline的关系");        Channel channel = ctx.channel();        ChannelPipeline pipeline = ctx.pipeline(); //本质是一个双向链接, 出站入站        //将 msg 转成一个 ByteBuf        //ByteBuf 是 Netty 提供的，不是 NIO 的 ByteBuffer.        ByteBuf buf = (ByteBuf) msg;        System.out.println("客户端发送消息是:" + buf.toString(CharsetUtil.UTF_8));        System.out.println("客户端地址:" + channel.remoteAddress());    &#125;    //数据读取完毕    @Override    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception &#123;        //writeAndFlush 是 write + flush        //将数据写入到缓存，并刷新        //一般讲，我们对这个发送的数据进行编码        ctx.writeAndFlush(Unpooled.copiedBuffer("hello, 客户端~(&gt;^ω^&lt;)喵1", CharsetUtil.UTF_8));    &#125;    //处理异常, 一般是需要关闭通道    @Override    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;        ctx.close();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;        <span class="comment">//客户端需要一个事件循环组        EventLoopGroup group = new NioEventLoopGroup();        try &#123;            //创建客户端启动对象            //注意客户端使用的不是 ServerBootstrap 而是 Bootstrap            Bootstrap bootstrap = new Bootstrap();            //设置相关参数            bootstrap.group(group) //设置线程组                    .channel(NioSocketChannel.class) // 设置客户端通道的实现类(反射)                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;                        @Override                        protected void initChannel(SocketChannel ch) throws Exception &#123;                            ch.pipeline().addLast(new NettyClientHandler()); //加入自己的处理器                        &#125;                    &#125;);            System.out.println("客户端 ok..");            //启动客户端去连接服务器端            //关于 ChannelFuture 要分析，涉及到netty的异步模型            ChannelFuture channelFuture = bootstrap.connect("127.0.0.1", 6668).sync();            //给关闭通道进行监听            channelFuture.channel().closeFuture().sync();        &#125;finally &#123;            group.shutdownGracefully();        &#125;    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;    <span class="comment">//当通道就绪就会触发该方法    @Override    public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;        System.out.println("client " + ctx);        ctx.writeAndFlush(Unpooled.copiedBuffer("hello, server: (&gt;^ω^&lt;)喵", CharsetUtil.UTF_8));    &#125;    //当通道有读取事件时，会触发    @Override    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;        ByteBuf buf = (ByteBuf) msg;        System.out.println("服务器回复的消息:" + buf.toString(CharsetUtil.UTF_8));        System.out.println("服务器的地址： "+ ctx.channel().remoteAddress());    &#125;    @Override    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;        cause.printStackTrace();        ctx.close();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>





<h5 id="e，任务队列中的Task有3种典型使用场景："><a href="#e，任务队列中的Task有3种典型使用场景：" class="headerlink" title="e，任务队列中的Task有3种典型使用场景："></a>e，任务队列中的Task有3种典型使用场景：</h5><ul>
<li>用户程序自定义的普通任务【程序示例在上面】</li>
<li>用户自定义定时任务【程序示例在上面】</li>
<li>非当前Reactor线程调用Channel的各种方法</li>
</ul>
<h5 id="f，方案在说明："><a href="#f，方案在说明：" class="headerlink" title="f，方案在说明："></a>f，方案在说明：</h5><ul>
<li>Netty抽象出两组线程池，BossGroup专门负责接收客户端连接，WorkerGroup专门负责网络读写操作</li>
<li>NioEventLoop表示一个不断循环执行处理任务的线程，每个NioEventLoop都有一个selector，用于监听绑定在其上的socket网络通道</li>
<li>NioEventLoop内部采用串行化设计，从消息的读取 ——》解码 ——》 处理 ——》 编码 ——》 发送，始终由IO线程NioEventLoop负责<ul>
<li>NioEventLoopGroup下包含多个NioEventLoop</li>
<li>每个NioEventLoop中包含有一个Selector，一个taskQueue</li>
<li>每个NioEventLoop的Selector上可以注册监听多个NioChannel</li>
<li>每个NioChannel只会绑定在唯一的NioEventLoop上</li>
<li>每个NioChannel都绑定有一个自己的ChannelPipeline</li>
</ul>
</li>
</ul>
<h4 id="11，Netty的异步模型"><a href="#11，Netty的异步模型" class="headerlink" title="11，Netty的异步模型"></a>11，Netty的异步模型</h4><h5 id="a，基本介绍：-5"><a href="#a，基本介绍：-5" class="headerlink" title="a，基本介绍："></a>a，基本介绍：</h5><ul>
<li>异步的概念喝同步相对，当一个异步过程调用发出后，调用者不能立刻得到结果，实际处理这个调用的组件在完成后，通过状态，通知和回调来通知调用者</li>
<li>Netty中的I/O操作是异步的，包括Bind，Write，Connect等操作会简单的返回一个ChannelFuture</li>
<li>调用者并不能立刻获得结果，而是通过Future-Listener机制，用户可以方便的主动获取或者通过通知机制获得IO操作结果</li>
<li>Netty的异步模型使建立在future和callback的之上的，callback就是回调，重点说Future，它的核心思想是：假设一个方法fun，计算过程可能非常好使，等待fun返回显然不合适，那么可以在调用fun的时候，立马返回一个Future，后续可以通过Future去监控方法fun的处理过程（即：Future-Listener机制）</li>
</ul>
<h5 id="b，Future说明："><a href="#b，Future说明：" class="headerlink" title="b，Future说明："></a>b，Future说明：</h5><ul>
<li><p>表示异步的执行结果，可以通过它提供的方法来检测执行是否完成，比如检索计算等等</p>
</li>
<li><p>ChannelFuture是一个接口：<code>public interface ChannelFuture extends Future&lt;Void&gt;</code>我们可以添加监听器，当监听的事件发生时，就会通知到监听器</p>
</li>
<li><p><strong>工作原理示意图</strong>：</p>
<p><img src="/2021/07/16/netty/37.png" alt="image-20210720104108906"></p>
</li>
</ul>
<p><img src="/2021/07/16/netty/38.png" alt="image-20210720104132862"></p>
<p>说明：    </p>
<ul>
<li>在使用Netty进行编程时，拦截操作和转换出入站数据只需要你提供callback或利用future即可，这使得链式操作简单，高效，并有利于编写可重用，通用的代码</li>
<li>Netty框架的目标就是让你的业务逻辑从网络基础应用编码中分离出来，解脱出来</li>
</ul>
<h5 id="c，Future—Listener机制"><a href="#c，Future—Listener机制" class="headerlink" title="c，Future—Listener机制"></a>c，Future—Listener机制</h5><ul>
<li><p>当Future对象刚刚创建时，处于非完成状态，调用者可以通过返回的ChannelFuture来获取操作执行的状态，注册监听函数来执行完成后的操作</p>
</li>
<li><p>常见有如下操作：</p>
<ul>
<li>通过isDone方法来判断当前操作是否完成</li>
<li>通过该isSuccess方法来判断已完成的当前操作是否成功</li>
<li>通过getCause方法来获取已完成的当前操作失败的原因</li>
<li>通过isCancelled方法来判断已完成的当前操作是否被取消</li>
<li>通过addListener方法来注册监听器，当操作已完成（isDone方法返回完成），将会通知指定的监听器，如果Future对象已完成，则通知指定的监听器</li>
</ul>
</li>
<li><p>举例实例：绑定端口是同步操作，当绑定操作处理完，将会调用相应的监听器处理逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//绑定一个端口并且同步, 生成了一个 ChannelFuture 对象</span></span><br><span class="line"><span class="comment">//启动服务器(并绑定端口)</span></span><br><span class="line">ChannelFuture cf = bootstrap.bind(<span class="number">6668</span>).sync();</span><br><span class="line"></span><br><span class="line"><span class="comment">//给cf 注册监听器，监控我们关心的事件</span></span><br><span class="line"></span><br><span class="line">cf.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cf.isSuccess()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"监听端口 6668 成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"监听端口 6668 失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h5 id="d，快速入门实例——HTTP服务"><a href="#d，快速入门实例——HTTP服务" class="headerlink" title="d，快速入门实例——HTTP服务"></a>d，快速入门实例——HTTP服务</h5><ul>
<li>Netty服务器在6668端口监听，浏览器发出请求“<a href="http://localhost:6668/”" target="_blank" rel="noopener">http://localhost:6668/”</a></li>
<li>服务器可以回复消息给客户端“Hello~我是服务器”，并对特定请求资源继续拿给你过滤</li>
<li>目的：Netty可以做Http服务开发，并理解Handler实例和客户端及其请求的关系</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServer</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();        <span class="keyword">try</span> &#123;            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();            serverBootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>).<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">TestServerInitializer</span>())</span>;            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">6668</span>).sync();                        channelFuture.channel().closeFuture().sync();        &#125;<span class="keyword">finally</span> &#123;            bossGroup.shutdownGracefully();            workerGroup.shutdownGracefully();        &#125;    &#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*说明1. SimpleChannelInboundHandler 是 ChannelInboundHandlerAdapter2. HttpObject 客户端和服务器端相互通讯的数据被封装成 HttpObject */</span><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestHttpServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">HttpObject</span>&gt; </span>&#123;    <span class="comment">//channelRead0 读取客户端数据    @Override    protected void channelRead0(ChannelHandlerContext ctx, HttpObject msg) throws Exception &#123;        System.out.println("对应的channel=" + ctx.channel() + " pipeline=" + ctx        .pipeline() + " 通过pipeline获取channel" + ctx.pipeline().channel());        System.out.println("当前ctx的handler=" + ctx.handler());        //判断 msg 是不是 httprequest请求        if(msg instanceof HttpRequest) &#123;            System.out.println("ctx 类型="+ctx.getClass());            System.out.println("pipeline hashcode" + ctx.pipeline().hashCode() + " TestHttpServerHandler hash=" + this.hashCode());            System.out.println("msg 类型=" + msg.getClass());            System.out.println("客户端地址" + ctx.channel().remoteAddress());            //获取到            HttpRequest httpRequest = (HttpRequest) msg;            //获取uri, 过滤指定的资源            URI uri = new URI(httpRequest.uri());            if("/favicon.ico".equals(uri.getPath())) &#123;                System.out.println("请求了 favicon.ico, 不做响应");                return;            &#125;            //回复信息给浏览器 [http协议]            ByteBuf content = Unpooled.copiedBuffer("hello, 我是服务器", CharsetUtil.UTF_8);            //构造一个http的相应，即 httpresponse            FullHttpResponse response = new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK, content);            response.headers().set(HttpHeaderNames.CONTENT_TYPE, "text/plain");            response.headers().set(HttpHeaderNames.CONTENT_LENGTH, content.readableBytes());            //将构建好 response返回            ctx.writeAndFlush(response);        &#125;    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServerInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;    <span class="meta">@Override</span>    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;        <span class="comment">//向管道加入处理器        //得到管道        ChannelPipeline pipeline = ch.pipeline();        //加入一个netty 提供的httpServerCodec codec =&gt;[coder - decoder]        //HttpServerCodec 说明        //1. HttpServerCodec 是netty 提供的处理http的 编-解码器        pipeline.addLast("MyHttpServerCodec",new HttpServerCodec());        //2. 增加一个自定义的handler        pipeline.addLast("MyTestHttpServerHandler", new TestHttpServerHandler());        System.out.println("ok~~~~");    &#125;&#125;</span></span><br></pre></td></tr></table></figure>







<h3 id="五，Netty核心模块组件"><a href="#五，Netty核心模块组件" class="headerlink" title="五，Netty核心模块组件"></a>五，Netty核心模块组件</h3><h4 id="1，Bootstrap，ServerBootstrap"><a href="#1，Bootstrap，ServerBootstrap" class="headerlink" title="1，Bootstrap，ServerBootstrap"></a>1，Bootstrap，ServerBootstrap</h4><ul>
<li>Bootstrap意思是引导，一个Netty应用通常由一个Bootstrap开始，主要作用是配置整个Netty程序，串联各个组件，Netty中Bootstrap类是客户端程序的启动引导类，ServerBootstrap是服务端启动引导类</li>
<li>常见的方法有：<ul>
<li><code>public ServerBootstrap group(EventLoopGroup parentGroup,EventLoopGroup childGroup)</code>：该方法用于服务器端，用来设置两个EventLoop</li>
<li><code>public B group(EventLoopGroup group)</code>：该方法用于客户端，用来设置一个EventLoop</li>
<li><code>public B channel(Class&lt;? extends C&gt;channelClass)</code>：该方法用来设置一个服务器端的通道实现</li>
<li><code>public &lt;T&gt; B option(ChannelOption&lt;T&gt; option ,T value)</code>：用来给ServerChannel添加配置</li>
<li><code>public &lt;T&gt; ServerBootstrap childOption(ChannelOption&lt;T&gt; childOption,T value)</code>：用来给接收到的通道添加配置</li>
<li><code>public ServerBootstrap childHandler(ChannelHandler childHandler)</code>：该方法用来设置业务处理类（自定义的handler）</li>
<li><code>public ChannelFuture bind(int inetPort)</code>：该方法用于服务器端，用来设置占用的端口号</li>
<li><code>public ChannelFuture connect(String inetHost,int inetPort)</code>：该方法用于客户端，用来连接服务器端</li>
</ul>
</li>
</ul>
<h4 id="2，Future，ChannelFuture"><a href="#2，Future，ChannelFuture" class="headerlink" title="2，Future，ChannelFuture"></a>2，Future，ChannelFuture</h4><ul>
<li>Netty中所有的IO操作都是异步的，不能立刻得知消息是否被正确处理，但是可以过一会等它执行完成或者直接注册一个监听，具体的实现就是通过Future和ChannelFutures，他们可以注册一个监听，当操作执行成功或失败时监听会自动触发注册的监听事件</li>
<li>常见的方法有：<ul>
<li><code>Channel channel()</code>：返回当前正在进行IO操作的通道</li>
<li><code>ChannelFuture sync()</code>：阻塞当前主线程任务，等待异步操作执行完毕</li>
</ul>
</li>
</ul>
<h4 id="3，Channel"><a href="#3，Channel" class="headerlink" title="3，Channel"></a>3，Channel</h4><ul>
<li>Netty网络通信的组件，能够用于执行网络的I/O操作</li>
<li>通过Channel可获得当前网络连接的通道的状态</li>
<li>通过Channel可获得网络连接的配置参数（例如接收缓冲区大小）</li>
<li>Channel提供异步的网络I/O操作（如建立连接，读写，绑定绑定端口），异步调用意味着任何I/O调用都将立即返回，并且不保证在调用结束时所请求的I/O操作已完成</li>
<li>调用立即返回一个ChannelFuture实例，通过注册监听器到ChannelFuture上，可以I/O操作成功，失败或取消时回调通知调用方</li>
<li>支持关联I/O操作与对应的处理程序</li>
<li>不同协议，不同的阻塞类型的连接都有不同的Channel类型与之对应，常用的Channel类型：<ul>
<li><code>NioSocketChannel</code>：异步的客户端TCP Socket连接</li>
<li><code>NioServerSocketChannel</code>：异步的服务器端TCPSocket连接</li>
<li><code>NioDatagramChannel</code>：异步的UDP连接</li>
<li><code>NioSctpChannel</code>：异步的客户端Sctp连接</li>
<li><code>NioSctpServerChannel</code>：异步的Sctp服务器端连接，这些通道涵盖了UDP和TCP网络IO以及文件IO</li>
</ul>
</li>
</ul>
<h4 id="4，Selector"><a href="#4，Selector" class="headerlink" title="4，Selector"></a>4，Selector</h4><ul>
<li>Netty基于Selector对象实现I/O多路复用，通过Selector一个线程可以监听多个连接Channel事件</li>
<li>当向一个Selector中注册Channel后，Selector内部的机制就可以自动不断地查询（Select）这些注册的Channel是否有已就绪的I/O事件（例如可读，可写，网络连接完成等），这样程序就可以很简单地使用一个线程高线地管理多个Channel</li>
</ul>
<h4 id="5，ChannelHandler"><a href="#5，ChannelHandler" class="headerlink" title="5，ChannelHandler"></a>5，ChannelHandler</h4><ul>
<li><p>ChannelHandler是一个接口，处理I/O事件或拦截I/O操作，并将其转发到其ChannelPipeline（业务处理链）中的下一个处理程序</p>
</li>
<li><p>ChannelHandler本身并没有提供很多方法，因为这个接口有许多的方法需要实现，方便使用期间，可以继承它的子类</p>
</li>
<li><p>ChannelHandler及其实现类UML类图：</p>
<p><img src="/2021/07/16/netty/39.png" alt="image-20210720202335505"></p>
</li>
</ul>
<ul>
<li><p>我们经常需要自定义一个Handler类去继承ChannelInboundHandlerAdapter，然后通过重写相应方法实现业务逻辑，我们接下来看看一般都需要重写哪些方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChannelInboundHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">ChannelInboundHandler</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChannelInboundHandlerAdapter</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.fireChannelRegistered();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelUnregistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.fireChannelUnregistered();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通道就绪事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.fireChannelActive();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.fireChannelInactive();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通道读取数据事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx,Object msg)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.fireChannelRead(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//数据读取完毕事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(CHnanelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.fireChannelReadComplete();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx,Object evt)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.fireUserEventTriggered(evt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.channelWritabilityChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通道发生异常事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx,Throwable cause)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h4 id="6，Pipeline和ChannelPipeline"><a href="#6，Pipeline和ChannelPipeline" class="headerlink" title="6，Pipeline和ChannelPipeline"></a>6，Pipeline和ChannelPipeline</h4><ul>
<li><p>ChannelPipeline是一个重点：</p>
<ul>
<li><p>ChannelPipeline是一个Handler的集合，它负责处理和拦截inbound或者outbound的事件和操作，相当于一个贯穿Netty的链。（也可以这样理解：ChannelPipeline是保存ChannelHandler的List，用于处理或拦截Channel的入站时间和出站事件）</p>
</li>
<li><p>ChannelPipeline实现了一个高级形式的拦截过滤器模式，使用户可以完全控制事件的处理方式，以及Channel中各个的ChannelHandler如何相互交互</p>
</li>
<li><p>在Netty中每个Channel都有且仅有一个ChannelPipeline与之对应，他们的组成关系如下：</p>
<p><img src="/2021/07/16/netty/40.png" alt="image-20210720203831363"></p>
<ul>
<li>一个Channel包含了一个ChannelPipeline，而ChannelPipeline中又维护了一个由ChannelHandlerContext组成的双向链表，并且每个ChannelHnadlerContext中又关联着一个ChannelHandler</li>
<li>入站事件和出站事件在一个双向链表中，入站事件会从链表head往后传递到最后一个入站的handler，出站事件会从链表tail往前传递到最前一个出站的handler，两种类型的handler互不干扰</li>
</ul>
</li>
</ul>
</li>
<li><p>常用方法：</p>
<ul>
<li><code>ChannelPipeline addFirst(ChannelHandler... handlers)</code>：把一个业务处理类（handler）添加到链中的第一个位置</li>
<li><code>ChannelPipeline addLast(ChannelHandler... handlers)</code>：把一个业务处理类（handler）添加到链中的最后一个位置</li>
</ul>
</li>
</ul>
<h4 id="7，ChannelHandlerContext"><a href="#7，ChannelHandlerContext" class="headerlink" title="7，ChannelHandlerContext"></a>7，ChannelHandlerContext</h4><ul>
<li>保存Channel相关的所有上下文信息，同时关联一个ChannelHandler对象</li>
<li>即ChannelHandlerContext中包含一个具体的事件处理器ChannelHandler，同时ChannelHandlerContext中也绑定了对应的pipeline和Channel的信息，方便对ChannnelHandler进行调用</li>
<li>常用方法：<ul>
<li><code>ChannelFuture close()</code>：关闭通道</li>
<li><code>ChannelOutboundInvoker flush()</code>：刷新</li>
<li><code>ChannelFuture writeAndFlush(Object msg)</code>：将数据写到ChannelPipeline中当前</li>
<li><code>ChannelHandler</code>的下一个<code>ChannelHandler</code>开始处理（出站）</li>
</ul>
</li>
</ul>
<h4 id="8，ChannelOption"><a href="#8，ChannelOption" class="headerlink" title="8，ChannelOption"></a>8，ChannelOption</h4><ul>
<li>Netty在创建Channel实例后，一般都需要设置ChannelOption参数</li>
<li>ChannelOption参数如下：<ul>
<li><code>ChannelOption.SO_BACKLOG</code><ul>
<li>对应TCP/IP协议listen函数中的backlog参数，用来初始化服务器可连接队列大小。服务端处理客户端连接请求是顺序处理的，所以同一时间只能处理一个客户端连接。多个客户端来的时候，服务端将不能处理的客户端连接请求放在队列中等待处理，backing参数指定了队列的大小</li>
</ul>
</li>
<li><code>ChannelOption.SO_KEEPALIVE</code><ul>
<li>一直保持连接活动状态</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="9，EventLoopGroup和其实现类NioEventLoopGroup"><a href="#9，EventLoopGroup和其实现类NioEventLoopGroup" class="headerlink" title="9，EventLoopGroup和其实现类NioEventLoopGroup"></a>9，EventLoopGroup和其实现类NioEventLoopGroup</h4><ul>
<li><p>EventLoopGroup是一组EventLoop的抽闲，Netty为了更好的利用多核CPU资源，一般会有多个EvenetLooop同时工作，每个EventLoop维护着一个Selector实例</p>
</li>
<li><p>EventLoopGroup提供next接口，可以从组里面按照一定规则获取其中一个EventLoop来处理任务，在Netty服务器端编程中，我们一般都需要提供两个EventLoopGroup，例如：<code>BpssEventLoopGroup</code>和<code>WorkerEventLoopGroup</code></p>
</li>
<li><p>通常一个服务端口即一个<code>ServerSocketChannel</code>对应一个Selector和一个EventLoop线程。BossEventLoop负责接收客户端的连接并将<code>SocketChannel</code>交给<code>WorkerEventLoopGroup</code>来进行IO处理，如下图所示：</p>
<p><img src="/2021/07/16/netty/41.png" alt="image-20210720221900537"></p>
</li>
<li><p>常用方法：</p>
<ul>
<li><code>public NioEventLoopGroup()</code>：构造方法</li>
<li><code>public Future&lt;?&gt; shutdownGracefully()</code>：断开连接，关闭线程</li>
</ul>
</li>
</ul>
<h4 id="10，Unpooled类"><a href="#10，Unpooled类" class="headerlink" title="10，Unpooled类"></a>10，Unpooled类</h4><ul>
<li><p>Netty提供一个专门用来操作缓冲区（即Netty的数据容器）的工具类</p>
</li>
<li><p>常用方法如下所示：</p>
<ul>
<li><code>public static ByteBuf copiedBuffer(CharSequence string,Charset charset)</code>：通过给定的数据和字符编码返回一个ByteBuf对象（类似于NIO中的ByteBuffer但有区别）</li>
</ul>
</li>
<li><p>举例说明：Unpooled获取Netty的数据容器ByteBuf的基本使用</p>
<p><img src="/2021/07/16/netty/42.png" alt="image-20210720222229496"></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyByteBuf01</span> </span>&#123;    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;        <span class="comment">//创建一个ByteBuf        //说明        //1. 创建 对象，该对象包含一个数组arr , 是一个byte[10]        //2. 在netty 的buffer中，不需要使用flip 进行反转        //   底层维护了 readerindex 和 writerIndex        //3. 通过 readerindex 和  writerIndex 和  capacity， 将buffer分成三个区域        // 0---readerindex 已经读取的区域        // readerindex---writerIndex ， 可读的区域        // writerIndex -- capacity, 可写的区域        ByteBuf buffer = Unpooled.buffer(10);        for(int i = 0; i &lt; 10; i++) &#123;            buffer.writeByte(i);        &#125;        System.out.println("capacity=" + buffer.capacity());//10        //输出//        for(int i = 0; i&lt;buffer.capacity(); i++) &#123;//            System.out.println(buffer.getByte(i));//        &#125;        for(int i = 0; i &lt; buffer.capacity(); i++) &#123;            System.out.println(buffer.readByte());        &#125;        System.out.println("执行完毕");    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyByteBuf02</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建ByteBuf</span></span><br><span class="line">        ByteBuf byteBuf = Unpooled.copiedBuffer(<span class="string">"hello,world!"</span>, Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用相关的方法</span></span><br><span class="line">        <span class="keyword">if</span>(byteBuf.hasArray()) &#123; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] content = byteBuf.array();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将 content 转成字符串</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> String(content, Charset.forName(<span class="string">"utf-8"</span>)));</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"byteBuf="</span> + byteBuf);</span><br><span class="line"></span><br><span class="line">            System.out.println(byteBuf.arrayOffset()); <span class="comment">// 0</span></span><br><span class="line">            System.out.println(byteBuf.readerIndex()); <span class="comment">// 0</span></span><br><span class="line">            System.out.println(byteBuf.writerIndex()); <span class="comment">// 12</span></span><br><span class="line">            System.out.println(byteBuf.capacity()); <span class="comment">// 36</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//System.out.println(byteBuf.readByte()); //</span></span><br><span class="line">            System.out.println(byteBuf.getByte(<span class="number">0</span>)); <span class="comment">// 104</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> len = byteBuf.readableBytes(); <span class="comment">//可读的字节数  12</span></span><br><span class="line">            System.out.println(<span class="string">"len="</span> + len);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用for取出各个字节</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                System.out.println((<span class="keyword">char</span>) byteBuf.getByte(i));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//按照某个范围读取</span></span><br><span class="line">            System.out.println(byteBuf.getCharSequence(<span class="number">0</span>, <span class="number">4</span>, Charset.forName(<span class="string">"utf-8"</span>)));</span><br><span class="line">            System.out.println(byteBuf.getCharSequence(<span class="number">4</span>, <span class="number">6</span>, Charset.forName(<span class="string">"utf-8"</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="11，Netty应用实例——群聊系统"><a href="#11，Netty应用实例——群聊系统" class="headerlink" title="11，Netty应用实例——群聊系统"></a>11，Netty应用实例——群聊系统</h4><ul>
<li><p>实例要求：</p>
<ul>
<li>编写一个Netty群聊系统，实现服务器端和客户端之间的数据简单通讯（非阻塞）</li>
<li>实现多人群聊</li>
<li>服务器端：可以监测用户上线，离线，并实现消息转发功能</li>
<li>客户端：通过channel可以无阻塞发送消息给其他所有用户，同时可以接受其他用户发送的消息（有服务器转发得到）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port; <span class="comment">//监听端口</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupChatServer</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//编写run方法，处理客户端的请求</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建两个线程组</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); <span class="comment">//8个NioEventLoop</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line">            b.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                    .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_BACKLOG</span>, 128)</span></span><br><span class="line"><span class="class">                    .<span class="title">childOption</span>(<span class="title">ChannelOption</span>.<span class="title">SO_KEEPALIVE</span>, <span class="title">true</span>)</span></span><br><span class="line"><span class="class">                    .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">//获取到pipeline</span></span><br><span class="line">                            ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                            <span class="comment">//向pipeline加入解码器</span></span><br><span class="line">                            pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder());</span><br><span class="line">                            <span class="comment">//向pipeline加入编码器</span></span><br><span class="line">                            pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder());</span><br><span class="line">                            <span class="comment">//加入自己的业务处理handler</span></span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> GroupChatServerHandler());</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"netty 服务器启动"</span>);</span><br><span class="line">            ChannelFuture channelFuture = b.bind(port).sync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//监听关闭</span></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> GroupChatServer(<span class="number">7000</span>).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//public static List&lt;Channel&gt; channels = new ArrayList&lt;Channel&gt;();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用一个hashmap 管理</span></span><br><span class="line">    <span class="comment">//public static Map&lt;String, Channel&gt; channels = new HashMap&lt;String,Channel&gt;();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个channle 组，管理所有的channel</span></span><br><span class="line">    <span class="comment">//GlobalEventExecutor.INSTANCE) 是全局的事件执行器，是一个单例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ChannelGroup  channelGroup = <span class="keyword">new</span> DefaultChannelGroup(GlobalEventExecutor.INSTANCE);</span><br><span class="line">    SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//handlerAdded 表示连接建立，一旦连接，第一个被执行</span></span><br><span class="line">    <span class="comment">//将当前channel 加入到  channelGroup</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Channel channel = ctx.channel();</span><br><span class="line">        <span class="comment">//将该客户加入聊天的信息推送给其它在线的客户端</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        该方法会将 channelGroup 中所有的channel 遍历，并发送 消息，</span></span><br><span class="line"><span class="comment">        我们不需要自己遍历</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channelGroup.writeAndFlush(<span class="string">"[客户端]"</span> + channel.remoteAddress() + <span class="string">" 加入聊天"</span> + sdf.format(<span class="keyword">new</span> java.util.Date()) + <span class="string">" \n"</span>);</span><br><span class="line">        channelGroup.add(channel);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//断开连接, 将xx客户离开信息推送给当前在线的客户</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Channel channel = ctx.channel();</span><br><span class="line">        channelGroup.writeAndFlush(<span class="string">"[客户端]"</span> + channel.remoteAddress() + <span class="string">" 离开了\n"</span>);</span><br><span class="line">        System.out.println(<span class="string">"channelGroup size"</span> + channelGroup.size());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//表示channel 处于活动状态, 提示 xx上线</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(ctx.channel().remoteAddress() + <span class="string">" 上线了~"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//表示channel 处于不活动状态, 提示 xx离线了</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(ctx.channel().remoteAddress() + <span class="string">" 离线了~"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, String msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取到当前channel</span></span><br><span class="line">        Channel channel = ctx.channel();</span><br><span class="line">        <span class="comment">//这时我们遍历channelGroup, 根据不同的情况，回送不同的消息</span></span><br><span class="line"></span><br><span class="line">        channelGroup.forEach(ch -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(channel != ch) &#123; <span class="comment">//不是当前的channel,转发消息</span></span><br><span class="line">                ch.writeAndFlush(<span class="string">"[客户]"</span> + channel.remoteAddress() + <span class="string">" 发送了消息"</span> + msg + <span class="string">"\n"</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;<span class="comment">//回显自己发送的消息给自己</span></span><br><span class="line">                ch.writeAndFlush(<span class="string">"[自己]发送了消息"</span> + msg + <span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//关闭通道</span></span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//属性</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupChatClient</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap()</span><br><span class="line">                .group(group)</span><br><span class="line">                .channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">handler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//得到pipeline</span></span><br><span class="line">                        ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                        <span class="comment">//加入相关handler</span></span><br><span class="line">                        pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder());</span><br><span class="line">                        pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder());</span><br><span class="line">                        <span class="comment">//加入自定义的handler</span></span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> GroupChatClientHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        ChannelFuture channelFuture = bootstrap.connect(host, port).sync();</span><br><span class="line">        <span class="comment">//得到channel</span></span><br><span class="line">            Channel channel = channelFuture.channel();</span><br><span class="line">            System.out.println(<span class="string">"-------"</span> + channel.localAddress()+ <span class="string">"--------"</span>);</span><br><span class="line">            <span class="comment">//客户端需要输入信息，创建一个扫描器</span></span><br><span class="line">            Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">                String msg = scanner.nextLine();</span><br><span class="line">                <span class="comment">//通过channel 发送到服务器端</span></span><br><span class="line">                channel.writeAndFlush(msg + <span class="string">"\r\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> GroupChatClient(<span class="string">"127.0.0.1"</span>, <span class="number">7000</span>).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, String msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(msg.trim());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String pwd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="12，Netty心跳检测机制案例"><a href="#12，Netty心跳检测机制案例" class="headerlink" title="12，Netty心跳检测机制案例"></a>12，Netty心跳检测机制案例</h4><ul>
<li>实例要求：<ul>
<li>编写一个Netty心跳检测机制案例，当服务器超过3秒没有读时，就提示读空闲</li>
<li>当服务器超过5秒没有写操作时，就提示写空闲</li>
<li>实现当服务器超过7秒没有读或者写操作时，就提示读写空闲</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建两个线程组</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); <span class="comment">//8个NioEventLoop</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup);</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            serverBootstrap.handler(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO));</span><br><span class="line">            serverBootstrap.childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                    <span class="comment">//加入一个netty 提供 IdleStateHandler</span></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    说明</span></span><br><span class="line"><span class="comment">                    1. IdleStateHandler 是netty 提供的处理空闲状态的处理器</span></span><br><span class="line"><span class="comment">                    2. long readerIdleTime : 表示多长时间没有读, 就会发送一个心跳检测包检测是否连接</span></span><br><span class="line"><span class="comment">                    3. long writerIdleTime : 表示多长时间没有写, 就会发送一个心跳检测包检测是否连接</span></span><br><span class="line"><span class="comment">                    4. long allIdleTime : 表示多长时间没有读写, 就会发送一个心跳检测包检测是否连接</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    5. 文档说明</span></span><br><span class="line"><span class="comment">                    triggers an &#123;@link IdleStateEvent&#125; when a &#123;@link Channel&#125; has not performed</span></span><br><span class="line"><span class="comment"> * read, write, or both operation for a while.</span></span><br><span class="line"><span class="comment"> *                  6. 当 IdleStateEvent 触发后 , 就会传递给管道 的下一个handler去处理</span></span><br><span class="line"><span class="comment"> *                  通过调用(触发)下一个handler 的 userEventTiggered , 在该方法中去处理 IdleStateEvent(读空闲，写空闲，读写空闲)</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> IdleStateHandler(<span class="number">7000</span>,<span class="number">7000</span>,<span class="number">10</span>, TimeUnit.SECONDS));</span><br><span class="line">                    <span class="comment">//加入一个对空闲检测进一步处理的handler(自定义)</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> MyServerHandler());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//启动服务器</span></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">7000</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt 事件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将  evt 向下转型 IdleStateEvent</span></span><br><span class="line">            IdleStateEvent event = (IdleStateEvent) evt;</span><br><span class="line">            String eventType = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">switch</span> (event.state()) &#123;</span><br><span class="line">                <span class="keyword">case</span> READER_IDLE:</span><br><span class="line">                  eventType = <span class="string">"读空闲"</span>;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WRITER_IDLE:</span><br><span class="line">                    eventType = <span class="string">"写空闲"</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ALL_IDLE:</span><br><span class="line">                    eventType = <span class="string">"读写空闲"</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(ctx.channel().remoteAddress() + <span class="string">"--超时时间--"</span> + eventType);</span><br><span class="line">            System.out.println(<span class="string">"服务器做相应处理.."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果发生空闲，我们关闭通道</span></span><br><span class="line">           <span class="comment">// ctx.channel().close();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt 事件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将  evt 向下转型 IdleStateEvent</span></span><br><span class="line">            IdleStateEvent event = (IdleStateEvent) evt;</span><br><span class="line">            String eventType = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">switch</span> (event.state()) &#123;</span><br><span class="line">                <span class="keyword">case</span> READER_IDLE:</span><br><span class="line">                  eventType = <span class="string">"读空闲"</span>;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WRITER_IDLE:</span><br><span class="line">                    eventType = <span class="string">"写空闲"</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ALL_IDLE:</span><br><span class="line">                    eventType = <span class="string">"读写空闲"</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(ctx.channel().remoteAddress() + <span class="string">"--超时时间--"</span> + eventType);</span><br><span class="line">            System.out.println(<span class="string">"服务器做相应处理.."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果发生空闲，我们关闭通道</span></span><br><span class="line">           <span class="comment">// ctx.channel().close();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(System.nanoTime()); <span class="comment">//纳秒  10亿分之1</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(System.nanoTime());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="13，Netty通过WebSocket编程实现服务器和客户端长连接"><a href="#13，Netty通过WebSocket编程实现服务器和客户端长连接" class="headerlink" title="13，Netty通过WebSocket编程实现服务器和客户端长连接"></a>13，Netty通过WebSocket编程实现服务器和客户端长连接</h4><ul>
<li>实例要求：<ul>
<li>Http协议是无状态的，浏览器和服务器间的请求响应一次，下一次会重新创建连接</li>
<li>要求：实现基于WebSocket的长连接的全双工的交互</li>
<li>改变Http协议多次请去的约束，实现了长连接了，服务器可以发送消息给浏览器</li>
<li>客户端浏览器和服务器端相互感知，比如服务器关闭了，浏览器会感知，同样浏览器关闭了，服务器会感知</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建两个线程组</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); <span class="comment">//8个NioEventLoop</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup);</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            serverBootstrap.handler(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO));</span><br><span class="line">            serverBootstrap.childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//因为基于http协议，使用http的编码和解码器</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> HttpServerCodec());</span><br><span class="line">                    <span class="comment">//是以块方式写，添加ChunkedWriteHandler处理器</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> ChunkedWriteHandler());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    说明</span></span><br><span class="line"><span class="comment">                    1. http数据在传输过程中是分段, HttpObjectAggregator ，就是可以将多个段聚合</span></span><br><span class="line"><span class="comment">                    2. 这就就是为什么，当浏览器发送大量数据时，就会发出多次http请求</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> HttpObjectAggregator(<span class="number">8192</span>));</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    说明</span></span><br><span class="line"><span class="comment">                    1. 对应websocket ，它的数据是以 帧(frame) 形式传递</span></span><br><span class="line"><span class="comment">                    2. 可以看到WebSocketFrame 下面有六个子类</span></span><br><span class="line"><span class="comment">                    3. 浏览器请求时 ws://localhost:7000/hello 表示请求的uri</span></span><br><span class="line"><span class="comment">                    4. WebSocketServerProtocolHandler 核心功能是将 http协议升级为 ws协议 , 保持长连接</span></span><br><span class="line"><span class="comment">                    5. 是通过一个 状态码 101</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> WebSocketServerProtocolHandler(<span class="string">"/hello2"</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//自定义的handler ，处理业务逻辑</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> MyTextWebSocketFrameHandler());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//启动服务器</span></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">7000</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里 TextWebSocketFrame 类型，表示一个文本帧(frame)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTextWebSocketFrameHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">TextWebSocketFrame</span>&gt;</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, TextWebSocketFrame msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"服务器收到消息 "</span> + msg.text());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//回复消息</span></span><br><span class="line">        ctx.channel().writeAndFlush(<span class="keyword">new</span> TextWebSocketFrame(<span class="string">"服务器时间"</span> + LocalDateTime.now() + <span class="string">" "</span> + msg.text()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当web客户端连接后， 触发方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//id 表示唯一的值，LongText 是唯一的 ShortText 不是唯一</span></span><br><span class="line">        System.out.println(<span class="string">"handlerAdded 被调用"</span> + ctx.channel().id().asLongText());</span><br><span class="line">        System.out.println(<span class="string">"handlerAdded 被调用"</span> + ctx.channel().id().asShortText());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"handlerRemoved 被调用"</span> + ctx.channel().id().asLongText());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"异常发生 "</span> + cause.getMessage());</span><br><span class="line">        ctx.close(); <span class="comment">//关闭连接</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> socket;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">//判断当前浏览器是否支持websocket</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span>(<span class="built_in">window</span>.WebSocket) &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">//go on</span></span></span><br><span class="line"><span class="actionscript">        socket = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:7000/hello2"</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">//相当于channelReado, ev 收到服务器端回送的消息</span></span></span><br><span class="line"><span class="actionscript">        socket.onmessage = <span class="function"><span class="keyword">function</span> <span class="params">(ev)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> rt = <span class="built_in">document</span>.getElementById(<span class="string">"responseText"</span>);</span></span><br><span class="line"><span class="actionscript">            rt.value = rt.value + <span class="string">"\n"</span> + ev.data;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">//相当于连接开启(感知到连接开启)</span></span></span><br><span class="line"><span class="actionscript">        socket.onopen = <span class="function"><span class="keyword">function</span> <span class="params">(ev)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> rt = <span class="built_in">document</span>.getElementById(<span class="string">"responseText"</span>);</span></span><br><span class="line"><span class="actionscript">            rt.value = <span class="string">"连接开启了.."</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">//相当于连接关闭(感知到连接关闭)</span></span></span><br><span class="line"><span class="actionscript">        socket.onclose = <span class="function"><span class="keyword">function</span> <span class="params">(ev)</span> </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> rt = <span class="built_in">document</span>.getElementById(<span class="string">"responseText"</span>);</span></span><br><span class="line"><span class="actionscript">            rt.value = rt.value + <span class="string">"\n"</span> + <span class="string">"连接关闭了.."</span></span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">        alert(<span class="string">"当前浏览器不支持websocket"</span>)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">//发送消息到服务器</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">(message)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(!<span class="built_in">window</span>.socket) &#123; <span class="comment">//先判断socket是否创建好</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">        if(socket.readyState == WebSocket.OPEN) &#123;</span><br><span class="line"><span class="actionscript">            <span class="comment">//通过socket 发送消息</span></span></span><br><span class="line">            socket.send(message)</span><br><span class="line"><span class="actionscript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">            alert(<span class="string">"连接没有开启"</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">"return false"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">"message"</span> <span class="attr">style</span>=<span class="string">"height: 300px; width: 300px"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"发生消息"</span> <span class="attr">onclick</span>=<span class="string">"send(this.form.message.value)"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"responseText"</span> <span class="attr">style</span>=<span class="string">"height: 300px; width: 300px"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"清空内容"</span> <span class="attr">onclick</span>=<span class="string">"document.getElementById('responseText').value=''"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="六，Google-Protobuf"><a href="#六，Google-Protobuf" class="headerlink" title="六，Google Protobuf"></a>六，Google Protobuf</h3><h4 id="1，编码和解码的基本介绍"><a href="#1，编码和解码的基本介绍" class="headerlink" title="1，编码和解码的基本介绍"></a>1，编码和解码的基本介绍</h4><ul>
<li><p>编写网络应用程序时，因为数据在网络中传输的都是二进制字节码数据，在发送数据时就需要编码，接收数据时就需要解码</p>
<p><img src="/2021/07/16/netty/43.png" alt="image-20210722001031250"></p>
<ul>
<li>codec（编解码器）的组成部分有两个：decoder(解码器)和encoder（编码器）。encoder负责把业务数据转换成字节码数据，decoder负责把字节码数据转换成业务数据</li>
</ul>
</li>
</ul>
<h4 id="2，Netty本身的编码和解码的机制和问题分析"><a href="#2，Netty本身的编码和解码的机制和问题分析" class="headerlink" title="2，Netty本身的编码和解码的机制和问题分析"></a>2，Netty本身的编码和解码的机制和问题分析</h4><ul>
<li>Netty自身提供了一些codec（编解码器）</li>
<li>Netty提供的编码器<ul>
<li><code>StringEncoder</code>：对字符串数据进行编码</li>
<li><code>ObjectEncoder</code>：对Java对象进行编码</li>
</ul>
</li>
<li>Netty提供的解码器：<ul>
<li><code>StringDecoder</code>：对字符串数据进行解码</li>
<li><code>ObjectDecoder</code>：对Java对象进行解码</li>
</ul>
</li>
<li>Netty本身自带的ObjectDecoder和ObjectEncoder可以用来实现POJO对象或各种业务对象的编码和解码，底层使用的仍是Java序列化技术，而Java序列化技术本身效率就不高，存在如下问题：<ul>
<li>无法跨语言</li>
<li>序列化后的体积太大，是二进制编码的5倍多</li>
<li>序列化性能太低</li>
</ul>
</li>
<li>——》引出新的解决方案【Google Protobuf】</li>
</ul>
<h4 id="3，Protobuf基本介绍"><a href="#3，Protobuf基本介绍" class="headerlink" title="3，Protobuf基本介绍"></a>3，Protobuf基本介绍</h4><ul>
<li><p>Protobuf是Google发布的开源项目，全称是Google Protocol Buffers，是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或RPC【远程过程调用   remote procedure call】数据交换格式</p>
<p>目前很多公司是 http+json   tcp+protobuf</p>
</li>
<li><p><a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="noopener">参考文档</a></p>
</li>
<li><p>Protobuf是以message的方式来管理数据的</p>
</li>
<li><p>支持跨平台，跨语言</p>
</li>
<li><p>高性能，高可靠性</p>
</li>
<li><p>使用protobuf编译器能自动生成代码，Protobuf是将类的定义使用.proto文件进行描述。说明，在IDEA中编写.proto文件时，会自动提示是否下载.proto编写插件，可以让语法高亮</p>
</li>
<li><p>通过protoc.exe编译器根据.proto自动生成Java文件</p>
</li>
<li><p>protobuf使用示意图</p>
<p><img src="/2021/07/16/netty/44.png" alt="image-20210722002850826"></p>
</li>
</ul>
<h4 id="4，Protobuf快速入门实例："><a href="#4，Protobuf快速入门实例：" class="headerlink" title="4，Protobuf快速入门实例："></a>4，Protobuf快速入门实例：</h4><ul>
<li><p>编写程序，使用Protobuf完成如下功能</p>
<ul>
<li>客户端可以发送一个Student PoJo对象到服务器（通过Protobuf编码）</li>
<li>服务端能接受Student PoJo对象，并显示信息（通过Protobuf解码）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>; <span class="comment">//版本</span></span><br><span class="line">option java_outer_classname = <span class="string">"StudentPOJO"</span>;<span class="comment">//生成的外部类名，同时也是文件名</span></span><br><span class="line"><span class="comment">//protobuf 使用message 管理数据</span></span><br><span class="line">message Student &#123; <span class="comment">//会在 StudentPOJO 外部类生成一个内部类 Student， 他是真正发送的POJO对象</span></span><br><span class="line">    int32 id = <span class="number">1</span>; <span class="comment">// Student 类中有 一个属性 名字为 id 类型为int32(protobuf类型) 1表示属性序号，不是值</span></span><br><span class="line">    string name = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentPOJO</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">StudentPOJO</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAllExtensions</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      com.google.protobuf.ExtensionRegistryLite registry)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAllExtensions</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      com.google.protobuf.ExtensionRegistry registry)</span> </span>&#123;</span><br><span class="line">    registerAllExtensions(</span><br><span class="line">        (com.google.protobuf.ExtensionRegistryLite) registry);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentOrBuilder</span> <span class="keyword">extends</span></span></span><br><span class="line">      // @@protoc_insertion_point(interface_extends:Student)</span><br><span class="line">      com.google.protobuf.MessageOrBuilder &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * Student 类中有 一个属性 名字为 id 类型为int32(protobuf类型) 1表示属性序号，不是值</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    com.google.protobuf.ByteString</span><br><span class="line">        getNameBytes();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">   *protobuf 使用message 管理数据</span></span><br><span class="line"><span class="comment">   * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Protobuf type &#123;<span class="doctag">@code</span> Student&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">      <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span> <span class="keyword">implements</span></span></span><br><span class="line">      // @@protoc_insertion_point(message_implements:Student)</span><br><span class="line">      StudentOrBuilder &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// Use Student.newBuilder() to construct.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Student</span><span class="params">(com.google.protobuf.GeneratedMessageV3.Builder&lt;?&gt; builder)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(builder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Student</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      id_ = <span class="number">0</span>;</span><br><span class="line">      name_ = <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet</span><br><span class="line">    getUnknownFields() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.unknownFields;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Student</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>();</span><br><span class="line">      <span class="keyword">if</span> (extensionRegistry == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> mutable_bitField0_ = <span class="number">0</span>;</span><br><span class="line">      com.google.protobuf.UnknownFieldSet.Builder unknownFields =</span><br><span class="line">          com.google.protobuf.UnknownFieldSet.newBuilder();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">          <span class="keyword">int</span> tag = input.readTag();</span><br><span class="line">          <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">              done = <span class="keyword">true</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: &#123;</span><br><span class="line"></span><br><span class="line">              id_ = input.readInt32();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>: &#123;</span><br><span class="line">              String s = input.readStringRequireUtf8();</span><br><span class="line"></span><br><span class="line">              name_ = s;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">              <span class="keyword">if</span> (!parseUnknownFieldProto3(</span><br><span class="line">                  input, unknownFields, extensionRegistry, tag)) &#123;</span><br><span class="line">                done = <span class="keyword">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.setUnfinishedMessage(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> com.google.protobuf.InvalidProtocolBufferException(</span><br><span class="line">            e).setUnfinishedMessage(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.unknownFields = unknownFields.build();</span><br><span class="line">        makeExtensionsImmutable();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">        getDescriptor() &#123;</span><br><span class="line">      <span class="keyword">return</span> StudentPOJO.internal_static_Student_descriptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> FieldAccessorTable</span><br><span class="line">        internalGetFieldAccessorTable() &#123;</span><br><span class="line">      <span class="keyword">return</span> StudentPOJO.internal_static_Student_fieldAccessorTable</span><br><span class="line">          .ensureFieldAccessorsInitialized(</span><br><span class="line">              Student<span class="class">.<span class="keyword">class</span>, <span class="title">Builder</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ID_FIELD_NUMBER = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id_;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * Student 类中有 一个属性 名字为 id 类型为int32(protobuf类型) 1表示属性序号，不是值</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> id_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NAME_FIELD_NUMBER = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Object name_;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Object ref = name_;</span><br><span class="line">      <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) ref;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        com.google.protobuf.ByteString bs = </span><br><span class="line">            (com.google.protobuf.ByteString) ref;</span><br><span class="line">        String s = bs.toStringUtf8();</span><br><span class="line">        name_ = s;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> com.google.protobuf.ByteString</span><br><span class="line">        getNameBytes() &#123;</span><br><span class="line">      Object ref = name_;</span><br><span class="line">      <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        com.google.protobuf.ByteString b = </span><br><span class="line">            com.google.protobuf.ByteString.copyFromUtf8(</span><br><span class="line">                (String) ref);</span><br><span class="line">        name_ = b;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (com.google.protobuf.ByteString) ref;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> memoizedIsInitialized = -<span class="number">1</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">byte</span> isInitialized = memoizedIsInitialized;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized == <span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">      memoizedIsInitialized = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(com.google.protobuf.CodedOutputStream output)</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (id_ != <span class="number">0</span>) &#123;</span><br><span class="line">        output.writeInt32(<span class="number">1</span>, id_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!getNameBytes().isEmpty()) &#123;</span><br><span class="line">        com.google.protobuf.GeneratedMessageV3.writeString(output, <span class="number">2</span>, name_);</span><br><span class="line">      &#125;</span><br><span class="line">      unknownFields.writeTo(output);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSerializedSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> size = memoizedSize;</span><br><span class="line">      <span class="keyword">if</span> (size != -<span class="number">1</span>) <span class="keyword">return</span> size;</span><br><span class="line"></span><br><span class="line">      size = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (id_ != <span class="number">0</span>) &#123;</span><br><span class="line">        size += com.google.protobuf.CodedOutputStream</span><br><span class="line">          .computeInt32Size(<span class="number">1</span>, id_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!getNameBytes().isEmpty()) &#123;</span><br><span class="line">        size += com.google.protobuf.GeneratedMessageV3.computeStringSize(<span class="number">2</span>, name_);</span><br><span class="line">      &#125;</span><br><span class="line">      size += unknownFields.getSerializedSize();</span><br><span class="line">      memoizedSize = size;</span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(<span class="keyword">final</span> Object obj)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Student)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.equals(obj);</span><br><span class="line">      &#125;</span><br><span class="line">      Student other = (Student) obj;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">      result = result &amp;&amp; (getId()</span><br><span class="line">          == other.getId());</span><br><span class="line">      result = result &amp;&amp; getName()</span><br><span class="line">          .equals(other.getName());</span><br><span class="line">      result = result &amp;&amp; unknownFields.equals(other.unknownFields);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (memoizedHashCode != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> memoizedHashCode;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> hash = <span class="number">41</span>;</span><br><span class="line">      hash = (<span class="number">19</span> * hash) + getDescriptor().hashCode();</span><br><span class="line">      hash = (<span class="number">37</span> * hash) + ID_FIELD_NUMBER;</span><br><span class="line">      hash = (<span class="number">53</span> * hash) + getId();</span><br><span class="line">      hash = (<span class="number">37</span> * hash) + NAME_FIELD_NUMBER;</span><br><span class="line">      hash = (<span class="number">53</span> * hash) + getName().hashCode();</span><br><span class="line">      hash = (<span class="number">29</span> * hash) + unknownFields.hashCode();</span><br><span class="line">      memoizedHashCode = hash;</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.nio.ByteBuffer data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.nio.ByteBuffer data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ByteString data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ByteString data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(<span class="keyword">byte</span>[] data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">byte</span>[] data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(java.io.InputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.io.InputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseDelimitedFrom</span><span class="params">(java.io.InputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseDelimitedWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseDelimitedFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.io.InputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseDelimitedWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">newBuilderForType</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> newBuilder(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE.toBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">(Student prototype)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE.toBuilder().mergeFrom(prototype);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">toBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span> == DEFAULT_INSTANCE</span><br><span class="line">          ? <span class="keyword">new</span> Builder() : <span class="keyword">new</span> Builder().mergeFrom(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Builder <span class="title">newBuilderForType</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        BuilderParent parent)</span> </span>&#123;</span><br><span class="line">      Builder builder = <span class="keyword">new</span> Builder(parent);</span><br><span class="line">      <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *protobuf 使用message 管理数据</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Protobuf type &#123;<span class="doctag">@code</span> Student&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">        <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span>.<span class="title">Builder</span>&lt;<span class="title">Builder</span>&gt; <span class="keyword">implements</span></span></span><br><span class="line">        // @@protoc_insertion_point(builder_implements:Student)</span><br><span class="line">        StudentOrBuilder &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">          getDescriptor() &#123;</span><br><span class="line">        <span class="keyword">return</span> StudentPOJO.internal_static_Student_descriptor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">protected</span> FieldAccessorTable</span><br><span class="line">          internalGetFieldAccessorTable() &#123;</span><br><span class="line">        <span class="keyword">return</span> StudentPOJO.internal_static_Student_fieldAccessorTable</span><br><span class="line">            .ensureFieldAccessorsInitialized(</span><br><span class="line">                Student<span class="class">.<span class="keyword">class</span>, <span class="title">Builder</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Construct using StudentPOJO.Student.newBuilder()</span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        maybeForceBuilderInitialization();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          BuilderParent parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        maybeForceBuilderInitialization();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeForceBuilderInitialization</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (com.google.protobuf.GeneratedMessageV3</span><br><span class="line">                .alwaysUseFieldBuilders) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.clear();</span><br><span class="line">        id_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        name_ = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">          getDescriptorForType() &#123;</span><br><span class="line">        <span class="keyword">return</span> StudentPOJO.internal_static_Student_descriptor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">getDefaultInstanceForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Student.getDefaultInstance();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Student result = buildPartial();</span><br><span class="line">        <span class="keyword">if</span> (!result.isInitialized()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> newUninitializedMessageException(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">buildPartial</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Student result = <span class="keyword">new</span> Student(<span class="keyword">this</span>);</span><br><span class="line">        result.id_ = id_;</span><br><span class="line">        result.name_ = name_;</span><br><span class="line">        onBuilt();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clone();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.setField(field, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clearField(field);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearOneof</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.OneofDescriptor oneof)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clearOneof(oneof);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setRepeatedField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> index, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.setRepeatedField(field, index, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">addRepeatedField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.addRepeatedField(field, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(com.google.protobuf.Message other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other <span class="keyword">instanceof</span> Student) &#123;</span><br><span class="line">          <span class="keyword">return</span> mergeFrom((Student)other);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">super</span>.mergeFrom(other);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(Student other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other == Student.getDefaultInstance()) <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (other.getId() != <span class="number">0</span>) &#123;</span><br><span class="line">          setId(other.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!other.getName().isEmpty()) &#123;</span><br><span class="line">          name_ = other.name_;</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.mergeUnknownFields(other.unknownFields);</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        Student parsedMessage = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          parsedMessage = PARSER.parsePartialFrom(input, extensionRegistry);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">          parsedMessage = (Student) e.getUnfinishedMessage();</span><br><span class="line">          <span class="keyword">throw</span> e.unwrapIOException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (parsedMessage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mergeFrom(parsedMessage);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> id_ ;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       * Student 类中有 一个属性 名字为 id 类型为int32(protobuf类型) 1表示属性序号，不是值</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       * Student 类中有 一个属性 名字为 id 类型为int32(protobuf类型) 1表示属性序号，不是值</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setId</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        id_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       * Student 类中有 一个属性 名字为 id 类型为int32(protobuf类型) 1表示属性序号，不是值</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        id_ = <span class="number">0</span>;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> Object name_ = <span class="string">""</span>;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object ref = name_;</span><br><span class="line">        <span class="keyword">if</span> (!(ref <span class="keyword">instanceof</span> String)) &#123;</span><br><span class="line">          com.google.protobuf.ByteString bs =</span><br><span class="line">              (com.google.protobuf.ByteString) ref;</span><br><span class="line">          String s = bs.toStringUtf8();</span><br><span class="line">          name_ = s;</span><br><span class="line">          <span class="keyword">return</span> s;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> (String) ref;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> com.google.protobuf.ByteString</span><br><span class="line">          getNameBytes() &#123;</span><br><span class="line">        Object ref = name_;</span><br><span class="line">        <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">          com.google.protobuf.ByteString b = </span><br><span class="line">              com.google.protobuf.ByteString.copyFromUtf8(</span><br><span class="line">                  (String) ref);</span><br><span class="line">          name_ = b;</span><br><span class="line">          <span class="keyword">return</span> b;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> (com.google.protobuf.ByteString) ref;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">        name_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        name_ = getDefaultInstance().getName();</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setNameBytes</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ByteString value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  &#125;</span><br><span class="line">  checkByteStringIsUtf8(value);</span><br><span class="line">        </span><br><span class="line">        name_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Builder <span class="title">setUnknownFields</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet unknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.setUnknownFieldsProto3(unknownFields);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Builder <span class="title">mergeUnknownFields</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet unknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.mergeUnknownFields(unknownFields);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// @@protoc_insertion_point(builder_scope:Student)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @@protoc_insertion_point(class_scope:Student)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Student DEFAULT_INSTANCE;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">      DEFAULT_INSTANCE = <span class="keyword">new</span> Student();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">getDefaultInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Parser&lt;Student&gt;</span><br><span class="line">        PARSER = <span class="keyword">new</span> com.google.protobuf.AbstractParser&lt;Student&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">parsePartialFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Student(input, extensionRegistry);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> com.google.protobuf.<span class="function">Parser&lt;Student&gt; <span class="title">parser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> com.google.protobuf.<span class="function">Parser&lt;Student&gt; <span class="title">getParserForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Student <span class="title">getDefaultInstanceForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">    internal_static_Student_descriptor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> </span><br><span class="line">    com.google.protobuf.GeneratedMessageV3.FieldAccessorTable</span><br><span class="line">      internal_static_Student_fieldAccessorTable;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> com.google.protobuf.Descriptors.FileDescriptor</span><br><span class="line">      getDescriptor() &#123;</span><br><span class="line">    <span class="keyword">return</span> descriptor;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span>  com.google.protobuf.Descriptors.FileDescriptor</span><br><span class="line">      descriptor;</span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    String[] descriptorData = &#123;</span><br><span class="line">      <span class="string">"\n\rStudent.proto\"#\n\007Student\022\n\n\002id\030\001 \001(\005\022\014"</span> +</span><br><span class="line">      <span class="string">"\n\004name\030\002 \001(\tB\rB\013StudentPOJOb\006proto3"</span></span><br><span class="line">    &#125;;</span><br><span class="line">    com.google.protobuf.Descriptors.FileDescriptor.InternalDescriptorAssigner assigner =</span><br><span class="line">        <span class="keyword">new</span> com.google.protobuf.Descriptors.FileDescriptor.    InternalDescriptorAssigner() &#123;</span><br><span class="line">          <span class="keyword">public</span> com.google.protobuf.<span class="function">ExtensionRegistry <span class="title">assignDescriptors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">              com.google.protobuf.Descriptors.FileDescriptor root)</span> </span>&#123;</span><br><span class="line">            descriptor = root;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    com.google.protobuf.Descriptors.FileDescriptor</span><br><span class="line">      .internalBuildGeneratedFileFrom(descriptorData,</span><br><span class="line">        <span class="keyword">new</span> com.google.protobuf.Descriptors.FileDescriptor[] &#123;</span><br><span class="line">        &#125;, assigner);</span><br><span class="line">    internal_static_Student_descriptor =</span><br><span class="line">      getDescriptor().getMessageTypes().get(<span class="number">0</span>);</span><br><span class="line">    internal_static_Student_fieldAccessorTable = <span class="keyword">new</span></span><br><span class="line">      com.google.protobuf.GeneratedMessageV3.FieldAccessorTable(</span><br><span class="line">        internal_static_Student_descriptor,</span><br><span class="line">        <span class="keyword">new</span> String[] &#123; <span class="string">"Id"</span>, <span class="string">"Name"</span>, &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// @@protoc_insertion_point(outer_class_scope)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建BossGroup 和 WorkerGroup</span></span><br><span class="line">        <span class="comment">//说明</span></span><br><span class="line">        <span class="comment">//1. 创建两个线程组 bossGroup 和 workerGroup</span></span><br><span class="line">        <span class="comment">//2. bossGroup 只是处理连接请求 , 真正的和客户端业务处理，会交给 workerGroup完成</span></span><br><span class="line">        <span class="comment">//3. 两个都是无限循环</span></span><br><span class="line">        <span class="comment">//4. bossGroup 和 workerGroup 含有的子线程(NioEventLoop)的个数</span></span><br><span class="line">        <span class="comment">//   默认实际 cpu核数 * 2</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); <span class="comment">//8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建服务器端的启动对象，配置参数</span></span><br><span class="line">            ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用链式编程来进行设置</span></span><br><span class="line">            bootstrap.group(bossGroup, workerGroup) <span class="comment">//设置两个线程组</span></span><br><span class="line">                    .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>) //使用<span class="title">NioSocketChannel</span> 作为服务器的通道实现</span></span><br><span class="line"><span class="class">                    .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_BACKLOG</span>, 128) // 设置线程队列得到连接个数</span></span><br><span class="line"><span class="class">                    .<span class="title">childOption</span>(<span class="title">ChannelOption</span>.<span class="title">SO_KEEPALIVE</span>, <span class="title">true</span>) //设置保持活动连接状态</span></span><br><span class="line"><span class="class">//                    .<span class="title">handler</span>(<span class="title">null</span>) // 该 <span class="title">handler</span>对应 <span class="title">bossGroup</span> , <span class="title">childHandler</span> 对应 <span class="title">workerGroup</span></span></span><br><span class="line"><span class="class">                    .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;<span class="comment">//创建一个通道初始化对象(匿名对象)</span></span><br><span class="line">                        <span class="comment">//给pipeline 设置处理器</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                            <span class="comment">//在pipeline加入ProtoBufDecoder</span></span><br><span class="line">                            <span class="comment">//指定对哪种对象进行解码</span></span><br><span class="line">                            pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> ProtobufDecoder(StudentPOJO.Student.getDefaultInstance()));</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> NettyServerHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;); <span class="comment">// 给我们的workerGroup 的 EventLoop 对应的管道设置处理器</span></span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">".....服务器 is ready..."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//绑定一个端口并且同步, 生成了一个 ChannelFuture 对象</span></span><br><span class="line">            <span class="comment">//启动服务器(并绑定端口)</span></span><br><span class="line">            ChannelFuture cf = bootstrap.bind(<span class="number">6668</span>).sync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//给cf 注册监听器，监控我们关心的事件</span></span><br><span class="line"></span><br><span class="line">            cf.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (cf.isSuccess()) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"监听端口 6668 成功"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">"监听端口 6668 失败"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//对关闭通道进行监听</span></span><br><span class="line">            cf.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">说明</span></span><br><span class="line"><span class="comment">1. 我们自定义一个Handler 需要继续netty 规定好的某个HandlerAdapter(规范)</span></span><br><span class="line"><span class="comment">2. 这时我们自定义一个Handler , 才能称为一个handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//public class NettyServerHandler extends ChannelInboundHandlerAdapter &#123;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">StudentPOJO</span>.<span class="title">Student</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取数据实际(这里我们可以读取客户端发送的消息)</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    1. ChannelHandlerContext ctx:上下文对象, 含有 管道pipeline , 通道channel, 地址</span></span><br><span class="line"><span class="comment">    2. Object msg: 就是客户端发送的数据 默认Object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, StudentPOJO.Student msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取从客户端发送的StudentPojo.Student</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"客户端发送的数据 id="</span> + msg.getId() + <span class="string">" 名字="</span> + msg.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    //读取数据实际(这里我们可以读取客户端发送的消息)</span></span><br><span class="line"><span class="comment">//    /*</span></span><br><span class="line"><span class="comment">//    1. ChannelHandlerContext ctx:上下文对象, 含有 管道pipeline , 通道channel, 地址</span></span><br><span class="line"><span class="comment">//    2. Object msg: 就是客户端发送的数据 默认Object</span></span><br><span class="line"><span class="comment">//     */</span></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //读取从客户端发送的StudentPojo.Student</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        StudentPOJO.Student student = (StudentPOJO.Student) msg;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        System.out.println("客户端发送的数据 id=" + student.getId() + " 名字=" + student.getName());</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据读取完毕</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//writeAndFlush 是 write + flush</span></span><br><span class="line">        <span class="comment">//将数据写入到缓存，并刷新</span></span><br><span class="line">        <span class="comment">//一般讲，我们对这个发送的数据进行编码</span></span><br><span class="line">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">"hello, 客户端~(&gt;^ω^&lt;)喵1"</span>, CharsetUtil.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理异常, 一般是需要关闭通道</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//客户端需要一个事件循环组</span></span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建客户端启动对象</span></span><br><span class="line">            <span class="comment">//注意客户端使用的不是 ServerBootstrap 而是 Bootstrap</span></span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置相关参数</span></span><br><span class="line">            bootstrap.group(group) <span class="comment">//设置线程组</span></span><br><span class="line">                    .channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>) // 设置客户端通道的实现类(反射)</span></span><br><span class="line"><span class="class">                    .<span class="title">handler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                            <span class="comment">//在pipeline中加入 ProtoBufEncoder</span></span><br><span class="line">                            pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> ProtobufEncoder());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> NettyClientHandler()); <span class="comment">//加入自己的处理器</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"客户端 ok.."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//启动客户端去连接服务器端</span></span><br><span class="line">            <span class="comment">//关于 ChannelFuture 要分析，涉及到netty的异步模型</span></span><br><span class="line">            ChannelFuture channelFuture = bootstrap.connect(<span class="string">"127.0.0.1"</span>, <span class="number">6668</span>).sync();</span><br><span class="line">            <span class="comment">//给关闭通道进行监听</span></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当通道就绪就会触发该方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发生一个Student 对象到服务器</span></span><br><span class="line"></span><br><span class="line">        StudentPOJO.Student student = StudentPOJO.Student.newBuilder().setId(<span class="number">4</span>).setName(<span class="string">"智多星 吴用"</span>).build();</span><br><span class="line">        <span class="comment">//Teacher , Member ,Message</span></span><br><span class="line">        ctx.writeAndFlush(student);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当通道有读取事件时，会触发</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ByteBuf buf = (ByteBuf) msg;</span><br><span class="line">        System.out.println(<span class="string">"服务器回复的消息:"</span> + buf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        System.out.println(<span class="string">"服务器的地址： "</span>+ ctx.channel().remoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h4 id="5，Protobuf快速入门实例2️⃣"><a href="#5，Protobuf快速入门实例2️⃣" class="headerlink" title="5，Protobuf快速入门实例2️⃣"></a>5，Protobuf快速入门实例2️⃣</h4><ul>
<li><p>编写程序，使用Protobuf完成如下功能：</p>
<ul>
<li>客户端可以随机发送Student POJO/Worker POJO对象到服务器（通过Protobuf编码）</li>
<li>服务器能接受Student POJO/Worker POJO对象（需要判断是哪种类型），并显示信息（通过Protobuf解码）</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">option</span> optimize_for = SPEED; <span class="comment">// 加快解析</span></span><br><span class="line"><span class="keyword">option</span> java_package=<span class="string">"com.atguigu.netty.codec2"</span>;   <span class="comment">//指定生成到哪个包下</span></span><br><span class="line"><span class="keyword">option</span> java_outer_classname=<span class="string">"MyDataInfo"</span>; <span class="comment">// 外部类名, 文件名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//protobuf 可以使用message 管理其他的message</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">MyMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个枚举类型</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">DataType</span> </span>&#123;</span><br><span class="line">        StudentType = <span class="number">0</span>; <span class="comment">//在proto3 要求enum的编号从0开始</span></span><br><span class="line">        WorkerType = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line">    DataType data_type = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//表示每次枚举类型最多只能出现其中的一个, 节省空间</span></span><br><span class="line">    <span class="keyword">oneof</span> dataBody &#123;</span><br><span class="line">        Student student = <span class="number">2</span>;</span><br><span class="line">        Worker worker = <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> id = <span class="number">1</span>;<span class="comment">//Student类的属性</span></span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">2</span>; <span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Worker</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">int32</span> age=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br><span class="line">1870</span><br><span class="line">1871</span><br><span class="line">1872</span><br><span class="line">1873</span><br><span class="line">1874</span><br><span class="line">1875</span><br><span class="line">1876</span><br><span class="line">1877</span><br><span class="line">1878</span><br><span class="line">1879</span><br><span class="line">1880</span><br><span class="line">1881</span><br><span class="line">1882</span><br><span class="line">1883</span><br><span class="line">1884</span><br><span class="line">1885</span><br><span class="line">1886</span><br><span class="line">1887</span><br><span class="line">1888</span><br><span class="line">1889</span><br><span class="line">1890</span><br><span class="line">1891</span><br><span class="line">1892</span><br><span class="line">1893</span><br><span class="line">1894</span><br><span class="line">1895</span><br><span class="line">1896</span><br><span class="line">1897</span><br><span class="line">1898</span><br><span class="line">1899</span><br><span class="line">1900</span><br><span class="line">1901</span><br><span class="line">1902</span><br><span class="line">1903</span><br><span class="line">1904</span><br><span class="line">1905</span><br><span class="line">1906</span><br><span class="line">1907</span><br><span class="line">1908</span><br><span class="line">1909</span><br><span class="line">1910</span><br><span class="line">1911</span><br><span class="line">1912</span><br><span class="line">1913</span><br><span class="line">1914</span><br><span class="line">1915</span><br><span class="line">1916</span><br><span class="line">1917</span><br><span class="line">1918</span><br><span class="line">1919</span><br><span class="line">1920</span><br><span class="line">1921</span><br><span class="line">1922</span><br><span class="line">1923</span><br><span class="line">1924</span><br><span class="line">1925</span><br><span class="line">1926</span><br><span class="line">1927</span><br><span class="line">1928</span><br><span class="line">1929</span><br><span class="line">1930</span><br><span class="line">1931</span><br><span class="line">1932</span><br><span class="line">1933</span><br><span class="line">1934</span><br><span class="line">1935</span><br><span class="line">1936</span><br><span class="line">1937</span><br><span class="line">1938</span><br><span class="line">1939</span><br><span class="line">1940</span><br><span class="line">1941</span><br><span class="line">1942</span><br><span class="line">1943</span><br><span class="line">1944</span><br><span class="line">1945</span><br><span class="line">1946</span><br><span class="line">1947</span><br><span class="line">1948</span><br><span class="line">1949</span><br><span class="line">1950</span><br><span class="line">1951</span><br><span class="line">1952</span><br><span class="line">1953</span><br><span class="line">1954</span><br><span class="line">1955</span><br><span class="line">1956</span><br><span class="line">1957</span><br><span class="line">1958</span><br><span class="line">1959</span><br><span class="line">1960</span><br><span class="line">1961</span><br><span class="line">1962</span><br><span class="line">1963</span><br><span class="line">1964</span><br><span class="line">1965</span><br><span class="line">1966</span><br><span class="line">1967</span><br><span class="line">1968</span><br><span class="line">1969</span><br><span class="line">1970</span><br><span class="line">1971</span><br><span class="line">1972</span><br><span class="line">1973</span><br><span class="line">1974</span><br><span class="line">1975</span><br><span class="line">1976</span><br><span class="line">1977</span><br><span class="line">1978</span><br><span class="line">1979</span><br><span class="line">1980</span><br><span class="line">1981</span><br><span class="line">1982</span><br><span class="line">1983</span><br><span class="line">1984</span><br><span class="line">1985</span><br><span class="line">1986</span><br><span class="line">1987</span><br><span class="line">1988</span><br><span class="line">1989</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line">1995</span><br><span class="line">1996</span><br><span class="line">1997</span><br><span class="line">1998</span><br><span class="line">1999</span><br><span class="line">2000</span><br><span class="line">2001</span><br><span class="line">2002</span><br><span class="line">2003</span><br><span class="line">2004</span><br><span class="line">2005</span><br><span class="line">2006</span><br><span class="line">2007</span><br><span class="line">2008</span><br><span class="line">2009</span><br><span class="line">2010</span><br><span class="line">2011</span><br><span class="line">2012</span><br><span class="line">2013</span><br><span class="line">2014</span><br><span class="line">2015</span><br><span class="line">2016</span><br><span class="line">2017</span><br><span class="line">2018</span><br><span class="line">2019</span><br><span class="line">2020</span><br><span class="line">2021</span><br><span class="line">2022</span><br><span class="line">2023</span><br><span class="line">2024</span><br><span class="line">2025</span><br><span class="line">2026</span><br><span class="line">2027</span><br><span class="line">2028</span><br><span class="line">2029</span><br><span class="line">2030</span><br><span class="line">2031</span><br><span class="line">2032</span><br><span class="line">2033</span><br><span class="line">2034</span><br><span class="line">2035</span><br><span class="line">2036</span><br><span class="line">2037</span><br><span class="line">2038</span><br><span class="line">2039</span><br><span class="line">2040</span><br><span class="line">2041</span><br><span class="line">2042</span><br><span class="line">2043</span><br><span class="line">2044</span><br><span class="line">2045</span><br><span class="line">2046</span><br><span class="line">2047</span><br><span class="line">2048</span><br><span class="line">2049</span><br><span class="line">2050</span><br><span class="line">2051</span><br><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br><span class="line">2056</span><br><span class="line">2057</span><br><span class="line">2058</span><br><span class="line">2059</span><br><span class="line">2060</span><br><span class="line">2061</span><br><span class="line">2062</span><br><span class="line">2063</span><br><span class="line">2064</span><br><span class="line">2065</span><br><span class="line">2066</span><br><span class="line">2067</span><br><span class="line">2068</span><br><span class="line">2069</span><br><span class="line">2070</span><br><span class="line">2071</span><br><span class="line">2072</span><br><span class="line">2073</span><br><span class="line">2074</span><br><span class="line">2075</span><br><span class="line">2076</span><br><span class="line">2077</span><br><span class="line">2078</span><br><span class="line">2079</span><br><span class="line">2080</span><br><span class="line">2081</span><br><span class="line">2082</span><br><span class="line">2083</span><br><span class="line">2084</span><br><span class="line">2085</span><br><span class="line">2086</span><br><span class="line">2087</span><br><span class="line">2088</span><br><span class="line">2089</span><br><span class="line">2090</span><br><span class="line">2091</span><br><span class="line">2092</span><br><span class="line">2093</span><br><span class="line">2094</span><br><span class="line">2095</span><br><span class="line">2096</span><br><span class="line">2097</span><br><span class="line">2098</span><br><span class="line">2099</span><br><span class="line">2100</span><br><span class="line">2101</span><br><span class="line">2102</span><br><span class="line">2103</span><br><span class="line">2104</span><br><span class="line">2105</span><br><span class="line">2106</span><br><span class="line">2107</span><br><span class="line">2108</span><br><span class="line">2109</span><br><span class="line">2110</span><br><span class="line">2111</span><br><span class="line">2112</span><br><span class="line">2113</span><br><span class="line">2114</span><br><span class="line">2115</span><br><span class="line">2116</span><br><span class="line">2117</span><br><span class="line">2118</span><br><span class="line">2119</span><br><span class="line">2120</span><br><span class="line">2121</span><br><span class="line">2122</span><br><span class="line">2123</span><br><span class="line">2124</span><br><span class="line">2125</span><br><span class="line">2126</span><br><span class="line">2127</span><br><span class="line">2128</span><br><span class="line">2129</span><br><span class="line">2130</span><br><span class="line">2131</span><br><span class="line">2132</span><br><span class="line">2133</span><br><span class="line">2134</span><br><span class="line">2135</span><br><span class="line">2136</span><br><span class="line">2137</span><br><span class="line">2138</span><br><span class="line">2139</span><br><span class="line">2140</span><br><span class="line">2141</span><br><span class="line">2142</span><br><span class="line">2143</span><br><span class="line">2144</span><br><span class="line">2145</span><br><span class="line">2146</span><br><span class="line">2147</span><br><span class="line">2148</span><br><span class="line">2149</span><br><span class="line">2150</span><br><span class="line">2151</span><br><span class="line">2152</span><br><span class="line">2153</span><br><span class="line">2154</span><br><span class="line">2155</span><br><span class="line">2156</span><br><span class="line">2157</span><br><span class="line">2158</span><br><span class="line">2159</span><br><span class="line">2160</span><br><span class="line">2161</span><br><span class="line">2162</span><br><span class="line">2163</span><br><span class="line">2164</span><br><span class="line">2165</span><br><span class="line">2166</span><br><span class="line">2167</span><br><span class="line">2168</span><br><span class="line">2169</span><br><span class="line">2170</span><br><span class="line">2171</span><br><span class="line">2172</span><br><span class="line">2173</span><br><span class="line">2174</span><br><span class="line">2175</span><br><span class="line">2176</span><br><span class="line">2177</span><br><span class="line">2178</span><br><span class="line">2179</span><br><span class="line">2180</span><br><span class="line">2181</span><br><span class="line">2182</span><br><span class="line">2183</span><br><span class="line">2184</span><br><span class="line">2185</span><br><span class="line">2186</span><br><span class="line">2187</span><br><span class="line">2188</span><br><span class="line">2189</span><br><span class="line">2190</span><br><span class="line">2191</span><br><span class="line">2192</span><br><span class="line">2193</span><br><span class="line">2194</span><br><span class="line">2195</span><br><span class="line">2196</span><br><span class="line">2197</span><br><span class="line">2198</span><br><span class="line">2199</span><br><span class="line">2200</span><br><span class="line">2201</span><br><span class="line">2202</span><br><span class="line">2203</span><br><span class="line">2204</span><br><span class="line">2205</span><br><span class="line">2206</span><br><span class="line">2207</span><br><span class="line">2208</span><br><span class="line">2209</span><br><span class="line">2210</span><br><span class="line">2211</span><br><span class="line">2212</span><br><span class="line">2213</span><br><span class="line">2214</span><br><span class="line">2215</span><br><span class="line">2216</span><br><span class="line">2217</span><br><span class="line">2218</span><br><span class="line">2219</span><br><span class="line">2220</span><br><span class="line">2221</span><br><span class="line">2222</span><br><span class="line">2223</span><br><span class="line">2224</span><br><span class="line">2225</span><br><span class="line">2226</span><br><span class="line">2227</span><br><span class="line">2228</span><br><span class="line">2229</span><br><span class="line">2230</span><br><span class="line">2231</span><br><span class="line">2232</span><br><span class="line">2233</span><br><span class="line">2234</span><br><span class="line">2235</span><br><span class="line">2236</span><br><span class="line">2237</span><br><span class="line">2238</span><br><span class="line">2239</span><br><span class="line">2240</span><br><span class="line">2241</span><br><span class="line">2242</span><br><span class="line">2243</span><br><span class="line">2244</span><br><span class="line">2245</span><br><span class="line">2246</span><br><span class="line">2247</span><br><span class="line">2248</span><br><span class="line">2249</span><br><span class="line">2250</span><br><span class="line">2251</span><br><span class="line">2252</span><br><span class="line">2253</span><br><span class="line">2254</span><br><span class="line">2255</span><br><span class="line">2256</span><br><span class="line">2257</span><br><span class="line">2258</span><br><span class="line">2259</span><br><span class="line">2260</span><br><span class="line">2261</span><br><span class="line">2262</span><br><span class="line">2263</span><br><span class="line">2264</span><br><span class="line">2265</span><br><span class="line">2266</span><br><span class="line">2267</span><br><span class="line">2268</span><br><span class="line">2269</span><br><span class="line">2270</span><br><span class="line">2271</span><br><span class="line">2272</span><br><span class="line">2273</span><br><span class="line">2274</span><br><span class="line">2275</span><br><span class="line">2276</span><br><span class="line">2277</span><br><span class="line">2278</span><br><span class="line">2279</span><br><span class="line">2280</span><br><span class="line">2281</span><br><span class="line">2282</span><br><span class="line">2283</span><br><span class="line">2284</span><br><span class="line">2285</span><br><span class="line">2286</span><br><span class="line">2287</span><br><span class="line">2288</span><br><span class="line">2289</span><br><span class="line">2290</span><br><span class="line">2291</span><br><span class="line">2292</span><br><span class="line">2293</span><br><span class="line">2294</span><br><span class="line">2295</span><br><span class="line">2296</span><br><span class="line">2297</span><br><span class="line">2298</span><br><span class="line">2299</span><br><span class="line">2300</span><br><span class="line">2301</span><br><span class="line">2302</span><br><span class="line">2303</span><br><span class="line">2304</span><br><span class="line">2305</span><br><span class="line">2306</span><br><span class="line">2307</span><br><span class="line">2308</span><br><span class="line">2309</span><br><span class="line">2310</span><br><span class="line">2311</span><br><span class="line">2312</span><br><span class="line">2313</span><br><span class="line">2314</span><br><span class="line">2315</span><br><span class="line">2316</span><br><span class="line">2317</span><br><span class="line">2318</span><br><span class="line">2319</span><br><span class="line">2320</span><br><span class="line">2321</span><br><span class="line">2322</span><br><span class="line">2323</span><br><span class="line">2324</span><br><span class="line">2325</span><br><span class="line">2326</span><br><span class="line">2327</span><br><span class="line">2328</span><br><span class="line">2329</span><br><span class="line">2330</span><br><span class="line">2331</span><br><span class="line">2332</span><br><span class="line">2333</span><br><span class="line">2334</span><br><span class="line">2335</span><br><span class="line">2336</span><br><span class="line">2337</span><br><span class="line">2338</span><br><span class="line">2339</span><br><span class="line">2340</span><br><span class="line">2341</span><br><span class="line">2342</span><br><span class="line">2343</span><br><span class="line">2344</span><br><span class="line">2345</span><br><span class="line">2346</span><br><span class="line">2347</span><br><span class="line">2348</span><br><span class="line">2349</span><br><span class="line">2350</span><br><span class="line">2351</span><br><span class="line">2352</span><br><span class="line">2353</span><br><span class="line">2354</span><br><span class="line">2355</span><br><span class="line">2356</span><br><span class="line">2357</span><br><span class="line">2358</span><br><span class="line">2359</span><br><span class="line">2360</span><br><span class="line">2361</span><br><span class="line">2362</span><br><span class="line">2363</span><br><span class="line">2364</span><br><span class="line">2365</span><br><span class="line">2366</span><br><span class="line">2367</span><br><span class="line">2368</span><br><span class="line">2369</span><br><span class="line">2370</span><br><span class="line">2371</span><br><span class="line">2372</span><br><span class="line">2373</span><br><span class="line">2374</span><br><span class="line">2375</span><br><span class="line">2376</span><br><span class="line">2377</span><br><span class="line">2378</span><br><span class="line">2379</span><br><span class="line">2380</span><br><span class="line">2381</span><br><span class="line">2382</span><br><span class="line">2383</span><br><span class="line">2384</span><br><span class="line">2385</span><br><span class="line">2386</span><br><span class="line">2387</span><br><span class="line">2388</span><br><span class="line">2389</span><br><span class="line">2390</span><br><span class="line">2391</span><br><span class="line">2392</span><br><span class="line">2393</span><br><span class="line">2394</span><br><span class="line">2395</span><br><span class="line">2396</span><br><span class="line">2397</span><br><span class="line">2398</span><br><span class="line">2399</span><br><span class="line">2400</span><br><span class="line">2401</span><br><span class="line">2402</span><br><span class="line">2403</span><br><span class="line">2404</span><br><span class="line">2405</span><br><span class="line">2406</span><br><span class="line">2407</span><br><span class="line">2408</span><br><span class="line">2409</span><br><span class="line">2410</span><br><span class="line">2411</span><br><span class="line">2412</span><br><span class="line">2413</span><br><span class="line">2414</span><br><span class="line">2415</span><br><span class="line">2416</span><br><span class="line">2417</span><br><span class="line">2418</span><br><span class="line">2419</span><br><span class="line">2420</span><br><span class="line">2421</span><br><span class="line">2422</span><br><span class="line">2423</span><br><span class="line">2424</span><br><span class="line">2425</span><br><span class="line">2426</span><br><span class="line">2427</span><br><span class="line">2428</span><br><span class="line">2429</span><br><span class="line">2430</span><br><span class="line">2431</span><br><span class="line">2432</span><br><span class="line">2433</span><br><span class="line">2434</span><br><span class="line">2435</span><br><span class="line">2436</span><br><span class="line">2437</span><br><span class="line">2438</span><br><span class="line">2439</span><br><span class="line">2440</span><br><span class="line">2441</span><br><span class="line">2442</span><br><span class="line">2443</span><br><span class="line">2444</span><br><span class="line">2445</span><br><span class="line">2446</span><br><span class="line">2447</span><br><span class="line">2448</span><br><span class="line">2449</span><br><span class="line">2450</span><br><span class="line">2451</span><br><span class="line">2452</span><br><span class="line">2453</span><br><span class="line">2454</span><br><span class="line">2455</span><br><span class="line">2456</span><br><span class="line">2457</span><br><span class="line">2458</span><br><span class="line">2459</span><br><span class="line">2460</span><br><span class="line">2461</span><br><span class="line">2462</span><br><span class="line">2463</span><br><span class="line">2464</span><br><span class="line">2465</span><br><span class="line">2466</span><br><span class="line">2467</span><br><span class="line">2468</span><br><span class="line">2469</span><br><span class="line">2470</span><br><span class="line">2471</span><br><span class="line">2472</span><br><span class="line">2473</span><br><span class="line">2474</span><br><span class="line">2475</span><br><span class="line">2476</span><br><span class="line">2477</span><br><span class="line">2478</span><br><span class="line">2479</span><br><span class="line">2480</span><br><span class="line">2481</span><br><span class="line">2482</span><br><span class="line">2483</span><br><span class="line">2484</span><br><span class="line">2485</span><br><span class="line">2486</span><br><span class="line">2487</span><br><span class="line">2488</span><br><span class="line">2489</span><br><span class="line">2490</span><br><span class="line">2491</span><br><span class="line">2492</span><br><span class="line">2493</span><br><span class="line">2494</span><br><span class="line">2495</span><br><span class="line">2496</span><br><span class="line">2497</span><br><span class="line">2498</span><br><span class="line">2499</span><br><span class="line">2500</span><br><span class="line">2501</span><br><span class="line">2502</span><br><span class="line">2503</span><br><span class="line">2504</span><br><span class="line">2505</span><br><span class="line">2506</span><br><span class="line">2507</span><br><span class="line">2508</span><br><span class="line">2509</span><br><span class="line">2510</span><br><span class="line">2511</span><br><span class="line">2512</span><br><span class="line">2513</span><br><span class="line">2514</span><br><span class="line">2515</span><br><span class="line">2516</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDataInfo</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">MyDataInfo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAllExtensions</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      com.google.protobuf.ExtensionRegistryLite registry)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAllExtensions</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      com.google.protobuf.ExtensionRegistry registry)</span> </span>&#123;</span><br><span class="line">    registerAllExtensions(</span><br><span class="line">        (com.google.protobuf.ExtensionRegistryLite) registry);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyMessageOrBuilder</span> <span class="keyword">extends</span></span></span><br><span class="line">      // @@protoc_insertion_point(interface_extends:MyMessage)</span><br><span class="line">      com.google.protobuf.MessageOrBuilder &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getDataTypeValue</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    MyMessage.<span class="function">DataType <span class="title">getDataType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasStudent</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Student <span class="title">getStudent</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">StudentOrBuilder <span class="title">getStudentOrBuilder</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasWorker</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Worker <span class="title">getWorker</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">WorkerOrBuilder <span class="title">getWorkerOrBuilder</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MyMessage.<span class="function">DataBodyCase <span class="title">getDataBodyCase</span><span class="params">()</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">   *protobuf 可以使用message 管理其他的message</span></span><br><span class="line"><span class="comment">   * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Protobuf type &#123;<span class="doctag">@code</span> MyMessage&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">      <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span> <span class="keyword">implements</span></span></span><br><span class="line">      // @@protoc_insertion_point(message_implements:MyMessage)</span><br><span class="line">      MyMessageOrBuilder &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// Use MyMessage.newBuilder() to construct.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MyMessage</span><span class="params">(com.google.protobuf.GeneratedMessageV3.Builder&lt;?&gt; builder)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(builder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MyMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      dataType_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet</span><br><span class="line">    getUnknownFields() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.unknownFields;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MyMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>();</span><br><span class="line">      <span class="keyword">if</span> (extensionRegistry == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> mutable_bitField0_ = <span class="number">0</span>;</span><br><span class="line">      com.google.protobuf.UnknownFieldSet.Builder unknownFields =</span><br><span class="line">          com.google.protobuf.UnknownFieldSet.newBuilder();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">          <span class="keyword">int</span> tag = input.readTag();</span><br><span class="line">          <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">              done = <span class="keyword">true</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: &#123;</span><br><span class="line">              <span class="keyword">int</span> rawValue = input.readEnum();</span><br><span class="line"></span><br><span class="line">              dataType_ = rawValue;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>: &#123;</span><br><span class="line">              Student.Builder subBuilder = <span class="keyword">null</span>;</span><br><span class="line">              <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">                subBuilder = ((Student) dataBody_).toBuilder();</span><br><span class="line">              &#125;</span><br><span class="line">              dataBody_ =</span><br><span class="line">                  input.readMessage(Student.parser(), extensionRegistry);</span><br><span class="line">              <span class="keyword">if</span> (subBuilder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                subBuilder.mergeFrom((Student) dataBody_);</span><br><span class="line">                dataBody_ = subBuilder.buildPartial();</span><br><span class="line">              &#125;</span><br><span class="line">              dataBodyCase_ = <span class="number">2</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">26</span>: &#123;</span><br><span class="line">              Worker.Builder subBuilder = <span class="keyword">null</span>;</span><br><span class="line">              <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">                subBuilder = ((Worker) dataBody_).toBuilder();</span><br><span class="line">              &#125;</span><br><span class="line">              dataBody_ =</span><br><span class="line">                  input.readMessage(Worker.parser(), extensionRegistry);</span><br><span class="line">              <span class="keyword">if</span> (subBuilder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                subBuilder.mergeFrom((Worker) dataBody_);</span><br><span class="line">                dataBody_ = subBuilder.buildPartial();</span><br><span class="line">              &#125;</span><br><span class="line">              dataBodyCase_ = <span class="number">3</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">              <span class="keyword">if</span> (!parseUnknownFieldProto3(</span><br><span class="line">                  input, unknownFields, extensionRegistry, tag)) &#123;</span><br><span class="line">                done = <span class="keyword">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.setUnfinishedMessage(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> com.google.protobuf.InvalidProtocolBufferException(</span><br><span class="line">            e).setUnfinishedMessage(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.unknownFields = unknownFields.build();</span><br><span class="line">        makeExtensionsImmutable();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">        getDescriptor() &#123;</span><br><span class="line">      <span class="keyword">return</span> MyDataInfo.internal_static_MyMessage_descriptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> FieldAccessorTable</span><br><span class="line">        internalGetFieldAccessorTable() &#123;</span><br><span class="line">      <span class="keyword">return</span> MyDataInfo.internal_static_MyMessage_fieldAccessorTable</span><br><span class="line">          .ensureFieldAccessorsInitialized(</span><br><span class="line">              MyMessage<span class="class">.<span class="keyword">class</span>, <span class="title">Builder</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *定义一个枚举类型</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Protobuf enum &#123;<span class="doctag">@code</span> MyMessage.DataType&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> DataType</span><br><span class="line">        implements com.google.protobuf.ProtocolMessageEnum &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *在proto3 要求enum的编号从0开始</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;StudentType = 0;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      StudentType(<span class="number">0</span>),</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;WorkerType = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      WorkerType(<span class="number">1</span>),</span><br><span class="line">      UNRECOGNIZED(-<span class="number">1</span>),</span><br><span class="line">      ;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *在proto3 要求enum的编号从0开始</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;StudentType = 0;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> StudentType_VALUE = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;WorkerType = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WorkerType_VALUE = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == UNRECOGNIZED) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">              <span class="string">"Can't get the number of an unknown enum value."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@deprecated</span> Use &#123;<span class="doctag">@link</span> #forNumber(int)&#125; instead.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="meta">@Deprecated</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataType <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> forNumber(value);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataType <span class="title">forNumber</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (value) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> StudentType;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> WorkerType;</span><br><span class="line">          <span class="keyword">default</span>: <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> com.google.protobuf.Internal.EnumLiteMap&lt;DataType&gt;</span><br><span class="line">          internalGetValueMap() &#123;</span><br><span class="line">        <span class="keyword">return</span> internalValueMap;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Internal.EnumLiteMap&lt;</span><br><span class="line">          DataType&gt; internalValueMap =</span><br><span class="line">            <span class="keyword">new</span> com.google.protobuf.Internal.EnumLiteMap&lt;DataType&gt;() &#123;</span><br><span class="line">              <span class="function"><span class="keyword">public</span> DataType <span class="title">findValueByNumber</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> DataType.forNumber(number);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.EnumValueDescriptor</span><br><span class="line">          getValueDescriptor() &#123;</span><br><span class="line">        <span class="keyword">return</span> getDescriptor().getValues().get(ordinal());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.EnumDescriptor</span><br><span class="line">          getDescriptorForType() &#123;</span><br><span class="line">        <span class="keyword">return</span> getDescriptor();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.EnumDescriptor</span><br><span class="line">          getDescriptor() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyMessage.getDescriptor().getEnumTypes().get(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DataType[] VALUES = values();</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataType <span class="title">valueOf</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.EnumValueDescriptor desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (desc.getType() != getDescriptor()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">            <span class="string">"EnumValueDescriptor is not for this type."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (desc.getIndex() == -<span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> UNRECOGNIZED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> VALUES[desc.getIndex()];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">DataType</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// @@protoc_insertion_point(enum_scope:MyMessage.DataType)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> dataBodyCase_ = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Object dataBody_;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> DataBodyCase</span><br><span class="line">        implements com.google.protobuf.Internal.EnumLite &#123;</span><br><span class="line">      STUDENT(<span class="number">2</span>),</span><br><span class="line">      WORKER(<span class="number">3</span>),</span><br><span class="line">      DATABODY_NOT_SET(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">DataBodyCase</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@deprecated</span> Use &#123;<span class="doctag">@link</span> #forNumber(int)&#125; instead.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="meta">@Deprecated</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataBodyCase <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> forNumber(value);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataBodyCase <span class="title">forNumber</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (value) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">2</span>: <span class="keyword">return</span> STUDENT;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">3</span>: <span class="keyword">return</span> WORKER;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> DATABODY_NOT_SET;</span><br><span class="line">          <span class="keyword">default</span>: <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DataBodyCase</span><br><span class="line">    getDataBodyCase() &#123;</span><br><span class="line">      <span class="keyword">return</span> DataBodyCase.forNumber(</span><br><span class="line">          dataBodyCase_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATA_TYPE_FIELD_NUMBER = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> dataType_;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDataTypeValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> dataType_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataType <span class="title">getDataType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">      DataType result = DataType.valueOf(dataType_);</span><br><span class="line">      <span class="keyword">return</span> result == <span class="keyword">null</span> ? DataType.UNRECOGNIZED : result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STUDENT_FIELD_NUMBER = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasStudent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> dataBodyCase_ == <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Student <span class="title">getStudent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> (Student) dataBody_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Student.getDefaultInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StudentOrBuilder <span class="title">getStudentOrBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> (Student) dataBody_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Student.getDefaultInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WORKER_FIELD_NUMBER = <span class="number">3</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> dataBodyCase_ == <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Worker <span class="title">getWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> (Worker) dataBody_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Worker.getDefaultInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WorkerOrBuilder <span class="title">getWorkerOrBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> (Worker) dataBody_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Worker.getDefaultInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> memoizedIsInitialized = -<span class="number">1</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">byte</span> isInitialized = memoizedIsInitialized;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized == <span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">      memoizedIsInitialized = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(com.google.protobuf.CodedOutputStream output)</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (dataType_ != DataType.StudentType.getNumber()) &#123;</span><br><span class="line">        output.writeEnum(<span class="number">1</span>, dataType_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">        output.writeMessage(<span class="number">2</span>, (Student) dataBody_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">        output.writeMessage(<span class="number">3</span>, (Worker) dataBody_);</span><br><span class="line">      &#125;</span><br><span class="line">      unknownFields.writeTo(output);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSerializedSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> size = memoizedSize;</span><br><span class="line">      <span class="keyword">if</span> (size != -<span class="number">1</span>) <span class="keyword">return</span> size;</span><br><span class="line"></span><br><span class="line">      size = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (dataType_ != DataType.StudentType.getNumber()) &#123;</span><br><span class="line">        size += com.google.protobuf.CodedOutputStream</span><br><span class="line">          .computeEnumSize(<span class="number">1</span>, dataType_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">        size += com.google.protobuf.CodedOutputStream</span><br><span class="line">          .computeMessageSize(<span class="number">2</span>, (Student) dataBody_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">        size += com.google.protobuf.CodedOutputStream</span><br><span class="line">          .computeMessageSize(<span class="number">3</span>, (Worker) dataBody_);</span><br><span class="line">      &#125;</span><br><span class="line">      size += unknownFields.getSerializedSize();</span><br><span class="line">      memoizedSize = size;</span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(<span class="keyword">final</span> Object obj)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> MyMessage)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.equals(obj);</span><br><span class="line">      &#125;</span><br><span class="line">      MyMessage other = (MyMessage) obj;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">      result = result &amp;&amp; dataType_ == other.dataType_;</span><br><span class="line">      result = result &amp;&amp; getDataBodyCase().equals(</span><br><span class="line">          other.getDataBodyCase());</span><br><span class="line">      <span class="keyword">if</span> (!result) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">switch</span> (dataBodyCase_) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          result = result &amp;&amp; getStudent()</span><br><span class="line">              .equals(other.getStudent());</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          result = result &amp;&amp; getWorker()</span><br><span class="line">              .equals(other.getWorker());</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line">      result = result &amp;&amp; unknownFields.equals(other.unknownFields);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (memoizedHashCode != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> memoizedHashCode;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> hash = <span class="number">41</span>;</span><br><span class="line">      hash = (<span class="number">19</span> * hash) + getDescriptor().hashCode();</span><br><span class="line">      hash = (<span class="number">37</span> * hash) + DATA_TYPE_FIELD_NUMBER;</span><br><span class="line">      hash = (<span class="number">53</span> * hash) + dataType_;</span><br><span class="line">      <span class="keyword">switch</span> (dataBodyCase_) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          hash = (<span class="number">37</span> * hash) + STUDENT_FIELD_NUMBER;</span><br><span class="line">          hash = (<span class="number">53</span> * hash) + getStudent().hashCode();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          hash = (<span class="number">37</span> * hash) + WORKER_FIELD_NUMBER;</span><br><span class="line">          hash = (<span class="number">53</span> * hash) + getWorker().hashCode();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line">      hash = (<span class="number">29</span> * hash) + unknownFields.hashCode();</span><br><span class="line">      memoizedHashCode = hash;</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.nio.ByteBuffer data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.nio.ByteBuffer data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ByteString data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ByteString data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(<span class="keyword">byte</span>[] data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">byte</span>[] data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(java.io.InputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.io.InputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseDelimitedFrom</span><span class="params">(java.io.InputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseDelimitedWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseDelimitedFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.io.InputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseDelimitedWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">newBuilderForType</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> newBuilder(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE.toBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">(MyMessage prototype)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE.toBuilder().mergeFrom(prototype);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">toBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span> == DEFAULT_INSTANCE</span><br><span class="line">          ? <span class="keyword">new</span> Builder() : <span class="keyword">new</span> Builder().mergeFrom(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Builder <span class="title">newBuilderForType</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        BuilderParent parent)</span> </span>&#123;</span><br><span class="line">      Builder builder = <span class="keyword">new</span> Builder(parent);</span><br><span class="line">      <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *protobuf 可以使用message 管理其他的message</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Protobuf type &#123;<span class="doctag">@code</span> MyMessage&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">        <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span>.<span class="title">Builder</span>&lt;<span class="title">Builder</span>&gt; <span class="keyword">implements</span></span></span><br><span class="line">        // @@protoc_insertion_point(builder_implements:MyMessage)</span><br><span class="line">        MyMessageOrBuilder &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">          getDescriptor() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_MyMessage_descriptor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">protected</span> FieldAccessorTable</span><br><span class="line">          internalGetFieldAccessorTable() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_MyMessage_fieldAccessorTable</span><br><span class="line">            .ensureFieldAccessorsInitialized(</span><br><span class="line">                MyMessage<span class="class">.<span class="keyword">class</span>, <span class="title">Builder</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Construct using com.atguigu.netty.codec2.MyDataInfo.MyMessage.newBuilder()</span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        maybeForceBuilderInitialization();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          BuilderParent parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        maybeForceBuilderInitialization();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeForceBuilderInitialization</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (com.google.protobuf.GeneratedMessageV3</span><br><span class="line">                .alwaysUseFieldBuilders) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.clear();</span><br><span class="line">        dataType_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        dataBodyCase_ = <span class="number">0</span>;</span><br><span class="line">        dataBody_ = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">          getDescriptorForType() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_MyMessage_descriptor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> MyMessage <span class="title">getDefaultInstanceForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyMessage.getDefaultInstance();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> MyMessage <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyMessage result = buildPartial();</span><br><span class="line">        <span class="keyword">if</span> (!result.isInitialized()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> newUninitializedMessageException(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> MyMessage <span class="title">buildPartial</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyMessage result = <span class="keyword">new</span> MyMessage(<span class="keyword">this</span>);</span><br><span class="line">        result.dataType_ = dataType_;</span><br><span class="line">        <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (studentBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.dataBody_ = dataBody_;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.dataBody_ = studentBuilder_.build();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (workerBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.dataBody_ = dataBody_;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.dataBody_ = workerBuilder_.build();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        result.dataBodyCase_ = dataBodyCase_;</span><br><span class="line">        onBuilt();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clone();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.setField(field, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clearField(field);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearOneof</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.OneofDescriptor oneof)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clearOneof(oneof);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setRepeatedField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> index, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.setRepeatedField(field, index, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">addRepeatedField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.addRepeatedField(field, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(com.google.protobuf.Message other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other <span class="keyword">instanceof</span> MyMessage) &#123;</span><br><span class="line">          <span class="keyword">return</span> mergeFrom((MyMessage)other);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">super</span>.mergeFrom(other);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(MyMessage other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other == MyMessage.getDefaultInstance()) <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (other.dataType_ != <span class="number">0</span>) &#123;</span><br><span class="line">          setDataTypeValue(other.getDataTypeValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (other.getDataBodyCase()) &#123;</span><br><span class="line">          <span class="keyword">case</span> STUDENT: &#123;</span><br><span class="line">            mergeStudent(other.getStudent());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> WORKER: &#123;</span><br><span class="line">            mergeWorker(other.getWorker());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> DATABODY_NOT_SET: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.mergeUnknownFields(other.unknownFields);</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        MyMessage parsedMessage = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          parsedMessage = PARSER.parsePartialFrom(input, extensionRegistry);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">          parsedMessage = (MyMessage) e.getUnfinishedMessage();</span><br><span class="line">          <span class="keyword">throw</span> e.unwrapIOException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (parsedMessage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mergeFrom(parsedMessage);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> dataBodyCase_ = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">private</span> Object dataBody_;</span><br><span class="line">      <span class="keyword">public</span> DataBodyCase</span><br><span class="line">          getDataBodyCase() &#123;</span><br><span class="line">        <span class="keyword">return</span> DataBodyCase.forNumber(</span><br><span class="line">            dataBodyCase_);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearDataBody</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dataBodyCase_ = <span class="number">0</span>;</span><br><span class="line">        dataBody_ = <span class="keyword">null</span>;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> dataType_ = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDataTypeValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataType_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setDataTypeValue</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        dataType_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> DataType <span class="title">getDataType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">        DataType result = DataType.valueOf(dataType_);</span><br><span class="line">        <span class="keyword">return</span> result == <span class="keyword">null</span> ? DataType.UNRECOGNIZED : result;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setDataType</span><span class="params">(DataType value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        dataType_ = value.getNumber();</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *用data_type 来标识传的是哪一个枚举类型</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearDataType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        dataType_ = <span class="number">0</span>;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> com.google.protobuf.SingleFieldBuilderV3&lt;</span><br><span class="line">          Student, Student.Builder, StudentOrBuilder&gt; studentBuilder_;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasStudent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataBodyCase_ == <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">getStudent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (studentBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Student) dataBody_;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> Student.getDefaultInstance();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> studentBuilder_.getMessage();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> Student.getDefaultInstance();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setStudent</span><span class="params">(Student value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (studentBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">          &#125;</span><br><span class="line">          dataBody_ = value;</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          studentBuilder_.setMessage(value);</span><br><span class="line">        &#125;</span><br><span class="line">        dataBodyCase_ = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setStudent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          Student.Builder builderForValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (studentBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          dataBody_ = builderForValue.build();</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          studentBuilder_.setMessage(builderForValue.build());</span><br><span class="line">        &#125;</span><br><span class="line">        dataBodyCase_ = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeStudent</span><span class="params">(Student value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (studentBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span> &amp;&amp;</span><br><span class="line">              dataBody_ != Student.getDefaultInstance()) &#123;</span><br><span class="line">            dataBody_ = Student.newBuilder((Student) dataBody_)</span><br><span class="line">                .mergeFrom(value).buildPartial();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dataBody_ = value;</span><br><span class="line">          &#125;</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">            studentBuilder_.mergeFrom(value);</span><br><span class="line">          &#125;</span><br><span class="line">          studentBuilder_.setMessage(value);</span><br><span class="line">        &#125;</span><br><span class="line">        dataBodyCase_ = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearStudent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (studentBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">            dataBodyCase_ = <span class="number">0</span>;</span><br><span class="line">            dataBody_ = <span class="keyword">null</span>;</span><br><span class="line">            onChanged();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">            dataBodyCase_ = <span class="number">0</span>;</span><br><span class="line">            dataBody_ = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          studentBuilder_.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> Student.<span class="function">Builder <span class="title">getStudentBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getStudentFieldBuilder().getBuilder();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> StudentOrBuilder <span class="title">getStudentOrBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((dataBodyCase_ == <span class="number">2</span>) &amp;&amp; (studentBuilder_ != <span class="keyword">null</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> studentBuilder_.getMessageOrBuilder();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Student) dataBody_;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> Student.getDefaultInstance();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">private</span> com.google.protobuf.SingleFieldBuilderV3&lt;</span><br><span class="line">          Student, Student.Builder, StudentOrBuilder&gt;</span><br><span class="line">          getStudentFieldBuilder() &#123;</span><br><span class="line">        <span class="keyword">if</span> (studentBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(dataBodyCase_ == <span class="number">2</span>)) &#123;</span><br><span class="line">            dataBody_ = Student.getDefaultInstance();</span><br><span class="line">          &#125;</span><br><span class="line">          studentBuilder_ = <span class="keyword">new</span> com.google.protobuf.SingleFieldBuilderV3&lt;</span><br><span class="line">              Student, Student.Builder, StudentOrBuilder&gt;(</span><br><span class="line">                  (Student) dataBody_,</span><br><span class="line">                  getParentForChildren(),</span><br><span class="line">                  isClean());</span><br><span class="line">          dataBody_ = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        dataBodyCase_ = <span class="number">2</span>;</span><br><span class="line">        onChanged();;</span><br><span class="line">        <span class="keyword">return</span> studentBuilder_;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> com.google.protobuf.SingleFieldBuilderV3&lt;</span><br><span class="line">          Worker, Worker.Builder, WorkerOrBuilder&gt; workerBuilder_;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataBodyCase_ == <span class="number">3</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Worker <span class="title">getWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (workerBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Worker) dataBody_;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> Worker.getDefaultInstance();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> workerBuilder_.getMessage();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> Worker.getDefaultInstance();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setWorker</span><span class="params">(Worker value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (workerBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">          &#125;</span><br><span class="line">          dataBody_ = value;</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          workerBuilder_.setMessage(value);</span><br><span class="line">        &#125;</span><br><span class="line">        dataBodyCase_ = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setWorker</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          Worker.Builder builderForValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (workerBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          dataBody_ = builderForValue.build();</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          workerBuilder_.setMessage(builderForValue.build());</span><br><span class="line">        &#125;</span><br><span class="line">        dataBodyCase_ = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeWorker</span><span class="params">(Worker value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (workerBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span> &amp;&amp;</span><br><span class="line">              dataBody_ != Worker.getDefaultInstance()) &#123;</span><br><span class="line">            dataBody_ = Worker.newBuilder((Worker) dataBody_)</span><br><span class="line">                .mergeFrom(value).buildPartial();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dataBody_ = value;</span><br><span class="line">          &#125;</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">            workerBuilder_.mergeFrom(value);</span><br><span class="line">          &#125;</span><br><span class="line">          workerBuilder_.setMessage(value);</span><br><span class="line">        &#125;</span><br><span class="line">        dataBodyCase_ = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (workerBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">            dataBodyCase_ = <span class="number">0</span>;</span><br><span class="line">            dataBody_ = <span class="keyword">null</span>;</span><br><span class="line">            onChanged();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">            dataBodyCase_ = <span class="number">0</span>;</span><br><span class="line">            dataBody_ = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          workerBuilder_.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> Worker.<span class="function">Builder <span class="title">getWorkerBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getWorkerFieldBuilder().getBuilder();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> WorkerOrBuilder <span class="title">getWorkerOrBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((dataBodyCase_ == <span class="number">3</span>) &amp;&amp; (workerBuilder_ != <span class="keyword">null</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> workerBuilder_.getMessageOrBuilder();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (dataBodyCase_ == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Worker) dataBody_;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> Worker.getDefaultInstance();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">private</span> com.google.protobuf.SingleFieldBuilderV3&lt;</span><br><span class="line">          Worker, Worker.Builder, WorkerOrBuilder&gt;</span><br><span class="line">          getWorkerFieldBuilder() &#123;</span><br><span class="line">        <span class="keyword">if</span> (workerBuilder_ == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(dataBodyCase_ == <span class="number">3</span>)) &#123;</span><br><span class="line">            dataBody_ = Worker.getDefaultInstance();</span><br><span class="line">          &#125;</span><br><span class="line">          workerBuilder_ = <span class="keyword">new</span> com.google.protobuf.SingleFieldBuilderV3&lt;</span><br><span class="line">              Worker, Worker.Builder, WorkerOrBuilder&gt;(</span><br><span class="line">                  (Worker) dataBody_,</span><br><span class="line">                  getParentForChildren(),</span><br><span class="line">                  isClean());</span><br><span class="line">          dataBody_ = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        dataBodyCase_ = <span class="number">3</span>;</span><br><span class="line">        onChanged();;</span><br><span class="line">        <span class="keyword">return</span> workerBuilder_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Builder <span class="title">setUnknownFields</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet unknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.setUnknownFieldsProto3(unknownFields);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Builder <span class="title">mergeUnknownFields</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet unknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.mergeUnknownFields(unknownFields);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// @@protoc_insertion_point(builder_scope:MyMessage)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @@protoc_insertion_point(class_scope:MyMessage)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MyMessage DEFAULT_INSTANCE;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">      DEFAULT_INSTANCE = <span class="keyword">new</span> MyMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyMessage <span class="title">getDefaultInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Parser&lt;MyMessage&gt;</span><br><span class="line">        PARSER = <span class="keyword">new</span> com.google.protobuf.AbstractParser&lt;MyMessage&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> MyMessage <span class="title">parsePartialFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyMessage(input, extensionRegistry);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> com.google.protobuf.<span class="function">Parser&lt;MyMessage&gt; <span class="title">parser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> com.google.protobuf.<span class="function">Parser&lt;MyMessage&gt; <span class="title">getParserForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyMessage <span class="title">getDefaultInstanceForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentOrBuilder</span> <span class="keyword">extends</span></span></span><br><span class="line">      // @@protoc_insertion_point(interface_extends:Student)</span><br><span class="line">      com.google.protobuf.MessageOrBuilder &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *Student类的属性</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    com.google.protobuf.ByteString</span><br><span class="line">        getNameBytes();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Protobuf type &#123;<span class="doctag">@code</span> Student&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">      <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span> <span class="keyword">implements</span></span></span><br><span class="line">      // @@protoc_insertion_point(message_implements:Student)</span><br><span class="line">      StudentOrBuilder &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// Use Student.newBuilder() to construct.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Student</span><span class="params">(com.google.protobuf.GeneratedMessageV3.Builder&lt;?&gt; builder)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(builder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Student</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      id_ = <span class="number">0</span>;</span><br><span class="line">      name_ = <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet</span><br><span class="line">    getUnknownFields() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.unknownFields;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Student</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>();</span><br><span class="line">      <span class="keyword">if</span> (extensionRegistry == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> mutable_bitField0_ = <span class="number">0</span>;</span><br><span class="line">      com.google.protobuf.UnknownFieldSet.Builder unknownFields =</span><br><span class="line">          com.google.protobuf.UnknownFieldSet.newBuilder();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">          <span class="keyword">int</span> tag = input.readTag();</span><br><span class="line">          <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">              done = <span class="keyword">true</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: &#123;</span><br><span class="line"></span><br><span class="line">              id_ = input.readInt32();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>: &#123;</span><br><span class="line">              String s = input.readStringRequireUtf8();</span><br><span class="line"></span><br><span class="line">              name_ = s;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">              <span class="keyword">if</span> (!parseUnknownFieldProto3(</span><br><span class="line">                  input, unknownFields, extensionRegistry, tag)) &#123;</span><br><span class="line">                done = <span class="keyword">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.setUnfinishedMessage(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> com.google.protobuf.InvalidProtocolBufferException(</span><br><span class="line">            e).setUnfinishedMessage(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.unknownFields = unknownFields.build();</span><br><span class="line">        makeExtensionsImmutable();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">        getDescriptor() &#123;</span><br><span class="line">      <span class="keyword">return</span> MyDataInfo.internal_static_Student_descriptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> FieldAccessorTable</span><br><span class="line">        internalGetFieldAccessorTable() &#123;</span><br><span class="line">      <span class="keyword">return</span> MyDataInfo.internal_static_Student_fieldAccessorTable</span><br><span class="line">          .ensureFieldAccessorsInitialized(</span><br><span class="line">              Student<span class="class">.<span class="keyword">class</span>, <span class="title">Builder</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ID_FIELD_NUMBER = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id_;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *Student类的属性</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> id_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NAME_FIELD_NUMBER = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Object name_;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Object ref = name_;</span><br><span class="line">      <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) ref;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        com.google.protobuf.ByteString bs = </span><br><span class="line">            (com.google.protobuf.ByteString) ref;</span><br><span class="line">        String s = bs.toStringUtf8();</span><br><span class="line">        name_ = s;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> com.google.protobuf.ByteString</span><br><span class="line">        getNameBytes() &#123;</span><br><span class="line">      Object ref = name_;</span><br><span class="line">      <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        com.google.protobuf.ByteString b = </span><br><span class="line">            com.google.protobuf.ByteString.copyFromUtf8(</span><br><span class="line">                (String) ref);</span><br><span class="line">        name_ = b;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (com.google.protobuf.ByteString) ref;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> memoizedIsInitialized = -<span class="number">1</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">byte</span> isInitialized = memoizedIsInitialized;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized == <span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">      memoizedIsInitialized = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(com.google.protobuf.CodedOutputStream output)</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (id_ != <span class="number">0</span>) &#123;</span><br><span class="line">        output.writeInt32(<span class="number">1</span>, id_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!getNameBytes().isEmpty()) &#123;</span><br><span class="line">        com.google.protobuf.GeneratedMessageV3.writeString(output, <span class="number">2</span>, name_);</span><br><span class="line">      &#125;</span><br><span class="line">      unknownFields.writeTo(output);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSerializedSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> size = memoizedSize;</span><br><span class="line">      <span class="keyword">if</span> (size != -<span class="number">1</span>) <span class="keyword">return</span> size;</span><br><span class="line"></span><br><span class="line">      size = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (id_ != <span class="number">0</span>) &#123;</span><br><span class="line">        size += com.google.protobuf.CodedOutputStream</span><br><span class="line">          .computeInt32Size(<span class="number">1</span>, id_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!getNameBytes().isEmpty()) &#123;</span><br><span class="line">        size += com.google.protobuf.GeneratedMessageV3.computeStringSize(<span class="number">2</span>, name_);</span><br><span class="line">      &#125;</span><br><span class="line">      size += unknownFields.getSerializedSize();</span><br><span class="line">      memoizedSize = size;</span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(<span class="keyword">final</span> Object obj)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Student)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.equals(obj);</span><br><span class="line">      &#125;</span><br><span class="line">      Student other = (Student) obj;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">      result = result &amp;&amp; (getId()</span><br><span class="line">          == other.getId());</span><br><span class="line">      result = result &amp;&amp; getName()</span><br><span class="line">          .equals(other.getName());</span><br><span class="line">      result = result &amp;&amp; unknownFields.equals(other.unknownFields);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (memoizedHashCode != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> memoizedHashCode;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> hash = <span class="number">41</span>;</span><br><span class="line">      hash = (<span class="number">19</span> * hash) + getDescriptor().hashCode();</span><br><span class="line">      hash = (<span class="number">37</span> * hash) + ID_FIELD_NUMBER;</span><br><span class="line">      hash = (<span class="number">53</span> * hash) + getId();</span><br><span class="line">      hash = (<span class="number">37</span> * hash) + NAME_FIELD_NUMBER;</span><br><span class="line">      hash = (<span class="number">53</span> * hash) + getName().hashCode();</span><br><span class="line">      hash = (<span class="number">29</span> * hash) + unknownFields.hashCode();</span><br><span class="line">      memoizedHashCode = hash;</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.nio.ByteBuffer data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.nio.ByteBuffer data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ByteString data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ByteString data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(<span class="keyword">byte</span>[] data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">byte</span>[] data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(java.io.InputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.io.InputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseDelimitedFrom</span><span class="params">(java.io.InputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseDelimitedWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseDelimitedFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.io.InputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseDelimitedWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">newBuilderForType</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> newBuilder(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE.toBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">(Student prototype)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE.toBuilder().mergeFrom(prototype);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">toBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span> == DEFAULT_INSTANCE</span><br><span class="line">          ? <span class="keyword">new</span> Builder() : <span class="keyword">new</span> Builder().mergeFrom(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Builder <span class="title">newBuilderForType</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        BuilderParent parent)</span> </span>&#123;</span><br><span class="line">      Builder builder = <span class="keyword">new</span> Builder(parent);</span><br><span class="line">      <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Protobuf type &#123;<span class="doctag">@code</span> Student&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">        <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span>.<span class="title">Builder</span>&lt;<span class="title">Builder</span>&gt; <span class="keyword">implements</span></span></span><br><span class="line">        // @@protoc_insertion_point(builder_implements:Student)</span><br><span class="line">        StudentOrBuilder &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">          getDescriptor() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_Student_descriptor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">protected</span> FieldAccessorTable</span><br><span class="line">          internalGetFieldAccessorTable() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_Student_fieldAccessorTable</span><br><span class="line">            .ensureFieldAccessorsInitialized(</span><br><span class="line">                Student<span class="class">.<span class="keyword">class</span>, <span class="title">Builder</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Construct using com.atguigu.netty.codec2.MyDataInfo.Student.newBuilder()</span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        maybeForceBuilderInitialization();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          BuilderParent parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        maybeForceBuilderInitialization();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeForceBuilderInitialization</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (com.google.protobuf.GeneratedMessageV3</span><br><span class="line">                .alwaysUseFieldBuilders) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.clear();</span><br><span class="line">        id_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        name_ = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">          getDescriptorForType() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_Student_descriptor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">getDefaultInstanceForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Student.getDefaultInstance();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Student result = buildPartial();</span><br><span class="line">        <span class="keyword">if</span> (!result.isInitialized()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> newUninitializedMessageException(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">buildPartial</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Student result = <span class="keyword">new</span> Student(<span class="keyword">this</span>);</span><br><span class="line">        result.id_ = id_;</span><br><span class="line">        result.name_ = name_;</span><br><span class="line">        onBuilt();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clone();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.setField(field, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clearField(field);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearOneof</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.OneofDescriptor oneof)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clearOneof(oneof);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setRepeatedField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> index, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.setRepeatedField(field, index, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">addRepeatedField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.addRepeatedField(field, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(com.google.protobuf.Message other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other <span class="keyword">instanceof</span> Student) &#123;</span><br><span class="line">          <span class="keyword">return</span> mergeFrom((Student)other);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">super</span>.mergeFrom(other);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(Student other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other == Student.getDefaultInstance()) <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (other.getId() != <span class="number">0</span>) &#123;</span><br><span class="line">          setId(other.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!other.getName().isEmpty()) &#123;</span><br><span class="line">          name_ = other.name_;</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.mergeUnknownFields(other.unknownFields);</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        Student parsedMessage = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          parsedMessage = PARSER.parsePartialFrom(input, extensionRegistry);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">          parsedMessage = (Student) e.getUnfinishedMessage();</span><br><span class="line">          <span class="keyword">throw</span> e.unwrapIOException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (parsedMessage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mergeFrom(parsedMessage);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> id_ ;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *Student类的属性</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *Student类的属性</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setId</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        id_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       *Student类的属性</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        id_ = <span class="number">0</span>;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> Object name_ = <span class="string">""</span>;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object ref = name_;</span><br><span class="line">        <span class="keyword">if</span> (!(ref <span class="keyword">instanceof</span> String)) &#123;</span><br><span class="line">          com.google.protobuf.ByteString bs =</span><br><span class="line">              (com.google.protobuf.ByteString) ref;</span><br><span class="line">          String s = bs.toStringUtf8();</span><br><span class="line">          name_ = s;</span><br><span class="line">          <span class="keyword">return</span> s;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> (String) ref;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> com.google.protobuf.ByteString</span><br><span class="line">          getNameBytes() &#123;</span><br><span class="line">        Object ref = name_;</span><br><span class="line">        <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">          com.google.protobuf.ByteString b = </span><br><span class="line">              com.google.protobuf.ByteString.copyFromUtf8(</span><br><span class="line">                  (String) ref);</span><br><span class="line">          name_ = b;</span><br><span class="line">          <span class="keyword">return</span> b;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> (com.google.protobuf.ByteString) ref;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">        name_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        name_ = getDefaultInstance().getName();</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">       * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setNameBytes</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ByteString value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  &#125;</span><br><span class="line">  checkByteStringIsUtf8(value);</span><br><span class="line">        </span><br><span class="line">        name_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Builder <span class="title">setUnknownFields</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet unknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.setUnknownFieldsProto3(unknownFields);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Builder <span class="title">mergeUnknownFields</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet unknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.mergeUnknownFields(unknownFields);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// @@protoc_insertion_point(builder_scope:Student)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @@protoc_insertion_point(class_scope:Student)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Student DEFAULT_INSTANCE;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">      DEFAULT_INSTANCE = <span class="keyword">new</span> Student();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">getDefaultInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Parser&lt;Student&gt;</span><br><span class="line">        PARSER = <span class="keyword">new</span> com.google.protobuf.AbstractParser&lt;Student&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">parsePartialFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Student(input, extensionRegistry);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> com.google.protobuf.<span class="function">Parser&lt;Student&gt; <span class="title">parser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> com.google.protobuf.<span class="function">Parser&lt;Student&gt; <span class="title">getParserForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Student <span class="title">getDefaultInstanceForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WorkerOrBuilder</span> <span class="keyword">extends</span></span></span><br><span class="line">      // @@protoc_insertion_point(interface_extends:Worker)</span><br><span class="line">      com.google.protobuf.MessageOrBuilder &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    com.google.protobuf.ByteString</span><br><span class="line">        getNameBytes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;int32 age = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Protobuf type &#123;<span class="doctag">@code</span> Worker&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">      <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span> <span class="keyword">implements</span></span></span><br><span class="line">      // @@protoc_insertion_point(message_implements:Worker)</span><br><span class="line">      WorkerOrBuilder &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// Use Worker.newBuilder() to construct.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Worker</span><span class="params">(com.google.protobuf.GeneratedMessageV3.Builder&lt;?&gt; builder)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(builder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Worker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      name_ = <span class="string">""</span>;</span><br><span class="line">      age_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet</span><br><span class="line">    getUnknownFields() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.unknownFields;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Worker</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>();</span><br><span class="line">      <span class="keyword">if</span> (extensionRegistry == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> mutable_bitField0_ = <span class="number">0</span>;</span><br><span class="line">      com.google.protobuf.UnknownFieldSet.Builder unknownFields =</span><br><span class="line">          com.google.protobuf.UnknownFieldSet.newBuilder();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">          <span class="keyword">int</span> tag = input.readTag();</span><br><span class="line">          <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">              done = <span class="keyword">true</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>: &#123;</span><br><span class="line">              String s = input.readStringRequireUtf8();</span><br><span class="line"></span><br><span class="line">              name_ = s;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>: &#123;</span><br><span class="line"></span><br><span class="line">              age_ = input.readInt32();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">              <span class="keyword">if</span> (!parseUnknownFieldProto3(</span><br><span class="line">                  input, unknownFields, extensionRegistry, tag)) &#123;</span><br><span class="line">                done = <span class="keyword">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.setUnfinishedMessage(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> com.google.protobuf.InvalidProtocolBufferException(</span><br><span class="line">            e).setUnfinishedMessage(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.unknownFields = unknownFields.build();</span><br><span class="line">        makeExtensionsImmutable();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">        getDescriptor() &#123;</span><br><span class="line">      <span class="keyword">return</span> MyDataInfo.internal_static_Worker_descriptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> FieldAccessorTable</span><br><span class="line">        internalGetFieldAccessorTable() &#123;</span><br><span class="line">      <span class="keyword">return</span> MyDataInfo.internal_static_Worker_fieldAccessorTable</span><br><span class="line">          .ensureFieldAccessorsInitialized(</span><br><span class="line">              Worker<span class="class">.<span class="keyword">class</span>, <span class="title">Builder</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NAME_FIELD_NUMBER = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Object name_;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Object ref = name_;</span><br><span class="line">      <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) ref;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        com.google.protobuf.ByteString bs = </span><br><span class="line">            (com.google.protobuf.ByteString) ref;</span><br><span class="line">        String s = bs.toStringUtf8();</span><br><span class="line">        name_ = s;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> com.google.protobuf.ByteString</span><br><span class="line">        getNameBytes() &#123;</span><br><span class="line">      Object ref = name_;</span><br><span class="line">      <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        com.google.protobuf.ByteString b = </span><br><span class="line">            com.google.protobuf.ByteString.copyFromUtf8(</span><br><span class="line">                (String) ref);</span><br><span class="line">        name_ = b;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (com.google.protobuf.ByteString) ref;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AGE_FIELD_NUMBER = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age_;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;int32 age = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> age_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> memoizedIsInitialized = -<span class="number">1</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">byte</span> isInitialized = memoizedIsInitialized;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized == <span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">      memoizedIsInitialized = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(com.google.protobuf.CodedOutputStream output)</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!getNameBytes().isEmpty()) &#123;</span><br><span class="line">        com.google.protobuf.GeneratedMessageV3.writeString(output, <span class="number">1</span>, name_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (age_ != <span class="number">0</span>) &#123;</span><br><span class="line">        output.writeInt32(<span class="number">2</span>, age_);</span><br><span class="line">      &#125;</span><br><span class="line">      unknownFields.writeTo(output);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSerializedSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> size = memoizedSize;</span><br><span class="line">      <span class="keyword">if</span> (size != -<span class="number">1</span>) <span class="keyword">return</span> size;</span><br><span class="line"></span><br><span class="line">      size = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (!getNameBytes().isEmpty()) &#123;</span><br><span class="line">        size += com.google.protobuf.GeneratedMessageV3.computeStringSize(<span class="number">1</span>, name_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (age_ != <span class="number">0</span>) &#123;</span><br><span class="line">        size += com.google.protobuf.CodedOutputStream</span><br><span class="line">          .computeInt32Size(<span class="number">2</span>, age_);</span><br><span class="line">      &#125;</span><br><span class="line">      size += unknownFields.getSerializedSize();</span><br><span class="line">      memoizedSize = size;</span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(<span class="keyword">final</span> Object obj)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Worker)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.equals(obj);</span><br><span class="line">      &#125;</span><br><span class="line">      Worker other = (Worker) obj;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">      result = result &amp;&amp; getName()</span><br><span class="line">          .equals(other.getName());</span><br><span class="line">      result = result &amp;&amp; (getAge()</span><br><span class="line">          == other.getAge());</span><br><span class="line">      result = result &amp;&amp; unknownFields.equals(other.unknownFields);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (memoizedHashCode != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> memoizedHashCode;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> hash = <span class="number">41</span>;</span><br><span class="line">      hash = (<span class="number">19</span> * hash) + getDescriptor().hashCode();</span><br><span class="line">      hash = (<span class="number">37</span> * hash) + NAME_FIELD_NUMBER;</span><br><span class="line">      hash = (<span class="number">53</span> * hash) + getName().hashCode();</span><br><span class="line">      hash = (<span class="number">37</span> * hash) + AGE_FIELD_NUMBER;</span><br><span class="line">      hash = (<span class="number">53</span> * hash) + getAge();</span><br><span class="line">      hash = (<span class="number">29</span> * hash) + unknownFields.hashCode();</span><br><span class="line">      memoizedHashCode = hash;</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.nio.ByteBuffer data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.nio.ByteBuffer data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ByteString data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ByteString data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(<span class="keyword">byte</span>[] data)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">byte</span>[] data,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER.parseFrom(data, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(java.io.InputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.io.InputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseDelimitedFrom</span><span class="params">(java.io.InputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseDelimitedWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseDelimitedFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        java.io.InputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseDelimitedWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">parseFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">        com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> com.google.protobuf.GeneratedMessageV3</span><br><span class="line">          .parseWithIOException(PARSER, input, extensionRegistry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">newBuilderForType</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> newBuilder(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE.toBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">(Worker prototype)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE.toBuilder().mergeFrom(prototype);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">toBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span> == DEFAULT_INSTANCE</span><br><span class="line">          ? <span class="keyword">new</span> Builder() : <span class="keyword">new</span> Builder().mergeFrom(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Builder <span class="title">newBuilderForType</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        BuilderParent parent)</span> </span>&#123;</span><br><span class="line">      Builder builder = <span class="keyword">new</span> Builder(parent);</span><br><span class="line">      <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Protobuf type &#123;<span class="doctag">@code</span> Worker&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">        <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span>.<span class="title">Builder</span>&lt;<span class="title">Builder</span>&gt; <span class="keyword">implements</span></span></span><br><span class="line">        // @@protoc_insertion_point(builder_implements:Worker)</span><br><span class="line">        WorkerOrBuilder &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">          getDescriptor() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_Worker_descriptor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">protected</span> FieldAccessorTable</span><br><span class="line">          internalGetFieldAccessorTable() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_Worker_fieldAccessorTable</span><br><span class="line">            .ensureFieldAccessorsInitialized(</span><br><span class="line">                Worker<span class="class">.<span class="keyword">class</span>, <span class="title">Builder</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Construct using com.atguigu.netty.codec2.MyDataInfo.Worker.newBuilder()</span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        maybeForceBuilderInitialization();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          BuilderParent parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        maybeForceBuilderInitialization();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeForceBuilderInitialization</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (com.google.protobuf.GeneratedMessageV3</span><br><span class="line">                .alwaysUseFieldBuilders) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.clear();</span><br><span class="line">        name_ = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        age_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">          getDescriptorForType() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyDataInfo.internal_static_Worker_descriptor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Worker <span class="title">getDefaultInstanceForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Worker.getDefaultInstance();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Worker <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Worker result = buildPartial();</span><br><span class="line">        <span class="keyword">if</span> (!result.isInitialized()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> newUninitializedMessageException(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Worker <span class="title">buildPartial</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Worker result = <span class="keyword">new</span> Worker(<span class="keyword">this</span>);</span><br><span class="line">        result.name_ = name_;</span><br><span class="line">        result.age_ = age_;</span><br><span class="line">        onBuilt();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clone();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.setField(field, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clearField(field);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearOneof</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.OneofDescriptor oneof)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.clearOneof(oneof);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setRepeatedField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> index, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.setRepeatedField(field, index, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">addRepeatedField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.Descriptors.FieldDescriptor field,</span></span></span><br><span class="line"><span class="function"><span class="params">          Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Builder) <span class="keyword">super</span>.addRepeatedField(field, value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(com.google.protobuf.Message other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other <span class="keyword">instanceof</span> Worker) &#123;</span><br><span class="line">          <span class="keyword">return</span> mergeFrom((Worker)other);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">super</span>.mergeFrom(other);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(Worker other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other == Worker.getDefaultInstance()) <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (!other.getName().isEmpty()) &#123;</span><br><span class="line">          name_ = other.name_;</span><br><span class="line">          onChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (other.getAge() != <span class="number">0</span>) &#123;</span><br><span class="line">          setAge(other.getAge());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.mergeUnknownFields(other.unknownFields);</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">mergeFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        Worker parsedMessage = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          parsedMessage = PARSER.parsePartialFrom(input, extensionRegistry);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">          parsedMessage = (Worker) e.getUnfinishedMessage();</span><br><span class="line">          <span class="keyword">throw</span> e.unwrapIOException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (parsedMessage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mergeFrom(parsedMessage);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> Object name_ = <span class="string">""</span>;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object ref = name_;</span><br><span class="line">        <span class="keyword">if</span> (!(ref <span class="keyword">instanceof</span> String)) &#123;</span><br><span class="line">          com.google.protobuf.ByteString bs =</span><br><span class="line">              (com.google.protobuf.ByteString) ref;</span><br><span class="line">          String s = bs.toStringUtf8();</span><br><span class="line">          name_ = s;</span><br><span class="line">          <span class="keyword">return</span> s;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> (String) ref;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> com.google.protobuf.ByteString</span><br><span class="line">          getNameBytes() &#123;</span><br><span class="line">        Object ref = name_;</span><br><span class="line">        <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">          com.google.protobuf.ByteString b = </span><br><span class="line">              com.google.protobuf.ByteString.copyFromUtf8(</span><br><span class="line">                  (String) ref);</span><br><span class="line">          name_ = b;</span><br><span class="line">          <span class="keyword">return</span> b;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> (com.google.protobuf.ByteString) ref;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">        name_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        name_ = getDefaultInstance().getName();</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;string name = 1;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setNameBytes</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ByteString value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  &#125;</span><br><span class="line">  checkByteStringIsUtf8(value);</span><br><span class="line">        </span><br><span class="line">        name_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> age_ ;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 age = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age_;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 age = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        age_ = value;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &lt;code&gt;int32 age = 2;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Builder <span class="title">clearAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        age_ = <span class="number">0</span>;</span><br><span class="line">        onChanged();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Builder <span class="title">setUnknownFields</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet unknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.setUnknownFieldsProto3(unknownFields);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Builder <span class="title">mergeUnknownFields</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">final</span> com.google.protobuf.UnknownFieldSet unknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.mergeUnknownFields(unknownFields);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// @@protoc_insertion_point(builder_scope:Worker)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @@protoc_insertion_point(class_scope:Worker)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Worker DEFAULT_INSTANCE;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">      DEFAULT_INSTANCE = <span class="keyword">new</span> Worker();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Worker <span class="title">getDefaultInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Parser&lt;Worker&gt;</span><br><span class="line">        PARSER = <span class="keyword">new</span> com.google.protobuf.AbstractParser&lt;Worker&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Worker <span class="title">parsePartialFrom</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.CodedInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">          com.google.protobuf.ExtensionRegistryLite extensionRegistry)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> com.google.protobuf.InvalidProtocolBufferException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Worker(input, extensionRegistry);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> com.google.protobuf.<span class="function">Parser&lt;Worker&gt; <span class="title">parser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> com.google.protobuf.<span class="function">Parser&lt;Worker&gt; <span class="title">getParserForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> PARSER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Worker <span class="title">getDefaultInstanceForType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">    internal_static_MyMessage_descriptor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> </span><br><span class="line">    com.google.protobuf.GeneratedMessageV3.FieldAccessorTable</span><br><span class="line">      internal_static_MyMessage_fieldAccessorTable;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">    internal_static_Student_descriptor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> </span><br><span class="line">    com.google.protobuf.GeneratedMessageV3.FieldAccessorTable</span><br><span class="line">      internal_static_Student_fieldAccessorTable;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.protobuf.Descriptors.Descriptor</span><br><span class="line">    internal_static_Worker_descriptor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> </span><br><span class="line">    com.google.protobuf.GeneratedMessageV3.FieldAccessorTable</span><br><span class="line">      internal_static_Worker_fieldAccessorTable;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> com.google.protobuf.Descriptors.FileDescriptor</span><br><span class="line">      getDescriptor() &#123;</span><br><span class="line">    <span class="keyword">return</span> descriptor;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span>  com.google.protobuf.Descriptors.FileDescriptor</span><br><span class="line">      descriptor;</span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    String[] descriptorData = &#123;</span><br><span class="line">      <span class="string">"\n\rStudent.proto\"\244\001\n\tMyMessage\022&amp;\n\tdata_ty"</span> +</span><br><span class="line">      <span class="string">"pe\030\001 \001(\0162\023.MyMessage.DataType\022\033\n\007student"</span> +</span><br><span class="line">      <span class="string">"\030\002 \001(\0132\010.StudentH\000\022\031\n\006worker\030\003 \001(\0132\007.Wor"</span> +</span><br><span class="line">      <span class="string">"kerH\000\"+\n\010DataType\022\017\n\013StudentType\020\000\022\016\n\nWo"</span> +</span><br><span class="line">      <span class="string">"rkerType\020\001B\n\n\010dataBody\"#\n\007Student\022\n\n\002id\030"</span> +</span><br><span class="line">      <span class="string">"\001 \001(\005\022\014\n\004name\030\002 \001(\t\"#\n\006Worker\022\014\n\004name\030\001 "</span> +</span><br><span class="line">      <span class="string">"\001(\t\022\013\n\003age\030\002 \001(\005B(\n\030com.atguigu.netty.co"</span> +</span><br><span class="line">      <span class="string">"dec2B\nMyDataInfoH\001b\006proto3"</span></span><br><span class="line">    &#125;;</span><br><span class="line">    com.google.protobuf.Descriptors.FileDescriptor.InternalDescriptorAssigner assigner =</span><br><span class="line">        <span class="keyword">new</span> com.google.protobuf.Descriptors.FileDescriptor.    InternalDescriptorAssigner() &#123;</span><br><span class="line">          <span class="keyword">public</span> com.google.protobuf.<span class="function">ExtensionRegistry <span class="title">assignDescriptors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">              com.google.protobuf.Descriptors.FileDescriptor root)</span> </span>&#123;</span><br><span class="line">            descriptor = root;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    com.google.protobuf.Descriptors.FileDescriptor</span><br><span class="line">      .internalBuildGeneratedFileFrom(descriptorData,</span><br><span class="line">        <span class="keyword">new</span> com.google.protobuf.Descriptors.FileDescriptor[] &#123;</span><br><span class="line">        &#125;, assigner);</span><br><span class="line">    internal_static_MyMessage_descriptor =</span><br><span class="line">      getDescriptor().getMessageTypes().get(<span class="number">0</span>);</span><br><span class="line">    internal_static_MyMessage_fieldAccessorTable = <span class="keyword">new</span></span><br><span class="line">      com.google.protobuf.GeneratedMessageV3.FieldAccessorTable(</span><br><span class="line">        internal_static_MyMessage_descriptor,</span><br><span class="line">        <span class="keyword">new</span> String[] &#123; <span class="string">"DataType"</span>, <span class="string">"Student"</span>, <span class="string">"Worker"</span>, <span class="string">"DataBody"</span>, &#125;);</span><br><span class="line">    internal_static_Student_descriptor =</span><br><span class="line">      getDescriptor().getMessageTypes().get(<span class="number">1</span>);</span><br><span class="line">    internal_static_Student_fieldAccessorTable = <span class="keyword">new</span></span><br><span class="line">      com.google.protobuf.GeneratedMessageV3.FieldAccessorTable(</span><br><span class="line">        internal_static_Student_descriptor,</span><br><span class="line">        <span class="keyword">new</span> String[] &#123; <span class="string">"Id"</span>, <span class="string">"Name"</span>, &#125;);</span><br><span class="line">    internal_static_Worker_descriptor =</span><br><span class="line">      getDescriptor().getMessageTypes().get(<span class="number">2</span>);</span><br><span class="line">    internal_static_Worker_fieldAccessorTable = <span class="keyword">new</span></span><br><span class="line">      com.google.protobuf.GeneratedMessageV3.FieldAccessorTable(</span><br><span class="line">        internal_static_Worker_descriptor,</span><br><span class="line">        <span class="keyword">new</span> String[] &#123; <span class="string">"Name"</span>, <span class="string">"Age"</span>, &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// @@protoc_insertion_point(outer_class_scope)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">ublic <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建BossGroup 和 WorkerGroup</span></span><br><span class="line">        <span class="comment">//说明</span></span><br><span class="line">        <span class="comment">//1. 创建两个线程组 bossGroup 和 workerGroup</span></span><br><span class="line">        <span class="comment">//2. bossGroup 只是处理连接请求 , 真正的和客户端业务处理，会交给 workerGroup完成</span></span><br><span class="line">        <span class="comment">//3. 两个都是无限循环</span></span><br><span class="line">        <span class="comment">//4. bossGroup 和 workerGroup 含有的子线程(NioEventLoop)的个数</span></span><br><span class="line">        <span class="comment">//   默认实际 cpu核数 * 2</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); <span class="comment">//8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建服务器端的启动对象，配置参数</span></span><br><span class="line">            ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用链式编程来进行设置</span></span><br><span class="line">            bootstrap.group(bossGroup, workerGroup) <span class="comment">//设置两个线程组</span></span><br><span class="line">                    .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>) //使用<span class="title">NioSocketChannel</span> 作为服务器的通道实现</span></span><br><span class="line"><span class="class">                    .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_BACKLOG</span>, 128) // 设置线程队列得到连接个数</span></span><br><span class="line"><span class="class">                    .<span class="title">childOption</span>(<span class="title">ChannelOption</span>.<span class="title">SO_KEEPALIVE</span>, <span class="title">true</span>) //设置保持活动连接状态</span></span><br><span class="line"><span class="class">//                    .<span class="title">handler</span>(<span class="title">null</span>) // 该 <span class="title">handler</span>对应 <span class="title">bossGroup</span> , <span class="title">childHandler</span> 对应 <span class="title">workerGroup</span></span></span><br><span class="line"><span class="class">                    .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;<span class="comment">//创建一个通道初始化对象(匿名对象)</span></span><br><span class="line">                        <span class="comment">//给pipeline 设置处理器</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                            <span class="comment">//在pipeline加入ProtoBufDecoder</span></span><br><span class="line">                            <span class="comment">//指定对哪种对象进行解码</span></span><br><span class="line">                            pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> ProtobufDecoder(MyDataInfo.MyMessage.getDefaultInstance()));</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> NettyServerHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;); <span class="comment">// 给我们的workerGroup 的 EventLoop 对应的管道设置处理器</span></span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">".....服务器 is ready..."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//绑定一个端口并且同步, 生成了一个 ChannelFuture 对象</span></span><br><span class="line">            <span class="comment">//启动服务器(并绑定端口)</span></span><br><span class="line">            ChannelFuture cf = bootstrap.bind(<span class="number">6668</span>).sync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//给cf 注册监听器，监控我们关心的事件</span></span><br><span class="line"></span><br><span class="line">            cf.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (cf.isSuccess()) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"监听端口 6668 成功"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">"监听端口 6668 失败"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//对关闭通道进行监听</span></span><br><span class="line">            cf.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">说明</span></span><br><span class="line"><span class="comment">1. 我们自定义一个Handler 需要继续netty 规定好的某个HandlerAdapter(规范)</span></span><br><span class="line"><span class="comment">2. 这时我们自定义一个Handler , 才能称为一个handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//public class NettyServerHandler extends ChannelInboundHandlerAdapter &#123;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">MyDataInfo</span>.<span class="title">MyMessage</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取数据实际(这里我们可以读取客户端发送的消息)</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    1. ChannelHandlerContext ctx:上下文对象, 含有 管道pipeline , 通道channel, 地址</span></span><br><span class="line"><span class="comment">    2. Object msg: 就是客户端发送的数据 默认Object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, MyDataInfo.MyMessage msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据dataType 来显示不同的信息</span></span><br><span class="line"></span><br><span class="line">        MyDataInfo.MyMessage.DataType dataType = msg.getDataType();</span><br><span class="line">        <span class="keyword">if</span>(dataType == MyDataInfo.MyMessage.DataType.StudentType) &#123;</span><br><span class="line"></span><br><span class="line">            MyDataInfo.Student student = msg.getStudent();</span><br><span class="line">            System.out.println(<span class="string">"学生id="</span> + student.getId() + <span class="string">" 学生名字="</span> + student.getName());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(dataType == MyDataInfo.MyMessage.DataType.WorkerType) &#123;</span><br><span class="line">            MyDataInfo.Worker worker = msg.getWorker();</span><br><span class="line">            System.out.println(<span class="string">"工人的名字="</span> + worker.getName() + <span class="string">" 年龄="</span> + worker.getAge());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"传输的类型不正确"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    //读取数据实际(这里我们可以读取客户端发送的消息)</span></span><br><span class="line"><span class="comment">//    /*</span></span><br><span class="line"><span class="comment">//    1. ChannelHandlerContext ctx:上下文对象, 含有 管道pipeline , 通道channel, 地址</span></span><br><span class="line"><span class="comment">//    2. Object msg: 就是客户端发送的数据 默认Object</span></span><br><span class="line"><span class="comment">//     */</span></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //读取从客户端发送的StudentPojo.Student</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        StudentPOJO.Student student = (StudentPOJO.Student) msg;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        System.out.println("客户端发送的数据 id=" + student.getId() + " 名字=" + student.getName());</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据读取完毕</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//writeAndFlush 是 write + flush</span></span><br><span class="line">        <span class="comment">//将数据写入到缓存，并刷新</span></span><br><span class="line">        <span class="comment">//一般讲，我们对这个发送的数据进行编码</span></span><br><span class="line">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">"hello, 客户端~(&gt;^ω^&lt;)喵1"</span>, CharsetUtil.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理异常, 一般是需要关闭通道</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//客户端需要一个事件循环组</span></span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建客户端启动对象</span></span><br><span class="line">            <span class="comment">//注意客户端使用的不是 ServerBootstrap 而是 Bootstrap</span></span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置相关参数</span></span><br><span class="line">            bootstrap.group(group) <span class="comment">//设置线程组</span></span><br><span class="line">                    .channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>) // 设置客户端通道的实现类(反射)</span></span><br><span class="line"><span class="class">                    .<span class="title">handler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                            <span class="comment">//在pipeline中加入 ProtoBufEncoder</span></span><br><span class="line">                            pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> ProtobufEncoder());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> NettyClientHandler()); <span class="comment">//加入自己的处理器</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"客户端 ok.."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//启动客户端去连接服务器端</span></span><br><span class="line">            <span class="comment">//关于 ChannelFuture 要分析，涉及到netty的异步模型</span></span><br><span class="line">            ChannelFuture channelFuture = bootstrap.connect(<span class="string">"127.0.0.1"</span>, <span class="number">6668</span>).sync();</span><br><span class="line">            <span class="comment">//给关闭通道进行监听</span></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当通道就绪就会触发该方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//随机的发送Student 或者 Workder 对象</span></span><br><span class="line">        <span class="keyword">int</span> random = <span class="keyword">new</span> Random().nextInt(<span class="number">3</span>);</span><br><span class="line">        MyDataInfo.MyMessage myMessage = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> == random) &#123; <span class="comment">//发送Student 对象</span></span><br><span class="line"></span><br><span class="line">            myMessage = MyDataInfo.MyMessage.newBuilder().setDataType(MyDataInfo.MyMessage.DataType.StudentType).setStudent(MyDataInfo.Student.newBuilder().setId(<span class="number">5</span>).setName(<span class="string">"玉麒麟 卢俊义"</span>).build()).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 发送一个Worker 对象</span></span><br><span class="line"></span><br><span class="line">            myMessage = MyDataInfo.MyMessage.newBuilder().setDataType(MyDataInfo.MyMessage.DataType.WorkerType).setWorker(MyDataInfo.Worker.newBuilder().setAge(<span class="number">20</span>).setName(<span class="string">"老李"</span>).build()).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.writeAndFlush(myMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当通道有读取事件时，会触发</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ByteBuf buf = (ByteBuf) msg;</span><br><span class="line">        System.out.println(<span class="string">"服务器回复的消息:"</span> + buf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        System.out.println(<span class="string">"服务器的地址： "</span>+ ctx.channel().remoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




</li>
</ul>
<h3 id="七，Netty编码器和handler的调用机制"><a href="#七，Netty编码器和handler的调用机制" class="headerlink" title="七，Netty编码器和handler的调用机制"></a>七，Netty编码器和handler的调用机制</h3><h4 id="1，基本说明："><a href="#1，基本说明：" class="headerlink" title="1，基本说明："></a>1，基本说明：</h4><ul>
<li><p>netty的组件设计：Netty的主要组件有Channel，EventLoop，ChannelFuture，ChannelHandler，ChannelPipe等</p>
</li>
<li><p>ChannelHandler充当了处理入站和出站数据的应用程序逻辑的容器，例如，实现ChannelInboundHandler接口（或ChannelInboundHandlerAdapter），你就可以接收入站事件和数据，这些数据会被业务逻辑处理，当要给客户端发送响应时，也可以从ChannelInboundHandler冲刷数据。业务逻辑通过写在一个或者多个ChannelInboundHandlerAdapter中。ChannelOutboundHandler原理一样，只不过它是用来处理出站数据的</p>
</li>
<li><p>ChannelPipeline提供了ChannelHandler链的容器，以客户端应用程序为例，如果事件的运动方向是从客户端到服务端，那么我们称这些事件为出站的，即客户端发送给服务端的数据会通过pipeline中的一系列ChannelOutboundHandler，并被这些Handler处理，反之则称为入站的</p>
<p><img src="/2021/07/16/netty/45.png" alt="image-20210722171332614"></p>
</li>
</ul>
<h4 id="2，编码解码器"><a href="#2，编码解码器" class="headerlink" title="2，编码解码器"></a>2，编码解码器</h4><ul>
<li>当Netty发送或者接收一个消息的时候，就将会发生一次数据转换，入站消息会被解码：从字节转换为另一种格式（比如Java对象）；如果是出站消息，它会被编码成字节</li>
<li>Netty提供一系列实用的编解码器，他们都实现了ChannelInboundHandler或者ChannelOutboundHandler接口，在这些类中，channelRead方法已经被重写了。以入站为例，对于每个从入站Channel读取的消息，这个方法会被调用。随后，他将调用由解码器所提供的decode（）方法进行解码，并将已经解码的字节转发给ChannelPipeline中的下一个ChannelInboundHandler</li>
</ul>
<h5 id="3，解码器——ByteToMessageDecoder"><a href="#3，解码器——ByteToMessageDecoder" class="headerlink" title="3，解码器——ByteToMessageDecoder"></a>3，解码器——ByteToMessageDecoder</h5><ul>
<li><p>关系继承图：</p>
<p><img src="/2021/07/16/netty/46.png" alt="image-20210722171740774"></p>
</li>
<li><p>由于不可能知道远程结点是否回一次性发送一个完整的信息，TCP有可能出现粘包拆包的问题，这个类会对入站数据进行缓冲，直到它准备好被处理</p>
</li>
<li><p>一个关于ByteToMessageDecoder实例分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToInteerDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx,ByteBuf in,List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(in.readableBytes() &gt;= <span class="number">4</span>)&#123;</span><br><span class="line">            out.add(in.readInt());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这个例子，每次入站从ByteBuf中读取4字节，将其解码为一个int，然后将它添加到下一个List中。当没有更多元素可以被添加到该List中时，它的内容将会被发送给下一个ChannelInboundHandler。int在被添加到List中时，会被自动装箱到Integer。在调用readInt()方法前必须验证所输入的ByteBuf是否具有足够的数据</p>
</li>
<li><p>decode执行分析图</p>
<p><img src="/2021/07/16/netty/47.png" alt="image-20210722181752704"></p>
</li>
</ul>
</li>
</ul>
<h4 id="4，Netty的handler链的调用机制"><a href="#4，Netty的handler链的调用机制" class="headerlink" title="4，Netty的handler链的调用机制"></a>4，Netty的handler链的调用机制</h4><ul>
<li><p>实例要求：</p>
<ul>
<li>使用自定义的编码器和解码器来说明Netty的handler调用机制<ul>
<li>客户端发送long ——》 服务端</li>
<li>服务端发送long ——》 客户端</li>
</ul>
</li>
</ul>
<p><img src="/2021/07/16/netty/48.png" alt="image-20210722182142441"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup).channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>).<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">MyServerInitializer</span>())</span>; <span class="comment">//自定义一个初始化类</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">7000</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Long msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"从客户端"</span> + ctx.channel().remoteAddress() + <span class="string">" 读取到long "</span> + msg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给客户端发送一个long</span></span><br><span class="line">        ctx.writeAndFlush(<span class="number">98765L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ChannelPipeline pipeline = ch.pipeline();<span class="comment">//一会下断点</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//入站的handler进行解码 MyByteToLongDecoder</span></span><br><span class="line">        <span class="comment">//pipeline.addLast(new MyByteToLongDecoder());</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyByteToLongDecoder2());</span><br><span class="line">        <span class="comment">//出站的handler进行编码</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyLongToByteEncoder());</span><br><span class="line">        <span class="comment">//自定义的handler 处理业务逻辑</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyServerHandler());</span><br><span class="line">        System.out.println(<span class="string">"xx"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLongToByteEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//编码方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Long msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"MyLongToByteEncoder encode 被调用"</span>);</span><br><span class="line">        System.out.println(<span class="string">"msg="</span> + msg);</span><br><span class="line">        out.writeLong(msg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyByteToLongDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * decode 会根据接收的数据，被调用多次, 直到确定没有新的元素被添加到list</span></span><br><span class="line"><span class="comment">     * , 或者是ByteBuf 没有更多的可读字节为止</span></span><br><span class="line"><span class="comment">     * 如果list out 不为空，就会将list的内容传递给下一个 channelinboundhandler处理, 该处理器的方法也会被调用多次</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx 上下文对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in 入站的 ByteBuf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out List 集合，将解码后的数据传给下一个handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"MyByteToLongDecoder 被调用"</span>);</span><br><span class="line">        <span class="comment">//因为 long 8个字节, 需要判断有8个字节，才能读取一个long</span></span><br><span class="line">        <span class="keyword">if</span>(in.readableBytes() &gt;= <span class="number">8</span>) &#123;</span><br><span class="line">            out.add(in.readLong());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyByteToLongDecoder2</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"MyByteToLongDecoder2 被调用"</span>);</span><br><span class="line">        <span class="comment">//在 ReplayingDecoder 不需要判断数据是否足够读取，内部会进行处理判断</span></span><br><span class="line">        out.add(in.readLong());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            bootstrap.group(group).channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                    .<span class="title">handler</span>(<span class="title">new</span> <span class="title">MyClientInitializer</span>())</span>; <span class="comment">//自定义一个初始化类</span></span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = bootstrap.connect(<span class="string">"localhost"</span>, <span class="number">7000</span>).sync();</span><br><span class="line"></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientHandler</span>  <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Long msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"服务器的ip="</span> + ctx.channel().remoteAddress());</span><br><span class="line">        System.out.println(<span class="string">"收到服务器消息="</span> + msg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重写channelActive 发送数据</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MyClientHandler 发送数据"</span>);</span><br><span class="line">        <span class="comment">//ctx.writeAndFlush(Unpooled.copiedBuffer(""))</span></span><br><span class="line">        ctx.writeAndFlush(<span class="number">123456L</span>); <span class="comment">//发送的是一个long</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//分析</span></span><br><span class="line">        <span class="comment">//1. "abcdabcdabcdabcd" 是 16个字节</span></span><br><span class="line">        <span class="comment">//2. 该处理器的前一个handler 是  MyLongToByteEncoder</span></span><br><span class="line">        <span class="comment">//3. MyLongToByteEncoder 父类  MessageToByteEncoder</span></span><br><span class="line">        <span class="comment">//4. 父类  MessageToByteEncoder</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception &#123;</span></span><br><span class="line"><span class="comment">        ByteBuf buf = null;</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            if (acceptOutboundMessage(msg)) &#123; //判断当前msg 是不是应该处理的类型，如果是就处理，不是就跳过encode</span></span><br><span class="line"><span class="comment">                @SuppressWarnings("unchecked")</span></span><br><span class="line"><span class="comment">                I cast = (I) msg;</span></span><br><span class="line"><span class="comment">                buf = allocateBuffer(ctx, cast, preferDirect);</span></span><br><span class="line"><span class="comment">                try &#123;</span></span><br><span class="line"><span class="comment">                    encode(ctx, cast, buf);</span></span><br><span class="line"><span class="comment">                &#125; finally &#123;</span></span><br><span class="line"><span class="comment">                    ReferenceCountUtil.release(cast);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                if (buf.isReadable()) &#123;</span></span><br><span class="line"><span class="comment">                    ctx.write(buf, promise);</span></span><br><span class="line"><span class="comment">                &#125; else &#123;</span></span><br><span class="line"><span class="comment">                    buf.release();</span></span><br><span class="line"><span class="comment">                    ctx.write(Unpooled.EMPTY_BUFFER, promise);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">                buf = null;</span></span><br><span class="line"><span class="comment">            &#125; else &#123;</span></span><br><span class="line"><span class="comment">                ctx.write(msg, promise);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        4. 因此我们编写 Encoder 是要注意传入的数据类型和处理的数据类型一致</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">// ctx.writeAndFlush(Unpooled.copiedBuffer("abcdabcdabcdabcd",CharsetUtil.UTF_8));</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加入一个出站的handler 对数据进行一个编码</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyLongToByteEncoder());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这时一个入站的解码器(入站handler )</span></span><br><span class="line">        <span class="comment">//pipeline.addLast(new MyByteToLongDecoder());</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyByteToLongDecoder2());</span><br><span class="line">        <span class="comment">//加入一个自定义的handler ， 处理业务</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyClientHandler());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结论：<ul>
<li>不论解码器handler还是编码器handler即接收的消息类型必须与待处理的消息类型一致，否则该handler不会被执行</li>
<li>在解码器进行数据解码时，需要判断缓存区（ByteBuf）的数据是否足够，否则接收到的结果会期望结果可能不一致</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="5，解码器——ReplayingDecoder"><a href="#5，解码器——ReplayingDecoder" class="headerlink" title="5，解码器——ReplayingDecoder"></a>5，解码器——ReplayingDecoder</h4><ul>
<li><p><code>public abstract class ReplayingDecoder&lt;S&gt; extends ByteToMessageDecoder</code></p>
</li>
<li><p>ReplayingDecoder扩展了ByteToMessageDecoder类，使用这个类，我们不必调用readableBytes()方法，参数S指定了用户状态管理的类型，其中Void代表不需要状态管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyByteToLongDecoder2</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"MyByteToLongDecoder2 被调用"</span>);</span><br><span class="line">        <span class="comment">//在 ReplayingDecoder 不需要判断数据是否足够读取，内部会进行处理判断</span></span><br><span class="line">        out.add(in.readLong());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ReplayingDecoder使用方便，但它也有一些局限性：<ul>
<li>并不是所有的ByteBuf操作都被支持，如果调用了一个不被支持的方法，将会抛出一个<code>UnsupportedOpreationException</code></li>
<li>ReplayingDecoder在某些情况下可能稍微慢于ByteToMessageDecoder，例如网络缓慢并且消息格式复杂时，消息会被拆成了多个碎片，速度变慢</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="6，其他编解码器"><a href="#6，其他编解码器" class="headerlink" title="6，其他编解码器"></a>6，其他编解码器</h4><ul>
<li><code>LineBaseFrameDecoder</code>：这个类在Netty内部也有使用，它使用行尾控制字符（\n 或者\r \n）作为分隔符来解析数据</li>
<li><code>DelimiterBaseFrameDecoder</code>：使用自定义的特殊字符作为消息的分隔符</li>
<li><code>HttpObjectDecoder</code>：一个HTTP数据的解码器</li>
<li><code>LengthFieldBaseFrameDecoder</code>：通过指定长度来标识整包消息，这样就可以自动的处理粘包和半包消息</li>
</ul>
<p><img src="/2021/07/16/netty/49.png" alt="image-20210722230943867"></p>
<h4 id="7，Log4j整合到Netty"><a href="#7，Log4j整合到Netty" class="headerlink" title="7，Log4j整合到Netty"></a>7，Log4j整合到Netty</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;groupId&gt;log4j&lt;/groupId&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;artifactId&gt;log4j&lt;/artifactId&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;version&gt;1.2.17&lt;/version&gt;--&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;groupId&gt;org.slf4j&lt;/groupId&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;version&gt;1.7.25&lt;/version&gt;--&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;groupId&gt;org.slf4j&lt;/groupId&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;version&gt;1.7.25&lt;/version&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;groupId&gt;org.slf4j&lt;/groupId&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;artifactId&gt;slf4j-simple&lt;/artifactId&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;version&gt;1.7.25&lt;/version&gt;--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#log4j.rootLogger=DEBUG, stdout</span></span><br><span class="line"><span class="comment">#log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="comment">#log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="comment">#log4j.appender.stdout.layout.ConversionPattern=[%p] %C&#123;1&#125; - %m%n</span></span><br></pre></td></tr></table></figure>





<h3 id="八，TCP粘包和拆包及解决方案"><a href="#八，TCP粘包和拆包及解决方案" class="headerlink" title="八，TCP粘包和拆包及解决方案"></a>八，TCP粘包和拆包及解决方案</h3><h4 id="1，TCP粘包和拆包基本介绍"><a href="#1，TCP粘包和拆包基本介绍" class="headerlink" title="1，TCP粘包和拆包基本介绍"></a>1，TCP粘包和拆包基本介绍</h4><ul>
<li><p>TCP是面向连接的，面向流的，提供高可靠性服务。收发两端（客户端和服务器端）都要有一一成对的socket，因此，发送端为了将多个发给接收端的包，更有效的发给对方，使用优化方法（Nagle算法），将多次间隔较小且数据量小的数据，合并成一个大的数据块，然后进行封包。这样做虽然提供了效率，但是接收端就难于分辨出完成的数据包了，因为面向流的通信是无消息保护边界的</p>
</li>
<li><p>由于TCP无消息保护边界，需要在接收端处理消息边界问题，也就是我们所说的粘包，拆包问题</p>
</li>
<li><p>TCP粘包，拆包图解</p>
<p><img src="/2021/07/16/netty/50.png" alt="image-20210723115508470"></p>
<ul>
<li>假设客户端分别发送了两个数据报D1和D2给服务端，由于服务端一次读取到字节数是不确定的，故可能存在以下四种情况：<ul>
<li>服务端分两次读取到了两个独立的数据包，分别是D1和D2，没有粘包和拆包</li>
<li>服务端一次接受到了两个数据包，D1和D2粘合在一起，称之为TCP粘包</li>
<li>服务端分两次读取到了数据包，第一次读取到了完整的D1包和D2包的部分内容，第二次读取到了D2包的剩余内容，这称之为TCP拆包</li>
<li>服务端分两次读取到了数据包，第一次读取到了D1包的部分内容D1_1，第二次读取到了D1包的剩余部分内容D1_2和完整的D2包</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2，TCP粘包和拆包现象实例"><a href="#2，TCP粘包和拆包现象实例" class="headerlink" title="2，TCP粘包和拆包现象实例"></a>2，TCP粘包和拆包现象实例</h4><ul>
<li><p>在编写Netty程序时，如果没有做处理，就会发生粘包和拆包的问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup).channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>).<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">MyServerInitializer</span>())</span>; <span class="comment">//自定义一个初始化类</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">7000</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">ByteBuf</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//cause.printStackTrace();</span></span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[msg.readableBytes()];</span><br><span class="line">        msg.readBytes(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将buffer转成字符串</span></span><br><span class="line">        String message = <span class="keyword">new</span> String(buffer, Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"服务器接收到数据 "</span> + message);</span><br><span class="line">        System.out.println(<span class="string">"服务器接收到消息量="</span> + (++<span class="keyword">this</span>.count));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//服务器回送数据给客户端, 回送一个随机id ,</span></span><br><span class="line">        ByteBuf responseByteBuf = Unpooled.copiedBuffer(UUID.randomUUID().toString() + <span class="string">" "</span>, Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line">        ctx.writeAndFlush(responseByteBuf);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line"></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyServerHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            bootstrap.group(group).channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                    .<span class="title">handler</span>(<span class="title">new</span> <span class="title">MyClientInitializer</span>())</span>; <span class="comment">//自定义一个初始化类</span></span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = bootstrap.connect(<span class="string">"localhost"</span>, <span class="number">7000</span>).sync();</span><br><span class="line"></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">ByteBuf</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//使用客户端发送10条数据 hello,server 编号</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i= <span class="number">0</span>; i&lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            ByteBuf buffer = Unpooled.copiedBuffer(<span class="string">"hello,server "</span> + i, Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line">            ctx.writeAndFlush(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[msg.readableBytes()];</span><br><span class="line">        msg.readBytes(buffer);</span><br><span class="line"></span><br><span class="line">        String message = <span class="keyword">new</span> String(buffer, Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line">        System.out.println(<span class="string">"客户端接收到消息="</span> + message);</span><br><span class="line">        System.out.println(<span class="string">"客户端接收消息数量="</span> + (++<span class="keyword">this</span>.count));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyClientHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







</li>
</ul>
<h4 id="3，TCP粘包和拆包解决方案"><a href="#3，TCP粘包和拆包解决方案" class="headerlink" title="3，TCP粘包和拆包解决方案"></a>3，TCP粘包和拆包解决方案</h4><ul>
<li><p>使用自定义协议+编码器来解决</p>
</li>
<li><p>关键就是要解决服务器端每次读取数据长度的问题，这个问题解决就不会出现服务器多读或少读数据的问题，从而避免的TCP粘包，拆包</p>
</li>
<li><p>案例实例；</p>
<ul>
<li><p>要求客户端发送5个Message对象，客户端每次发送一个Message对象</p>
</li>
<li><p>服务器端每次接受一个Message，分5次进行解码，每读取到一个Message，会回复一个Message对象给客户端</p>
<p><img src="/2021/07/16/netty/51.png" alt="image-20210723120355909"></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup).channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>).<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">MyServerInitializer</span>())</span>; <span class="comment">//自定义一个初始化类</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">7000</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理业务的handler</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">MessageProtocol</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//cause.printStackTrace();</span></span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, MessageProtocol msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//接收到数据，并处理</span></span><br><span class="line">        <span class="keyword">int</span> len = msg.getLen();</span><br><span class="line">        <span class="keyword">byte</span>[] content = msg.getContent();</span><br><span class="line"></span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(<span class="string">"服务器接收到信息如下"</span>);</span><br><span class="line">        System.out.println(<span class="string">"长度="</span> + len);</span><br><span class="line">        System.out.println(<span class="string">"内容="</span> + <span class="keyword">new</span> String(content, Charset.forName(<span class="string">"utf-8"</span>)));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"服务器接收到消息包数量="</span> + (++<span class="keyword">this</span>.count));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//回复消息</span></span><br><span class="line"></span><br><span class="line">        String responseContent = UUID.randomUUID().toString();</span><br><span class="line">        <span class="keyword">int</span> responseLen = responseContent.getBytes(<span class="string">"utf-8"</span>).length;</span><br><span class="line">        <span class="keyword">byte</span>[]  responseContent2 = responseContent.getBytes(<span class="string">"utf-8"</span>);</span><br><span class="line">        <span class="comment">//构建一个协议包</span></span><br><span class="line">        MessageProtocol messageProtocol = <span class="keyword">new</span> MessageProtocol();</span><br><span class="line">        messageProtocol.setLen(responseLen);</span><br><span class="line">        messageProtocol.setContent(responseContent2);</span><br><span class="line"></span><br><span class="line">        ctx.writeAndFlush(messageProtocol);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line"></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyMessageDecoder());<span class="comment">//解码器</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyMessageEncoder());<span class="comment">//编码器</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyServerHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//协议包</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> len; <span class="comment">//关键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLen</span><span class="params">(<span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.len = len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getContent() &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(<span class="keyword">byte</span>[] content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            bootstrap.group(group).channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                    .<span class="title">handler</span>(<span class="title">new</span> <span class="title">MyClientInitializer</span>())</span>; <span class="comment">//自定义一个初始化类</span></span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = bootstrap.connect(<span class="string">"localhost"</span>, <span class="number">7000</span>).sync();</span><br><span class="line"></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">MessageProtocol</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//使用客户端发送10条数据 "今天天气冷，吃火锅" 编号</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            String mes = <span class="string">"今天天气冷，吃火锅"</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] content = mes.getBytes(Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line">            <span class="keyword">int</span> length = mes.getBytes(Charset.forName(<span class="string">"utf-8"</span>)).length;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建协议包对象</span></span><br><span class="line">            MessageProtocol messageProtocol = <span class="keyword">new</span> MessageProtocol();</span><br><span class="line">            messageProtocol.setLen(length);</span><br><span class="line">            messageProtocol.setContent(content);</span><br><span class="line">            ctx.writeAndFlush(messageProtocol);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, MessageProtocol msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> len = msg.getLen();</span><br><span class="line">        <span class="keyword">byte</span>[] content = msg.getContent();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"客户端接收到消息如下"</span>);</span><br><span class="line">        System.out.println(<span class="string">"长度="</span> + len);</span><br><span class="line">        System.out.println(<span class="string">"内容="</span> + <span class="keyword">new</span> String(content, Charset.forName(<span class="string">"utf-8"</span>)));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"客户端接收消息数量="</span> + (++<span class="keyword">this</span>.count));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"异常消息="</span> + cause.getMessage());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyMessageEncoder()); <span class="comment">//加入编码器</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyMessageDecoder()); <span class="comment">//加入解码器</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> MyClientHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessageDecoder</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MyMessageDecoder decode 被调用"</span>);</span><br><span class="line">        <span class="comment">//需要将得到二进制字节码-&gt; MessageProtocol 数据包(对象)</span></span><br><span class="line">        <span class="keyword">int</span> length = in.readInt();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] content = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">        in.readBytes(content);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装成 MessageProtocol 对象，放入 out， 传递下一个handler业务处理</span></span><br><span class="line">        MessageProtocol messageProtocol = <span class="keyword">new</span> MessageProtocol();</span><br><span class="line">        messageProtocol.setLen(length);</span><br><span class="line">        messageProtocol.setContent(content);</span><br><span class="line"></span><br><span class="line">        out.add(messageProtocol);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessageEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">MessageProtocol</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, MessageProtocol msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MyMessageEncoder encode 方法被调用"</span>);</span><br><span class="line">        out.writeInt(msg.getLen());</span><br><span class="line">        out.writeBytes(msg.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="九，Netty核心源码剖析"><a href="#九，Netty核心源码剖析" class="headerlink" title="九，Netty核心源码剖析"></a>九，Netty核心源码剖析</h3><h4 id="1，Netty启动过程源码剖析"><a href="#1，Netty启动过程源码剖析" class="headerlink" title="1，Netty启动过程源码剖析"></a>1，Netty启动过程源码剖析</h4><h5 id="a，源码剖析目的"><a href="#a，源码剖析目的" class="headerlink" title="a，源码剖析目的"></a>a，源码剖析目的</h5><ul>
<li>用源码剖析的方式走一下Netty（服务器）的启动过程，更好的理解Netty的整体设计和运行机制</li>
</ul>
<h5 id="b，源码剖析——demo源码的基本理解"><a href="#b，源码剖析——demo源码的基本理解" class="headerlink" title="b，源码剖析——demo源码的基本理解"></a>b，源码剖析——demo源码的基本理解</h5><ul>
<li><p>源码需要剖析到Netty调用doBind方法，追踪到NioServerSocketChannel的doBind</p>
</li>
<li><p>并且要Debug程序到NioEventLoop类的run代码，无限循环，在服务器端运行</p>
<p><img src="/2021/07/16/netty/52.png" alt="image-20210724001724702"></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*Echoes back any received data from a client.</span></span><br><span class="line"><span class="comment">服务端启动类源码</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SSL = System.getProperty(<span class="string">"ssl"</span>) != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = Integer.parseInt(System.getProperty(<span class="string">"port"</span>, <span class="string">"8007"</span>));</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// Configure SSL.</span></span><br><span class="line">        <span class="keyword">final</span> SslContext sslCtx; <span class="keyword">if</span> (SSL) &#123;</span><br><span class="line">            SelfSignedCertificate ssc = <span class="keyword">new</span> SelfSignedCertificate();</span><br><span class="line">            sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey()).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sslCtx = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Configure the server.</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>); </span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap(); </span><br><span class="line">            b.group(bossGroup, workerGroup)</span><br><span class="line">                .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_BACKLOG</span>, 100)</span></span><br><span class="line"><span class="class">                .<span class="title">handler</span>(<span class="title">new</span> <span class="title">LoggingHandler</span>(<span class="title">LogLevel</span>.<span class="title">INFO</span>))</span></span><br><span class="line"><span class="class">                .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123; </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        ChannelPipeline p = ch.pipeline();           </span><br><span class="line">                        <span class="keyword">if</span> (sslCtx != <span class="keyword">null</span>) &#123; </span><br><span class="line">                            p.addLast(sslCtx.newHandler(ch.alloc()));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//p.addLast(new LoggingHandler(LogLevel.INFO)); </span></span><br><span class="line">                        p.addLast(<span class="keyword">new</span> EchoServerHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            <span class="comment">// Start the server.</span></span><br><span class="line">            ChannelFuture f = b.bind(PORT).sync();</span><br><span class="line">            <span class="comment">// Wait until the server socket is closed. </span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Shut down all event loops to terminate all threads. </span></span><br><span class="line">            bossGroup.shutdownGracefully(); workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>先看启动类：main方法中，首先创建了关于SSL的配置类</p>
</li>
<li><p>重点分析创建了两个EventLoopGroup对象：</p>
<ul>
<li><p><code>EventLoopGroup bossGroup = new NioEventLoopGroup(1);</code></p>
</li>
<li><p><code>EventLoopGroup workerGroup = new NioEventLoopGroup();</code></p>
<ol>
<li><p>这两个对象是整个Netty的核心对象，可以说，整个Netty的运作都依赖于他们。bossGroup用于接受TCP请求，他会将请求交给workerGroup，workerGroup会获取真正的连接，然后和连接进行通信，比如读写解码编码等操作</p>
</li>
<li><p>EventLoopGroup是事件循环组（线程组）含有多个EventLoop，可以注册channel，用于在事件循环中去进行选择（和选择器相关）</p>
</li>
<li><p><code>new NioEventLoopGroup(1)</code>：这个1表示bossGroup事件组有1个线程，你可以指定，如果<code>new NioEventLoopGroup()</code>会含有默认个线程 cpu核数 * 2，即可以充分的利用多核的优势</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT_EVENT_LOOP_THREADS = Math.max(<span class="number">1</span>,SystemPropertyUtil.getInt(<span class="string">"io.netty.eventLoopThreads"</span>,NettyRuntime.availableProcessors() * <span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<p>会创建EventExecutor数组<code>children = new EventExecutor[nThreads];</code></p>
<p>每个元素的类型就是NioEventLoop，NioEventLoop实现了EventLoop接口和Executor接口，try块中创建了一个ServerBootstrap对象，他是一个引导类，用于启动服务器和引导整个程序的初始化。它和ServerChannel关联，而ServerChannel继承了Channel，有一些方法remoteAddress等，随后，变量b调用了group方法将两个group放入了自己的字段中，用于后期引导使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*Set the &#123;<span class="doctag">@link</span> EventLoopGroup&#125; for the parent (acceptor) and the child (client). These &#123;<span class="doctag">@link</span> EventLoopGroup&#125;'s are used to handle all the events and IO for &#123;<span class="doctag">@link</span> ServerChannel&#125; and &#123;<span class="doctag">@link</span> Channel&#125;'s.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后添加了一个channel，其中参数一个Class对象，引导类将通过这个Class对象反射创建ChannelFactory。然后添加了一些TCP的参数。【说明：Channel的创建在bind方法，可以Debug下bind，会找到<code>channel = channelFactory.newChannel();</code>】</p>
</li>
<li><p>再添加了一个服务器专属的日志处理器handler</p>
</li>
<li><p>再添加一个SocketChannel（不是ServerSocketChannel）的handler</p>
</li>
<li><p>然后绑定端口并阻塞至连接成功</p>
</li>
<li><p>最后main线程阻塞等待关闭</p>
</li>
<li><p>finally块中的代码将在服务器关闭时优雅关闭所有资源</p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务器端处理器源码</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*Copyright 2012 The Netty Project</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*The Netty Project licenses this file to you under the Apache License,</span></span><br><span class="line"><span class="comment">*version 2.0 (the "License"); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment">*with the License. You may obtain a copy of the License at:</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">*distributed under the License is distributed on an "AS IS" BASIS, WITHOUT</span></span><br><span class="line"><span class="comment">*WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span></span><br><span class="line"><span class="comment">*License for the specific language governing permissions and limitations</span></span><br><span class="line"><span class="comment">*under the License.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> atguigu.netty.example.echo2;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandler.Sharable;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*Handler implementation for the echo server.</span></span><br><span class="line"><span class="comment">*/</span> <span class="meta">@Sharable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line">        ctx.write(msg);	</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="meta">@Override</span>	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;	</span><br><span class="line">        ctx.flush();	</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="meta">@Override</span>	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> </span>&#123;	</span><br><span class="line">        <span class="comment">// Close the connection when an exception is raised.	</span></span><br><span class="line">        cause.printStackTrace();	</span><br><span class="line">        ctx.close();	</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这是一个普通的处理器类，用于处理客户端发送来的消息，在我们这里，我们简单的解析出客户端传过来的内容，然后打印，最后发送字符串给客户端</li>
</ul>
<h5 id="c，源码剖析——分析EventLoopGroup"><a href="#c，源码剖析——分析EventLoopGroup" class="headerlink" title="c，源码剖析——分析EventLoopGroup"></a>c，源码剖析——分析EventLoopGroup</h5><ul>
<li><p>构造器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioEventLoopGroup</span><span class="params">(<span class="keyword">int</span> nThreads)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(nThreads,(Executor)<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的<code>this(nThreads,(Executor)null);</code>调用下面构造器（通过alt+d看）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioEventLoopGroup</span><span class="params">(<span class="keyword">int</span> nThreads,Executor executor)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(nThreads,executor,SelectorProvider.provider());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的<code>this(nThreads,executor,SelectorProvider.provider());</code>调用下面构造器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioEventLoopGroup</span><span class="params">(<span class="keyword">int</span> nThreads,Executor executor,<span class="keyword">final</span> SelectorProvider selectorProvider)</span></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>(nThreads,executor,selectorProvider,DefaultSelectStrategyFactory.INSTANCE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的<code>this(nThreads,executor,selectorProvider,DefaultSelectStrategyFactory.INSTANCE);</code>调用下面构造器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioEventLoopGroup</span><span class="params">(<span class="keyword">int</span> nThreads,Executor executor,<span class="keyword">final</span> SelectorProvider selectorProvider,<span class="keyword">final</span> SelectStrategyFactory selectStrategyFactory)</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(nThreads,executor,selectorProvider,selectStrategyFactory,RejectedExecutionHandlers.reject());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的<code>super(nThreads,executor,selectorProvider,selectStrategyFactory,RejectedExecutionHandlers.reject());</code>的方法的父类<code>MultithreadEventLoopGroup</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MultithreadEventLoopGroup</span><span class="params">(<span class="keyword">int</span> nThreads,Executor executor,Object... args)</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(nThreads == <span class="number">0</span> ? DEFAULT_EVENT_LOOP_THREADS : nThreads,executor,args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>追踪到源码抽象类<code>MultithreadEventExecutorGroup</code>的构造器方法<code>MultithreadEventExecutorGroup</code>才是<code>NioEventLoopGroup</code>真正的构造方法，这里可以看成是一个模板方法，使用了设计模式的模板方法，所以，我们就需要好好分析<code>MultithreadEventExecutorGroup</code>方法了</p>
</li>
<li><p>分析<code>MultithreadEventExecutorGroup</code></p>
<ul>
<li>参数说明：<ul>
<li><code>nThreads</code>：使用的线程数，默认为core * 2</li>
<li><code>executor</code>：执行器，如果传入null，则采用Netty默认的线程工厂和默认的执行器<code>ThreadPerTaskExecutor</code></li>
<li><code>chooserFactory</code>：单例<code>new DefaultEventExecutorChooserFactory()</code></li>
<li><code>args</code>：args在创建执行器的时候传入固定参数</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MultithreadEventExecutorGroup</span><span class="params">(<span class="keyword">int</span> nThreads, Executor executor,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        EventExecutorChooserFactory chooserFactory, Object... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nThreads &lt;= <span class="number">0</span>) &#123; <span class="comment">//</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"nThreads: %d (expected: &gt; 0)"</span>, nThreads));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (executor == <span class="keyword">null</span>) &#123; <span class="comment">//如果传入的执行器是空的则采用默认的线程工厂和默认的执行器</span></span><br><span class="line">        executor = <span class="keyword">new</span> ThreadPerTaskExecutor(newDefaultThreadFactory());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建指定线程数的执行器数组 </span></span><br><span class="line">    children = <span class="keyword">new</span> EventExecutor[nThreads];</span><br><span class="line">    <span class="comment">//初始化线程数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nThreads; i ++) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创 建 new NioEventLoop</span></span><br><span class="line">            children[i] = newChild(executor, args); success = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Think about if this is a good exception type       </span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"failed to create a child event loop"</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 如果创建失败，优雅关闭</span></span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j ++) &#123;</span><br><span class="line">                    children[j].shutdownGracefully();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j ++) &#123;</span><br><span class="line">                    EventExecutor e = children[j];</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">while</span> (!e.isTerminated()) &#123;</span><br><span class="line">                            e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException interrupted) &#123;</span><br><span class="line">                        <span class="comment">// Let the caller handle the interruption. Thread.currentThread().interrupt(); break;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    chooser = chooserFactory.newChooser(children);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> FutureListener&lt;Object&gt; terminationListener = <span class="keyword">new</span> FutureListener&lt;Object&gt;() &#123; </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future&lt;Object&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (terminatedChildren.incrementAndGet() == children.length) &#123;</span><br><span class="line">                terminationFuture.setSuccess(<span class="keyword">null</span>);	</span><br><span class="line">            &#125;	</span><br><span class="line">        &#125;	</span><br><span class="line">    &#125;;	</span><br><span class="line">    <span class="comment">//为每一个单例线程池添加一个关闭监听器	</span></span><br><span class="line">    <span class="keyword">for</span> (EventExecutor e: children) &#123;	</span><br><span class="line">        e.terminationFuture().addListener(terminationListener);	</span><br><span class="line">    &#125;	</span><br><span class="line">    Set&lt;EventExecutor&gt; childrenSet = <span class="keyword">new</span> LinkedHashSet&lt;EventExecutor&gt;(children.length);	</span><br><span class="line">    <span class="comment">//将所有的单例线程池添加到一个 HashSet 中。	</span></span><br><span class="line">    Collections.addAll(childrenSet, children);	</span><br><span class="line">    readonlyChildren = Collections.unmodifiableSet(childrenSet);	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果executor是null，创建一个默认的ThreadPerTaskExecutor，使用Netty默认的线程工厂</li>
<li>根据传入的线程数（CPU*2）创建一个线程池（单例线程池）数组</li>
<li>循环填充数组中的元素，如果异常，则关闭所有的单例线程池</li>
<li>根据线程选择工厂创建一个线程选择器</li>
<li>为每一个单例线程池添加一个关闭监听器</li>
<li>将所有的单例线程池添加到一个HashSet中</li>
</ul>
</li>
</ul>
<h5 id="d，源码剖析——ServerBootstrap创建和构造过程"><a href="#d，源码剖析——ServerBootstrap创建和构造过程" class="headerlink" title="d，源码剖析——ServerBootstrap创建和构造过程"></a>d，源码剖析——ServerBootstrap创建和构造过程</h5><ul>
<li><p>ServerBootstrap是一个空构造，但是有默认的成员变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ChannelOption&lt;?&gt;, Object&gt; childOptions = <span class="keyword">new</span> LinkedHashMap&lt;ChannelOption&lt;?&gt;, Object&gt;();	</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;AttributeKey&lt;?&gt;, Object&gt; childAttrs = <span class="keyword">new</span> LinkedHashMap&lt;AttributeKey&lt;?&gt;, Object&gt;();</span><br><span class="line"><span class="comment">//config 对象，会在后面起很大作用</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ServerBootstrapConfig config = <span class="keyword">new</span> ServerBootstrapConfig(<span class="keyword">this</span>); <span class="keyword">private</span> <span class="keyword">volatile</span> EventLoopGroup childGroup;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ChannelHandler childHandler;</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析一下ServerBootstrap基本使用情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">b.group(bossGroup, workerGroup)</span><br><span class="line">    .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_BACKLOG</span>, 100)</span></span><br><span class="line"><span class="class">    .<span class="title">handler</span>(<span class="title">new</span> <span class="title">LoggingHandler</span>(<span class="title">LogLevel</span>.<span class="title">INFO</span>))</span></span><br><span class="line"><span class="class">    .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line">            ChannelPipeline p = ch.pipeline();</span><br><span class="line">            <span class="keyword">if</span> (sslCtx != <span class="keyword">null</span>) &#123; </span><br><span class="line">                p.addLast(sslCtx.newHandler(ch.alloc()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span></span><br><span class="line">            p.addLast(<span class="keyword">new</span> EchoServerHandler());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>链式调用：group方法，将boss和worker传入，boss赋值给parentGroup属性，worker赋值给childGroup属性</li>
<li>channel方法传入NioServerSocketChannel class对象，会根据这个class创建channel对象</li>
<li>option方法传入TCP参数，放在一个LinkedHashMap中</li>
<li>handler方法传入一个handler中，这个handler只专属于ServerSocketChannel而不是SocketChannel</li>
<li>childHandler传入一个handler，这个handler将会在每个客户端连接的时候调用，供SocketChannel使用</li>
</ul>
</li>
</ul>
<h5 id="e，源码剖析——绑定端口的分析："><a href="#e，源码剖析——绑定端口的分析：" class="headerlink" title="e，源码剖析——绑定端口的分析："></a>e，源码剖析——绑定端口的分析：</h5><ul>
<li><p><strong>服务器就是在这个bind方法里启动完成的</strong></p>
</li>
<li><p><strong>bind方法代码，追踪到创建了一个端口对象，并做了一些空判断，核心代码doBind</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress)</span> </span>&#123;</span><br><span class="line">    validate();</span><br><span class="line">    <span class="keyword">if</span> (localAddress == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"localAddress"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> doBind(localAddress);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>doBind源码剖析，核心是两个方法initAndRegister和doBind0</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister(); </span><br><span class="line">    <span class="keyword">final</span> Channel channel = regFuture.channel();</span><br><span class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">return</span> regFuture;</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</span><br><span class="line">        <span class="comment">// At this point we know that the registration was complete and successful. ChannelPromise promise = channel.newPromise();                 //============================================</span></span><br><span class="line">        <span class="comment">//说明:执行 doBind0  方法，完成对端口的绑定                       //============================================</span></span><br><span class="line">        doBind0(regFuture, channel, localAddress, promise);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Registration future is almost always fulfilled already, but just in case it's not.</span></span><br><span class="line">        <span class="keyword">final</span> PendingRegistrationPromise promise = <span class="keyword">new</span> PendingRegistrationPromise(channel);</span><br><span class="line">        regFuture.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line">                Throwable cause = future.cause();</span><br><span class="line">                <span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Registration on the EventLoop failed so fail the ChannelPromise directly to not</span></span><br><span class="line">                    <span class="comment">// IllegalStateException once we try to access the EventLoop of the Channel. promise.setFailure(cause);</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Registration was successful, so set the correct executor to use.</span></span><br><span class="line">                    <span class="comment">// See https://github.com/netty/netty/issues/2586 promise.registered();</span></span><br><span class="line">                    doBind0(regFuture, channel, localAddress, promise);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>分析说明initAndRegister</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ChannelFuture <span class="title">initAndRegister</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    Channel channel = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel = channelFactory.newChannel();<span class="comment">//NioServerSocketChannel</span></span><br><span class="line">        init(channel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123; </span><br><span class="line">            channel.unsafe().closeForcibly();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>	<span class="keyword">new</span>	DefaultChannelPromise(<span class="keyword">new</span> FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);</span><br><span class="line">    &#125;</span><br><span class="line">    ChannelFuture regFuture = config().group().register(channel); </span><br><span class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (channel.isRegistered()) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            channel.unsafe().closeForcibly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> regFuture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>channel = channelFactory.newChannel();</code>：通过ServerBootstrap的通道工厂反射创建一个NioServerSocketChannel<ul>
<li>通过NIO的SelectorProvider的openServerSocketChannel方法得到JDK的channel。目的是让Netty包装JDK的channel</li>
<li>创建了一个唯一的ChannelId，创建了一个NioMessageUnsafe，用于操作消息，创建了一个DefaultChannelPipeline管道，是一个双向链表结构，用于过滤所有的进出的消息</li>
<li>创建了一个NioServerSocketChannelConfig对象，用于对外展示一些配置</li>
</ul>
</li>
<li><code>init(channel);</code>初始化这个NioServerSocketChannel<ul>
<li>init方法，这是个抽象方法（AbstractBootstrap类），由ServerBootstrap实现（<code>setChannelOptions(channel,options,logger);</code>）</li>
<li>设置NioServerSocketChannel的TCP属性</li>
<li>由于LinkedHashMap是非线程安全的，使用同步进行处理</li>
<li>对NioServerSocketChannel的ChannelPipeline添加ChannelInitializer处理器</li>
<li>可以看出，init的方法核心作用在和ChannelPipeline相关</li>
<li>从NioServerSocketChannel的初始化过程中，我们知道，pipeline是一个双向链表，并且他本身就初始化了head和tail，这里调用了他的allLast方法，也就是将整个handler插入到tail的前面，因为tail永远会在后面，需要做一些系统的固定工作</li>
</ul>
</li>
<li>对<code>initAndRegister</code>的分析说明：<ul>
<li>基本说明：initAndRegister（）初始化NioServerSocketChannel通道并注册各个handler，返回一个future</li>
<li>通过ServerBootstrap的通道工厂反射创建一个NioServerSocketChannel</li>
<li>init初始化这个NioServerSocketChannel</li>
<li>config().group.register(channel)通过ServerBootstrap的bossGroup注册NioServerSocketChannel</li>
<li>最后，返回这个异步执行的占位符即regFuture</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>init方法会调用addLast，现在进入到addLast方法内查看</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup group, String name, ChannelHandler handler)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext newCtx;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; </span><br><span class="line">        checkMultiplicity(handler);</span><br><span class="line">        newCtx = newContext(group, filterName(name, handler), handler);</span><br><span class="line">        addLast0(newCtx);</span><br><span class="line">        <span class="keyword">if</span> (!registered) &#123;</span><br><span class="line">            newCtx.setAddPending(); </span><br><span class="line">            callHandlerCallbackLater(newCtx, <span class="keyword">true</span>); <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        EventExecutor executor = newCtx.executor();</span><br><span class="line">        <span class="keyword">if</span> (!executor.inEventLoop()) &#123;</span><br><span class="line">            newCtx.setAddPending(); </span><br><span class="line">            executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span>	</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    callHandlerAdded0(newCtx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    callHandlerAdded0(newCtx);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>addLast方法，在DefaultChannelPipeline类中</li>
<li>addLast方法这就是pipeline方法的核心</li>
<li>检查该handler是否符合标准</li>
<li>创建一个AbstractChannelHandlerContext对象，这里说一下，ChannelHandlerContext对象是ChannelHandler和ChannelPipeline之间关联，每当有ChannelHandler添加到Pipeline中时，都会创建Context。Context的主要功能是管理他所关联的Handler和同一个Pipeline中的其他Handler之间的交互</li>
<li>将Context添加到链表中，也就是追加到tail节点的前面</li>
<li>最后，同步或者异步或者晚点异步的调用callHandlerAdded0方法</li>
</ul>
</li>
<li><p>前面说了dobind方法有2个重要的步骤，initAndRegister说完，接下来看doBind0方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doBind0</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This method is invoked before channelRegistered() is triggered.	Give user handlers a chance to set up	</span></span><br><span class="line">    <span class="comment">// the pipeline in its channelRegistered() implementation.	</span></span><br><span class="line">    channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;	</span><br><span class="line">        <span class="meta">@Override</span>	</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;	</span><br><span class="line">            <span class="keyword">if</span> (regFuture.isSuccess()) &#123;	</span><br><span class="line">                <span class="comment">//bind 方法这里下断点，这里下断点，来玩!!	</span></span><br><span class="line">                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);	</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;	</span><br><span class="line">                promise.setFailure(regFuture.cause());	</span><br><span class="line">            &#125;	</span><br><span class="line">        &#125;	</span><br><span class="line">    &#125;);	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>该方法的参数initAndRegister的future，NioServerSocketChannel，端口地址，NioServerSocketChannel的promise</p>
</li>
<li><p>这里就可以根据前面下的断电，一直debug</p>
<ul>
<li>将调用 LoggingHandler 的 invokeBind  方法,  最后会追到DefaultChannelPipeline 类的 bind然后进入到 unsafe.bind 方法 debug ,  注意要追踪到 unsafe.bind , 要 debug 第二圈的时候，才能看到.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;		</span><br><span class="line">    unsafe.bind(localAddress, promise);		</span><br><span class="line">&#125;		</span><br><span class="line"><span class="comment">//继续追踪 AbstractChannel  的		</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;		</span><br><span class="line">    <span class="comment">//....		</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;		</span><br><span class="line">        <span class="comment">//!!!!小红旗 可以看到，这里最终的方法就是 doBind 方法，执行成功后，执行通道的		</span></span><br><span class="line">        <span class="comment">//fireChannelActive 方法，告诉所有的 handler，已经成功绑定。		</span></span><br><span class="line">            doBind(localAddress);<span class="comment">//		</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;		</span><br><span class="line">        safeSetFailure(promise, t);		</span><br><span class="line">        closeIfClosed();		</span><br><span class="line">        <span class="keyword">return</span>;		</span><br><span class="line">    &#125;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最终doBind就会追踪到NioServerSocketChannel的doBind，说明Netty底层使用的Nio</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBind</span><span class="params">(SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.javaVersion() &gt;= <span class="number">7</span>) &#123;</span><br><span class="line">        javaChannel().bind(localAddress, config.getBacklog());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        javaChannel().socket().bind(localAddress, config.getBacklog());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>回到bind方法（alt+v），最后一步：<code>safeSetSuccess(promise)</code>，告诉promise任务成功了，其可以执行监听器的方法了，到此整个启动过程已经结束了</p>
</li>
<li><p>继续alt+V服务器就会进入的（NioEventLoop类）一个循环代码，进行监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h5 id="f，Netty启动过程梳理"><a href="#f，Netty启动过程梳理" class="headerlink" title="f，Netty启动过程梳理"></a>f，Netty启动过程梳理</h5><ul>
<li>创建2个EventLoopGroup线程池数组，数组默认大小 CPU * 2，方便chooser选择线程池时提高性能</li>
<li>BootStrap将boss设置为group属性，将worker设置为childer属性</li>
<li>通过bind方法启动，内部重要方法为initAndRegister和dobind方法</li>
<li>initAndRegister方法会反射创建NioServerSocketChannel及其相关的NIO的对象，pipeline，unsafe，同时也为pipeline初始了heal节点和tail节点</li>
<li>在register（）方法成功以后调用在dobind方法中调用doBind()方法，该方法会调用NioServerSocketChannel的doBind方法对JDK的channel和端口进行绑定，完成Netty服务器的所有启动，并开始监听连接事件</li>
</ul>
<h4 id="2，Netty接受请求过程源码剖析"><a href="#2，Netty接受请求过程源码剖析" class="headerlink" title="2，Netty接受请求过程源码剖析"></a>2，Netty接受请求过程源码剖析</h4><h5 id="a，源码剖析的目的"><a href="#a，源码剖析的目的" class="headerlink" title="a，源码剖析的目的"></a>a，源码剖析的目的</h5><ul>
<li>服务器启动后肯定是要接受客户端请求并返回客户端想要的信息的，下面源码分析Netty在启动之后是如何接受客户端请求的</li>
</ul>
<h5 id="b，源码剖析"><a href="#b，源码剖析" class="headerlink" title="b，源码剖析"></a>b，源码剖析</h5><blockquote>
<p><strong>说明</strong>：</p>
<ul>
<li>从之前服务器启动的源码中，我们得知，服务器最终注册了一个Accept事件等待客户端的连接，我们也知道，NioServerSocketChannel将自己注册到boss单例线程池（reactor线程）上，也就是EventLoop</li>
<li>先简单说下，EventLoop的逻辑</li>
<li>EventLoop的作用是一个死循环，而这个循环中做3件事情：<ul>
<li>有条件的等待Nio事件</li>
<li>处理Nio事件</li>
<li>处理消息队列中的任务</li>
</ul>
</li>
<li>仍用前面的项目来分析：进入到NioEventLoop源码中后，在<code>private void processSelectedKey(SelectionKey k,AbstractNioChannel ch)</code>方法开始调试最终我们要分析到AbstractNioChannel的doBeginRead方法，当到这个方法时，针对于这个客户端连接就完成了，接下里就可以监听读事件了</li>
</ul>
</blockquote>
<ul>
<li><p>断点位置NioEventLoop的如下方法proecssSelectedKey</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) &#123; </span><br><span class="line">    unsafe.read(); <span class="comment">//断点位置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行浏览器<a href="http://localhost:8007，客户端发出请求">http://localhost:8007，客户端发出请求</a></p>
</li>
<li><p>从断点我们可以看出，readyOps是16，也就是Accept事件，说明浏览器的请求已经进来了</p>
</li>
<li><p>这个unsafe是boss线程中NioServerSocketChannel的AbstractNioMessageChannel $ NioMessageUnsafe对象。我们进入到AbstractNioMessageChannel $ NioMessageUnsafe的read方法中</p>
</li>
<li><p>read方法代码并分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">assert</span> <span class="title">eventLoop</span><span class="params">()</span>.<span class="title">inEventLoop</span><span class="params">()</span></span>; </span><br><span class="line">    <span class="keyword">final</span> ChannelConfig config = config();</span><br><span class="line">    <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</span><br><span class="line">    <span class="keyword">final</span> RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle(); </span><br><span class="line">    allocHandle.reset(config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> closed = <span class="keyword">false</span>; </span><br><span class="line">    Throwable exception = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> localRead = doReadMessages(readBuf);</span><br><span class="line">                <span class="keyword">if</span> (localRead == <span class="number">0</span>) &#123;	</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (localRead &lt; <span class="number">0</span>) &#123; </span><br><span class="line">                    closed = <span class="keyword">true</span>; <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                allocHandle.incMessagesRead(localRead);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (allocHandle.continueReading());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            exception = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> size = readBuf.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i ++) &#123; </span><br><span class="line">            readPending = <span class="keyword">false</span>;</span><br><span class="line">            pipeline.fireChannelRead(readBuf.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        readBuf.clear();</span><br><span class="line">        allocHandle.readComplete();</span><br><span class="line">        pipeline.fireChannelReadComplete();</span><br><span class="line">        <span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</span><br><span class="line">            closed = closeOnReadError(exception);</span><br><span class="line">            pipeline.fireExceptionCaught(exception);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">            inputShutdown = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (isOpen()) &#123;</span><br><span class="line">                close(voidPromise());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// Check if there is a readPending which was not processed yet.</span></span><br><span class="line">        <span class="comment">// This could be for two reasons:</span></span><br><span class="line">        <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span></span><br><span class="line">        <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...)</span></span><br><span class="line">        <span class="comment">// See https://github.com/netty/netty/issues/2254</span></span><br><span class="line">        <span class="keyword">if</span> (!readPending &amp;&amp; !config.isAutoRead()) &#123;</span><br><span class="line">            removeReadOp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>检查该eventloop线程是否是当前线程<code>assert eventLoop().inEventLoop()</code></li>
<li>执行doReadMessage方法，并传入一个readBuf变量，这个变量是一个List，也就是容器</li>
<li>循环容器，执行<code>pipeline.fireChannelRead(readBuf.get(i));</code></li>
<li>doReadMessages是读取boss线程中NioServerSocketChannel接受到的请求，并把这些请求放进容器</li>
<li>循环遍历容器中的所有请求，调用pipeline中fireChannelRead方法，用于处理这些接受的请求或者其他事件，在read方法中，循环调用ServerSocket的pipeline的fireChannelRead方法，开始执行管道中的handler的ChannelRead方法</li>
</ul>
</li>
<li><p>追踪一下doReadMessages方法，就可以看得更清晰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doReadMessages</span><span class="params">(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line">    SocketChannel ch = SocketUtils.accept(javaChannel());</span><br><span class="line">    buf.add(<span class="keyword">new</span> NioSocketChannel(<span class="keyword">this</span>, ch));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过工具类，调用NioServerSocketChannel内部封装的ServerSocketChannel的accept方法，这是Nio做法</li>
<li>获取到一个JDK的SocketChannel，然后使用NioSocketChannel进行封装，最后添加到容器中</li>
<li>这样容器buf中就有NioSocketChannel</li>
</ul>
</li>
<li><p>回到read方法，继续分析循环执行<code>pipeline.fireChannelRead</code>方法</p>
<ul>
<li><p>前面分析doReadMessages方法的作用是通过ServerSocket的accept方法获取到TCP连接，然后封装成Netty的NioSocketChannel对象，最后添加到容器中</p>
</li>
<li><p>在read方法中，循环调用ServerSocket的pipeline的fireChannelRead方法，开始执行管道中的handler的ChannelRead方法</p>
</li>
<li><p>经过debug，可以看到会反复执行多个handler的ChannelRead，我们知道，pipeline里面又4个handler，分别是Head，LoggingHandler，ServerBootstrapAcceptor，Tail</p>
</li>
<li><p>我们重点看看ServerBootstrapAcceptor，debug之后，断电会进入到ServerBootstrapAcceptor中来，我们来看看ServerBootstrapAccesstor的channelRead方法</p>
</li>
<li><p>channelRead方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Obprotected <span class="keyword">int</span> doReadMessages(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line">    SocketChannel ch = SocketUtils.accept(javaChannel());</span><br><span class="line">    buf.add(<span class="keyword">new</span> NioSocketChannel(<span class="keyword">this</span>, ch));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">                        ject msg) &#123;</span><br><span class="line">    <span class="keyword">final</span> Channel child = (Channel) msg;</span><br><span class="line">    child.pipeline().addLast(childHandler);</span><br><span class="line">    setChannelOptions(child, childOptions, logger);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: childAttrs) &#123; </span><br><span class="line">        child.attr((AttributeKey&lt;Object&gt;) e.getKey()).set(e.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;<span class="comment">//将客户端连接注册到 worker 线程池</span></span><br><span class="line">        childGroup.register(child).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!future.isSuccess()) &#123;</span><br><span class="line">                    forceClose(child, future.cause());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123; </span><br><span class="line">        forceClose(child, t);	</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>msg强转成Channel，实际上就是NioSocketChannel</li>
<li>添加NioSocketChannel的pipeline的handler，就是我们main方法里面设置的childHanlder方法里的</li>
<li>设置NioSocketChannel的各种属性</li>
<li>将该NioSocketChannel注册到childGroup中的一个EventLoop上，并添加一个监听器</li>
<li>这个childGroup就是我们main方法创建的数组workerGroup</li>
</ul>
</li>
</ul>
</li>
<li><p>进入register方法查看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">    AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</span><br><span class="line">    <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123; </span><br><span class="line">        register0(promise);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        eventLoop.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                register0(promise);<span class="comment">//进入到这里	</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//继续进入到 下面方法， 执行管道中可能存在的任务, 这里我们就不追了</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最终会调用deBeginRead方法，也就是AbstractNioChannel类的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;	</span><br><span class="line">    <span class="comment">// Channel.read() or ChannelHandlerContext.read() was called	</span></span><br><span class="line">    <span class="keyword">final</span> SelectionKey selectionKey = <span class="keyword">this</span>.selectionKey; <span class="comment">//断点	</span></span><br><span class="line">    <span class="keyword">if</span> (!selectionKey.isValid()) &#123;	</span><br><span class="line">        <span class="keyword">return</span>;	</span><br><span class="line">    &#125;	</span><br><span class="line"></span><br><span class="line">    readPending = <span class="keyword">true</span>;	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> interestOps = selectionKey.interestOps();	</span><br><span class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) == <span class="number">0</span>) &#123;	</span><br><span class="line">        selectionKey.interestOps(interestOps | readInterestOp);	</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这个地方调试时，请把前面的断点都去掉，然后启动服务器就会停止在doBeginRead（需要先放过该断点，然后浏览器请求，才能看到效果）</p>
</li>
<li><p>执行到这里时，针对这个客户端的连接就完成了，接下来就可以监听读事件了</p>
</li>
</ul>
<h5 id="c，Netty接受请求过程梳理："><a href="#c，Netty接受请求过程梳理：" class="headerlink" title="c，Netty接受请求过程梳理："></a>c，Netty接受请求过程梳理：</h5><ul>
<li>总体流程：接受连接——》创建一个新的NioSocketChannel ——》注册到一个workerEventLoop上——》注册selector Read事件</li>
<li>服务器轮询Accept事件，获取事件后调用unsafe的read方法，这个unsafe是ServerSocket的内部类，该方法内部由2部分组成</li>
<li>doReadMessages用于创建NioSocketChannel对象，该对象包装JDK的NioChannel客户端，该方法会像创建ServerSocketChannel类似创建相关的pipeline，unsafe，config</li>
<li>随后执行pipeline.fireChannelRead方法，并将自己绑定到一个chooser选择器选择的workerGroup中的一个EventLoop，并注册一个0，表示注册成功，但没有注册读（1）事件</li>
</ul>
<h4 id="3，Pipeline-Handler-HandlerContext创建源码剖析"><a href="#3，Pipeline-Handler-HandlerContext创建源码剖析" class="headerlink" title="3，Pipeline | Handler | HandlerContext创建源码剖析"></a>3，Pipeline | Handler | HandlerContext创建源码剖析</h4><h5 id="a，源码剖析目的："><a href="#a，源码剖析目的：" class="headerlink" title="a，源码剖析目的："></a>a，源码剖析目的：</h5><ul>
<li>Netty中ChannelPipeline，ChannelHandler和ChannelHandlerContext是非常核心的组件，我们从源码来分析Netty是如何设计这三个核心组件，并分析是如何创建和协调工作的·</li>
</ul>
<h5 id="b，ChannelPipeline-ChannelHandler-ChannelHandlerContext介绍"><a href="#b，ChannelPipeline-ChannelHandler-ChannelHandlerContext介绍" class="headerlink" title="b，ChannelPipeline | ChannelHandler | ChannelHandlerContext介绍"></a>b，ChannelPipeline | ChannelHandler | ChannelHandlerContext介绍</h5><ul>
<li><p>三者关系：</p>
<ul>
<li><p>每当ServerSocket创建一个新的连接，就会创建一个Socket，对应的就是目标客户端</p>
</li>
<li><p>每一个新创建的Socket都将会分配一个全新的ChannelPipeline</p>
</li>
<li><p>每个ChannelPipeline内部都含有多个ChannelHandlerContext</p>
</li>
<li><p>他们一起组成了双向链表，这些Context用于包装我们调用addLast方法时添加的ChannelHandler</p>
<p><img src="/2021/07/16/netty/53.png" alt="image-20210724171924637"></p>
<ul>
<li>上图中：ChannelSocket和ChannelPipeline是一对一的关联关系，而pipeline内部的多个Context形成了链表：Context只是对Handler的封装</li>
<li>当一个请求进来的时候，会进入Socket对应的pipeline，并经过pipeline所有的handler对，就是设计模式中的过滤器模式</li>
</ul>
</li>
</ul>
</li>
<li><p>ChannelPipeline作用及设计</p>
<ul>
<li><p>pipeline接口设计</p>
<p><img src="/2021/07/16/netty/54.png" alt="image-20210724172215446"></p>
<p><img src="/2021/07/16/netty/55.png" alt="image-20210724172257867"></p>
<p>可以看到该接口继承了inBound，outBound，Iterable接口，表示他可以调用数据出站和入站的方法，同时也能遍历内部的链表，看看他的几个代表性的方法，基本上都是针对handler链表的插入，追加，删除，替换操作，类似是一个LinkedList。同时，也能返回channel（也就是socket）</p>
</li>
<li><p>在pipeline的接口文档上，提供了一幅图</p>
<p><img src="/2021/07/16/netty/56.png" alt="image-20210724172644171"></p>
<ul>
<li><p>这是一个handler的list，handler用于处理或拦截入站事件和出站事件，pipeline实现了过滤器的高级形式，以便用户控制事件如何处理以及handler在pipeline中如何交互</p>
</li>
<li><p>上图描述了一个典型的handler在pipeline中处理I/O事件的方式，IO事件由inboundHandler或者outBoundHandler处理，并通过调用ChannelHandlerContext.fireChannelRead方法转发给其最近的处理程序</p>
</li>
<li><p>入站事件由入站处理程序以自下而上的方向处理，如图所示，入站处理程序通常处理由图底部的I/O线程生成入站数据，入站数据通常从如SocketChannel.read(ByteBuffer)获取</p>
</li>
<li><p>通常一个pipeline有多个handler，例如，一个典型的服务器在每个通道的管道中都会有以下处理程序协议解码器——将二进制数据转换成Java对象</p>
</li>
<li><p>业务逻辑处理程序 —— 执行实际业务逻辑（例如数据库访问）</p>
</li>
<li><p>你的业务程序不能将线程阻塞，会影响IO的速度，进而影响整个Netty程序的性能，如果你的业务程序很快，就可以放在IO线程中，反之，你需要异步执行，或者在添加handler的时候添加一个线程池，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//下面这个任务执行的时候，将不会阻塞IO线程，执行的线程来自group线程池</span></span><br><span class="line">pipeline.addLast(group,<span class="string">"handler"</span>,<span class="keyword">new</span> MyBusinessLogicHandler());</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="c，ChanndlerHandler作用及设计"><a href="#c，ChanndlerHandler作用及设计" class="headerlink" title="c，ChanndlerHandler作用及设计"></a>c，ChanndlerHandler作用及设计</h5><ul>
<li><p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ChannelHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">//当把 ChannelHandler 添加到 pipeline 时被调用</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="comment">//当从 pipeline 中移除时调用</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="comment">// 当处理过程中在 pipeline 发生异常时调用</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>ChannelHandler的作用就是处理IO事件或拦截IO事件，并将其转发给下一个处理程序ChannelHandler。Handler处理事件时分入站和出站的，两个方向的操作都是不同的，因此，Netty定义了两个子接口继承ChannelHandler</p>
</li>
<li><p>ChannelInboundHandler入站事件接口</p>
<p><img src="/2021/07/16/netty/57.png" alt="image-20210724173847758"></p>
<ul>
<li>channelActive用于当Channel处于活动状态时被调用</li>
<li>channelRead当从Channel读取数据时被调用等等方法</li>
<li>程序员需要重写一些方法，当发生关注的事件，需要在方法中实现我们的业务逻辑，因为当事件发生时，Netty会回调对应的方法</li>
</ul>
</li>
<li><p>ChannelOutboundHandler出站事件接口</p>
<p><img src="/2021/07/16/netty/58.png" alt="image-20210724174107505"></p>
<ul>
<li>bind方法：当请求将Channel绑定到本地地址时调用</li>
<li>close方法，当请求关闭Channel时调用等等</li>
<li>出站操作都是一些连接和写出数据类似的方法</li>
</ul>
</li>
</ul>
<ul>
<li><p>ChannelDuplexHandler处理出站和入站事件（不推荐使用）</p>
<p><img src="/2021/07/16/netty/59.png" alt="image-20210724174256454"></p>
<ul>
<li>ChannelDuplexHandler间接实现了入站接口并直接实现了出站接口</li>
<li>是一个通用的能够同时处理入站事件和出站事件的类</li>
</ul>
</li>
<li><p>ChannelHandlerContext作用及设计</p>
<ul>
<li><p>ChannelHandlerContextUML图</p>
<p><img src="/2021/07/16/netty/60.png" alt="image-20210724174436374"></p>
</li>
<li><p>ChannelHandlerContext继承了出站方法调用接口和入站方法调用及饿哦库</p>
<ul>
<li><p>ChannelOutboundInvoker和ChannelInboundInvoker</p>
<p><img src="/2021/07/16/netty/61.png" alt="image-20210724174608999"></p>
<p><img src="/2021/07/16/netty/62.png" alt="image-20210724174646749"></p>
<ul>
<li>这两个invoker就是针对入站或出站方法来的，就是在入站或者出站handler的外层再包装一层，达到在方法前后拦截并做一些特定操作的目的</li>
</ul>
</li>
</ul>
</li>
<li><p><img src="/2021/07/16/netty/63.png" alt="image-20210724174828182"></p>
<ul>
<li>ChannelHandlerContext不仅仅是继承了他们两个的方法，同时也定义了一些自己的方法</li>
<li>这些方法能够获取Context上下文环境中对应的比如channel，executor，handler，pipeline，内存分配器，关联的handler是否被删除</li>
<li>Context就是包装了handler相关的一切，以方便Context可以在pipeline方便的操作handler</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="d，ChannelPipeline-ChannelHandler-ChannelHandlerContext创建过程"><a href="#d，ChannelPipeline-ChannelHandler-ChannelHandlerContext创建过程" class="headerlink" title="d，ChannelPipeline | ChannelHandler | ChannelHandlerContext创建过程"></a>d，ChannelPipeline | ChannelHandler | ChannelHandlerContext创建过程</h5><ul>
<li><p>分为3个步骤来看创建的过程：</p>
<ul>
<li>任何一个ChannelSocket创建的同时都会创建一个pipeline</li>
<li>当用户或系统内部调用pipeline的add*** 方法添加handler时，都会创建一个包装这handler的Context</li>
<li>这些Context在pipeline中组成了双向链表</li>
</ul>
</li>
<li><p>Socket创建的时候创建pipeline</p>
<ul>
<li><p>在SocketChannel的抽象父类AbstractChannel的构造方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractChannel</span><span class="params">(Channel parent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.parent = parent; <span class="comment">//断点测试</span></span><br><span class="line">    id = newId();</span><br><span class="line">    unsafe = newUnsafe();</span><br><span class="line">    pipeline = newChannelPipeline();</span><br><span class="line">&#125;</span><br><span class="line">DefaultChannelPipeline(Channel channel) &#123;</span><br><span class="line">    <span class="keyword">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="string">"channel"</span>); </span><br><span class="line">    succeededFuture = <span class="keyword">new</span> SucceededChannelFuture(channel, <span class="keyword">null</span>); </span><br><span class="line">    voidPromise = <span class="keyword">new</span> VoidChannelPromise(channel, <span class="keyword">true</span>);</span><br><span class="line">    tail = <span class="keyword">new</span> TailContext(<span class="keyword">this</span>); head = <span class="keyword">new</span> HeadContext(<span class="keyword">this</span>);</span><br><span class="line">    head.next = tail;</span><br><span class="line">    tail.prev = head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将channel赋值给channel字段，用于pipeline操作channel</li>
<li>创建一个future和promise，用于异步回调使用</li>
<li>创建一个inbound的tailContext，创建一个既是inbound类型又是outbound类型的headContext</li>
<li>最后，将两个Context相互连接，形成双向链表</li>
<li>tailContext和HeadContext非常的重要，所有pipeline中的事件都会流经他们</li>
</ul>
</li>
</ul>
</li>
<li><p>在add<em>*<em>添加处理器的时候创建Context\</em>\</em></p>
<ul>
<li><p>看下DefaultChannelPipeline的addLast方法如何创建Context</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup executor, ChannelHandler... handlers)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (handlers == <span class="keyword">null</span>) &#123; <span class="comment">//断点</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"handlers"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (ChannelHandler h: handlers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (h == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        addLast(executor, <span class="keyword">null</span>, h);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup group, String name, ChannelHandler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext newCtx;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; checkMultiplicity(handler);</span><br><span class="line">                         newCtx = newContext(group, filterName(name, handler), handler);</span><br><span class="line">                         addLast0(newCtx);</span><br><span class="line">                         <span class="comment">// If the registered is false it means that the channel was not registered on an eventloop yet.</span></span><br><span class="line">                         <span class="comment">// In this case we add the context to the pipeline and add a task that will call</span></span><br><span class="line">                         <span class="comment">// ChannelHandler.handlerAdded(...) once the channel is registered. if (!registered) &#123;</span></span><br><span class="line">                         newCtx.setAddPending();</span><br><span class="line">                         callHandlerCallbackLater(newCtx, <span class="keyword">true</span>); </span><br><span class="line">                         <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">    EventExecutor executor = newCtx.executor(); </span><br><span class="line">    <span class="keyword">if</span> (!executor.inEventLoop()) &#123;</span><br><span class="line">        newCtx.setAddPending();</span><br><span class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                callHandlerAdded0(newCtx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">callHandlerAdded0(newCtx); </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>pipeline添加handler，参数是线程池，name是null，handler是我们或者系统传入的handler，Netty为了防止多个线程导致安全问题，同步了这段代码，步骤如下：<ul>
<li>检查这个handler实例是否是共享的，如果不是，并且已经被别的pipeline使用了，则抛出异常</li>
<li>调用<code>newContext(group,filterName(name,handler),handler)</code>方法，创建一个Context，从这里可以看出来了，每次添加一个handler都会创建一个关联Context</li>
<li>调用addLast方法，将Context追加到链表中</li>
<li>如果这个通道还没有注册到selector上，就将这个Context添加到这个pipeline的待办任务中，当注册好了以后，就会调用callHandlerAdded()方法（默认是什么都不做，用户可以实现这个方法）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="f，Pipeline-Handler-HandlerContext创建过程梳理"><a href="#f，Pipeline-Handler-HandlerContext创建过程梳理" class="headerlink" title="f，Pipeline Handler HandlerContext创建过程梳理"></a>f，Pipeline Handler HandlerContext创建过程梳理</h5><ul>
<li>每当创建ChannelSocket的时候都会创建一个绑定的pipeline，一对一的关系，创建pipeline的时候也会创建tail节点和head节点，形成最初的链表</li>
<li>在调用pipeline的addLast方法的时候，会根据给定的handler创建一个Context，然后将这个Context插入到链表的尾端（tail前面）</li>
<li>Context包装handler，多个Context在pipeline中形成了双向链表</li>
<li>入站方向叫inbound，由head节点开始，出站方法叫outbound，由tail节点开始</li>
</ul>
<h4 id="4，ChannelPipeline调度handler的源码剖析"><a href="#4，ChannelPipeline调度handler的源码剖析" class="headerlink" title="4，ChannelPipeline调度handler的源码剖析"></a>4，ChannelPipeline调度handler的源码剖析</h4><h5 id="a，源码剖析目的-1"><a href="#a，源码剖析目的-1" class="headerlink" title="a，源码剖析目的"></a>a，源码剖析目的</h5><ul>
<li>当一个请求进来的时候，ChannelPipeline是如何调用内部的这些handler的呢？</li>
<li>首先，当一个请求进来的时候，会第一个调用pipeline的相关方法，如果是入站事件，这些方法由fire开头，表示开始管道的流动，让后面的handler继续处理</li>
</ul>
<h5 id="b，源码剖析——DefaultChannelPipeline如何实现fire方法？"><a href="#b，源码剖析——DefaultChannelPipeline如何实现fire方法？" class="headerlink" title="b，源码剖析——DefaultChannelPipeline如何实现fire方法？"></a>b，源码剖析——DefaultChannelPipeline如何实现fire方法？</h5><blockquote>
<p>说明：</p>
<ul>
<li><p>当浏览器输入<a href="http://localhost:8007，可以看到执行handler在Debug时，可以将断电下在DefaultChannelPipeline类">http://localhost:8007，可以看到执行handler在Debug时，可以将断电下在DefaultChannelPipeline类</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    AbstractChannelHandlerContext.invokeChannelActive(head); <span class="comment">//断点</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<ul>
<li><p>DefaultChannelPipeline源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultChannelPipeline</span> <span class="keyword">implements</span> <span class="title">ChannelPipeline</span> </span>&#123; <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        AbstractChannelHandlerContext.invokeChannelActive(head);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelInactive</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        AbstractChannelHandlerContext.invokeChannelInactive(head); </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireExceptionCaught</span><span class="params">(Throwable cause)</span> </span>&#123; </span><br><span class="line">        AbstractChannelHandlerContext.invokeExceptionCaught(head, cause); </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireUserEventTriggered</span><span class="params">(Object event)</span> </span>&#123; </span><br><span class="line">        AbstractChannelHandlerContext.invokeUserEventTriggered(head, event); </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelRead</span><span class="params">(Object msg)</span> </span>&#123; </span><br><span class="line">        AbstractChannelHandlerContext.invokeChannelRead(head, msg); </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelReadComplete</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        AbstractChannelHandlerContext.invokeChannelReadComplete(head);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelWritabilityChanged</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        AbstractChannelHandlerContext.invokeChannelWritabilityChanged(head);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看出来，这些方法都是inbound的方法，也就是入站事件，调用静态方法传入的也是inbound的类型head handler。这些静态方法则会调用head的ChannelInboundInvoker接口的方法，再然后调用handler的真正方法</li>
</ul>
</li>
<li><p>再看下pipeline的outbound的fire方法实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultChannelPipeline</span> <span class="keyword">implements</span> <span class="title">ChannelPipeline</span> </span>&#123; </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> tail.bind(localAddress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> tail.connect(remoteAddress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, SocketAddress localAddress)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> tail.connect(remoteAddress, localAddress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">disconnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tail.disconnect();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tail.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">deregister</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tail.deregister();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">flush</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        tail.flush();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> tail.bind(localAddress, promise);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tail.connect(remoteAddress, promise);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">connect</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tail.connect(remoteAddress, localAddress, promise);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">disconnect</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tail.disconnect(promise);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这些都是出站的实现，但是调用的是outbound类型的tail handler来进行处理，因为这些都是outbound事件</li>
<li><strong>出站是tail开始，入站从head开始</strong>，因为出站是从内存向外面写，从tail开始，能够让前面的handler进行处理，防止handler被遗漏，比如编码。反之，入站当然是从head往内部输入，让后面的handler能够处理这些输入的数据。比如解码，因此虽然head也实现了outbound接口，但不是从head开始执行出站任务</li>
</ul>
</li>
</ul>
<h5 id="c，源码剖析——关于如何调度？"><a href="#c，源码剖析——关于如何调度？" class="headerlink" title="c，源码剖析——关于如何调度？"></a>c，源码剖析——关于如何调度？</h5><p><img src="/2021/07/16/netty/64.png" alt="image-20210724203055068"></p>
<ul>
<li>pipeline首先会调用Context的静态方法fireXXX，并传入Context</li>
<li>然后，静态方法调用Contetxt的invoker方法，而invoker方法内部会调用该Context所包含的Handler的真正的XXX方法，调用结束后，如果还需要继续向后传递，就调用Context的fireXXX2方法，循环往复</li>
</ul>
<h5 id="d，ChannelPipeline调度handler梳理"><a href="#d，ChannelPipeline调度handler梳理" class="headerlink" title="d，ChannelPipeline调度handler梳理"></a>d，ChannelPipeline调度handler梳理</h5><ul>
<li>Context包装handler，多个Context在pipeline中形成了双向链表，入站方向叫inbound，由head节点开始，出站方法叫outbound，由tail节点开始</li>
<li>而节点中间的传递通过AbstractChannelHandlerContext类内部的fire系列方法，找到当前节点的下一个节点不断的循环传播，是一个过滤器形式完成对handler的调度</li>
</ul>
<h4 id="5，Netty心跳（heartbeat）服务源码剖析"><a href="#5，Netty心跳（heartbeat）服务源码剖析" class="headerlink" title="5，Netty心跳（heartbeat）服务源码剖析"></a>5，Netty心跳（heartbeat）服务源码剖析</h4><h5 id="a，源码剖析目的-2"><a href="#a，源码剖析目的-2" class="headerlink" title="a，源码剖析目的"></a>a，源码剖析目的</h5><ul>
<li>Netty作为一个网络框架，提供了诸多功能，比如编码解等，Netty还提供了非常重要的一个服务——心跳机制heartbeat。通过心跳检查对方是否有效，这是RPC框架中必不可少的功能，下面我们分析一下Netty内部心跳服务源码实现</li>
</ul>
<h5 id="b，源码剖析——Netty提供的心跳介绍"><a href="#b，源码剖析——Netty提供的心跳介绍" class="headerlink" title="b，源码剖析——Netty提供的心跳介绍"></a>b，源码剖析——Netty提供的心跳介绍</h5><blockquote>
<p>说明：</p>
<ul>
<li><p>Netty提供了IdleStateHandler，ReadTimeoutHandler，WriteTimeoutHandler三个Handler检测连接的有效性，重点分析IdleStateHandler</p>
<p><img src="/2021/07/16/netty/65.png" alt="image-20210724230702193"></p>
</li>
<li><p>ReadTimeout事件和WriteTimeout事件都会自动关闭连接，而且属于异常处理</p>
</li>
</ul>
</blockquote>
<h5 id="c，源码剖析——IdleStateHandler分析"><a href="#c，源码剖析——IdleStateHandler分析" class="headerlink" title="c，源码剖析——IdleStateHandler分析"></a>c，源码剖析——IdleStateHandler分析</h5><ul>
<li><p>4个属性：</p>
<ul>
<li><code>private final boolean observeOutput</code>：是否考虑出站时较慢的情况，默认值是false</li>
<li><code>private final long readerIdleTimeNanos</code>：读事件空闲时间，0则禁用事件</li>
<li><code>private final long writeIdleTimeNanos</code>：写事件空闲时间，0则禁用事件</li>
<li><code>private final long allIdleTimeNanos</code>：读或写空闲时间，0则禁用事件</li>
</ul>
</li>
<li><p>handlerAdded方法</p>
<ul>
<li><p>当该handler被添加到pipeline中时，则调用initialize方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Avoid the case where destroy() is called before scheduling timeouts.</span></span><br><span class="line">    <span class="comment">// See: https://github.com/netty/netty/issues/143 </span></span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    state = <span class="number">1</span>;</span><br><span class="line">    initOutputChanged(ctx);</span><br><span class="line">    lastReadTime = lastWriteTime = ticksInNanos(); </span><br><span class="line">    <span class="keyword">if</span> (readerIdleTimeNanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//这里的 schedule 方法会调用 eventLoop 的 schedule 方法，将定时任务添加进队列中</span></span><br><span class="line">        readerIdleTimeout = schedule(ctx, <span class="keyword">new</span> ReaderIdleTimeoutTask(ctx), readerIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (writerIdleTimeNanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        writerIdleTimeout = schedule(ctx, <span class="keyword">new</span> WriterIdleTimeoutTask(ctx), writerIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (allIdleTimeNanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        allIdleTimeout = schedule(ctx, <span class="keyword">new</span> AllIdleTimeoutTask(ctx), allIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>只要给定的参数大于0，就创建一个定时任务，每个事件都创建。同时，将state状态设置为1，防止重复初始化。调用initOutputChanged方法，初始化“监控出站数据属性”</li>
</ul>
</li>
</ul>
</li>
<li><p>该类内部的3个定时任务类</p>
<p><img src="/2021/07/16/netty/66.png" alt="image-20210724231629620"></p>
<ul>
<li><p>这3个定时任务分别对应读，写，读或者写事件，共有一个父类（AbstractIdleTask），这个父类提供了一个模板方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractIdleTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandlerContext ctx;</span><br><span class="line">    AbstractIdleTask(ChannelHandlerContext ctx) &#123;</span><br><span class="line">        <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!ctx.channel().isOpen()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        run(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当通道关闭了，就不执行任务了，反之，执行子类的run方法</li>
</ul>
</li>
</ul>
</li>
<li><p>读事件的run方法（即ReaderIdleTimeoutTast的run方法）分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> nextDelay = readerIdleTimeNanos;</span><br><span class="line">    <span class="keyword">if</span> (!reading) &#123;</span><br><span class="line">        nextDelay -= ticksInNanos() - lastReadTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nextDelay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Reader is idle - set a new timeout and notify the callback.</span></span><br><span class="line">        <span class="comment">// 用于取消任务 promise</span></span><br><span class="line">        readerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, readerIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line">        <span class="keyword">boolean</span> first = firstReaderIdleEvent; firstReaderIdleEvent = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//再次提交任务</span></span><br><span class="line">            IdleStateEvent event = newIdleStateEvent(IdleState.READER_IDLE, first);</span><br><span class="line">            <span class="comment">//触发用户 handler use channelIdle(ctx, event);</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123; </span><br><span class="line">            ctx.fireExceptionCaught(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Read occurred before the timeout - set a new timeout with shorter delay.</span></span><br><span class="line">        readerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>得到用户设置的超时时间</li>
<li>如果读取操作结束了（执行了channelReadComplete方法设置），就用当前时间减去给定时间和最后一次读（执行操作的时间channelReadComplete方法设置），如果小于0，就触发事件，反之，继续放入队列，间隔时间是新的计算时间</li>
<li>触发的逻辑是：首先将任务再次放到队列，时间是刚开始设置的时间，返回一个promise对象，用于做取消操作，然后，设置first属性为false，表示下一次读取不再是是第一次了，这个属性在channelRead方法会被改成true</li>
<li>创建一个IdleStateEvent类型的写事件对象，将此对象传递个用户的UserEventTriggered方法，完成触发事件的操作</li>
<li>总的来说，每次读取操作都会记录一个时间，定时任务时间到了，会计算当前时间和最后一次读的时间的间隔，如果间隔超过了设置的时间，就触发UserEventTrigered方法</li>
</ul>
</li>
<li><p>写事件run方法（即WriteIdleTimeoutTask的run方法）分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> lastWriteTime = IdleStateHandler.<span class="keyword">this</span>.lastWriteTime;</span><br><span class="line">    <span class="keyword">long</span> nextDelay = writerIdleTimeNanos - (ticksInNanos() - lastWriteTime); <span class="keyword">if</span> (nextDelay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Writer is idle - set a new timeout and notify the callback.</span></span><br><span class="line">        writerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, writerIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line">        <span class="keyword">boolean</span> first = firstWriterIdleEvent; firstWriterIdleEvent = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasOutputChanged(ctx, first)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            IdleStateEvent event = newIdleStateEvent(IdleState.WRITER_IDLE, first);</span><br><span class="line">            channelIdle(ctx, event);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ctx.fireExceptionCaught(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Write occurred before the timeout - set a new timeout with shorter delay.</span></span><br><span class="line">        writerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>写任务的run代码逻辑基本和读任务的逻辑是一样的，唯一不同的就是有一个针对出站较慢数据的判断hasOutputChanged</li>
</ul>
</li>
<li><p>所有事件的run方法（即AllIdleTimeoutTask的run方法）分析代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> nextDelay = allIdleTimeNanos; </span><br><span class="line">    <span class="keyword">if</span> (!reading) &#123;</span><br><span class="line">        nextDelay -= ticksInNanos() - Math.max(lastReadTime, lastWriteTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nextDelay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Both reader and writer are idle - set a new timeout and</span></span><br><span class="line">        <span class="comment">// notify the callback.</span></span><br><span class="line">        allIdleTimeout = schedule(ctx, <span class="keyword">this</span>, allIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line">        <span class="keyword">boolean</span> first = firstAllIdleEvent; </span><br><span class="line">        firstAllIdleEvent = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasOutputChanged(ctx, first)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            IdleStateEvent event = newIdleStateEvent(IdleState.ALL_IDLE, first); </span><br><span class="line">            channelIdle(ctx, event);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ctx.fireExceptionCaught(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Either read or write occurred before the timeout - set a new</span></span><br><span class="line">        <span class="comment">// timeout with shorter delay.</span></span><br><span class="line">        allIdleTimeout = schedule(ctx, <span class="keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>表示这个监控着所有的事件，当读写事件发生时，都会记录，代码逻辑和写事件的基本一致</p>
</li>
<li><p>需要大家注意的地方是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> nextDelay = allIdleTimeNanos;</span><br><span class="line"><span class="keyword">if</span> (!reading) &#123;</span><br><span class="line">    <span class="comment">// 当前时间减去 最后一次写或读 的时间 ，若大于 0，说明超时了</span></span><br><span class="line">    nextDelay -= ticksInNanos() - Math.max(lastReadTime, lastWriteTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里的时间计算是取读写事件中的最大值来的，然后像写事件一样，判断是否发生了写的慢的情况</p>
</li>
</ul>
</li>
</ul>
<h5 id="d，小结Netty的心跳机制"><a href="#d，小结Netty的心跳机制" class="headerlink" title="d，小结Netty的心跳机制"></a>d，小结Netty的心跳机制</h5><ul>
<li>IdleStateHandler可以实现心跳功能，当服务器和客户端没有任何读写交互时，并超过了给定的时间，则会触发用户handler的userEventTriggered方法，用户可以在这个方法中尝试向对方发送信息，如果发送失败，则关闭连接</li>
<li>IdleStateHandler的实现基于EventLoop的定时任务，每次读写都会记录一个值，在定时任务运行的时候，通过计算当前时间和设置时间和上次事件发生时间的结果，来判断是否空闲</li>
<li>内部有3个定时任务，分别对应读事件，写事件，读写事件，通常用户监听读写事件就足够了</li>
<li>同时，IdleStateHandler内部也考虑一些极端情况：客户端接收缓慢，一次接收数据的速度超过了设置的空闲时间，Netty通过构造方法中observeOutput属性来决定是否对出站缓冲区的情况进行判断</li>
<li>如果出站缓慢，Netty不认为这是空闲，也就不触发空闲事件，但第一次无论如何也是要触发的，因为第一次无法判断是出站缓慢还是空闲，当然，出站缓慢的话，可能造成OOM，OOM比空闲的问题更大</li>
<li>所以，当你的应用出现了内存溢出，OOM之类，并且写空闲极少发生（使用了observeOutput为true），那么就需要注意是不是数据出站速度过慢</li>
<li>还有一个注意的地方：就是ReadTimeoutHandler，它继承自IdleStateHandler，当触发读空闲事件的时候，就触发<code>ctx.fireExceptionCaught</code>方法，并传入一个ReadTimeoutException，然后关闭Socket</li>
<li>而WriteTimeoutHandler的实现不是基于IdleStateHandler的，他的原理，当调用write方法的时候，会创建一个定时任务，任务内容是根据传入的promise的完成情况来判断是否超出了写的时间。当定时任务根据指定时间开始运行，发现promise的isDone方法返回false，表明还没有写完，说明超时了，则抛出异常，当write方法完成后，会打断定时任务。</li>
</ul>
<h4 id="6，Netty核心组件EventLoop源码剖析"><a href="#6，Netty核心组件EventLoop源码剖析" class="headerlink" title="6，Netty核心组件EventLoop源码剖析"></a>6，Netty核心组件EventLoop源码剖析</h4><h5 id="a，源码剖析目的：-1"><a href="#a，源码剖析目的：-1" class="headerlink" title="a，源码剖析目的："></a>a，源码剖析目的：</h5><p>Echo第一行代码就是：<code>EventLoopGroup bossGroup = new NioEventLoopGroup;</code>下面分析其最核心的组件EventLoop</p>
<h5 id="b，源码剖析-1"><a href="#b，源码剖析-1" class="headerlink" title="b，源码剖析"></a>b，源码剖析</h5><ul>
<li><p>EventLoop介绍：</p>
<p><img src="/2021/07/16/netty/67.png" alt="image-20210725003045275"></p>
<ul>
<li>ScheduleExecutorService接口表示是一个定时任务接口，EventLoop可以接收定时任务</li>
<li>EventLoop接口：Netty接口文档说明该接口作用：一旦Channel注册了，就处理该Channel对应的所有I/O操作</li>
<li>SingleThreadEvetExecutor表示这是一个单个线程的线程池</li>
<li>EventLoop是一个单例的线程池，里面含有一个死循环的线程不断的做着3件事情：监听端口，处理端口事件，处理队列事件。每个EventLoop都可以绑定多个Channel，而每个Channel始终只能由一个EventLoop来处理</li>
</ul>
</li>
<li><p>NioEventLoop的使用——execute方法</p>
<p><img src="/2021/07/16/netty/68.png" alt="image-20210725003732579"></p>
<ul>
<li><p>在EventLoop的使用，一般都是eventloop.execute(task)；看下execute方法的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"task"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> inEventLoop = inEventLoop();</span><br><span class="line">    <span class="keyword">if</span> (inEventLoop) &#123;</span><br><span class="line">        addTask(task);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        startThread();</span><br><span class="line">        addTask(task);</span><br><span class="line">        <span class="keyword">if</span> (isShutdown() &amp;&amp; removeTask(task)) &#123;</span><br><span class="line">            reject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) &#123;</span><br><span class="line">        wakeup(inEventLoop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先判断该EventLoop的线程是否是当前线程，如果是，直接添加到任务队列中去，如果不是，则尝试启动线程（但由于线程是单个的，因此只能启动一次），随后再将任务添加到队列中去</li>
<li>如果线程已经停止，并且删除任务失败，则执行拒绝策略，默认是抛出异常</li>
<li>如果addTaskWakesUp是false，并且任务不是NonWakeupRunable类型，就尝试唤醒selector。这个时候，阻塞在selector的线程就会立即返回</li>
</ul>
</li>
<li><p>addTask和offerTask方法源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addTask</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"task"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!offerTask(task)) &#123;</span><br><span class="line">        reject(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">offerTask</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isShutdown()) &#123;</span><br><span class="line">        reject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> taskQueue.offer(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>NioEventLoop的父类SingleThreadEventExecutor的startThread方法</p>
<ul>
<li><p>当执行execute方法的时候，如果当前线程不是EventLoop所属线程，则尝试启动线程，也就是startThread方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (state == ST_NOT_STARTED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (STATE_UPDATER.compareAndSet(<span class="keyword">this</span>, ST_NOT_STARTED, ST_STARTED)) &#123; </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doStartThread();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable cause) &#123; </span><br><span class="line">                STATE_UPDATER.set(<span class="keyword">this</span>, ST_NOT_STARTED);</span><br><span class="line"></span><br><span class="line">                PlatformDependent.throwException(cause);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>该方法首先判断是否启动过了，保证EventLoop只有一个线程，如果没有启动过，则尝试使用CAS将state状态改为ST_STARTED，也就是已启动，然后调用doStartThread方法，如果失败，则进行回滚</li>
</ul>
</li>
<li><p>doStartThread方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doStartThread</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">            updateLastExecutionTime(); </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                SingleThreadEventExecutor.<span class="keyword">this</span>.run();</span><br><span class="line"></span><br><span class="line">                success = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    <span class="keyword">int</span> oldState = state;</span><br><span class="line">                    <span class="keyword">if</span> (oldState &gt;= ST_SHUTTING_DOWN || STATE_UPDATER.compareAndSet( SingleThreadEventExecutor.<span class="keyword">this</span>, oldState, ST_SHUTTING_DOWN)) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (confirmShutdown()) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        cleanup();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        STATE_UPDATER.set(SingleThreadEventExecutor.<span class="keyword">this</span>, ST_TERMINATED);</span><br><span class="line">                        threadLock.release();</span><br><span class="line">                        terminationFuture.setSuccess(<span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先调用executor的execute方法，这个executor就是在创建EventLoopGroup的时候创建的ThreadPerTaskExecutor类，该execute方法会将Runnable包装成Netty的FastThreadLocalThread</li>
<li>任务中，首先判断线程中断状态，然后设置最后一次的执行时间</li>
<li>执行当前NioEventLoop的run方法，注意：这个方法是个死循环，是整个EventLoop的核心</li>
<li>在finally块中，使用CAS不断修改state状态，改成ST_SHUTTING_DOWN，也就是当线程Loop结束的时候，关闭线程。最后还要死循环确认是否关闭，否则不会break。然后，执行cleanup操作，更新状态为ST_TERMINATED，并释放当前线程锁，如果任务队列不是空，则打印队列中海油多少个未完成的任务。并回调terminationFuture方法</li>
<li>其实最核心的就是EventLoop自身的run方法，再继续深入run方法</li>
</ul>
</li>
</ul>
</li>
<li><p>EventLoop中的Loop是靠run实现的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) &#123;</span><br><span class="line">                <span class="keyword">case</span> SelectStrategy.CONTINUE:</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">case</span> SelectStrategy.SELECT: select(wakenUp.getAndSet(<span class="keyword">false</span>)); <span class="keyword">if</span> (wakenUp.get()) &#123;	</span><br><span class="line">                    selector.wakeup();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">            &#125;</span><br><span class="line">            cancelledKeys = <span class="number">0</span>; needsToSelectAgain = <span class="keyword">false</span>; </span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> ioRatio = <span class="keyword">this</span>.ioRatio; <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    processSelectedKeys();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// Ensure we always run tasks. </span></span><br><span class="line">                    runAllTasks();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> ioStartTime = System.nanoTime(); </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    processSelectedKeys();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// Ensure we always run tasks.</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioTime = System.nanoTime() - ioStartTime; </span><br><span class="line">                    runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleLoopException(t);	</span><br><span class="line">        &#125;	</span><br><span class="line">        <span class="comment">// Always handle shutdown even if the loop processing threw an exception.	</span></span><br><span class="line">        <span class="keyword">try</span> &#123;	</span><br><span class="line">            <span class="keyword">if</span> (isShuttingDown()) &#123;	</span><br><span class="line">                closeAll();	</span><br><span class="line">                <span class="keyword">if</span> (confirmShutdown()) &#123;	</span><br><span class="line">                    <span class="keyword">return</span>;	</span><br><span class="line">                &#125;	</span><br><span class="line">            &#125;	</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;	</span><br><span class="line">            handleLoopException(t);	</span><br><span class="line">        &#125;	</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>从上面的步骤可以看出，整个run方法做了3件事情：</p>
<ul>
<li>select获取感兴趣的事件</li>
<li>processSelectedKeys处理事件</li>
<li>runAllTasks执行队列中的任务</li>
</ul>
</li>
<li><p>上面的三个方法，我们追一下select方法（体现非阻塞）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(<span class="keyword">boolean</span> oldWakenUp)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Selector selector = <span class="keyword">this</span>.selector;		</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> selectCnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> currentTimeNanos = System.nanoTime();</span><br><span class="line">        <span class="keyword">long</span> selectDeadLineNanos = currentTimeNanos + delayNanos(currentTimeNanos); </span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">long</span> timeoutMillis = (selectDeadLineNanos - currentTimeNanos + <span class="number">500000L</span>) / <span class="number">1000000L</span>;</span><br><span class="line">            <span class="keyword">if</span> (timeoutMillis &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (selectCnt == <span class="number">0</span>) &#123; </span><br><span class="line">                    selector.selectNow();</span><br><span class="line">                    selectCnt = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If a task was submitted when wakenUp value was true, the task didn't get a chance to call</span></span><br><span class="line">            <span class="comment">// Selector#wakeup. So we need to check task queue again before executing select operation.</span></span><br><span class="line">            <span class="comment">// If we don't, the task might be pended until select operation was timed out.</span></span><br><span class="line">            <span class="comment">// It might be pended until idle timeout if IdleStateHandler existed in pipeline.</span></span><br><span class="line">            <span class="keyword">if</span> (hasTasks() &amp;&amp; wakenUp.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                selector.selectNow(); selectCnt = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> selectedKeys = selector.select(timeoutMillis);<span class="comment">//否则阻塞给定时间，默认一秒</span></span><br><span class="line">            selectCnt ++;</span><br><span class="line">            <span class="comment">// 如果 1 秒后返回，有返回值 || select 被用户唤醒 || 任务队列有任务 || 有定时任务即将被执行； 则跳出循环</span></span><br><span class="line">            <span class="keyword">if</span> (selectedKeys != <span class="number">0</span> || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) &#123;</span><br><span class="line">                <span class="comment">// - Selected something,</span></span><br><span class="line">                <span class="comment">// - waken up by user, or</span></span><br><span class="line">                <span class="comment">// - the task queue has a pending task.</span></span><br><span class="line">                <span class="comment">// - a scheduled task is ready for processing</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">                <span class="comment">// Thread was interrupted so reset selected keys and break so we not run into a busy loop.</span></span><br><span class="line">                <span class="comment">// As this is most likely a bug in the handler of the user or it's client library we will</span></span><br><span class="line">                <span class="comment">// also log it.</span></span><br><span class="line">                <span class="comment">// See https://github.com/netty/netty/issues/2426</span></span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Selector.select() returned prematurely because "</span> + <span class="string">"Thread.currentThread().interrupt() was called. Use "</span> + <span class="string">"NioEventLoop.shutdownGracefully() to shutdown the NioEventLoop."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                selectCnt = <span class="number">1</span>; </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> time = System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos) &#123;</span><br><span class="line">                <span class="comment">// timeoutMillis elapsed without anything selected.</span></span><br><span class="line">                selectCnt = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SELECTOR_AUTO_REBUILD_THRESHOLD &gt; <span class="number">0</span> &amp;&amp; selectCnt &gt;= SELECTOR_AUTO_REBUILD_THRESHOLD) &#123;</span><br><span class="line">                <span class="comment">// The selector returned prematurely many times in a row.</span></span><br><span class="line">                <span class="comment">// Rebuild the selector to work around the problem. </span></span><br><span class="line">                logger.warn(</span><br><span class="line">                    <span class="string">"Selector.select() returned prematurely &#123;&#125; times in a row; rebuilding Selector &#123;&#125;."</span>,</span><br><span class="line">                    selectCnt, selector);</span><br><span class="line">                rebuildSelector();</span><br><span class="line">                selector = <span class="keyword">this</span>.selector;</span><br><span class="line">                <span class="comment">// Select again to populate selectedKeys. </span></span><br><span class="line">                selector.selectNow();</span><br><span class="line">                selectCnt = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            currentTimeNanos = time;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Selector.select() returned prematurely &#123;&#125; times in a row for Selector &#123;&#125;."</span>, selectCnt - <span class="number">1</span>, selector);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123; </span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(</span><br><span class="line">                CancelledKeyException.class.getSimpleName() + " raised by a Selector &#123;&#125; - JDK bug?",</span><br><span class="line">                selector, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Harmless exception - log anyway</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用selector的select方法，默认阻塞一秒钟，如果有定时任务，则在定时任务剩余时间的基础上在加上0.5秒进行阻塞，当执行execute方法的时候，也就是添加任务的时候，唤醒selector，防止selector阻塞时间过长</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="c，EventLoop作为Netty的核心的运行机制梳理"><a href="#c，EventLoop作为Netty的核心的运行机制梳理" class="headerlink" title="c，EventLoop作为Netty的核心的运行机制梳理"></a>c，EventLoop作为Netty的核心的运行机制梳理</h5><ul>
<li>每次执行execute方法都是向队列中添加任务，当第一次添加时就启动线程，执行run方法，而run方法是整个EventLoop的核心，就像EventLoop的名字一样，Loop，不停的Loop，Loop做什么呢？做3件事：<ul>
<li>调用selector的select方法，默认阻塞一秒钟，如果有定时任务，则在定时任务剩余时间的基础上在加上0.5秒进行阻塞，当执行execute方法的时候，也就是添加任务的时候，唤醒selector，防止selector阻塞时间过长</li>
<li>当selector返回的时候，回调用processSelectedKeys方法对selectKey进行处理</li>
<li>当processSelectedKeys方法执行结束后，则按照ioRatio的比例执行runAllTasks方法，默认是IO任务时间和非IO任务时间是相同的，你也可以根据你的应用特点进行调优。比如非IO任务比较多，那么你就将ioRatio调小一点，这样非IO任务就能执行的长一点，防止队列积攒过多的任务</li>
</ul>
</li>
</ul>
<h4 id="7，handler中加入线程池和Context中添加线程池的源码剖析"><a href="#7，handler中加入线程池和Context中添加线程池的源码剖析" class="headerlink" title="7，handler中加入线程池和Context中添加线程池的源码剖析"></a>7，handler中加入线程池和Context中添加线程池的源码剖析</h4><h5 id="a，源码剖析目的：-2"><a href="#a，源码剖析目的：-2" class="headerlink" title="a，源码剖析目的："></a>a，源码剖析目的：</h5><ul>
<li>在Netty中做耗时的，不可预料的操作，比如数据库，网络请求，会严重影响Netty对Socket的处理速度</li>
<li>而解决犯法就是将耗时任务添加到异步线程中，但就添加线程池这步操作来讲，可以有2种方式，而且这2中方式实现的区别也比较大</li>
<li>处理耗时业务的第一种方式——handler中加入线程池</li>
<li>处理耗时业务的第二种方式——Context中添加线程池</li>
</ul>
<h5 id="b，源码剖析——handler中加入线程池"><a href="#b，源码剖析——handler中加入线程池" class="headerlink" title="b，源码剖析——handler中加入线程池"></a>b，源码剖析——handler中加入线程池</h5><ul>
<li><p>对前面的Netty demo源码进行修改，在EchoServerHandler的channelRead方法进行异步</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Sharable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span>	</span>&#123;	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> EventExecutorGroup group = <span class="keyword">new</span> DefaultEventExecutorGroup(<span class="number">16</span>); </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> UnsupportedEncodingException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Object msgCop = msg;</span><br><span class="line">        <span class="keyword">final</span> ChannelHandlerContext cxtCop = ctx;</span><br><span class="line">        group.submit(<span class="keyword">new</span> Callable&lt;Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line">                ByteBuf buf = (ByteBuf) msgCop;</span><br><span class="line">                <span class="keyword">byte</span>[] req = <span class="keyword">new</span> <span class="keyword">byte</span>[buf.readableBytes()]; buf.readBytes(req);  </span><br><span class="line">                String body = <span class="keyword">new</span> String(req, <span class="string">"UTF-8"</span>); Thread.sleep(<span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">                System.err.println(body + <span class="string">" "</span> + Thread.currentThread().getName()); String reqString = <span class="string">"Hello i am server~~~"</span>;</span><br><span class="line">                ByteBuf resp = Unpooled.copiedBuffer(reqString.getBytes()); cxtCop.writeAndFlush(resp);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(<span class="string">"go	on .."</span>);</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="meta">@Override</span>	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;	</span><br><span class="line">        ctx.flush();	</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="meta">@Override</span>	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> </span>&#123;	</span><br><span class="line">        <span class="comment">// Close the connection when an exception is raised.	</span></span><br><span class="line">        cause.printStackTrace();	</span><br><span class="line">        ctx.close();	</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在channelRead方法，模拟一个耗时10秒的操作，这里我们将这个任务提交到了一个自定义的业务线程池中，这样，就不会阻塞Netty的IO线程</li>
<li><img src="/2021/07/16/netty/69.png" alt="image-20210725101351041"><ul>
<li>解释一下上图，当IO线程轮询到一个socket事件，然后IO线程开始处理，当走到耗时handler的时候，将耗时任务交给业务线程池</li>
<li>当耗时任务执行完毕再执行pipeline write方法的时候，（代码中使用的是context的write方法，上图画的是执行pipeline方法，是一个意思）会将这个任务交给IO线程</li>
</ul>
</li>
</ul>
</li>
<li><p>write方法的源码（在AbstractChannelHandlerContext类）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object msg, <span class="keyword">boolean</span> flush, ChannelPromise promise)</span> </span>&#123; </span><br><span class="line">    AbstractChannelHandlerContext next = findContextOutbound(); </span><br><span class="line">    <span class="keyword">final</span> Object m = pipeline.touch(msg, next);</span><br><span class="line"></span><br><span class="line">    EventExecutor executor = next.executor();</span><br><span class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (flush) &#123;</span><br><span class="line">            next.invokeWriteAndFlush(m, promise);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next.invokeWrite(m, promise);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;	</span><br><span class="line"></span><br><span class="line">        AbstractWriteTask task; <span class="keyword">if</span> (flush) &#123;</span><br><span class="line">            task = WriteAndFlushTask.newInstance(next, m, promise);</span><br><span class="line">        &#125;	<span class="keyword">else</span> &#123;</span><br><span class="line">            task = WriteTask.newInstance(next, m, promise);</span><br><span class="line">        &#125;</span><br><span class="line">        safeExecute(executor, task, promise, m);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当判定下个outbound的executor线程不是当前线程的时候，会将当前的工作封装成task，然后放入mpsc队列中，等待IO任务执行完毕后执行队列中的任务</li>
<li>这里可以Debug来验证（提醒：Debug时，服务器端Debug，客户端run的方式）。当我们使用了<code>group.submit(new Callable&lt;Object&gt;()){}</code>在handler中加入线程池，就会进入到<code>safeExecute(executor,task,promise,m);</code>如果去掉这段代码，而使用普通方式来执行耗时的业务，那么就不会进入到<code>safeExecute(executor,task,promise,m);</code>（说明：普通方式执行耗时代码）</li>
</ul>
</li>
</ul>
<h5 id="c，源码剖析——Context中添加线程池"><a href="#c，源码剖析——Context中添加线程池" class="headerlink" title="c，源码剖析——Context中添加线程池"></a>c，源码剖析——Context中添加线程池</h5><ul>
<li><p>在添加pipeline中的handler时候，添加一个线程池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//属性</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> EventExecutorGroup group = <span class="keyword">new</span> DefaultEventExecutorGroup(<span class="number">16</span>); ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">b.group(bossGroup, workerGroup)</span><br><span class="line">    .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_BACKLOG</span>, 100)	</span></span><br><span class="line"><span class="class">    .<span class="title">handler</span>(<span class="title">new</span> <span class="title">LoggingHandler</span>(<span class="title">LogLevel</span>.<span class="title">INFO</span>))</span></span><br><span class="line"><span class="class">    .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123; </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line">            ChannelPipeline p = ch.pipeline();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sslCtx != <span class="keyword">null</span>) &#123; p.addLast(sslCtx.newHandler(ch.alloc()));</span><br><span class="line">                                &#125;</span><br><span class="line">            <span class="comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span></span><br><span class="line">            <span class="comment">//p.addLast(new EchoServerHandler());</span></span><br><span class="line">            p.addLast(group,<span class="keyword">new</span> EchoServerHandler() );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>handler中的代码就使用普通的方式来处理耗时业务</p>
</li>
<li><p>当我们在调用addLast方法添加线程池后，handler将优先使用这个线程池，如果不添加，将使用IO线程</p>
</li>
<li><p>当走到AbstractChannelHandlerContext的invokeChannelRead方法的时候，executor.inEventLoop()是不会通过的，因为当前线程是IO线程Context也就是Handler的executor是业务线程，所以会异步执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeChannelRead</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next, Object msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, <span class="string">"msg"</span>), next);</span><br><span class="line">    EventExecutor executor = next.executor();</span><br><span class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">        next.invokeChannelRead(m);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123; <span class="comment">//执行 run @Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                next.invokeChannelRead(m);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证时，我们如果去掉<code>p.addLast(group,new EchoServerHandler());</code>改成<code>p.addLast(new EchoServerHandler();</code>你会发现代码不会进入异步执行</p>
</li>
<li><p>后面的整个流程就变成和第一个方式一样了</p>
</li>
</ul>
</li>
</ul>
<h5 id="d，两种方式的比较"><a href="#d，两种方式的比较" class="headerlink" title="d，两种方式的比较"></a>d，两种方式的比较</h5><ul>
<li>第一种方式在handler中添加异步，可能更加的自由，比如如果需要访问数据库，那我就异步，如果不需要，就不异步，异步会拖长接口响应时间，因为需要将任务放进mpscTask中。如果IO时间很短，task很多，可能一个循环下来，都没时间执行整个task，导致响应时间达不到指标</li>
<li>第二种方式是Netty标准方式（即加入到队列），但是，这么做会将整个handler都交给业务线程池，不论耗不耗时，都加入到队列里，不够灵活</li>
<li>各有 优劣，从灵活性考虑，第一种较好</li>
</ul>
<h3 id="十，用Netty自己实现dubboRPC"><a href="#十，用Netty自己实现dubboRPC" class="headerlink" title="十，用Netty自己实现dubboRPC"></a>十，用Netty自己实现dubboRPC</h3><h4 id="1，RPC基本介绍："><a href="#1，RPC基本介绍：" class="headerlink" title="1，RPC基本介绍："></a>1，RPC基本介绍：</h4><ul>
<li><p>RPC（Remote Procedure Call）——远程过程调用 ,是一个计算机通信协议，该协议允许运行于一台计算机的程序调用另一台计算机的子程序，而程序员无需额外地位这个交互作用编程</p>
</li>
<li><p>两个或多个应用程序都分布在不同的服务器上，他们之间的调用都像是本地方法调用一样</p>
<p><img src="/2021/07/16/netty/70.png" alt="image-20210726013531927"></p>
</li>
<li><p>常见的RPC框架有：比较知名的阿里dubbo，google的gRPC，Go语言的rppcx，Apache的thrift，Spring旗下的Spring Cloud</p>
</li>
</ul>
<h4 id="2，RPC调用流程图"><a href="#2，RPC调用流程图" class="headerlink" title="2，RPC调用流程图"></a>2，RPC调用流程图</h4><p><img src="/2021/07/16/netty/71.png" alt="image-20210726013727654"></p>
<ul>
<li>服务消费方（client）以本地调用方式调用服务</li>
<li>client stub 接收到调用后负责将方法，参数等封装成能够进行网络传输的消息体</li>
<li>client stub将消息进行编码并发送到服务端</li>
<li>server stub收到消息后进行解码</li>
<li>server stub根据解码结果调用本地的服务</li>
<li>本地服务执行并将结果返回给server stub</li>
<li>server stub将返回导入结果进行编码并发送至消费方</li>
<li>client stub接收到消息并进行解码</li>
<li>服务消费方（client）得到结果</li>
</ul>
<p>小结：RPC的目标就是将2-8这些步骤都封装起来，用户无需关心这些细节，可以像调用本地方法一样即可完成远程服务调用</p>
<h4 id="3，自己实现dubbO-RPC（基于Netty）"><a href="#3，自己实现dubbO-RPC（基于Netty）" class="headerlink" title="3，自己实现dubbO RPC（基于Netty）"></a>3，自己实现dubbO RPC（基于Netty）</h4><ul>
<li><p>需求说明：</p>
<ul>
<li>dubbo底层使用了Netty作为网络通讯框架，要求用Netty实现一个简单的RPC框架</li>
<li>模仿dubbo，消费者和提供者约定接口和协议，消费者远程调用提供者的服务，提供者返回一个字符串，消费者打印提供者返回的数据。底层网络通信使用Netty</li>
</ul>
</li>
<li><p>设计说明：</p>
<ul>
<li><p>创建一个接口，定义抽象方法，用于消费者和提供者之间的约定</p>
</li>
<li><p>创建一个提供者，该类需要监听消费者的请求，并按照约定返回数据</p>
</li>
<li><p>创建一个消费者，该类需要透明的调用自己不存在的方法，内部需要使用Netty请去提供者返回数据</p>
<p><img src="/2021/07/16/netty/72.png" alt="image-20210726014818683"></p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个是接口，是服务提供方和 服务消费方都需要</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">(String mes)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceImpl</span> <span class="keyword">implements</span> <span class="title">HelloService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//当有消费方调用该方法时， 就返回一个结果</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String mes)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"收到客户端消息="</span> + mes);</span><br><span class="line">        <span class="comment">//根据mes 返回不同的结果</span></span><br><span class="line">        <span class="keyword">if</span>(mes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"你好客户端, 我已经收到你的消息 ["</span> + mes + <span class="string">"] 第"</span> + (++count) + <span class="string">" 次"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"你好客户端, 我已经收到你的消息 "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ServerBootstrap 会启动一个服务提供者，就是 NettyServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerBootstrap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//代码代填..</span></span><br><span class="line">        NettyServer.startServer(<span class="string">"127.0.0.1"</span>, <span class="number">7000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientBootstrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里定义协议头</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String providerName = <span class="string">"HelloService#hello#"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建一个消费者</span></span><br><span class="line">        NettyClient customer = <span class="keyword">new</span> NettyClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建代理对象</span></span><br><span class="line">        HelloService service = (HelloService) customer.getBean(HelloService<span class="class">.<span class="keyword">class</span>, <span class="title">providerName</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;; ) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2</span> * <span class="number">1000</span>);</span><br><span class="line">            <span class="comment">//通过代理对象调用服务提供者的方法(服务)</span></span><br><span class="line">            String res = service.hello(<span class="string">"你好 dubbo~"</span>);</span><br><span class="line">            System.out.println(<span class="string">"调用的结果 res= "</span> + res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startServer</span><span class="params">(String hostName, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        startServer0(hostName,port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//编写一个方法，完成对NettyServer的初始化和启动</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startServer0</span><span class="params">(String hostname, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                    .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line">                                      <span class="meta">@Override</span></span><br><span class="line">                                      <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                          ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                                          pipeline.addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">                                          pipeline.addLast(<span class="keyword">new</span> StringEncoder());</span><br><span class="line">                                          pipeline.addLast(<span class="keyword">new</span> NettyServerHandler()); <span class="comment">//业务处理器</span></span><br><span class="line"></span><br><span class="line">                                      &#125;</span><br><span class="line">                                  &#125;</span><br><span class="line"></span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(hostname, port).sync();</span><br><span class="line">            System.out.println(<span class="string">"服务提供方开始提供服务~~"</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务器这边handler比较简单</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//获取客户端发送的消息，并调用服务</span></span><br><span class="line">        System.out.println(<span class="string">"msg="</span> + msg);</span><br><span class="line">        <span class="comment">//客户端在调用服务器的api 时，我们需要定义一个协议</span></span><br><span class="line">        <span class="comment">//比如我们要求 每次发消息是都必须以某个字符串开头 "HelloService#hello#你好"</span></span><br><span class="line">        <span class="keyword">if</span>(msg.toString().startsWith(ClientBootstrap.providerName)) &#123;</span><br><span class="line"></span><br><span class="line">            String result = <span class="keyword">new</span> HelloServiceImpl().hello(msg.toString().substring(msg.toString().lastIndexOf(<span class="string">"#"</span>) + <span class="number">1</span>));</span><br><span class="line">            ctx.writeAndFlush(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建线程池</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExecutorService executor = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NettyClientHandler client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//编写方法使用代理模式，获取一个代理对象</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; serivceClass, <span class="keyword">final</span> String providerName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> Class&lt;?&gt;[]&#123;serivceClass&#125;, (proxy, method, args) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">                    System.out.println(<span class="string">"(proxy, method, args) 进入...."</span> + (++count) + <span class="string">" 次"</span>);</span><br><span class="line">                    <span class="comment">//&#123;&#125;  部分的代码，客户端每调用一次 hello, 就会进入到该代码</span></span><br><span class="line">                    <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        initClient();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//设置要发给服务器端的信息</span></span><br><span class="line">                    <span class="comment">//providerName 协议头 args[0] 就是客户端调用api hello(???), 参数</span></span><br><span class="line">                    client.setPara(providerName + args[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="keyword">return</span> executor.submit(client).get();</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化客户端</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        client = <span class="keyword">new</span> NettyClientHandler();</span><br><span class="line">        <span class="comment">//创建EventLoopGroup</span></span><br><span class="line">        NioEventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        bootstrap.group(group)</span><br><span class="line">                .channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">TCP_NODELAY</span>, <span class="title">true</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">handler</span>(</span></span><br><span class="line"><span class="class">                        <span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                                pipeline.addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">                                pipeline.addLast(<span class="keyword">new</span> StringEncoder());</span><br><span class="line">                                pipeline.addLast(client);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bootstrap.connect(<span class="string">"127.0.0.1"</span>, <span class="number">7000</span>).sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">Callable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ChannelHandlerContext context;<span class="comment">//上下文</span></span><br><span class="line">    <span class="keyword">private</span> String result; <span class="comment">//返回的结果</span></span><br><span class="line">    <span class="keyword">private</span> String para; <span class="comment">//客户端调用方法时，传入的参数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//与服务器的连接创建后，就会被调用, 这个方法是第一个被调用(1)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">" channelActive 被调用  "</span>);</span><br><span class="line">        context = ctx; <span class="comment">//因为我们在其它方法会使用到 ctx</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到服务器的数据后，调用方法 (4)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">" channelRead 被调用  "</span>);</span><br><span class="line">        result = msg.toString();</span><br><span class="line">        notify(); <span class="comment">//唤醒等待的线程</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//被代理对象调用, 发送数据给服务器，-&gt; wait -&gt; 等待被唤醒(channelRead) -&gt; 返回结果 (3)-》5</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">" call1 被调用  "</span>);</span><br><span class="line">        context.writeAndFlush(para);</span><br><span class="line">        <span class="comment">//进行wait</span></span><br><span class="line">        wait(); <span class="comment">//等待channelRead 方法获取到服务器的结果后，唤醒</span></span><br><span class="line">        System.out.println(<span class="string">" call2 被调用  "</span>);</span><br><span class="line">        <span class="keyword">return</span>  result; <span class="comment">//服务方返回的结果</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//(2)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPara</span><span class="params">(String para)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">" setPara  "</span>);</span><br><span class="line">        <span class="keyword">this</span>.para = para;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/07/16/netty/" data-id="cks69tgb30006iwuaao8w0oo7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/07/28/rocketMQ/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          rocketMQ
        
      </div>
    </a>
  
  
    <a href="/2021/05/29/DynamicProgramming/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Dynamic Programming</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3try-catch%E5%90%97%EF%BC%9F/" rel="tag">你真的了解try-catch吗？</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3try-catch%E5%90%97%EF%BC%9F/" style="font-size: 10px;">你真的了解try-catch吗？</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/08/08/JUC/">JUC</a>
          </li>
        
          <li>
            <a href="/2021/07/28/rocketMQ/">rocketMQ</a>
          </li>
        
          <li>
            <a href="/2021/07/16/netty/">netty</a>
          </li>
        
          <li>
            <a href="/2021/05/29/DynamicProgramming/">Dynamic Programming</a>
          </li>
        
          <li>
            <a href="/2021/05/08/Greedy/">Greedy</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 It-fang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>