<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>It-fang</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A blog for discussing Java background development, which will regularly publish some bloggers in the learning process of their own experience and confusion, I hope that we can learn from each other he">
<meta property="og:type" content="website">
<meta property="og:title" content="It-fang">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="It-fang">
<meta property="og:description" content="A blog for discussing Java background development, which will regularly publish some bloggers in the learning process of their own experience and confusion, I hope that we can learn from each other he">
<meta property="article:author" content="It-fang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="It-fang" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">It-fang</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">It-fang</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-EasyExcel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/28/EasyExcel/" class="article-date">
  <time datetime="2020-09-28T08:55:07.000Z" itemprop="datePublished">2020-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/28/EasyExcel/">EasyExcel</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/28/EasyExcel/" data-id="ckfmaqxg20000kcua8rir0eif" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-MySQL深入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/" class="article-date">
  <time datetime="2020-09-11T12:36:13.629Z" itemprop="datePublished">2020-09-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/">MySQL深入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="MySQL深入"><a href="#MySQL深入" class="headerlink" title="MySQL深入"></a>MySQL深入</h1><h3 id="一，MySQL支持的日期和时间类型"><a href="#一，MySQL支持的日期和时间类型" class="headerlink" title="一，MySQL支持的日期和时间类型"></a>一，MySQL支持的日期和时间类型</h3><p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/mysql%E6%94%AF%E6%8C%81%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B.png" alt="mysql支持日期和时间类型"></p>
<ul>
<li>如果要用来表示年月日，通常用 DATE 来表示</li>
<li>如果要用来表示年月日时分秒，通常用 DATETIME 表示。</li>
<li>如果只用来表示时分秒，通常用 TIME 来表示</li>
<li>如果需要经常插入或者更新日期为当前系统时间，则通常使用 TIMESTAMP 来表示。<br>TIMESTAMP 值返回后显示为“YYYY-MM-DD HH:MM:SS”格式的字符串，显示宽度固定<br>为 19 个字符。如果想要获得数字值，应在 TIMESTAMP 列添加+0。TIMESTAMP还有一个重要特点，就是和时区相关。当插入日期时，会先转换为本地时区后存放；而从数据库里面取出时，也同样需要将日期转换为本地时区后显示。</li>
<li>如果只是表示年份，可以用 YEAR 来表示，它比 DATE 占用更少的空间。YEAR 有 2 位或<br>4 位格式的年。默认是 4 位格式。在 4 位格式中，允许的值是 1901～2155 和 0000。在<br>2 位格式中，允许的值是 70～69，表示从 1970～2069 年。MySQL 以 YYYY 格式显示 YEAR<br>值。</li>
<li>TIMESTAMP和DATETIME的区别：<ul>
<li>TIMESTAMP支持的时间范围较小，其取值范围从19700101080001到2038年的某个<br>时间，而DATETIME是从1000-01-01 00:00:00到9999-12-31 23:59:59，范围更大。</li>
<li>表中的第一个TIMESTAMP列自动设置为系统时间。如果在一个TIMESTAMP列中插入<br>NULL，则该列值将自动设置为当前的日期和时间。在插入或更新一行但不明确给<br>TIMESTAMP列赋值时也会自动设置该列的值为当前的日期和时间，当插入的值超出<br>取值范围时，MySQL认为该值溢出，使用“0000-00-00 00:00:00”进行填补</li>
<li>TIMESTAMP的插入和查询都受当地时区的影响，更能反应出实际的日期。而<br>DATETIME则只能反应出插入时当地的时区，其他时区的人查看数据必然会有误差<br>的</li>
</ul>
</li>
</ul>
<h3 id="二，MySQL支持的字符串类型"><a href="#二，MySQL支持的字符串类型" class="headerlink" title="二，MySQL支持的字符串类型"></a>二，MySQL支持的字符串类型</h3><p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/mysql%E6%94%AF%E6%8C%81%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B.png" alt="mysql支持的字符串类型"></p>
<ul>
<li><p>CHAR和VARCHAR类型的区别：</p>
<ul>
<li>主要区别在于<strong>存储方式</strong>的不同：CHAR 列的长度固定为创建表时声明的长度，长度可以为从 0～255 的任何值；而 VARCHAR 列中的值为可变长字符串，长度可以指定为 0～255（5.0.3 以前）或者65535（5.0.3以后）之间的值。<strong>在检索的时候，CHAR 列删除了尾部的空格，而 VARCHAR 则保留这些空格</strong></li>
</ul>
</li>
<li><p>ENUM类型：</p>
<ul>
<li>出 ENUM 类型是忽略大小写的，对’M’、’f’在存储的时候将它们都转<br>成了大写，还可以看出对于插入不在 ENUM 指定范围内的值时，并没有返回警告，而是插<br>入了 enum(‘M’,’F’)的第一值’M’</li>
<li>ENUM 类型只允许从值集合中选取单个值，而不能一次取多个值</li>
</ul>
</li>
<li><p>SET类型：</p>
<ul>
<li>SET 类型可以从允许值集合中选择任意 1 个或多个元素进行组合，所以对于输入的值只要是<br>在允许值的组合范围内，都可以正确地注入到 SET 类型的列中。</li>
<li>对于超出允许值范围的值例如（’a,d,f’）将不允许注入到上面例子中设置的 SET 类型列中，而对于（’a,d,a’）这样包含重复成员的集合将只取一次，写入后的结果为“a,d”。</li>
</ul>
</li>
</ul>
<h3 id="三，MySQL支持的比较运算符"><a href="#三，MySQL支持的比较运算符" class="headerlink" title="三，MySQL支持的比较运算符"></a>三，MySQL支持的比较运算符</h3><p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/mysql%E6%94%AF%E6%8C%81%E7%9A%84%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6.png" alt="mysql支持的比较运算符"></p>
<ul>
<li>“=”运算符，用于比较运算符两侧的操作数是否相等，如果两侧操作数相等返回值为 1，<br>否则为 0。注意 NULL 不能用于“=”比较。</li>
<li>“&lt;&gt;”运算符，和“=”相反，如果两侧操作数不等，则值为 1，否则为 0。NULL 不能用于“&lt;&gt;”比较</li>
<li>“&lt;=&gt;”安全的等于运算符，和“=”类似，在操作数相等时值为 1，不同之处在于即使<br>操作的值为 NULL 也可以正确比较。</li>
<li>“BETWEEN”运算符的使用格式为“a BETWEEN min AND max”，当 a 大于等于 min 并<br>且小于等于 max，则返回值为 1，否则返回 0；当操作数 a、min、max 类型相同时，此<br>表达式等价于（a&gt;=min and a&lt;=max），当操作数类型不同时，比较时会遵循类型转换原<br>则进行转换后，再进行比较运算。</li>
<li>“IN”运算符的使用格式为“a IN (value1,value2,…)”,当 a 的值存在于列表中时，则整<br>个比较表达式返回的值为 1，否则返回 0。</li>
<li>“REGEXP”运算符的使用格式为“str REGEXP str_pat”,当 str 字符串中含有 str_pat<br>相匹配的字符串时，则返回值为 1，否则返回 0。</li>
</ul>
<h3 id="四，MySQL支持的逻辑运算符"><a href="#四，MySQL支持的逻辑运算符" class="headerlink" title="四，MySQL支持的逻辑运算符"></a>四，MySQL支持的逻辑运算符</h3><p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/mysql%E6%94%AF%E6%8C%81%E7%9A%84%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6.png" alt="mysql支持的逻辑运算符"></p>
<ul>
<li>““NOT”或“！”表示逻辑非。返回和操作数相反的结果：当操作数为 0（假），则返回<br>值为 1，否则值为 0。但是有一点除外，那就是 NOT NULL 的返回值为 NULL。</li>
<li>““AND”或“&amp;&amp;”表示逻辑与运算。当所有操作数均为非零值并且不为 NULL 时，计<br>算所得结果为 1，当一个或多个操作数为 0 时，所得结果为 0，操作数中有任何一个为<br>NULL 则返回值为 NULL。</li>
<li>“OR”或“||”表示逻辑或运算。当两个操作数均为非 NULL 值时，如有任意一个操作<br>数为非零值，则结果为 1，否则结果为 0。当有一个操作数为 NULL 时，如另一个操作<br>数为非零值，则结果为 1，否则结果为 NULL。假如两个操作数均为 NULL，则所得结果<br>为 NULL。</li>
<li>“XOR”表示逻辑异或。当任意一个操作数为 NULL 时，返回值为 NULL。对于非 NULL 的<br>操作数，如果两个的逻辑真假值相异，则返回结果 1；否则返回 0。</li>
</ul>
<h3 id="五，MySQL常用的存储引擎"><a href="#五，MySQL常用的存储引擎" class="headerlink" title="五，MySQL常用的存储引擎"></a>五，MySQL常用的存储引擎</h3><p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/mysql%E5%B8%B8%E7%94%A8%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.png" alt="mysql常用存储引擎"></p>
<ul>
<li><strong>MyISAM（支持全文搜索）</strong>：是MySQL的默认存储引擎，MyISAM不支持事务，也不支持外键；<ul>
<li>优势：访问的速度快，对事务完整性没有要求或者以 SELECT、INSERT 为主的应用基本上都可以使用这个引擎来创建表</li>
<li>MyISAM 类型的表提供修复的工具，可以用 CHECK TABLE 语句来检查 MyISAM 表的健康，并用 REPAIR TABLE 语句修复一个损坏的 MyISAM 表</li>
<li>要指定索引文件和数据文件的路径，需要在创建表的时候通过 DATA DIRECTORY 和 INDEX<br>DIRECTORY 语句指定，也就是说不同 MyISAM 表的索引文件和数据文件可以放置到不同的路<br>径下。文件路径需要是绝对路径，并且具有访问权限。</li>
<li><strong>MyISAM 的表支持 3 种不同的存储格式</strong>：<ul>
<li><strong>静态（固定长度）表</strong>：静态表是默认的存储格式。静态表中的字段都是非变长字段，这样每个记录都是固定长度的，这种存储方式的优点是存储非常迅速，容易缓存，出现故障容易恢复；缺点是占用的空间通常比动态表多。静态表的数据在存储的时候会按照列的宽度定义补足空格，但是在应用访问的时候并不会得到这些空格，这些空格在返回给应用之前已经去掉。</li>
<li><strong>动态表</strong>：动态表中包含变长字段，记录不是固定长度的，这样存储的优点是占用的空间相对较少，但是频繁地更新删除记录会产生碎片，需要定期执行 OPTIMIZE TABLE 语句或 myisamchk -r 命令来改善性能，并且出现故障的时候恢复相对比较困难</li>
<li><strong>压缩表</strong>：压缩表由 myisampack 工具创建，占据非常小的磁盘空间。因为每个记录是被单独压缩的，所以只有非常小的访问开支</li>
</ul>
</li>
</ul>
</li>
<li><strong>InnoDB（支持事务）</strong>：InnoDB 存储引擎提供了具有提交、回滚和崩溃恢复能力的事务安全<ul>
<li>MySQL 支持外键的存储引擎只有 InnoDB，在创建外键的时候，要求父表必须有对应的<br>索引，子表在创建外键的时候也会自动创建对应的索引</li>
<li><strong>InnoDB 存储表和索引有以下两种方式</strong>：<ul>
<li>使用共享表空间存储，这种方式创建的表的表结构保存在.frm 文件中，数据和索引<br>保存在 innodb_data_home_dir 和 innodb_data_file_path 定义的表空间中，可以是<br>多个文件。</li>
<li>使用多表空间存储，这种方式创建的表的表结构仍然保存在.frm 文件中，但是每个<br>表的数据和索引单独保存在.ibd 中。如果是个分区表，则每个分区对应单独的.ibd<br>文件，文件名是“表名+分区名”，可以在创建分区的时候指定每个分区的数据文件<br>的位置，以此来将表的 IO 均匀分布在多个磁盘上。</li>
</ul>
</li>
</ul>
</li>
<li><strong>InnoDB和MyISAM的区别</strong>：<ul>
<li>对于 InnoDB 表，自动增长列必须是索引。如果是组合索引，也必须是组合索引的第一<br>列，但是对于 MyISAM 表，自动增长列可以是组合索引的其他列，这样插入记录后，自动增<br>长列是按照组合索引的前面几列进行排序后递增的</li>
<li>对比 MyISAM的存储引擎，InnoDB 写的处理效率差一些并且会占用更多的磁盘空间以保留数据和索引。</li>
</ul>
</li>
</ul>
<h3 id="六，MySQL的事务控制"><a href="#六，MySQL的事务控制" class="headerlink" title="六，MySQL的事务控制"></a>六，MySQL的事务控制</h3><ul>
<li><strong>MySQL</strong> 是自动提交（Autocommit）的，如果需要通过明确的 Commit 和<br>Rollback 来提交和回滚事务，那么需要通过明确的事务控制命令来开始事务<ul>
<li><strong>START TRANSACTION</strong> 或 <strong>BEGIN</strong> 语句可以开始一项新的事务。如果在锁表期间，用 start transaction 命令开始一个新事务，会造成一个隐含的 unlock<br>tables 被执行</li>
<li><strong>COMMIT</strong> 和 <strong>ROLLBACK</strong> 用来提交或者回滚事务</li>
<li><strong>CHAIN</strong> 和 <strong>RELEASE</strong> 子句分别用来定义在事务提交或者回滚之后的操作，CHAIN 会立<br>即启动一个新事务，并且和刚才的事务具有相同的隔离级别，RELEASE 则会断开和客户端的<br>连接</li>
<li><strong>SET AUTOCOMMIT</strong> 可以修改当前连接的提交方式，如果设置了 SET AUTOCOMMIT=0，<br>则设置之后的所有事务都需要通过明确的命令进行提交或者回滚。</li>
</ul>
</li>
</ul>
<h3 id="七，LOCK-TABLE-和-UNLOCK-TABLE"><a href="#七，LOCK-TABLE-和-UNLOCK-TABLE" class="headerlink" title="七，LOCK TABLE 和 UNLOCK TABLE"></a>七，LOCK TABLE 和 UNLOCK TABLE</h3><ul>
<li><strong>LOCK TABLE</strong>：LOCK TABLES 可以锁定用于当前线程的表。如果表被其他线程锁定，则当前线程会等待，直<br>到可以获取所有锁定为止</li>
<li><strong>UNLOCK TABLE</strong>：UNLOCK TABLES 可以释放当前线程获得的任何锁定。当前线程执行另一个 LOCK TABLES 时，或当与服务器的连接被关闭时，所有由当前线程锁定的表被隐含地解锁；</li>
</ul>
<h3 id="八，MySQL的分布式事务"><a href="#八，MySQL的分布式事务" class="headerlink" title="八，MySQL的分布式事务"></a>八，MySQL的分布式事务</h3><ul>
<li><p>MySQL 从 5.0.3 开始支持分布式事务，当前分布式事务只支持 InnoDB 存储引擎</p>
</li>
<li><p>使用分布式事务的应用程序涉及一个或多个资源管理器和一个事务管理<br>器：</p>
<ul>
<li><strong>资源管理器（RM）</strong>用于提供通向事务资源的途径。数据库服务器是一种资源管理器。<br>该管理器必须可以提交或回滚由 RM 管理的事务。例如，多台 MySQL 数据库作为多台资源<br>管理器或者几台 Mysql 服务器和几台 Oracle 服务器作为资源管理器</li>
<li><strong>事务管理器（TM）</strong>用于协调作为一个分布式事务一部分的事务。TM 与管理每个事务<br>的 RMs 进行通讯。一个分布式事务中各个单个事务均是分布式事务的“分支事务”。分布式<br>事务和各分支通过一种命名方法进行标识</li>
</ul>
</li>
<li><p>用于执行分布式事务的过程使用两个阶段提交，发生时间在由分布式事务的各个分支需要进行的行动已经被执行之后</p>
<ul>
<li>在第一阶段，所有的分支被预备好。即它们被TM告知哟啊准备提交。通常 ，这意味着用于管理分支的每个RM会记录对于被稳定保存的分支的行动。分支指示是否它们可以这么做。这些结果被用于第二阶段。</li>
<li>在第二阶段，TM 告知 RMs 是否要提交或回滚。如果在预备分支时，所有的分支指<br>示它们将能够提交，则所有的分支被告知要提交。如果在预备时，有任何分支指示它将不能<br>提交，则所有分支被告知回滚。</li>
</ul>
</li>
<li><p>分布式事务（XA事务）的SQL语法主要包括：</p>
<p><code>XA {START|BEGOM} xid [JOIN|RESUME]</code></p>
<ul>
<li><p>XA START xid用于启动一个带给定xid值的XA事务。每个XA事务必须有一个唯一的xid值，因此该值当前不能被其他的XA事务使用</p>
</li>
<li><p>xid是一个XA事务标识符，用来唯一标识一个分布式事务。xid值由客户端提供，或由MySQL服务器生成。</p>
</li>
<li><p>xid值包括1~3个部分：</p>
<p><code>xid:gtrid [, bqual [, formatID ]]</code></p>
<ul>
<li><strong>gtrid</strong>是一个分布式事务标识符，相同的分布式事务应该使用相同的 gtrid，这样可以明确知道 xa 事务属于哪个分布式事务</li>
<li><strong>bqual</strong> 是一个分支限定符，默认值是空串。对于一个分布式事务中的每个分支事务，bqual 值必须是唯一的。</li>
<li><strong>formatID</strong> 是一个数字 ，用于标识由 gtrid 和 bqual 值使用的格式，默认值是 1。</li>
</ul>
</li>
<li><p>下面其他XA语法中用到的xid值，都必须和START操作使用的xid值相同，也就是表示对这个启动的XA事务进行操作</p>
<p><code>XA EMD xid [SUSPEND [FOR MIGRATE]]</code></p>
</li>
<li><p>使事务进入PREPARE状态，也就是两阶段提交的第一个提交阶段</p>
<p><code>XA PREPARE xid</code></p>
</li>
<li><p>这两个命令用来提交或者回滚具体的分支事务。也就是两阶段提交的第二个提交阶段，分支事务被实际的提交或者回滚</p>
<p><code>XA COMMIT xid [ONE PHASE]</code></p>
<p><code>XA ROLLBACK xid</code></p>
</li>
<li><p>XA RECOVER 返回当前数据库中处于 PREPARE 状态的分支事务的详细信息。</p>
<p><code>XA RECOVER</code></p>
</li>
</ul>
</li>
</ul>
<h3 id="九，SQL注入"><a href="#九，SQL注入" class="headerlink" title="九，SQL注入"></a>九，SQL注入</h3><ul>
<li>简介：<ul>
<li>SQL Injection就是利用某些数据库的外部接口将用户数据插入到实际的数据库操作语言（SQL）当中，从而达到入侵数据库乃至操作系统给的目的。它的产生主要是由于程序对用户输入的数据没有进行严格的过滤，导致非法数据库查询语句的执行。</li>
</ul>
</li>
<li>应用开发中可以采取的应对措施：<ul>
<li><strong>PrepareStatement+Bind-variable</strong>：对于Java,JSP开发的应用，可以使用PrepareStatement+Bind-variable来防止SQL注入，而尽量不要使用拼接的SQL</li>
<li><strong>使用应用程序提供的转换函数</strong>：很多应用程序接口都提供了对特殊字符进行转换的函数，恰当地使用这些函数，可以防止应用程序用户输入使应用程序生成不期望的语句。</li>
<li><strong>自己定义函数进行校验</strong>：<ul>
<li>输入验证的途径可以分为以下几种：<ul>
<li>整理数据使之变得有</li>
<li>拒绝已知的非法输入；</li>
<li>只接受已知的合法输入</li>
</ul>
</li>
</ul>
</li>
<li>已知非法符：<code>“’”、“;”、“=”、“(”、“)”、“/*”、“*/”、“%”、“+”、“”、“&gt;”、“&lt;”、“--”、“[”、“]”</code><ul>
<li>只需要过滤非法的符号组合就可以阻止已知形式的攻击，并且如果发现更新的攻<br>击符号组合，也可以将这些符号组合增添进来，继续防范新的攻击。特别是空格符号和与其产生相同作用的分隔关键字的符号，例如“/**/”，如果能成功过滤这种符号，那么有很多注入攻击将不能发生，并且同时也要过滤它们的十六进制表示“％XX”。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="十，SQL-Mode-SQL-模式"><a href="#十，SQL-Mode-SQL-模式" class="headerlink" title="十，SQL Mode(SQL 模式)"></a>十，SQL Mode(SQL 模式)</h3><ul>
<li><p>SQL Mode常用来解决下面几类问题：</p>
<ul>
<li>通过设置SQL Mode，可以完成不同严格程序的数据校验，有效地保障数据准确性。</li>
<li>通过设置SQL Mode为ANSI模式，来保证大多数SQL符合标准的SQL语法，这样应用在不同数据库之间进行迁移时，则不需要对业务SQL进行较大的修改。</li>
<li>在不同数据库之间进行数据迁移之前，通过设置SQL Mode可以使MySQL上的数据更方便地迁移到目标数据库中。</li>
</ul>
</li>
<li><p>SQL Mode的命令：</p>
<ul>
<li>查看默认SQL Mode的命令：<code>select @@sql_mode;</code></li>
<li>sql_mode的一种修改方法：<code>SET [SESSION|GLOBAL] sql_mode=&#39;modes&#39;</code>其中SEESION选项表示只在本次连接中生效；而GLOBAL选项表示在本次连接中并不生效，而对于新的连接则生效</li>
<li>sql_mode的另一种修改方法：通过使用<code>--sql-mode=&quot;mode&quot;</code>选项，在MYSQL启动时设置sql_mode</li>
</ul>
</li>
<li><p>SQL Mode的常见功能：</p>
<ul>
<li><strong>校验日期数据合法性</strong>：在ANSI模式下，非法日期可以插入，但是插入值却变为“0000-00-00 00：00：00”，并且系统给出了warning；而在TRADITIONAL模式下，在直接提示日期非法，拒绝插入；</li>
<li><strong>在INSERT或UPDATE过程中，如果SQL MODE处于TRADITIONAL模式，运行MOD(X,0)会产生错误</strong>：因为TRADITIONAL也属于严格模式，在非严格模式下MOD(X,0)返回的结果是NULL，所以在含有MOD的运算中要根据实际情况设定好sql_mode。</li>
<li><strong>启用NO_BACKSLASH_ESCAPES模式，使反斜杠成为普通字符</strong>。在导入数据时，如果数据中含有反斜线字符，启用NO_BACKSLASH_ESCAPES模式保证数据的正确性，是个不错的选择。</li>
<li><strong>启用PIPES_AS_CONCAT模式。将“||”视为字符串连接操作符</strong>，在Oracle等数据库中，“||”被视为字符串的连接操作符，所以，在其他数据库中含有“||”操作符的SQL 在MySQL中将无法执行，为了解决这个问题，MySQL提供了PIPES_AS_CONCAT模式。ANSI模式中包含了PIPES_AS_CONCAT模式，所以默认情况下MySQL新版本支持将“||”视为字符串连接操作符。</li>
</ul>
<p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/sql_mode.png" alt="sql_mode"></p>
<ul>
<li>表格中第一列SQL Mode的值其实都是一些原子模式的组合，类似于角色和权限的关系。这样当实际应用时，只需要设置一个模式组合，就可以设置很多的原子模式，大大方便了用户的工作。</li>
</ul>
<p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/sql_mode%E7%BB%84%E5%90%88.png" alt="sql_mode组合"></p>
<ul>
<li>如果MySQL与其他异构数据库之间有数据迁移的需求的话，那么MySQL中提供的数据库组合模式则会对数据迁移过程中有所帮助。这些模式组合是由很多小的sql_mode组合而成，在异构数据库之间迁移数据时可以尝试使用这些模式来导出适合于目标数据库格式的数据，这样就使得导出数据更容易导入目标数据库。</li>
</ul>
</li>
</ul>
<h3 id="十一，常用SQL技巧和常见问题"><a href="#十一，常用SQL技巧和常见问题" class="headerlink" title="十一，常用SQL技巧和常见问题"></a>十一，常用SQL技巧和常见问题</h3><ul>
<li><p><strong>正则表达式的使用</strong></p>
<p>​    <img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.png" alt="正则表达式"></p>
<ul>
<li>“^”在字符串的开始处进行匹配，返回结果为 1 表示匹配，返回结果为 0 表示不匹配。</li>
<li>“$”在字符串的末尾处进行匹配。</li>
<li>“.”匹配任意单个字符，包括换行符。</li>
<li>“[…]”匹配出括号内的任意字符。</li>
<li>“[ ^.. ]”匹配不出括号内的任意字符。和“[…]”刚好相反。</li>
</ul>
</li>
<li><p><strong>巧用 RAND()提取随机行</strong></p>
<ul>
<li>在MySQL中，产生随机数的方法是RAND()函数。可以利用这个函数与ORDER BY子句一起完成随机抽取某些行的功能。它的原理其实就是ORDER BY RAND()能够把数据随机排序。随机抽取样本对总体的统计具有十分重要的意义，因此这个函数非常有用。</li>
</ul>
</li>
<li><p><strong>利用GROUP BY的WITH ROLLUP子句做统计</strong></p>
<ul>
<li><p>在SQL语句中，使用GROUP BY的WITH ROLLUP字句可以检索出更多的分组聚合信息，它不仅仅能像一般的GROUP BY语句那样检索出各组的聚合信息，还能检索出本组类的整体聚合信息。</p>
<blockquote>
<p>1、当使用 ROLLUP 时, 不能同时使用 ORDER BY 子句进行结果排序。换言之， ROLLUP<br>和 ORDER BY 是互相排斥的</p>
</blockquote>
<blockquote>
<p>2、LIMIT 用在 ROLLUP 后面</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>用 BIT GROUP FUNCTIONS 做统计</strong></p>
<ul>
<li><p>需求：假设该超市只有面包，牛奶，饼干，啤酒4种商品，现只需要记录用户所购买的商品种类，而不需要知道所购买的商品的详细信息。</p>
</li>
<li><p>用一个字段表示顾客购买商品的信息，但是这个字段是数值型的而不是字符型的，该字段存储一个十进制数字，当它转换成二进制的时候，那么每一位代表一种商品，而且如果所在位是“1”那么表示顾客购买了该种商品，“0”表示没有购买该种商品。比如规定数值的第1位代表面包，第2位代表牛奶，第3位代表饼干，第4位代表啤酒</p>
<p>用户购物表</p>
<table>
<thead>
<tr>
<th>id</th>
<th>customer_id</th>
<th>kind</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>5</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>4</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>4</td>
</tr>
</tbody></table>
<p>其中customerid是顾客编号，kind是所购买的商品；</p>
<p>1号顾客购买的商品数值是5和4，转化为二进制分别为0101，0100，表示第一次购买了牛奶和啤酒，第二次购买了牛奶；</p>
<p>2 号顾客购买的商品数值是3和4，转化为二进制分别为0011，0100，表示第一次购买了饼干和啤酒，第二次购买了牛奶。</p>
</li>
<li><p>下面用BIT_OR()函数与GROUP BY子句联合起来，统计这两个顾客在这个超市一共都购买过什么商品</p>
<blockquote>
<p>mysql&gt;select customer_id,bit_or(kind) from order_rab group by customer_id;</p>
<table>
<thead>
<tr>
<th>customer_id</th>
<th>bit_or(kind)</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>5</td>
</tr>
<tr>
<td>2</td>
<td>7</td>
</tr>
</tbody></table>
</blockquote>
<p>1号顾客的BIT_OR()结果是5即0101，表示这个顾客在本超市购买过牛奶和啤酒；</p>
<p>2号顾客的BIT_OR()结果是7即0111，表示这个顾客在本超市购买过牛奶，饼干，啤酒。    </p>
</li>
<li><p>可以用BIT_AND()统计每个顾客每次来本超市都会购买的商品</p>
<blockquote>
<p>mysql&gt;select customer_id,bit_and(kind) from order_rab group by customer_id;</p>
<table>
<thead>
<tr>
<th>customer_id</th>
<th>bit_and(kind)</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>4</td>
</tr>
<tr>
<td>2</td>
<td>0</td>
</tr>
</tbody></table>
</blockquote>
<p>1号顾客的BIT_AND()结果是4即0100，表示1号顾客每次来本超市都会购买牛奶；</p>
<p>2号顾客的BIT_AND()结果是0即0000，表示2号顾客没有每次来本超市都会购买的商品。</p>
</li>
</ul>
</li>
<li><p><strong>数据库名、表名大小写问题</strong></p>
<ul>
<li>在大多数 UNIX 环境中，由于操作系统对大小写的敏感性导致了数据库名和表名对大小写敏感性，所以一般<strong>总是用小写创建并引用数据库名和表名</strong></li>
</ul>
</li>
<li><p><strong>使用外键需要注意的问题</strong></p>
<ul>
<li>在 MySQL 中，InnoDB 存储引擎支持对外部关键字约束条件的检查。而对于其他类型存储引擎的表，当使用 REFERENCES tbl_name(col_name)子句定义列时可以使用外部关键字，但是该子句没有实际的效果，只作为备忘录或注释来提醒用户目前正定义的列指向另一个表中的一个列。</li>
</ul>
</li>
</ul>
<h3 id="十二，优化SQL语句的一般步骤"><a href="#十二，优化SQL语句的一般步骤" class="headerlink" title="十二，优化SQL语句的一般步骤"></a>十二，优化SQL语句的一般步骤</h3><ol>
<li><p><strong>通过show status命令了解各种SQL的执行效率</strong></p>
<p><code>show [session|global] status</code></p>
<ul>
<li><p>通过<code>show [session|global] status</code>命令可以提供服务器状态信息</p>
</li>
<li><p>在操作系统上使用mysqladmin extended-status命令获得服务器状态消息</p>
<blockquote>
<p>show status like “Com_%”</p>
<table>
<thead>
<tr>
<th>Variable_name</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>Com_admin_commands</td>
<td>0</td>
</tr>
<tr>
<td>Com_alter_db</td>
<td>0</td>
</tr>
<tr>
<td>……..</td>
<td></td>
</tr>
</tbody></table>
</blockquote>
</li>
<li><p>Com_xxx表示每个xxx语句执行的次数，我们通常比较关心的是以下几个统计参数：</p>
<ul>
<li><p>Com_select：执行select操作的次数，一次查询只累加1；</p>
</li>
<li><p>Com_insert：执行insert操作的次数，对于批量插入的insert操作，只累加一次。</p>
</li>
<li><p>Com_update：执行update操作的次数。</p>
</li>
<li><p>Com_delete：执行delete操作的次数。</p>
<p>上面这些参数对于所有存储引擎的表操作都会进行累计。下面这几个参数只是针对InnoDB存储引擎的。累加的算法也略有不同；</p>
</li>
<li><p>Innodb_rows_read：select 查询返回的行数</p>
</li>
<li><p>Innodb_rows_inserted：执行 insert操作插入的行数。</p>
</li>
<li><p>__Innodb_rows_updated：执行 UPDATE 操作更新的行数</p>
</li>
<li><p>Innodb_rows_deleted：执行 DELETE 操作删除的行数操作更新的行数</p>
</li>
<li><p>Connections：试图连接 MySQL 服务器的次数</p>
</li>
<li><p>Uptime：服务器工作时间</p>
</li>
<li><p>Slow_queries：慢查询的次数</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>定位执行效率较低的 SQL 语句</strong></p>
<ul>
<li>通过慢查询日志定位那些执行效率较低的 SQL 语句，用–log-slow-queries[=file_name]选项启动时，mysqld 写一个包含所有执行时间超过 long_query_time 秒的 SQL 语句的日志文件。</li>
<li>慢查询日志在查询结束以后才纪录，所以在应用反映执行效率出现问题的时候查询慢查询日志并不能定位问题，可以使用show processlist命令查看当前MySQL在进行的线程，包括线程的状态、是否锁表等，可以实时地查看 SQL 的执行情况，同时对一些锁表操作进行优化</li>
</ul>
</li>
<li><p><strong>通过 EXPLAIN 分析低效 SQL 的执行计划</strong></p>
<ul>
<li><p>​    通过以上步骤查询到效率低的 SQL 语句后，可以通过 EXPLAIN 或者 DESC 命令获取 MySQL<br>如何执行 SELECT 语句的信息，包括在 SELECT 语句执行过程中表如何连接和连接的顺序</p>
<blockquote>
<p>计算 2006 年所有公司的销售额，需要关联 sales 表和 company 表，并且对 moneys 字段<br>做求和（sum）操作，相应 SQL 的执行计划如下：</p>
<p>mysql&gt; explain select sum(moneys) from sales a,company b where a.company_id = b.id and a.year<br>= 2006\G;</p>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*****</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>1.row<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>****</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p>​                    id:1</p>
<p>​    select_type:SIMPLE</p>
<p>​                table:a</p>
<p>​                type:ALL</p>
<p>possible_keys:NULL</p>
<p>​                  key:NULL        </p>
<p>​           key_len:NULL</p>
<p>​                    ref:NULL</p>
<p>​                rows:1000</p>
<p>​                Extra:Using where</p>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*****</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>2.row<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>****</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<pre><code>                 id: 1
select_type: SIMPLE
            table: b
            type: ref</code></pre><p>  possible_keys: ind_company_id</p>
<pre><code>        key: ind_company_id
key_len: 5
        ref: sakila.a.company_id
    rows: 1
    Extra: Using where; Using index</code></pre><p>2 rows in set (0.00 sec)</p>
</blockquote>
<ul>
<li>select_type：表示 SELECT 的类型，常见的取值有 SIMPLE（简单表，即不使用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION（UNION 中的第二个或者后面的查询语句）、SUBQUERY（子查询中的第一个 SELECT）等</li>
<li>table：输出结果集的表。</li>
<li>type：表示表的连接类型，性能由好到差的连接类型为 system（表中仅有一行，即常量表）、const（单表中最多有一个匹配行，例如 primary key 或者 unique index）、eq_ref（对于前面的一行，在此表中只查询一条记录，简单来说，就是多表连接中使用primary key或者unique index）、ref（与eq_ref类似，区别在于不是使用primary key 或者 unique index，而是使用普通的索引）、ref_or_null（与 ref 类似，区别在于条件中包含对 NULL 的查询）、index_merge(索引合并优化)、unique_subquery（in的后面是一个查询主键字段的子查询）、index_subquery（与 unique_subquery 类似，区别在于 in 的后面是查询非唯一索引字段的子查询）、range（单表中的范围查询）、index（对于前面的每一行，都通过查询索引来得到数据）、all（对于前面的每一行，都通过全表扫描来得到数据）。</li>
<li>possible_keys：表示查询时，可能使用的索引。</li>
<li>key：表示实际使用的索引。</li>
<li>key_len：索引字段的长度。</li>
<li>rows：扫描行的数量。</li>
<li>Extra：执行情况的说明和描述</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>确定问题并采取相应的优化措施</strong></p>
<ul>
<li><p>在上面的例子中，已经可以确认是对 a 表的全表扫描导致效率的不理想，那么对 a 表的year 字段创建索引，具体如下：</p>
<blockquote>
<p>mysql&gt; create index ind_sales2_year on sales2(year);</p>
<p>mysql&gt; explain select sum(moneys) from sales2 a,company2 b where a.company_id = b.id and<br>a.year = 2006\G;<br><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong></p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>a</td>
<td>ref</td>
<td>ind_sales2_year</td>
<td>ind_sales2_year</td>
<td>2</td>
<td>const</td>
<td>1</td>
<td>Using where</td>
</tr>
</tbody></table>
<p><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 2. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong></p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>b</td>
<td>ref</td>
<td>ind_company2_id</td>
<td>ind_company2_id</td>
<td>5</td>
<td>sakila.a.company_id</td>
<td>1</td>
<td>Using where; Using index</td>
</tr>
</tbody></table>
<p>2 rows in set (0.00 sec)</p>
</blockquote>
<ul>
<li>发现建立索引后对 a 表需要扫描的行数明显减少（从 1000 行减少到 1 行），可见索引的<br>使用可以大大提高数据库的访问速度，尤其在表很庞大的时候这种优势更为明显。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="索引的使用以及常见问题"><a href="#索引的使用以及常见问题" class="headerlink" title="索引的使用以及常见问题"></a>索引的使用以及常见问题</h2><h3 id="十三，设计索引的原则"><a href="#十三，设计索引的原则" class="headerlink" title="十三，设计索引的原则"></a>十三，设计索引的原则</h3><ul>
<li>​    搜索的索引列，不一定是所要选择的列。换句话说，最适合索引的列是出现在 WHERE<br>子句中的列，或连接子句中指定的列，而不是出现在 SELECT 关键字后的选择列表中的列。</li>
<li>使用惟一索引。考虑某列中值的分布。索引的列的基数越大，索引的效果越好。例<br>如，存放出生日期的列具有不同值，很容易区分各行。而用来记录性别的列，只含有“ M”<br>和“F”，则对此列进行索引没有多大用处，因为不管搜索哪个值，都会得出大约一半的行。</li>
<li>使用短索引。如果对字符串列进行索引，应该指定一个前缀长度，只要有可能就应<br>该这样做。例如，如果有一个 CHAR(200)列，如果在前 10 个或 20 个字符内，多数值是惟一<br>的，那么就不要对整个列进行索引。对前10个或20个字符进行索引能够节省大量索引空间，<br>也可能会使查询更快。较小的索引涉及的磁盘 IO 较少，较短的值比较起来更快。更为重要<br>的是，对于较短的键值，索引高速缓存中的块能容纳更多的键值，因此，MySQL 也可以在<br>内存中容纳更多的值。这样就增加了找到行而不用读取索引中较多块的可能性。</li>
<li>利用最左前缀。在创建一个 n 列的索引时，实际是创建了 MySQL 可利用的 n 个索引。<br>多列索引可起几个索引的作用，因为可利用索引中最左边的列集来匹配行。这样的列集称为<br>最左前缀。</li>
<li>不要过度索引。不要以为索引“越多越好”，什么东西都用索引是错误的。每个额<br>外的索引都要占用额外的磁盘空间，并降低写操作的性能。在修改表的内容时，索引必须进<br>行更新，有时可能需要重构，因此，索引越多，所花的时间越长。如果有一个索引很少利用<br>或从不使用，那么会不必要地减缓表的修改速度。此外，MySQL 在生成一个执行计划时，<br>要考虑各个索引，这也要花费时间。创建多余的索引给查询优化带来了更多的工作。索引太<br>多，也可能会使 MySQL 选择不到所要使用的最好索引。只保持所需的索引有利于查询优化。</li>
<li>对于 InnoDB 存储引擎的表，记录默认会按照一定的顺序保存，如果有明确定义的主<br>键，则按照主键顺序保存。如果没有主键，但是有唯一索引，那么就是按照唯一索引的顺序<br>保存。如果既没有主键又没有唯一索引，那么表中会自动生成一个内部列，按照这个列的顺<br>序保存。按照主键或者内部列进行的访问是最快的，所以 InnoDB 表尽量自己指定主键，当<br>表中同时有几个列都是唯一的，都可以作为主键的时候，要选择最常作为访问条件的列作为<br>主键，提高查询的效率。另外，还需要注意，InnoDB 表的普通索引都会保存主键的键值，<br>所以主键要尽可能选择较短的数据类型，可以有效地减少索引的磁盘占用，提高索引的缓存<br>效果。</li>
</ul>
<h3 id="十四，索引的存储分类"><a href="#十四，索引的存储分类" class="headerlink" title="十四，索引的存储分类"></a>十四，索引的存储分类</h3><ul>
<li><p>MySAM存储引擎的表的数据和索引是自动分开存储的各自是独立的一个文件；</p>
</li>
<li><p>InnoDB存储引擎的表的数据和索引是存储在同一个表空间里面，但可以有多个文件组成</p>
</li>
<li><p>MySQL 中索引的存储类型:</p>
<ul>
<li>BTREE ：MyISAM 和 InnoDB 存储引擎都只支持 BTREE 索引；</li>
<li>HASH：MEMORY/HEAP 存储引擎可以支持 HASH和 BTREE 索引。</li>
</ul>
</li>
</ul>
<h3 id="十五，使用索引"><a href="#十五，使用索引" class="headerlink" title="十五，使用索引"></a>十五，使用索引</h3><ul>
<li><p>需要使用到索引的几种情况：</p>
<ul>
<li><p>对于创建的多列索引，只要查询的条件中用到了最左边的列，索引一般就会被使用，举例说明如下</p>
<blockquote>
<p>mysql&gt; create index ind_sales2_companyid_moneys on sales2(company_id,moneys);</p>
<p>mysql&gt; explain select * from sales2 where company_id = 2006;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>sales2</td>
<td>ref</td>
<td>ind_sales2_companyid_moneys</td>
<td>ind_sales2_companyid_moneys</td>
<td>5</td>
<td>const</td>
<td>1</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>可以发现即便 where 条件中不是用的 company_id 与 moneys 的组合条件，索引仍然能<br>用到，这就是索引的前缀特性。但是如果只按 moneys 条件查询表，那么索引就不会<br>被用到</p>
</blockquote>
</li>
<li><p>对于使用 like 的查询，后面如果是常量并且只有％号不在第一个字符，索引才可能会被使用，来看下面两个执行计划：</p>
<blockquote>
<p>mysql&gt; explain select * from company2 where name like ‘%3’;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>company2</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>1000</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>mysql&gt; explain select * from company2 where name like ‘3%’;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>company2</td>
<td>range</td>
<td>ind_company2_name</td>
<td>ind_company2_name</td>
<td>11</td>
<td>NULL</td>
<td>103</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>可以发现第一个例子没有使用索引，而第二例子就能够使用索引，区别就在于“%”的位置<br>不同，前者把“%”放到第一位就不能用到索引，而后者没有放到第一位就使用了索引。<br>另外，如果如果 like 后面跟的是一个列的名字，那么索引也不会被使用。</p>
</blockquote>
</li>
<li><p>如果对大的文本进行搜索，使用全文索引而不用使用 like ‘%…%’</p>
</li>
<li><p>如果列名是索引，使用 column_name is null 将使用索引。如下例中查询 name 为 null的记录就用到了索引：</p>
<blockquote>
<p>mysql&gt; explain select * from company2 where name is null;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>company2</td>
<td>ref</td>
<td>ind_company2_name</td>
<td>ind_company2_name</td>
<td>11</td>
<td>const</td>
<td>1</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="十六，存在索引但不使用索引"><a href="#十六，存在索引但不使用索引" class="headerlink" title="十六，存在索引但不使用索引"></a>十六，存在索引但不使用索引</h3><ul>
<li><p>在下列情况，虽然存在索引，但是MySQL并不会使用相应的索引：</p>
<ul>
<li><p>如果MySQL估计使用索引比全表扫描更慢，则不使用索引。例如如果列key_part1均匀分布在1和100之间，下列查询中使用索引就不是很好：</p>
<blockquote>
<p>SELECT * FROM table_name where key_part1 &gt; 1 and key_part1 &lt; 90;</p>
</blockquote>
</li>
<li><p>如果使用MEMORY/HEAP表并且where条件中不使用“=”进行索引列，那么不会用到索引。heap表只有在“=”的条件下才会使用索引。</p>
</li>
<li><p>用or分割开的条件，如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及到索引都不会被用到。例如</p>
<blockquote>
<p>mysql&gt; explain select * from sales where year = 2001 or country = ‘China’;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>sales</td>
<td>ALL</td>
<td>ind_sales_year</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>12</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
<p>可见虽然在year这个列上存在索引ind_sales_year，但是这个SQL语句并没有用到这个索引，<br>原因就是 or 中有一个条件中的列没有索引。</p>
</blockquote>
</li>
<li><p>如果不是索引列的第一部分，如下例子：</p>
<blockquote>
<p>mysql&gt; explain select * from sales2 where moneys = 1;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>sales2</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>1000</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
<p>可见虽然在 money 上面建有复合索引，但是由于 money 不是索引的第一列，那么在查询中<br>这个索引也不会被 MySQL 采用。</p>
</blockquote>
</li>
<li><p>如果like是以%开始，例如：</p>
<blockquote>
<p>mysql&gt; explain select * from company2 where name like ‘%3’;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>company2</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>1000</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
<p>可见虽然在 name 上建有索引，但是由于 where 条件中 like 的值的“%”在第一位了，那么<br>MySQL 也不会采用这个索引。</p>
</blockquote>
</li>
<li><p>如果列类型是字符串，那么一定记得在where条件中把字符常量值用引号引起来，否则的话即便这个列上有索引。如下面的例子中company2表中国的name字段是字符型的，但是SQL语句中的条件值294是一个数值型值，因此即便在name上有索引，MySQL也不能正确地用上索引，而是继续进行全表扫描</p>
<blockquote>
<p>mysql&gt; explain select * from company2 where name = 294;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>company2</td>
<td>ALL</td>
<td>ind_company2_name</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>1000</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>mysql&gt; explain select * from company2 where name = ‘294’;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>company2</td>
<td>ref</td>
<td>ind_company2_name</td>
<td>ind_company2_name</td>
<td>23</td>
<td>const</td>
<td>1</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
<p>从上面的例子中可以看到，第一个 SQL 语句中把一个数值型常量赋值给了一个字符型的列<br>name，那么虽然在 name 列上有索引，但是也没有用到；而第二个 SQL 语句就可以正确使<br>用索引。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="十七，查看索引使用情况"><a href="#十七，查看索引使用情况" class="headerlink" title="十七，查看索引使用情况"></a>十七，查看索引使用情况</h3><ul>
<li><p>如果索引正在工作，<strong>Handler_read_key</strong>的值将很高，这个值代表了一个行被索引值读的次数，很低的值表明增加索引得到的性能改善不高，因为索引并不经常使用。</p>
</li>
<li><p><strong>Handler_read_rnd_next</strong>的值高则意味着查询运行低效，并且应该建立索引补救。这个值的含义是在数据文件中毒下一行的请求数。如果正进行大量的表扫描，<strong>Handler_read_rnd_next</strong>的值较高，则通常说明表索引不正确或写入的查询没有利用索引，具体如下：</p>
<blockquote>
<p>mysql&gt; show status like ‘Handler_read%’;</p>
<table>
<thead>
<tr>
<th>Variable_name</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>Handler_read_first</td>
<td>0</td>
</tr>
<tr>
<td>Handler_read_key</td>
<td>5</td>
</tr>
<tr>
<td>Handler_read_next</td>
<td>0</td>
</tr>
<tr>
<td>Handler_read_prev</td>
<td>0</td>
</tr>
<tr>
<td>Handler_read_rnd</td>
<td>0</td>
</tr>
<tr>
<td>Handler_read_rnd_next</td>
<td>2055</td>
</tr>
</tbody></table>
<p>6 rows in set (0.00 sec)</p>
</blockquote>
</li>
</ul>
<h2 id="SQL语句的优化"><a href="#SQL语句的优化" class="headerlink" title="SQL语句的优化"></a>SQL语句的优化</h2><h3 id="十八，两个简单实用的优化方法"><a href="#十八，两个简单实用的优化方法" class="headerlink" title="十八，两个简单实用的优化方法"></a>十八，两个简单实用的优化方法</h3><ul>
<li><p>定期分析表和检查表</p>
<ul>
<li><p>分析表的语法如下：</p>
<blockquote>
<p>ANALYZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name [, tbl_name] ..</p>
<p>本语句用于分析和存储表的关键字分布，分析的结果将可以使得系统得到准确的统计信息，使得SQL能够生成正确的执行计划。如果用户感觉实际执行计划并不是预期的执行计划，执行一次分析表可能会解决问题。在分析期间，使用一个读取锁定对表进行锁定。这对 MyISAM, BDB 和 InnoDB 表有作用。对于 MyISAM 表，本语句与使用 myisamchk -a 相当，下例中对表 sales 做了表分析：</p>
<p>mysql&gt; analyze table sales;</p>
<table>
<thead>
<tr>
<th>Table</th>
<th>Op</th>
<th>Msg_type</th>
<th>Msg_text</th>
</tr>
</thead>
<tbody><tr>
<td>sakila.sales</td>
<td>analyze</td>
<td>status</td>
<td>OK</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
</blockquote>
</li>
<li><p>检查表的语法如下：</p>
<blockquote>
<p>CHECK TABLE tbl_name [, tbl_name] … [option] … option = {QUICK | FAST | MEDIUM | EXTENDED | CHANGED} </p>
<p>检查表的作用是检查一个或多个表是否有错误。CHECK TABLE对MyISAM和InnoDB表有作用。对于MyISAM表，关键字统计数据被更新。例如：</p>
<p>mysql&gt; check table sales;</p>
<table>
<thead>
<tr>
<th>Table</th>
<th>Op</th>
<th>Msg_type</th>
<th>Msg_text</th>
</tr>
</thead>
<tbody><tr>
<td>sakila.sales</td>
<td>check</td>
<td>status</td>
<td>OK</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
</blockquote>
</li>
<li><p>CHECK TABLE 也可以检查视图是否有错误，比如在视图定义中被引用的表已不存在，举例如下。</p>
<blockquote>
<p>（1）首先我们创建一个视图。</p>
<p>mysql&gt; create view sales_view3 as select * from sales3;<br>Query OK, 0 rows affected (0.00 sec)</p>
<p>（2）然后 CHECK 一下该视图，发现没有问题.</p>
<p>mysql&gt; check table sales_view3;</p>
<table>
<thead>
<tr>
<th>Table</th>
<th>Op</th>
<th>Msg_type</th>
<th>Msg_text</th>
</tr>
</thead>
<tbody><tr>
<td>sakila.sales_view3</td>
<td>check</td>
<td>status</td>
<td>OK</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
<p>（3）现在删除掉视图依赖的表。</p>
<p>mysql&gt; drop table sales3;<br>Query OK, 0 rows affected (0.00 sec)</p>
<p>（4）再来 CHECK 一下刚才的视图，发现报错了。</p>
<p>mysql&gt; check table salesview3;</p>
<table>
<thead>
<tr>
<th>Table</th>
<th>Op</th>
<th>Msg_type</th>
<th>Msg_text</th>
</tr>
</thead>
<tbody><tr>
<td>sakila.sales_view3</td>
<td>check</td>
<td>error</td>
<td>View ‘sakila.sales_view3’ references invalid table(s) or column(s) or function(s) <br>or definer/invoker of view lack rights to use them</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
</blockquote>
</li>
</ul>
</li>
<li><p>定期优化表</p>
<ul>
<li><p>优化表的语法如下:</p>
<blockquote>
<p>OPTIMIZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name [, tbl_name] …</p>
<p>如果已经删除了表的一大部分，或者如果已经对含有可变的长度的表（含有VARCHAR,BLOR或TEXT列的表）进行了很多的更改，则应使用OPTIMIZE TABLE命令来进行表优化。这个命令可以将表中的空间碎片进行合并，并且可以消除由于删除或者更新造成的空间浪费，但OPTIMIZE TABLE命令只对MyISAM,BDB和InnoDB表起作用。</p>
<p>以下例子显示了优化表sales的过程：</p>
<p>mysql&gt; optimize table sales;</p>
<table>
<thead>
<tr>
<th>Table</th>
<th>Op</th>
<th>Msg_type</th>
<th>Msg_text</th>
</tr>
</thead>
<tbody><tr>
<td>sakila.sales</td>
<td>optimize</td>
<td>status</td>
<td>OK</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
<p>注意：ANALYZE、CHECK、OPTIMIZE 执行期间将对表进行锁定，因此一定注意要在数据库不<br>繁忙的时候执行相关的操作。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="十九，常用的SQL的优化"><a href="#十九，常用的SQL的优化" class="headerlink" title="十九，常用的SQL的优化"></a>十九，常用的SQL的优化</h3><ul>
<li><p><strong>大批量插入数据</strong></p>
<ul>
<li><p>当用load命令导入数据的时候，适当的设置可以提高导入速度</p>
</li>
<li><p>对于 MyISAM 存储引擎的表，可以通过以下方式快速的导入大量的数据</p>
<blockquote>
<p>ALTER TABLE tbl_name DISABLE KEYS;<br>loading the data<br>ALTER TABLE tbl_name ENABLE KEYS;</p>
<p>DISABLE KEYS 和 ENABLE KEYS 用来打开或者关闭 MyISAM 表非唯一索引的更新。在导入大量的数据到一个非空的 MyISAM 表时，通过设置这两个命令，可以提高导入的效率。对于导入大量数据到一个空的 MyISAM 表，默认就是先导入数据然后才创建索引的，所以不用进行设置。</p>
</blockquote>
</li>
<li><p>以下几种方式提高InnoDB表的导入效率</p>
<ul>
<li>因为 InnoDB 类型的表是按照主键的顺序保存的，所以将导入的数据按照主键的顺序排列，可以有效地提高导入数据的效率。</li>
<li>在导入数据前执行 SET UNIQUE_CHECKS=0，关闭唯一性校验，在导入结束后执行SETUNIQUE_CHECKS=1，恢复唯一性校验，可以提高导入的效率。</li>
<li>如果应用使用自动提交的方式，建议在导入前执行 SET AUTOCOMMIT=0，关闭自动提交，导入结束后再执行 SET AUTOCOMMIT=1，打开自动提交，也可以提高导入的效率。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>优化 INSERT 语句</strong></p>
<ul>
<li><p>如果同时从同一客户插入很多行，尽量使用多个值表的 INSERT 语句，这种方式将大大缩减客户端与数据库之间的连接、关闭等消耗，使得效率比分开执行的单个 INSERT 语句快(在一些情况中几倍)。下面是一次插入多值的一个例子：</p>
<blockquote>
<p>insert into test values(1,2),(1,3),(1,4)…</p>
</blockquote>
</li>
<li><p>如果从不同客户插入很多行，能通过使用 INSERT DELAYED 语句得到更高的速度。DELAYED 的含义是让 INSERT 语句马上执行，其实数据都被放在内存的队列中，并没有真正写入磁盘，这比每条语句分别插入要快的多；LOW_PRIORITY 刚好相反，在所有其他用户对表的读写完后才进行插入；</p>
</li>
<li><p>将索引文件和数据文件分在不同的磁盘上存放（利用建表中的选项）；</p>
</li>
<li><p>如果进行批量插入，可以增加 bulk_insert_buffer_size 变量值的方法来提高速度，但是，这只能对 MyISAM 表使用；</p>
</li>
<li><p>当从一个文本文件装载一个表时，使用 LOAD DATA INFILE。这通常比使用很多 INSERT 语句快 20 倍。</p>
</li>
</ul>
</li>
<li><p><strong>优化 GROUP BY 语句</strong></p>
<ul>
<li><p>如果查询包括 GROUP BY 但用户想要避免排序结果的消耗，则可以指定 ORDER BY NULL禁止排序，如下面的例子：</p>
<blockquote>
<p>mysql&gt; explain select id,sum(moneys) from sales2 group by id;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>sales2</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>1000</td>
<td>Using temporary; Using filesort</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
<p>mysql&gt; explain select id,sum(moneys) from sales2 group by id order by null;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>sales2</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>1000</td>
<td>Using temporary</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>优化ORDER BY语句</strong></p>
<ul>
<li><p>在某些情况中，MySQL 可以使用一个索引来满足 ORDER BY 子句，而不需要额外的排序。WHERE 条件和 ORDER BY 使用相同的索引，并且 ORDER BY 的顺序和索引顺序相同，并且ORDER BY 的字段都是升序或者都是降序。</p>
<blockquote>
<p>下列 SQL 可以使用索引</p>
<p>SELECT * FROM t1 ORDER BY key_part1,key_part2,… ;<br>SELECT * FROM t1 WHERE key_part1=1 ORDER BY key_part1 DESC, key_part2 DESC;<br>SELECT * FROM t1 ORDER BY key_part1 DESC, key_part2 DESC;</p>
<p>但是在以下几种情况下则不使用索引：</p>
<p>SELECT * FROM t1 ORDER BY key_part1 DESC, key_part2 ASC；<br>–order by 的字段混合 ASC 和 DESC<br>SELECT * FROM t1 WHERE key2=constant ORDER BY key1；<br>–用于查询行的关键字与 ORDER BY 中所使用的不相同<br>SELECT * FROM t1 ORDER BY key1, key2；<br>–对不同的关键字使用 ORDER BY：</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>优化嵌套查询</strong></p>
<ul>
<li>MySQL 4.1 开始支持 SQL 的子查询。这个技术可以使用 SELECT 语句来创建一个单列的查询结果，然后把这个结果作为过滤条件用在另一个查询中。使用子查询可以一次性地完成很多逻辑上需要多个步骤才能完成的 SQL 操作，同时也可以避免事务或者表锁死，并且写起来也很容易。但是，有些情况下，子查询可以被更有效率的连接（JOIN）替代。连接（JOIN）之所以更有效率一些，是因为 MySQL 不需要在内存中创建临时表来完成这个逻辑上的需要两个步骤的查询工作。</li>
</ul>
</li>
<li><p><strong>优化 OR 条件</strong></p>
<ul>
<li><p>对于含有 OR 的查询子句，如果要利用索引，则 OR 之间的每个条件列都必须用到索引；如果没有索引，则应该考虑增加索引。</p>
<blockquote>
<p>例如，首先使用 show index 命令查看表 sales2 的索引，可知它有 3 个索引，在 id、year两个字段上分别有 1 个独立的索引，在 company_id 和 year 字段上有 1 个复合索引。可以发现查询正确的用到了索引，并且从执行计划的描述中，发现 MySQL 在处理含有 OR字句的查询时，实际是对 OR 的各个字段分别查询后的结果进行了 UNION。但是当在建有复合索引的列 company_id 和 moneys 上面做 OR 操作的时候，却不能用到索引。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>使用 SQL 提示</strong></p>
<ul>
<li><p>SQL 提示（SQL HINT）是优化数据库的一个重要手段，简单来说就是在 SQL 语句中加入一些<br>人为的提示来达到优化操作的目的。<br>下面是一个使用 SQL 提示的例子：</p>
<blockquote>
<p>SELECT SQL_BUFFER_RESULTS * FROM…</p>
<p>这个语句将强制 MySQL 生成一个临时结果集。只要临时结果集生成后，所有表上的锁<br>定均被释放。这能在遇到表锁定问题时或要花很长时间将结果传给客户端时有所帮助，因为<br>可以尽快释放锁资源。</p>
</blockquote>
</li>
<li><p><strong>USE INDEX</strong></p>
<blockquote>
<p>在查询语句中表名的后面，添加 USE INDEX 来提供希望 MySQL 去参考的索引列表，就可以让 MySQL 不再考虑其他可用的索引。</p>
<p>mysql&gt; explain select * from sales2 use index (ind_sales2_id) where id = 3;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>selcet_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>sales2</td>
<td>ref</td>
<td>ind_sales2_id</td>
<td>ind_sales2_id</td>
<td>5</td>
<td>const</td>
<td>1</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec).</p>
</blockquote>
</li>
<li><p><strong>IGNORE INDEX</strong></p>
<blockquote>
<p>mysql&gt; explain select * from sales2 ignore index (ind_sales2_id) where id = 3;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>selcet_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>sales2</td>
<td>ALL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>NULL</td>
<td>1000</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>1 row in set (0.00 sec)</p>
<p>从执行计划可以看出，系统忽略了指定的索引，而使用了全表扫描。</p>
</blockquote>
</li>
<li><p><strong>FORCE INDEX</strong></p>
<ul>
<li><p>为强制 MySQL 使用一个特定的索引，可在查询中使用 FORCE INDEX 作为 HINT。例如，当不强制使用索引的时候，因为 id 的值都是大于 0 的，因此 MySQL 会默认进行全表扫描，而不使用索引，但是，当使用 FORCE INDEX 进行提示时，即便使用索引的效率不是最高，MySQL 还是选择使用了索引，这是 MySQL 留给用户的一个自行选择执行计划的权力。加入 FORCE INDEX 提示后再次执行上面的 SQL：</p>
<blockquote>
<p>explain select * from sales2 force index (ind_sales2_id) where id &gt; 0 ;</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td>SIMPLE</td>
<td>sales2</td>
<td>range</td>
<td>ind_sales2_id</td>
<td>ind_sales2_id</td>
<td>5</td>
<td>NULL</td>
<td>1000</td>
<td>Using where</td>
</tr>
</tbody></table>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="数据库表对象的优化"><a href="#数据库表对象的优化" class="headerlink" title="数据库表对象的优化"></a>数据库表对象的优化</h2><h3 id="二十，优化数据库对象"><a href="#二十，优化数据库对象" class="headerlink" title="二十，优化数据库对象"></a>二十，优化数据库对象</h3><ul>
<li><p><strong>优化表的数据类型</strong></p>
<ul>
<li><p>在 MySQL 中，可以使用函数 PROCEDURE ANALYSE()对当前应用的表进行分析，该函数可<br>以对数据表中列的数据类型提出优化建议，用户可以根据应用的实际情况酌情考虑是否实施<br>优化。</p>
<blockquote>
<p>以下是函数 PROCEDURE ANALYSE()的使用方法：</p>
<p>SELECT * FROM tbl_name PROCEDURE ANALYSE();</p>
<p>SELECT * FROM tbl_name PROCEDURE ANALYSE(16,256);</p>
<p>输出的每一列信息都会对数据表中的列的数据类型提出优化建议。以上第二个语句告诉PROCEDURE ANALYSE()不要为那些包含的值多于16个或者256字节的ENUM类型提出建议。如果没有这样的限制，输出信息可能很长；ENUM 定义通常很难阅读。</p>
<p>根据 PROCEDURE ANALYSE()函数的输出信息，用户可能会发现，一些表中的字段可以修改为效率更高的数据类型。如果决定改变某个字段的类型，则需要使用 ALTER TABLE 语句，</p>
<p>（1）首先创建测试表 duck_cust，duck_cust 表中记录了客户的一些基本信息：</p>
<p>CREATE TABLE duck_cust(<br>cust_num MEDIUMINT AUTO_INCREMENT, –客户编号<br>cust_title TINYINT, –客户标题号</p>
<p>cust_last CHAR(20) NOT NULL, –客户姓氏<br>cust_first CHAR(15) NOT NULL, –客户名<br>cust_suffix ENUM(‘Jr.’, ‘II’, ‘III’,’IV’, ‘V’, ‘M.D.’,’PhD’), –附加码<br>cust_add1 CHAR(30) NOT NULL, –客户地址<br>cust_add2 CHAR(10), –客户地址<br>cust_city CHAR(18) NOT NULL, –客户所在城市<br>cust_state CHAR(2) NOT NULL, –客户所在州<br>cust_zip1 CHAR(5)NOT NULL, –客户邮编<br>cust_zip2 CHAR(4), –客户邮编<br>cust_duckname CHAR(25) NOT NULL, –客户名称<br>cust_duckbday DATE, –客户生日<br>PRIMARY KEY (cust_num)<br>)TYPE=MyISAM; </p>
<p>（2）然后生成一些测试数据：</p>
<p>INSERT INTO duck_cust VALUES(NULL, 1, ‘Irishlord’, ‘Red’, ‘III’, ‘1022 N.E. Sea of Rye’,<br>‘A207’, ‘Seacouver’, ‘WA’, ‘98601’, ‘3464’, ‘Netrek Rules’, ‘1967:10:21’);<br>INSERT INTO duck_cust VALUES(NULL, 4, ‘Thegreat’, ‘Vicki’, 0, ‘2004 Singleton Dr.’, 0,<br>‘Freedom’, ‘KS’, ‘67209’, ‘4321’, ‘Frida Kahlo de Tomayo’, ‘1948:03:21’);<br>INSERT INTO duck_cust VALUES(NULL, 9, ‘Montgomery’, ‘Chantel’, 0, ‘1567 Terra Cotta Way’,<br>0, ‘Chicago’, ‘IL’, ‘89129’, ‘4444’, ‘Bianca’, ‘1971:07:29’);<br>INSERT INTO duck_cust VALUES(NULL, 7, ‘Robert’, ‘David’, ‘Sr.’, ‘20113 Open Road Highway’,<br>‘#6’, ‘Blacktop’, ‘AZ’, ‘00606’, ‘1952’, ‘Harley’, ‘1949:08:00’);<br>INSERT INTO duck_cust VALUES(NULL, 5, ‘Kazui’, ‘Wonko’, ‘PhD’, ‘42 Cube Farm Lane’,<br>‘Gatehouse’, ‘Vlimpt’, ‘CA’, ‘45362’, 0, ‘Fitzwhistle’, ‘1961:12:04’);<br>INSERT INTO duck_cust VALUES(NULL, 6, ‘Gashlycrumb’, ‘Karen’, 0, ‘3113 Picket Fence Lane’,<br>0, ‘Fedora’, ‘VT’, ‘41927’, ‘5698’, ‘Tess D’’urberville’, ‘1948:08:19’);</p>
<p>desc duck_cust;</p>
<p>+———————-+———————————————-+——–+——-+———-+———+</p>
<p>| Field | Type | Null | Key | Default | Extra |</p>
<p>+———————-+———————————————-+——–+——-+———-+———+| </p>
<p>cust_num | mediumint(9) | | MUL | 0 | || </p>
<p>cust_title | tinyint(4) | YES | | NULL | || cust_last | char(20) | | | | || </p>
<p>cust_first | char(15) | | | | || </p>
<p>cust_suffix | enum(‘Jr.’,’II’,’III’,’IV’,’V’,’M.D.’,’PhD’) | YES | | NULL | || </p>
<p>cust_add1 | char(30) | | | | || cust_add2 | char(10) | YES | | NULL | || </p>
<p>cust_city | char(18) | | | | || </p>
<p>cust_state | char(2) | | | | || </p>
<p>cust_zip1 | char(5) | | | | || </p>
<p>cust_zip2 | char(4) | YES | | NULL | || </p>
<p>cust_duckname | char(25) | | | | |</p>
<p>cust_duckbday | date | YES | | NULL | </p>
<p>+———————-+———————————————-+——–+——-+———-+——–</p>
<p>（3）使用 PROCEDURE ANALYSE()函数确定要优化的列：</p>
<p>mysql&gt;SELECT * FROM duck_cust PROCEDURE ANALYSE();</p>
<table>
<thead>
<tr>
<th>Field_name</th>
<th>Min_value</th>
<th>Max_value</th>
<th>Min_length</th>
<th>Max_length</th>
<th>Empties_or_zeros</th>
<th>Nulls</th>
<th>Avg_value_or_avg_length</th>
<th>Std</th>
<th>Optimal_fieldtype:</th>
</tr>
</thead>
<tbody><tr>
<td>sakila.duck_cust.cust_num</td>
<td>1</td>
<td>6</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>3.5000</td>
<td>1.7078</td>
<td>ENUM(‘1’,’2’,’3’,’4’,’5’,’6’) NOT NULL</td>
</tr>
</tbody></table>
<p>从结果中，可以看到 test.duck_cust.cust_num 列的 Min_length、Max_length、<br>Avg_value_or_avg_length，根据这些统计值,可以对列进行优化，例如，插入的数据最大长度和最小长度都是 1，所以，可以优化字段 cust_num 为 mediumint(2)；同时，上面的结果也给出了优化建议“Optimal_fieldtype: ENUM(‘1’,’2’,’3’,’4’,’5’,’6’) NOT NULL”。看到这个建议读者可能会觉得很奇怪，怎么给出了枚举类型？而不是我们预期的整型。因为这时分析的测试表记录数太少，使得 cust_name 的唯一值太少，因此函数觉得用枚举类型会更合理。如果是对一个大表进行分析，提出的建议会更准确。</p>
<p>根据给出的统计信息和优化建议，可以使用如下语句进行字段类型的更改: </p>
<p>mysql&gt; alter table duck_cust modify cust_num mediumint(2);<br>Query OK, 6 rows affected (0.03 sec)<br>Records: 6 Duplicates: 0 Warnings: 0</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>通过拆分提高表的访问效率</strong></p>
<ul>
<li><p>这里所说的”拆分”，是指对数据表进行拆分。如果针对MyISAM类型的表进行，那么有两种拆分方法。</p>
<ul>
<li><p>第一种方法是垂直拆分，即吧主码和一些列放到一个表，然后把主码和另外的列放到另一个表中。</p>
<blockquote>
<p>如果一个表中某些列常用，而另外一些列不常用，则可以采用垂直拆分，另外垂直拆分可以使得数据行变小，一个数据页就能存放更多的数据，在查询时就会减少I/O次数。其缺点是需要管理冗余列，查询所有数据需要联合（JOIN）操作。</p>
</blockquote>
</li>
<li><p>第二种方法是水平拆分，即根据一列或多列数据的值把数据行放到两个独立的表中。水平拆分通常在以下几种情况下使用：</p>
<ul>
<li><p>表很大，分割后可以降低在查询时需要读的数据和索引的页数，同时也降低了索引的层数，提高查询速度。</p>
</li>
<li><p>表中的数据本来就有独立性，例如，表中分别记录各个地区的数据或不同时期的数据，特别是有些数据常用，而另外一些数据不常用。</p>
</li>
<li><p>需要把数据存放到多个介质上。</p>
<blockquote>
<p>例如，移动电话的账单表就可以分成两个表或多个表。最近 3 个月的账单数据存在一<br>个表中，3 个月前的历史账单存放在另外一个表中，超过 1 年的历史账单可以存储到<br>单独的存储介质上，这种拆分是最常使用的水平拆分方法。</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>水平拆分会给应用增加复杂度，它通常在查询时需要多个表名，查询所有数据需<br>要 UNION 操作。在许多数据库应用中，这种复杂性会超过它带来的优点，因为只要<br>索引关键字不大，则在索引用于查询时，表中增加 2 至 3 倍数据量，查询时也就增加<br>读一个索引层的磁盘次数，所以水平拆分要考虑数据量的增长速度，根据实际情况决<br>定是否需要对表进行水平拆分。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>逆规范化</strong></p>
<ul>
<li><p>因为规范化越高，那么产生的关系就越多，关系过多的直接结果就是导致表之间的连接操作越频繁，而表之间的连接操作是性能较低的操作，直接影响到查询的速度，所以对于查询较多的应用就需要根据实际情况运用逆规范化对数据进行设计，通过逆规范化来提高查询的性能。</p>
<blockquote>
<p>例如，移动电话的用户每月都会查询自己的账单，账单信息一般包含用户的名字和本月消费总金额，设想一下，如果用户的姓名和属性信息存放在一个表中，假设表名为 A，而用户的编号和他对应的账单信息存放在另外一张 B 表中，那么，用户每次查询自己的月账单时，数据库查询时都要进行表连接，因为账单表 B 中并不包含用户的名字，所以必须通过关联 A 表取过来，如果在数据库设计时考虑到这一点，就可以在 B 表增加一个冗余字段存放用户的名字，这样在查询账单时就不用再做表关联，可以使查询有更好的性能。</p>
</blockquote>
</li>
<li><p>反规范的好处是降低连接操作的需求、降低外码和索引的数目，还可能减少表的数目，相应带来的问题是可能出现数据的完整性问题。加快查询速度，但会降低修改速度。因此决定做反规范时，一定要权衡利弊，仔细分析应用的数据存取需求和实际的性能特点，好的索引和其他方法经常能够解决性能问题，而不必采用反规范这种方法</p>
</li>
<li><p>在进行反规范操作之前，要充分考虑数据的存取需求、常用表的大小、一些特殊的计算（例如合计）、数据的物理存储位置等。常用的反规范技术有增加冗余列、增加派生列、重新组表和分割表。</p>
<ul>
<li>增加冗余列：指在多个表中具有相同的列，它常用来在查询时避免连接操作。</li>
<li>增加派生列：指增加的列来自其他表中的数据，由其他表中的数据巾帼计算生成。增加的派生类起作用是在查询时减少连接连接操作，避免使用集函数。</li>
<li>重新组表：指如果许多用户需要查看两个表连接出来的结果数据，则把这两个表重新组成一个表来减少连接而提高性能。</li>
<li>分割表：垂直拆分和水平拆分</li>
</ul>
</li>
<li><p>逆规范技术需要维护数据的完整性。无论使用何种反规范技术，都需要一定的管理来维护数据的完整性。常用的方法是批处理维护，应用逻辑和触发器。</p>
<ul>
<li>批处理维护是指对复制列或派生列的修改积累一定的时间后，运行一批处理作业或存储过程对复制或派生列进行修改，这只能在对实时性要求不高的情况下使用。</li>
<li>数据的完整性也可由应用逻辑来实现，这就要求必须在同一事务中对所有涉及的表进行增，删，改操作。用应用逻辑来实现数据的完整性风险较大，因为同一逻辑必须在所有的应用中使用和维护，容易遗漏，特别是在需求变化时，不易于维护。</li>
<li>另一种方式就是使用触发器，对数据的任何修改立即触发对复制列或派生列的相应修改。触发器是实时的，而且相应的处理逻辑只在一个地方出现，易于维护。一般来说，是解决这类问题比较好的办法。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>使用中间表提高统计查询速度。</strong></p>
<ul>
<li><p>对于数据量较大的表，在其上进行统计查询通常会效率很低，并且还要考虑统计查询是否会对在线的应用产生负面影响。通常在这种情况下，使用中间表可以提高统计查询的效率，下面通过对 session 表的统计来介绍中间表的使用：</p>
<blockquote>
<p>（1）session 表记录了客户每天的消费记录，表结构如下：</p>
<p>CREATE TABLE session (<br>cust_id varchar(10) , –客户编号<br>cust_amount DECIMAL(16,2), –客户消费金额<br>cust_date DATE, –客户消费时间<br>cust_ip varchar(20) –客户 IP 地址<br>)</p>
<p>（2）由于每天都会产生大量的客户消费记录,所以 session 表的数据量很大,现在业务部门有一具体的需求：希望了解最近一周客户的消费总金额和近一周每天不同时段用户的消费总金额。针对这一需求我们通过 2 种方法来得出业务部门想要的结果。</p>
<p>方法1：在session表上直接进行统计，得出想要的结果。</p>
<p>mysql&gt; select sum(cust_amount) from session where cust_date&gt;adddate(now(),-7);</p>
<table>
<thead>
<tr>
<th>sum(cust_amount)</th>
</tr>
</thead>
<tbody><tr>
<td>161699200.64</td>
</tr>
</tbody></table>
<p>方法 2：创建中间表 tmp_session，表结构和源表结构完全相同。</p>
<p>CREATE TABLE tmp_session (<br>cust_id varchar(10) , –客户编号<br>cust_amount DECIMAL(16,2), –客户消费金额<br>cust_date DATE, –客户消费时间<br>cust_ip varchar(20) –客户 IP 地址<br>) ;</p>
<p>转移要统计的数据到中间表,然后在中间表上进行统计，得出想要的结果。</p>
<p>mysql&gt; insert into tmp_session select * from session where cust_date&gt;adddate(now(),-7);<br>Query OK, 1573328 rows affected (6.67 sec)<br>Records: 1573328 Duplicates: 0 Warnings: 0</p>
<p>mysql&gt; select sum(cust_amount) from tmp_session;</p>
<table>
<thead>
<tr>
<th>sum(cust_amount)</th>
</tr>
</thead>
<tbody><tr>
<td>161699200.64</td>
</tr>
</tbody></table>
<p>1 row in set (0.73 sec)</p>
<p>从上面的 2 种实现方法上看,在中间表中做统计花费的时间很少(这里不计算转移数据花费的时间)，另外，针对业务部门想了解“近一周每天不同时段用户的消费总金额”这一需求，在中间表上给出统计结果更为合适,原因是源数据表(session 表) cust_date 字段没有索引并且源表的数据量较大，所以在按时间进行分时段统计时效率很低，这时可以在中间表上对 cust_date 字段创建单独的索引来提高统计查询的速度。</p>
</blockquote>
</li>
<li><p>中间表在统计查询中经常会用到，其优点如下：</p>
<ul>
<li>中间表复制源表部分数据，并且与源表相“隔离”，在中间表上做统计查询不会对在线应用产生负面影响。</li>
<li>中间表上可以灵活的添加索引或增加临时用的新字段，从而达到提高统计查询效率和辅助统计查询作用。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="MySQL的锁"><a href="#MySQL的锁" class="headerlink" title="MySQL的锁"></a>MySQL的锁</h2><h3 id="二十一，MySQL锁概述"><a href="#二十一，MySQL锁概述" class="headerlink" title="二十一，MySQL锁概述"></a>二十一，MySQL锁概述</h3><ul>
<li>相对其他数据库而言，MySQL的锁机制比较简单，其最显著的特点是不同的存储引擎支持不同的锁机制。比如，。比如，MyISAM和MEMORY存储引擎采用的是表级锁（table-level locking）；BDB存储引擎采用的是页面锁（page-level locking），但也支持表级锁；InnoDB存储引擎既支持行级锁（row-level locking），也支持表级锁，但默认情况下是采用行级锁。</li>
<li>MySQL这3种锁的特性可大致归纳如下：<ul>
<li>表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发送锁冲突的概率最高，并发度最低。</li>
<li>行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</li>
<li>页面锁：开销和加锁时间介于表锁和行锁之间：会出现死锁；锁定粒度介于表锁和行锁之间，并发度一般。</li>
<li>仅从锁的角度莱索：表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如Web应用；而行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并发查询的应用，如一些在线事务处理（OLTP）系统。</li>
</ul>
</li>
</ul>
<h3 id="二十二，MyISAM表锁"><a href="#二十二，MyISAM表锁" class="headerlink" title="二十二，MyISAM表锁"></a>二十二，MyISAM表锁</h3><ul>
<li><p>MyISAM 存储引擎只支持表锁，</p>
</li>
<li><p><strong>查询表级锁争用情况</strong></p>
<blockquote>
<p>可以通过检查table_locks_waited和table_lock_immediate状态变量来分析系统上的表锁定争夺：</p>
<p>mysql&gt;show status like ‘table%’;</p>
<table>
<thead>
<tr>
<th>Variable_name</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>Table_locks_immediate</td>
<td>2979</td>
</tr>
<tr>
<td>Table_locks_waited</td>
<td>0</td>
</tr>
</tbody></table>
<p>如果Table_locks_waited的值比较高，则说明存在着较严重的表级锁争用情况。</p>
</blockquote>
</li>
<li><p><strong>MySQL表级锁的锁模式</strong>：表共享读锁（Table Read Lock）和表独占写锁（Table Write Lock）。</p>
<ul>
<li><p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/%E9%94%81%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7.png" alt="锁模式的兼容性"></p>
<blockquote>
<p> 可见，对 MyISAM 表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求；对 MyISAM 表的写操作，则会阻塞其他用户对同一表的读和写操作；MyISAM 表的读操作与写操作之间，以及写操作之间是串行的！根据如表 20-2 所示的例子可以知道，当一个线程获得对一个表的写锁后，只有持有锁的线程可以对表进行更新操作。其他线程的读、写操作都会等待，直到锁被释放为止。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>如何加表级锁</strong></p>
<ul>
<li><p>MyISAN在执行查询语句（SELECT）前，会自动给涉及的所有表加读锁，在执行更行操作（UPDATE、DELETE、INNSERT等）前，会自动给设计的表加写锁，这个过程并不需要用户干预，因此，用户一般不需要直接用LOCK TABLE命令给MyISAM表显式加锁。</p>
</li>
<li><p>给 MyISAM 表显示加锁，一般是为了在一定程度模拟事务操作，实现对某一时间点多个表的一致性读取。</p>
<blockquote>
<p>例如，有一个订单表 orders，其中记录有各订单的总金额 total，同时还有一个订单明细表 order_detail，其中记录有各订单每一产品的金额小计 subtotal，假设我们需要检查这两个表的金额合计是否相符，可能就需要执行如下两条 SQL：</p>
<p>Select sum(total) from orders;<br>Select sum(subtotal) from order_detail;</p>
<p>这时，如果不先给两个表加锁，就可能产生错误的结果，因为第一条语句执行过程中，<br>order_detail 表可能已经发生了改变。因此，正确的方法应该是：</p>
<p>Lock tables orders read local, order_detail read local;<br>Select sum(total) from orders;<br>Select sum(subtotal) from order_detail;<br>Unlock tables;</p>
<p>要特别说明以下两点内容：</p>
<ul>
<li>上面的例子在LOCK TABLES时加了“local”选项，其作用就是在满足MyISAM表并发插入条件的情况下，允许其他用户在表尾并发插入记录。</li>
<li>在用LOCK TABLES给表显式加表锁时，必须同时取得所有涉及到表的锁，并且MySQL不支持升级。也就是说，在执行LOCK TABLES后，只能访问显式加锁的这些表，不能访问未加锁的表；同时，如果加的是读锁，那么只能执行查询操作，而不能执行更新操作。其实，在自动加锁的情况下也基本如此，MyISAM总是一次获得SQL语句所需要的全部锁。这也正是MyISAM表不会出现死锁（Deadlock Free）的原因。</li>
</ul>
<p>当使用LOCK TABLES时，不仅需要一次锁定用到的所有表，而且，同一个表在SQL语句中出现多少次，就要通过与SQL语句中相同的别名表锁定多少次，否则也会出错！举例说明：</p>
<p>（1）对 actor 表获得读锁：</p>
<p>mysql&gt; lock table actor read;<br>Query OK, 0 rows affected (0.00 sec)</p>
<p>（2）但是通过别名访问会提示错误：</p>
<p>mysql&gt; select a.first_name,a.last_name,b.first_name,b.last_name from actor a,actor b where a.first_name = b.first_name and a.first_name = ‘Lisa’ and a.last_name = ‘Tom’ and a.last_name &lt;&gt; b.last_name;<br>ERROR 1100 (HY000): Table ‘a’ was not locked with LOCK TABLES</p>
<p>（3）需要对别名分别锁定：</p>
<p>mysql&gt; lock table actor as a read,actor as b read;<br>Query OK, 0 rows affected (0.00 sec)</p>
<p>（4）按照别名的查询可以正确执行：</p>
<p>mysql&gt; select a.first_name,a.last_name,b.first_name,b.last_name from actor a,actor b where<br>a.first_name = b.first_name and a.first_name = ‘Lisa’ and a.last_name = ‘Tom’ and a.last_name<br>&lt;&gt; b.last_name;</p>
<table>
<thead>
<tr>
<th>first_name</th>
<th>last_name</th>
<th>first_name</th>
<th>last_name</th>
</tr>
</thead>
<tbody><tr>
<td>Lisa</td>
<td>Tom</td>
<td>LISA</td>
<td>MONROE\</td>
</tr>
</tbody></table>
</blockquote>
</li>
</ul>
</li>
<li><p>并发插入（Concurrent Inserts）</p>
<ul>
<li><p>在一定条件下，MyISAM表也支持查询和插入操作的并发进行。</p>
</li>
<li><p>MyISAM存储引擎有一个系统变量concurrent_insert，专门用以控制其并发插入的行为，其值分别可以为0，1或2.</p>
<ul>
<li>当concurrent_insert设置为0时，不允许并发插入。</li>
<li>当concurrent_insert设置为1时，如果MyISAM表中没有空洞（即表的中间没有被删除的行），MyISAM允许在一个进程读表的同时，另一个进程从表尾插入记录。这也是MySQL的默认设置。</li>
<li>当concurrent_insert设置为2时，无论MyISAM表中有没有空洞，都允许在表尾并发插入记录。</li>
</ul>
<blockquote>
<p>可以利用MyISAM存储引擎的并发插入特性，来解决应用中对同一表查询和插入的锁争用。例如，将concurrent_insert系统变量设为2，总是允许并发插入；同时，通过定期在系统空闲时段执行OPTIMIZE TABLE语句来整理空间碎片，收回因删除记录而产生的中间空洞。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>MyISAM的锁调度</p>
<ul>
<li>MyISAM 存储引擎的读锁和写锁是互斥的，读写操作是串行的。那么，一个进程请求某个 MyISAM 表的读锁，同时另一个进程也请求同一表的写锁，MySQL 如何处理呢？答案是写进程先获得锁。不仅如此，即使读请求先到锁等待队列，写请求后到，写锁也会插到读锁请求之前！这是因为 MySQL 认为写请求一般比读请求要重要。这也正是 MyISAM 表不太适合于有大量更新操作和查询操作应用的原因，因为，大量的更新操作会造成查询操作很难获得读锁，从而可能永远阻塞。这种情况有时可能会变得非常糟糕！幸好我们可以通过一些设置来调节 MyISAM 的调度行为。<ul>
<li>通过指定启动参数low-priority-updates,使MyISAM引擎默认给予读请求以优先的权利。</li>
<li>通过执行命令SET LOW_PRIORITY_UPDATES=1,使该连接发出的更新请求优先级降低。</li>
<li>通过指定INSERT、UPDATE、DELETE语句的LOW_PRIORITY属性，降低该语句的优先级。</li>
<li>另外，MySQL也提供了一种折中的办法来调节读写冲突，即给系统参数max_write_lock_count设置一个合适的值，当一个表的读锁达到这个值后，MySQL就暂时将写请求的优先级降低，给读进程一定获得锁的机会。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="二十三，InnoDB锁问题"><a href="#二十三，InnoDB锁问题" class="headerlink" title="二十三，InnoDB锁问题"></a>二十三，InnoDB锁问题</h3><ul>
<li><p>InnoDB与MyISAM的最大不同有两点：一是支持事务（TRANSACTION）;二是采用了行级锁。行级锁与表级锁本来就有许多不同之处。</p>
</li>
<li><p><strong>事务（Transaction）及其ACID属性</strong></p>
<ul>
<li>事务是由一组SQL语句组成的逻辑处理单元，事务具有以下4个属性，通常简称为事务的ACID属性。<ul>
<li><strong>原子性（Atomicity）:</strong>事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。</li>
<li><strong>一致性（Consistent）</strong>:在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性；事务结束时，所有的内部数据结构（如B树索引或双向链表）也都必须是正确的。</li>
<li><strong>隔离性（Isolation）</strong>：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。</li>
<li><strong>持久性（Durable）</strong>:事务完成之后，他对于数据的修改是永久性的 ，即使出现系统故障也能够保持。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>并发事件处理带来的问题</strong></p>
<ul>
<li>相对于串行处理来说，并发事务处理能大大增加数据库资源的利用率，提高数据库系统的事务吞吐量，从而可以支持更多的用户。但并发事务处理也会带来一些问题，主要包括以下几种情况：<ul>
<li><strong>更新丢失（Lost Update）</strong>:当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题——最后的更新覆盖了由其他事务所做的更新。例如，两个编辑人员制作了同一文档的电子副本。每个编辑人员独立地更改其副本，然后保存更改后的副本，这样就覆盖了原始文档。最后保存其更改副本的编辑人员覆盖另一个编辑人员所做的更改。如果在一个编辑人员完成并提交事务之前，另一个编辑人员不能访问同一文件，则可避免次问题</li>
<li><strong>脏读（Dirty Reads）</strong>：一个事务正在对一条记录做修改，在这个事务完成并提交前，这条记录的数据就处于不一致的状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些’脏’数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做“脏读”。</li>
<li><strong>不可重复读（Non-Repeatable Reads）</strong>:一个事务在读取某些数据后的某个时间再次读取以前读过的数据，却发现其读出的数据已经发生了改变，或某些记录已经被删除了！这种现象就叫做“不可重复读”。</li>
<li><strong>幻读（Phantom Reads）</strong>:一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为‘幻读’。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>事务隔离级别</strong></p>
<ul>
<li><p>“更新丢失”通常是应该完全避免的。但防止更新丢失，并不能单靠数据库事务控制器来解决，需要应用程序对要更新的数据加必要的锁来解决，因此，防止更新丢失应该是应用的责任。</p>
</li>
<li><p>“脏读”、“不可重复读”和“幻读”，其实都是数据读一致性问题，必须由数据库提供一定的事务隔离机制来解决。数据库实现事务隔离的方式，基本上可分为以下两种：</p>
<ul>
<li>一种是在读取数据前，对其加锁，阻止其他事务对数据进行修改。</li>
<li>另一种是不用加任何锁，通过一定机制生成一个数据请求时间点来一致性数据快照（Snapshot）,并用这个快照来提供一定级别（语句级或事务级）的一致性读取。从用户的角度来看，好像是数据库可以提供同一数据的多个版本，因此，这种技术叫做数据多版本并发控制（MultiVersion Concurrency Control，简称MVCC或MCC），也经常称为多版本数据库。</li>
</ul>
</li>
<li><p>数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使事务在一定程度上“串行化”进行，这显然与“并发”是矛盾的。同时，不同的应用对读一致性和事务隔离程度的要求也是不同的，比如许多应用对“不可重复读”和“幻读”并不敏感，可能更关心数据并发访问的能力，为了解决“隔离”与“并发”的矛盾，ISO/ANSI SQL92定义了4个事务隔离级别，每个级别的隔离程度不同，允许出现的副作用也不同，应用可以根据自己的业务逻辑要求，通过选择不同的隔离级别来平衡“隔离”与“并发”的矛盾。</p>
<p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/4%E7%A7%8D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E7%9A%84%E6%AF%94%E8%BE%83.png" alt="4种隔离级别的比较"></p>
<p>​    最后要说明的是：各具体数据库并不一定完全实现了上述4个隔离级别，例如，Oracle只提供Read committed和Serializable两个标准隔离级别，另外还提供自己定义的Read only隔离级别；SQL Server除支持上述ISO/ANSI SQL92定义的4个隔离级别外，还支持一个叫做“快照“的隔离级别，但严格来说它是一个用MVCC实现的Serializable隔离级别。MySQL支持全部4个隔离级别，但在具体实现时，有一些特点，比如在一些隔离级别下是采用MVCC一致性读，但某些情况下又不是。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>获取InnoDB行锁争用情况</strong></p>
<ul>
<li><p>可以通过检查InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况：</p>
<blockquote>
<p>mysql&gt;show status like ‘innodb_row_lock%’;</p>
<table>
<thead>
<tr>
<th>Variable_name</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>InnoDB_row_lock_current_waits</td>
<td>0</td>
</tr>
<tr>
<td>InnoDB_row_lock_time</td>
<td>0</td>
</tr>
<tr>
<td>InnoDB_row_lock_time_avg</td>
<td>0</td>
</tr>
<tr>
<td>InnoDB_row_lock_time_max</td>
<td>0</td>
</tr>
<tr>
<td>InnoDB_row_lock_waits</td>
<td>0</td>
</tr>
</tbody></table>
<p>如果发现锁争用比较严重，如InnoDB_row_lock_waits和InnoDB_row_lock_time_avg的值比较高，还可以通过设置InnoDB Monitors来进一步观察发生锁冲突的表，数据行等，并分析锁争用的原因。</p>
<p>具体方法如下：</p>
<p>mysql&gt; CREATE TABLE innodb_monitor(a INT) ENGINE=INNODB;<br>Query OK, 0 rows affected (0.14 sec)</p>
<p>mysql&gt; Show innodb status\G;</p>
<p><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br> Type: InnoDB<br> Name:<br>Status:<br>…</p>
<p>…</p>
<hr>
<p>TRANSACTIONS</p>
<hr>
<p>Trx id counter 0 117472192<br>Purge done for trx’s n:o &lt; 0 117472190 undo n:o &lt; 0 0<br>History list length 17<br>Total number of lock structs in row lock hash table 0<br>LIST OF TRANSACTIONS FOR EACH SESSION:<br>—TRANSACTION 0 117472185, not started, process no 11052, OS thread id 1158191456<br>MySQL thread id 200610, query id 291197 localhost root<br>—TRANSACTION 0 117472183, not started, process no 11052, OS thread id 1158723936<br>MySQL thread id 199285, query id 291199 localhost root<br>Show innodb status<br>…</p>
<p>监视器可以通过发出下列语句来停止查看：</p>
<p>mysql&gt; DROP TABLE innodb_monitor;<br>Query OK, 0 rows affected (0.05 sec)</p>
<p>设置监视器后，在SHOW INNODB STATUS的显示内容中，会有详细的当前锁等待的信息，包括表名，锁类型，锁定记录的情况等，便于进行进一步的分析和问题的确定。打开监视器以后，默认情况下每15秒会向日志中记录监控的内容，如果长时间打开会导致.err文件变得非常的巨大，所以用户在确认问题原因之后，要记得删除监控表以关闭监视器，或者通过使用“–console”选项来启动服务器以关闭写日志文件。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>InnoDB的行锁模式及加锁方法</strong></p>
<ul>
<li><p><strong>共享锁（S）</strong>：允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁。</p>
</li>
<li><p><strong>排他锁（X）</strong>：允许获得排他锁的事务更新数据，阻止其他事务取得相同数据集的共享读锁和排他写锁</p>
<blockquote>
<p>另外，为了允许行锁和表锁共存，实现多粒度锁机制，InnoDB还有两种内部使用的意向锁（IntentionLocks）,这两种意向锁都是表锁。</p>
</blockquote>
</li>
<li><p><strong>意向共享锁（IS）</strong>：事务打算给数据行加行共享锁，事务在给一个数据行加共享锁前必须先取得该表的IS锁。</p>
</li>
<li><p><strong>意向排他锁（IX）</strong>：事务打算给数据行加行排他锁，事务在给一行数据行加排他锁前必须先取得该表的IX锁。</p>
<p><img src="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/InnoDB%E8%A1%8C%E9%94%81%E6%A8%A1%E5%BC%8F%E5%85%BC%E5%AE%B9%E6%80%A7%E5%88%97%E8%A1%A8.png" alt="InnoDB行锁模式兼容性列表"></p>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/" data-id="ckfmaqxhw000dkcua5eui4u20" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Nginx" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/07/Nginx/" class="article-date">
  <time datetime="2020-09-07T14:02:09.629Z" itemprop="datePublished">2020-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/07/Nginx/">Nginx</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="一，概述："><a href="#一，概述：" class="headerlink" title="一，概述："></a>一，概述：</h2><p>Nginx是一款高性能的http服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器。由俄罗斯的程序设计师伊戈尔.西索夫所开发，官方测试nginx能够支撑5万并发链接，并且CPU，内存等资源消耗却非常低，运行非常稳定。</p>
<h2 id="二，Nginx应用场景"><a href="#二，Nginx应用场景" class="headerlink" title="二，Nginx应用场景"></a>二，Nginx应用场景</h2><ul>
<li><strong>http服务器</strong>：Nginx是一个http服务可以独立提供http服务。可以做网页静态服务器。</li>
<li><strong>虚拟主机</strong>：可以实现在一台服务器虚拟出多个网站。例如个人网站使用的虚拟主机</li>
<li><strong>反向代理，负载均衡</strong>：当网站的访问量达到一定程度后，单台服务器不能满足用户的请求时，需要用多台服务器集群可以使用nginx做反向代理。并且多台服务器可以平均分担负载，不会因为某台服务器负载高宕机而某台服务器闲置的情况。</li>
</ul>
<h2 id="三，nginx的配置文件组成"><a href="#三，nginx的配置文件组成" class="headerlink" title="三，nginx的配置文件组成"></a>三，nginx的配置文件组成</h2><ol>
<li><strong>第一部分：全局块</strong>：</li>
</ol>
<ul>
<li>从配置文件开始到events快之间的内容，主要会设置一些影响nginx服务器整体运行的配置指令，主要包括配置运行nginx服务器的用户（组），允许生成的worker process数，进程PID存放路径，日志存放路径和类型以及配置文件的引入等：比如：          worker_processes 1;worker_processes 的值越大，可以支持的并发处理量也越多，但是会受到硬件，软件等设备的制约。</li>
</ul>
<ol start="2">
<li><strong>第二部分：events块</strong>：</li>
</ol>
<ul>
<li>events块涉及的指令主要影响nginx服务器与用户的网络连接，常用的设置包括是否开启对多work process下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型来处理连接请求，每个word process可以同时支持的最大连接数等。比如：worker_connections  1024;就表示每个work process支持的最大连接数为1024。</li>
</ul>
<ol start="3">
<li><p><strong>第三部分：http块</strong>：代理，缓存和日志定义等绝大多数功能和第三方模块的配置都在这里，其包括http全局块，server块；每个http块可以包括多个server块，而每个server块就相当于一个虚拟主机。</p>
<ol>
<li><p><strong>http全局块</strong>：</p>
<ul>
<li>http全局块配置的指令包括文件引入，MIME-TYPE定义，日志自定义，连接超时时间，单链接请求数上限等。</li>
</ul>
</li>
<li><p><strong>server块</strong>：每个server块也分为全局server块，以及可以同时包含多个location块。</p>
<ul>
<li>这块和虚拟主机有密切关系，虚拟主机从用户角度看，和一台独立的硬件主机是完全一样的，该技术的产生是为了节省互联网服务器硬件成本。</li>
</ul>
<ol>
<li><strong>全局server块：</strong><ul>
<li>最常见的配置是本虚拟机主机的监听配置和本虚拟主机的名称或IP配置。    </li>
</ul>
</li>
<li><strong>location块</strong>：<ul>
<li>这块的主要作用是基于nginx服务器接收到的请求字符串（例如server_name/uri-string），对虚拟主机名称（也可以是IP别名）之外的字符串（例如前面的/uri-string）进行匹配，对特定的请求进行处理，地址定向，数据缓存和应答控制等功能，还有许多第三方模块的配置也在这里进行。</li>
<li><strong>location指令说明</strong>：该指令用于匹配URL<ul>
<li><strong>=</strong> ：用于不含正则表达式的uri前，要求请求字符串与uri严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求。</li>
<li><strong>~</strong>：用于表示uri包含正则表达式，并且区分大小写</li>
<li><strong>~*</strong>：用于表示uri包含正则表达式，并且不区分大小写</li>
<li><strong>^~</strong>：用于不含正则表达式的uri前，要求nginx服务器找到标识uri和请求字符串匹配度最高的location后，立即使用此location处理请求，而不再使用location块中的正则uri和请求字符串做匹配。</li>
<li>注意：如果uri包含正则表达式，则必须要有 <strong>~</strong> 或者 <strong>~*</strong> 标识。</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location [&#x3D; | ~ | ~* | ^~] uri&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四，Nginx的常用命令-需要在-usr-local-nginx-sbin目录下使用"><a href="#四，Nginx的常用命令-需要在-usr-local-nginx-sbin目录下使用" class="headerlink" title="四，Nginx的常用命令:需要在/usr/local/nginx/sbin目录下使用"></a>四，Nginx的常用命令:需要在/usr/local/nginx/sbin目录下使用</h2><ul>
<li>开启：./nginx</li>
<li>关闭：</li>
<li>./nginx -s stop（杀死进程，非正常退出）</li>
<li>./nginx -s quit（保存配置后在退出，正常退出）</li>
<li>重新加载：./nginx -s reload</li>
<li>查看版本号：./nginx -v</li>
</ul>
<h2 id="五，静态资源的部署"><a href="#五，静态资源的部署" class="headerlink" title="五，静态资源的部署"></a>五，静态资源的部署</h2><ul>
<li>修改/usr/local/nginx/conf目录下的nginx.conf配置文件<ul>
<li>listen：为访问的端口</li>
<li>server_name：为访问nginx的域名或IP地址</li>
<li>root：为nginx访问静态资源的目录。</li>
<li>index：为访问的资源名称</li>
</ul>
</li>
</ul>
<h2 id="六，nginx的反向代理和负载均衡"><a href="#六，nginx的反向代理和负载均衡" class="headerlink" title="六，nginx的反向代理和负载均衡"></a>六，nginx的反向代理和负载均衡</h2><ol>
<li><strong>反向代理的概念</strong>：反向代理方式是指以代理服务器来接受Internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给Internet上请求连接给的客户端，此时代理服务器对外就表现为一个反向代理服务器。正向代理是针对你的客户端，而反向代理是针对服务器的</li>
<li><strong>反向代理的配置</strong>：在nginx.conf中配置</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcat-travel&#123;</span><br><span class="line">	server 47.92.139.26:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">	listen 80; #默认端口号</span><br><span class="line">	server_name 47.92.139.26; #访问nginx的域名或端口号</span><br><span class="line">	location&#x2F;&#123;</span><br><span class="line">		#root index; #默认访问资源的目录</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;tomcat-travel;</span><br><span class="line">		index index.html index.html; #默认访问资源名称</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>负载均衡</strong>：nginx提供了几种分配方式（策略）</li>
</ol>
<ul>
<li><strong>轮询（默认）</strong>：每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器dwon掉，能自动剔除。</li>
<li><strong>weight</strong>：weight代表权重，默认为1，权重越高被分配的客户端越多，指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcat-travel&#123;</span><br><span class="line">	server 47.92.139.26:8080 weight&#x3D;2;</span><br><span class="line">	server 192.168.177.129:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">	listen 80; #默认端口号</span><br><span class="line">	server_name 47.92.139.26; #访问nginx的域名或端口号</span><br><span class="line">	location&#x2F;&#123;</span><br><span class="line">		#root index; #默认访问资源的目录</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;tomcat-travel;</span><br><span class="line">		index index.html index.html; #默认访问资源名称</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ip_hash</strong>：每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcat-travel&#123;</span><br><span class="line">    ip_hash;</span><br><span class="line"> 	server 47.92.139.26:8080;</span><br><span class="line">	server 192.168.177.129:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>fair（第三方）</strong>：按后端服务器的响应时间分配，响应时间短的优先分配。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcat-travel&#123;</span><br><span class="line">    server 47.92.139.26:8080;</span><br><span class="line">    server 192.168.177.129:8080;</span><br><span class="line">    fair;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="七，nginx的动静分离"><a href="#七，nginx的动静分离" class="headerlink" title="七，nginx的动静分离"></a>七，nginx的动静分离</h2><ol>
<li>动静分离的概念理解：严格意义上说应该是动态请求和静态请求分开，可以理解成使用nginx来处理静态页面，Tomcat来处理动态页面；</li>
<li>动静分离从目前实现角度来讲大致可以分为两种：<ol>
<li>一种是纯粹把静态文件独立成单独的域名，放在独立的服务器上，也是目前主流推崇的方案；</li>
<li>另一种方法就是动态跟静态文件混合在一起发布，通过nginx来分开。</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/07/Nginx/" data-id="ckfmaqxha0003kcuaftv00iuc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-RabbitMQ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/07/RabbitMQ/" class="article-date">
  <time datetime="2020-09-07T09:03:53.331Z" itemprop="datePublished">2020-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/07/RabbitMQ/">RabbitMQ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h1><h2 id="一，MQ的基本概念"><a href="#一，MQ的基本概念" class="headerlink" title="一，MQ的基本概念"></a>一，MQ的基本概念</h2><ul>
<li>MP全称Message Queue（消息队列），是在消息的传输过程中保存消息的容器。多用于分布式系统之间进行通信</li>
</ul>
<h2 id="二，MQ的优势和劣势："><a href="#二，MQ的优势和劣势：" class="headerlink" title="二，MQ的优势和劣势："></a>二，MQ的优势和劣势：</h2><ul>
<li><strong>优势</strong>：</li>
</ul>
<ol>
<li>应用解耦，提升了容错性和可维护性</li>
<li>异步提速，提升用户体验和系统吞吐量（单位时间内处理请求的数目）</li>
<li>削峰填谷，提高系统稳定性</li>
</ol>
<ul>
<li><strong>劣势</strong>：</li>
</ul>
<ol>
<li>系统可用性降低：系统引入的外部依赖越多，系统稳定性越差。一旦MQ宕机，就会对业务造成影响。需要保证MQ的高可用</li>
<li>系统复杂度提高：通过MQ进行异步调用，需要保证消息没有被重复消费，处理消息丢失的情况，保证消息传递的顺序性。</li>
<li>一致性问题：A系统处理完业务，通过MQ给B,C,D三个系统发消息数据，如果B系统，C系统处理成功，D系统处理失败，则需要保证消息数据处理一致。</li>
</ol>
<h2 id="三，MQ使用的业务场景："><a href="#三，MQ使用的业务场景：" class="headerlink" title="三，MQ使用的业务场景："></a>三，MQ使用的业务场景：</h2><ol>
<li>生产者不需要从消费者处获得反馈。引入消息队列之前的直接调用，其接口的返回值应该为空，这才让明明下层的动作还没做，上层却当成动作做完了继续往后走，即所谓异步成为了可能。</li>
<li>容许短暂的不一致性。</li>
<li>确实是用了有效果。即解耦，提速，削峰这些方面的收益，超过加入MQ，管理MQ这些成本。</li>
</ol>
<h2 id="四，RabbitMQ的相关概念："><a href="#四，RabbitMQ的相关概念：" class="headerlink" title="四，RabbitMQ的相关概念："></a>四，RabbitMQ的相关概念：</h2><ol>
<li><strong>Broker</strong>：接收和分发消息的应用，RabbitMQ Server就是Message Broker</li>
<li><strong>Virtual host</strong>：出于多租户和安全因素设计的，把AMQP的基本组件划分到一个虚拟的分组中类似于网络中namespace概念。当多个不同的用户使用同一个RabbitMQ server提供的服务时，可以划分出多个vhost，每个用户在自己的vhost创建exchange/queue等</li>
<li><strong>Connection</strong>：publisher/consumer和broker之间的TCP连接</li>
<li><strong>Channel</strong>：如果每一次访问RabbitMQ都建立一个Connection，在消息量大的时候建立TCP Connection的开销将是巨大的，效率也较低。Channel是在connection内部建立的逻辑连接，如果应用程序支持多线程,通常每个thread创建单独的channel进行通讯，AMQP method包含了channel id帮助客户端和message broker识别channel，所以channel之间是完全隔离的。Channel作为轻量级的Connection极大减少了操作系统建立TCP connection的开销。</li>
<li><strong>Exchange</strong>：message到大broker的第一站，根据分发规则，匹配查询表中的routing key，分发消息到queue中去。常用的类型有：direct（point-to-point），topic（publish-subscribe）and fanout （multicast）</li>
<li><strong>Queue</strong>：消息最终被送到这里等到consumer取走</li>
<li><strong>Bingding</strong>：exchange和queue之间的虚拟连接，binding中可以包含routing key。Bingding信息被保存到exchange中的查询表中，用于message的分发依据。</li>
</ol>
<h2 id="五，RabbitMQ的下载：下载教程"><a href="#五，RabbitMQ的下载：下载教程" class="headerlink" title="五，RabbitMQ的下载：下载教程"></a>五，RabbitMQ的下载：<a href="https://www.cnblogs.com/xwgcxk/p/10309254.html" target="_blank" rel="noopener">下载教程</a></h2><ol>
<li>下载Erlang</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">首先在系统中加入 erlang apt 仓库。</span><br><span class="line">$ wget https:&#x2F;&#x2F;packages.erlang-solutions.com&#x2F;erlang-solutions_1.0_all.deb</span><br><span class="line">$ sudo dpkg -i erlang-solutions_1.0_all.deb</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>修改 Erlang 镜像地址，默认的下载速度特别慢。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vim &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;erlang-solutions.list</span><br><span class="line">把里面默认值替换为</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.liuboping.com&#x2F;erlang&#x2F;ubuntu&#x2F; xenial contrib</span><br><span class="line">接着安装Erlang</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install erlang erlang-nox</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装 RabbitMQ</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">先在系统中加入 rabbitmq apt 仓库，再加入 rabbitmq signing key。</span><br><span class="line">$ echo &#39;deb http:&#x2F;&#x2F;www.rabbitmq.com&#x2F;debian&#x2F; testing main&#39; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;rabbitmq.list</span><br><span class="line">$ wget -O- https:&#x2F;&#x2F;www.rabbitmq.com&#x2F;rabbitmq-release-signing-key.asc | sudo apt-key add -</span><br><span class="line">接着安装RabbitMQ</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install rabbitmq-server</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>启用 RabbitMQ web 管理插件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rabbitmq-plugins enable rabbitmq_management</span><br><span class="line">重启服务器</span><br><span class="line">$ sudo systemctl restart rabbitmq-server</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>修改/usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/ebin/rabbit.app文件【用于修改默认配置，修改密码，配置等等】</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">放开guest用户：loopback_users, [&lt;&lt;&quot;guest&quot;&gt;&gt;]中的尖括号和双引号去掉</span><br></pre></td></tr></table></figure>



<h2 id="六，RabbitMQ的基础架构"><a href="#六，RabbitMQ的基础架构" class="headerlink" title="六，RabbitMQ的基础架构"></a>六，RabbitMQ的基础架构</h2><p><img src="/2020/09/07/RabbitMQ/RabbitMQ%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84.png" alt="RabbitMQ基本架构"></p>
<h2 id="七，RabbitMQ提供了6种工作模式："><a href="#七，RabbitMQ提供了6种工作模式：" class="headerlink" title="七，RabbitMQ提供了6种工作模式："></a>七，RabbitMQ提供了6种工作模式：</h2><ul>
<li><p><strong>简单模式</strong></p>
<p>  <img src="/2020/09/07/RabbitMQ/%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F.png" alt="简单模式"></p>
<ul>
<li><p>P：生产者，也就是要发送消息的程序</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        <span class="comment">//2. 设置参数</span></span><br><span class="line">        factory.setHost(<span class="string">"47.92.139.26"</span>);    <span class="comment">//设置IP地址,默认localhost</span></span><br><span class="line">        factory.setPort(<span class="number">5672</span>);  <span class="comment">// 端口  默认值 5672</span></span><br><span class="line">        factory.setVirtualHost(<span class="string">"/nightwatch"</span>);  <span class="comment">// 虚拟机 默认值/</span></span><br><span class="line">        factory.setUsername(<span class="string">"itfang"</span>); <span class="comment">// 用户名  默认值guest</span></span><br><span class="line">        factory.setPassword(<span class="string">"123456"</span>);  <span class="comment">// 密码  默认值guest</span></span><br><span class="line">        <span class="comment">//3. 创建连接</span></span><br><span class="line">        Connection connection = factory.newConnection();</span><br><span class="line">        <span class="comment">//4. 创建Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//5. 创建队列Queue</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        参数:</span></span><br><span class="line"><span class="comment">            1. queue:队列名称</span></span><br><span class="line"><span class="comment">            2. durable:是否持久化,当mq重启之后还在</span></span><br><span class="line"><span class="comment">            3. exclusive:</span></span><br><span class="line"><span class="comment">                * 是否独占,只能有一个消费者监听这个队列</span></span><br><span class="line"><span class="comment">                * 当Connection关闭时,是否删除队列</span></span><br><span class="line"><span class="comment">            4. autoDelete:是否自动删除,当没有Consumer时,自动删除</span></span><br><span class="line"><span class="comment">            5. arguments:参数。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//如果没有一个名字叫hello_world的队列,则会创建该队列,如果有则不会创建</span></span><br><span class="line">        channel.queueDeclare(<span class="string">"hello_world"</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//6. 发送消息</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        basicPublish(String exchange, String routingKey, BasicProperties props, byte[] body)</span></span><br><span class="line"><span class="comment">        参数:</span></span><br><span class="line"><span class="comment">            1. exchange:交换机名称,简单模式下交换机会使用默认的""</span></span><br><span class="line"><span class="comment">            2. routingKey:路由名称</span></span><br><span class="line"><span class="comment">            3. props:配置信息</span></span><br><span class="line"><span class="comment">            4. body:发送消息数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String body = <span class="string">"hello_rabbitmq"</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">""</span>,<span class="string">"hello_world"</span>,<span class="keyword">null</span>,body.getBytes());</span><br><span class="line">        <span class="comment">//7. 释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
<pre><code>- C：消费者，消息的接收者，会一直在等待消息到来。

    <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        <span class="comment">//2. 设置参数</span></span><br><span class="line">        factory.setHost(<span class="string">"47.92.139.26"</span>);    <span class="comment">//设置IP地址,默认localhost</span></span><br><span class="line">        factory.setPort(<span class="number">5672</span>);  <span class="comment">// 端口  默认值 5672</span></span><br><span class="line">        factory.setVirtualHost(<span class="string">"/nightwatch"</span>);  <span class="comment">// 虚拟机 默认值/</span></span><br><span class="line">        factory.setUsername(<span class="string">"itfang"</span>); <span class="comment">// 用户名  默认值guest</span></span><br><span class="line">        factory.setPassword(<span class="string">"123456"</span>);  <span class="comment">// 密码  默认值guest</span></span><br><span class="line">        <span class="comment">//3. 创建连接</span></span><br><span class="line">        Connection connection = factory.newConnection();</span><br><span class="line">        <span class="comment">//4. 创建Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//5. 创建队列Queue</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        参数:</span></span><br><span class="line"><span class="comment">            1. queue:队列名称</span></span><br><span class="line"><span class="comment">            2. durable:是否持久化,当mq重启之后还在</span></span><br><span class="line"><span class="comment">            3. exclusive:</span></span><br><span class="line"><span class="comment">                * 是否独占,只能有一个消费者监听这个队列</span></span><br><span class="line"><span class="comment">                * 当Connection关闭时,是否删除队列</span></span><br><span class="line"><span class="comment">            4. autoDelete:是否自动删除,当没有Consumer时,自动删除</span></span><br><span class="line"><span class="comment">            5. arguments:参数。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//如果没有一个名字叫hello_world的队列,则会创建该队列,如果有则不会创建</span></span><br><span class="line">        channel.queueDeclare(<span class="string">"hello_world"</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//6. 接收消息</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment">            参数:</span></span><br><span class="line"><span class="comment">                1. queue：队列名称</span></span><br><span class="line"><span class="comment">                2. autoAck：是否自动确认</span></span><br><span class="line"><span class="comment">                3. callback：回调对象</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        com.rabbitmq.client.Consumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                回调方法,当收到消息后,会自动执行该方法</span></span><br><span class="line"><span class="comment">                1. consumerTag：标识</span></span><br><span class="line"><span class="comment">                2. envelope：获取一些信息,交换机,路由器ey...</span></span><br><span class="line"><span class="comment">                3. properties：配置信息</span></span><br><span class="line"><span class="comment">                4. body：数据</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"consumerTag:"</span>+consumerTag);</span><br><span class="line">                System.out.println(<span class="string">"Exchange:"</span>+envelope.getExchange());</span><br><span class="line">                System.out.println(<span class="string">"RoutingKey:"</span>+envelope.getRoutingKey());</span><br><span class="line">                System.out.println(<span class="string">"properties:"</span>+properties);</span><br><span class="line">                System.out.println(<span class="string">"body:"</span>+<span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(<span class="string">"hello_world"</span>,<span class="keyword">true</span>,consumer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//消费者不要关闭资源</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



- queue：消息队列，类似一个邮箱，可以缓存消息；生产者其中投递消息，消费者从其中取出消息。</code></pre><ul>
<li><p><strong>work queues</strong> </p>
<p>  <img src="/2020/09/07/RabbitMQ/workqueue.png" alt="workqueue"></p>
<ul>
<li>与简单模式相比，多了一个或一些消费端，多个消费端共同消费同一个队列中的消息。</li>
<li>在一个队列中如果有多个消费者，那么消费者之间对于同一个消息的关系是竞争的关系。</li>
<li>应用场景：对于人物过重或人物较多情况使用工作队列可以提高任务处理的速度。例如：短信服务部署多个只需要有一个节点成功发送即可。</li>
</ul>
</li>
<li><p><strong>Publish/Subscribe发布与订阅模式</strong></p>
<p>  <img src="/2020/09/07/RabbitMQ/%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F.png" alt="订阅模式"></p>
<ul>
<li><p>P：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer_PubSub</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        <span class="comment">//2. 设置参数</span></span><br><span class="line">        factory.setHost(<span class="string">"47.92.139.26"</span>);    <span class="comment">//设置IP地址,默认localhost</span></span><br><span class="line">        factory.setPort(<span class="number">5672</span>);  <span class="comment">// 端口  默认值 5672</span></span><br><span class="line">        factory.setVirtualHost(<span class="string">"/nightwatch"</span>);  <span class="comment">// 虚拟机 默认值/</span></span><br><span class="line">        factory.setUsername(<span class="string">"itfang"</span>); <span class="comment">// 用户名  默认值guest</span></span><br><span class="line">        factory.setPassword(<span class="string">"123456"</span>);  <span class="comment">// 密码  默认值guest</span></span><br><span class="line">        <span class="comment">//3. 创建连接</span></span><br><span class="line">        Connection connection = factory.newConnection();</span><br><span class="line">        <span class="comment">//4. 创建Channel</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">            1. exchange：交换机的名称</span></span><br><span class="line"><span class="comment">            2. type：交换机的类型</span></span><br><span class="line"><span class="comment">                DIRECT("direct"),：定向</span></span><br><span class="line"><span class="comment">                FANOUT("fanout"),：扇形（广播),发送消息到每一个与之绑定队列</span></span><br><span class="line"><span class="comment">                TOPIC("topic"),：通配符的方式</span></span><br><span class="line"><span class="comment">                HEADERS("headers");：参数匹配</span></span><br><span class="line"><span class="comment">            3. durable：是否持久化</span></span><br><span class="line"><span class="comment">            4. autoDelete：自动删除</span></span><br><span class="line"><span class="comment">            5. internal：内部使用。一般false</span></span><br><span class="line"><span class="comment">            6. arguments：参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//5. 创建交换机</span></span><br><span class="line">        String exchangeName = <span class="string">"test_fanout"</span>;</span><br><span class="line">        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.FANOUT,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//6. 创建队列</span></span><br><span class="line">        String queue1Name = <span class="string">"test_fanout_queue1"</span>;</span><br><span class="line">        String queue2Name = <span class="string">"test_fanout_queue2"</span>;</span><br><span class="line">        channel.queueDeclare(queue1Name,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        channel.queueDeclare(queue2Name,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//7. 绑定队列和交换机</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        queueBind(String queue, String exchange, String routingKey, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">            1. queue：队列名称</span></span><br><span class="line"><span class="comment">            2. exchange：交换机名称</span></span><br><span class="line"><span class="comment">            3. routingKey：路由键,绑定规则</span></span><br><span class="line"><span class="comment">                如果交换机的类型为fanout,routingKey设置为""</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueBind(queue1Name,exchangeName,<span class="string">""</span>);</span><br><span class="line">        channel.queueBind(queue2Name,exchangeName,<span class="string">""</span>);</span><br><span class="line">        <span class="comment">//8. 发送消息</span></span><br><span class="line">        String body = <span class="string">"日志信息：11111111111111111"</span>;</span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">""</span>,<span class="keyword">null</span>,body.getBytes());</span><br><span class="line">        <span class="comment">//9. 释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
<pre><code>- C：消费者，消息的接收者，会一直等待消息到来

- Queue：消息队列，接收消息，缓存消息

- Exchange：交换机（X）。一方面，接收生产者发送的消息。另一方面，知道如何处理消息。例如递交给某个特别队列，递交给所有队列，或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有常见以下3中类型：

    - Fanout：广播，将消息交给所有绑定到交换机的队列
    - Direct：定向，把消息交给符合指定routing key的队列
    - Topic：通配符，把消息交给符合routing pattern（路由模式）的队列

&gt; Exchange（交换机）只负责转发消息，不具备存储消息的能力，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</code></pre><ul>
<li><p><strong>Routing路由模式</strong></p>
<p>  <img src="/2020/09/07/RabbitMQ/Routing.png" alt="Routing"></p>
<ul>
<li><p>P：生产者，向Exchange发送消息，发送消息时，会指定一个routingKey</p>
</li>
<li><p>X：Exchange（交换机），接收生产者的消息，然后把消息递交给与routingkey完全匹配的队列</p>
</li>
<li><p>C1：消费者，其所在队列指定了需要routingKey为error的消息</p>
</li>
<li><p>C2：消费者，其所在队列指定了需要routingKey为info，error，warning的消息</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><p>队列与交换机的绑定，不能是任意绑定了，而是要指定一个RoutingKey（路由key）</p>
</li>
<li><p>消息的发送方在向Exchange发送消息时，也必须指定消息的RoutingKey</p>
</li>
<li><p>Exchange不再把消息交给每一个绑定的队列，而是根据消息的RoutingKey进行判断，只有队列的RoutingKey与消息的RoutingKey完全一致，才会接收到消息</p>
</li>
<li><p>Routing模式要求队列在绑定交换机时要指定routingKey，消息会转发给符合routingKey的队列</p>
</li>
</ul>
</blockquote>
<ul>
<li><p><strong>Topics主题模式</strong></p>
<p>  <img src="/2020/09/07/RabbitMQ/topic.png" alt="topic"></p>
<ul>
<li><p>*：通配一个单词；#：通配0个或多个单词</p>
<blockquote>
<p>Topic主题模式可以实现Pub/Sub发布与订阅模式和Routing路由模式的功能，只是Topic在配置routingKey的时候可以使用通配符，显得更加灵活    </p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>RPC远程调用模式</strong></p>
</li>
</ul>
<h2 id="八，spring整合RabbitMQ生产者"><a href="#八，spring整合RabbitMQ生产者" class="headerlink" title="八，spring整合RabbitMQ生产者"></a>八，spring整合RabbitMQ生产者</h2><ol>
<li><p><strong>导入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>添加配置文件</strong></p>
<p><strong>rabbitmq.properties</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq.host=47.92.139.26</span><br><span class="line">rabbitmq.port=5672</span><br><span class="line">rabbitmq.username=itfang</span><br><span class="line">rabbitmq.password=123456</span><br><span class="line">rabbitmq.virtual-host=/nightwatch</span><br></pre></td></tr></table></figure>

<p><strong>spring-rabbitmq-producer.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">"http://www.springframework.org/schema/rabbit"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd "</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    加载配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath*:rabbitmq.properties"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    定义rabbitmq connectionFactory--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">host</span>=<span class="string">"$&#123;rabbitmq.host&#125;"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">port</span>=<span class="string">"$&#123;rabbitmq.port&#125;"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">username</span>=<span class="string">"$&#123;rabbitmq.username&#125;"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">password</span>=<span class="string">"$&#123;rabbitmq.password&#125;"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">virtual-host</span>=<span class="string">"$&#123;rabbitmq.virtual-host&#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    定义管理交换机,队列--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    定义持久化队列,不存在则自动创建,不绑定到交换机则绑定到默认交换机</span></span><br><span class="line"><span class="comment">        默认交换机类型为direct,名字为："",路由键为队列的名称--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">"spring_queue"</span> <span class="attr">name</span>=<span class="string">"spring_queue"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    ~~~~~~~~~~~~~~~~~~~广播,所有队列都能收到消息~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    定义广播交换机中的持久化队列,不存在则自动创建--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">"spring_fanout_queue_1"</span> <span class="attr">name</span>=<span class="string">"spring_fanout_queue_1"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">"spring_fanout_queue_2"</span> <span class="attr">name</span>=<span class="string">"spring_fanout_queue_2"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    定义广播类型交换机,并绑定上述两个队列--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:fanout-exchange</span> <span class="attr">name</span>=<span class="string">"spring_fanout_exchange"</span> <span class="attr">id</span>=<span class="string">"spring_fanout_exchange"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">"spring_fanout_queue_1"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">"spring_fanout_queue_2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:fanout-exchange</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    ~~~~~~~~~~~~~~~~~~~通配符：*匹配一个单词,#匹配多个单词~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    定义广播交换机中的持久化队列,不存在则自动创建--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">"spring_topic_queue_star"</span> <span class="attr">name</span>=<span class="string">"spring_topic_queue_star"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">"spring_topic_queue_well"</span> <span class="attr">name</span>=<span class="string">"spring_topic_queue_well"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">"spring_topic_queue_well2"</span> <span class="attr">name</span>=<span class="string">"spring_topic_queue_well2"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">"spring_topic_exchange"</span> <span class="attr">id</span>=<span class="string">"spring_topic_exchange"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">"itfang.*"</span> <span class="attr">queue</span>=<span class="string">"spring_topic_queue_star"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">"itfang.#"</span> <span class="attr">queue</span>=<span class="string">"spring_topic_queue_well"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">"error.#"</span> <span class="attr">queue</span>=<span class="string">"spring_topic_queue_well2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"rabbitTemplate"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p><strong>编写程序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ContextConfiguration</span>(<span class="title">locations</span> </span>= <span class="string">"classpath*:spring-rabbitmq-producer.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHelloWorld</span><span class="params">()</span></span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"spring_queue"</span>,<span class="string">"hello,rabbitmq~~"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h2 id="九，spring整合RabbitMQ消费者"><a href="#九，spring整合RabbitMQ消费者" class="headerlink" title="九，spring整合RabbitMQ消费者"></a>九，spring整合RabbitMQ消费者</h2><ol>
<li><p>导入依赖（与第八点导入的依赖一致）</p>
</li>
<li><p>添加配置文件</p>
<p><strong>rabbitmq.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq.host=47.92.139.26</span><br><span class="line">rabbitmq.port=5672</span><br><span class="line">rabbitmq.username=itfang</span><br><span class="line">rabbitmq.password=123456</span><br><span class="line">rabbitmq.virtual-host=/nightwatch</span><br></pre></td></tr></table></figure>

<p><strong>spring-rabbitmq-consumer.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">"http://www.springframework.org/schema/rabbit"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    加载配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:rabbitmq.properties"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--    定义rabbitmq connectionFactory--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">host</span>=<span class="string">"$&#123;rabbitmq.host&#125;"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">port</span>=<span class="string">"$&#123;rabbitmq.port&#125;"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">username</span>=<span class="string">"$&#123;rabbitmq.username&#125;"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">password</span>=<span class="string">"$&#123;rabbitmq.password&#125;"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">virtual-host</span>=<span class="string">"$&#123;rabbitmq.virtual-host&#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"springQueueListener"</span> <span class="attr">class</span>=<span class="string">"com.itfang.www.SpringQueueListener"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">"springQueueListener"</span> <span class="attr">queue-names</span>=<span class="string">"spring_queue"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写程序</p>
</li>
</ol>
<h2 id="十，springboot整合RabbitMQ生产者"><a href="#十，springboot整合RabbitMQ生产者" class="headerlink" title="十，springboot整合RabbitMQ生产者"></a>十，springboot整合RabbitMQ生产者</h2><ol>
<li><p>导入启动器依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>编写配置文件</p>
<p>application.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.92</span><span class="number">.139</span><span class="number">.26</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">itfang</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/nightwatch</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>定义交换机，队列以及绑定关系的配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME=<span class="string">"springboot_topic_exchange"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">"springboot_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 交换机</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"springboot_exchange"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exchange <span class="title">getExchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(<span class="keyword">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 队列</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"springboot_queue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">getQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 队列和交换机绑定关系</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">bingQueueExchange</span><span class="params">(@Qualifier(<span class="string">"springboot_queue"</span>)</span> Queue queue,@<span class="title">Qualifier</span><span class="params">(<span class="string">"springboot_exchange"</span>)</span> Exchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">"springboot.#"</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><p>注入RabbitTemplate,调用方法，完成消息的发送</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSend</span><span class="params">()</span></span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(ProducerConfig.EXCHANGE_NAME,<span class="string">"springboot.hahah"</span>,<span class="string">"hello,rabbitmq~~~"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h2 id="十一，springboot整合RabbitMQ消费者"><a href="#十一，springboot整合RabbitMQ消费者" class="headerlink" title="十一，springboot整合RabbitMQ消费者"></a>十一，springboot整合RabbitMQ消费者</h2><ol>
<li><p>引入启动器依赖（与第十点相同）</p>
</li>
<li><p>编写配置文件（与第十点相同）</p>
</li>
<li><p>定义监听类，使用@RabbitListener注解完成队列监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = <span class="string">"springboot_queue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenerQueue</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h2 id="十二，RabbitMQ的高级特性——消息的可靠投递"><a href="#十二，RabbitMQ的高级特性——消息的可靠投递" class="headerlink" title="十二，RabbitMQ的高级特性——消息的可靠投递"></a>十二，RabbitMQ的高级特性——消息的可靠投递</h2><ol>
<li><p>rabbitmq提供了两种方式用来控制下消息的投递可靠性：</p>
<ul>
<li><p><strong>confirm确认模式</strong></p>
<ol>
<li><p>确认模式开启,在配置文件的rabbit:connection-factory标签中配置publisher-confirms=”true”</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    定义rabbitmq connectionFactory--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">host</span>=<span class="string">"47.92.139.26"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">port</span>=<span class="string">"5672"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">username</span>=<span class="string">"itfang"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">password</span>=<span class="string">"123456"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">virtual-host</span>=<span class="string">"/nightwatch"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">publisher-confirms</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在rabbitTemplate定义ConfirmCallback回调函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  @<span class="title">ContextConfiguration</span>(<span class="title">locations</span> </span>= <span class="string">"classpath*:spring-rabbitmq-producer.xml"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerTest</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">      <span class="meta">@Autowired</span></span><br><span class="line">      <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 确认模式：</span></span><br><span class="line"><span class="comment">       *      步骤：</span></span><br><span class="line"><span class="comment">       *          1. 确认模式开启,在配置文件的rabbit:connection-factory标签中配置publisher-confirm="true"</span></span><br><span class="line"><span class="comment">       *          2. 在rabbitTemplate定义ConfirmCallback回调函数</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="meta">@Test</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConfirm</span><span class="params">()</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">          rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> RabbitTemplate.ConfirmCallback() &#123;</span><br><span class="line">              <span class="comment">/**</span></span><br><span class="line"><span class="comment">               *</span></span><br><span class="line"><span class="comment">               * <span class="doctag">@param</span> correlationData 相关配置信息</span></span><br><span class="line"><span class="comment">               * <span class="doctag">@param</span> ack   exchange交换机,是否成功收到了信息。true为成功,false为失败</span></span><br><span class="line"><span class="comment">               * <span class="doctag">@param</span> cause   失败的原因</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, String cause)</span> </span>&#123;</span><br><span class="line">                  System.out.println(<span class="string">"confirm方法被执行了....."</span>);</span><br><span class="line">                  <span class="keyword">if</span> (ack)&#123;</span><br><span class="line">                      System.out.println(<span class="string">"消息发送成功了"</span>+cause);</span><br><span class="line">                  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                      System.out.println(<span class="string">"消息发送失败了"</span>+cause);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">  </span><br><span class="line">          rabbitTemplate.convertAndSend(<span class="string">"test_exchange_confirm"</span>,<span class="string">"confirm"</span>,<span class="string">"message....."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p><strong>return退回模式</strong></p>
<ol>
<li><p>开启回退模式，在配置文件的rabbit:connection-factory标签中配置publisher-returns=”true”</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    定义rabbitmq connectionFactory--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">host</span>=<span class="string">"47.92.139.26"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">port</span>=<span class="string">"5672"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">username</span>=<span class="string">"itfang"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">password</span>=<span class="string">"123456"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">virtual-host</span>=<span class="string">"/nightwatch"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">publisher-confirms</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">publisher-returns</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ul>
</li>
</ol>
<pre><code>2. 设置ReturnCallBack

3. 设置Exchange处理消息的模式；

   1. 如果消息没有路由到Queue,则丢弃消息（默认）
   2. 如果消息没有路由到Queue，返回到消息发送方ReturnCallBack

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回退模式：当消息发送诶exchange后,exchange路由到到Queue失败时才执行ReturnCallBack</span></span><br><span class="line"><span class="comment">     *  步骤：</span></span><br><span class="line"><span class="comment">     *      1. 开启回退模式：publisher-returns="true"</span></span><br><span class="line"><span class="comment">     *      2. 设置ReturnCallBack</span></span><br><span class="line"><span class="comment">     *      3. 设置Exchange处理消息的模式：</span></span><br><span class="line"><span class="comment">     *          1. 如果消息没有路由到Queue,则丢弃消息（默认）</span></span><br><span class="line"><span class="comment">     *          2. 如果消息没有路由到Queue,返回该消息发送方ReturnCallBack</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReturn</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//        设置交换机处理失败消息的模式,如果设置了该参数,则消息会退回producer并执行回调函数returnMessage</span></span><br><span class="line">        rabbitTemplate.setMandatory(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置ReturnCallBack</span></span><br><span class="line">        rabbitTemplate.setReturnCallback(<span class="keyword">new</span> RabbitTemplate.ReturnCallback() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> message       消息对象</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> replyCode     错误码</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> replyText     错误信息</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> exchange      交换机</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> routingKey    路由键</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnedMessage</span><span class="params">(Message message, <span class="keyword">int</span> replyCode, String replyText, String exchange, String routingKey)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"return被执行了....."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"test_exchange_confirm"</span>,<span class="string">"confirm"</span>,<span class="string">"message,confirm..."</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></code></pre><ol start="2">
<li><p>rabbitmq整个消息投递的路径为：</p>
<p><code>producer----&gt;rabbitmq broker----&gt;exchange----&gt;queue----&gt;consumer</code></p>
<ul>
<li><strong>confirm确认模式下，消息从producer到exchange则会返回一个confirmCallback</strong></li>
<li><strong>return退回模式下，消息从exchange到queue投递失败则会返回一个returnCallback.</strong></li>
</ul>
</li>
</ol>
<h2 id="十三，RabbitMQ的高级特性——Consumer-Ack（也是为了消息投递的可靠性）"><a href="#十三，RabbitMQ的高级特性——Consumer-Ack（也是为了消息投递的可靠性）" class="headerlink" title="十三，RabbitMQ的高级特性——Consumer Ack（也是为了消息投递的可靠性）"></a>十三，RabbitMQ的高级特性——Consumer Ack（也是为了消息投递的可靠性）</h2><ol>
<li><p><strong>ack</strong>指Acknowledge,确认。表示消费端收到消息后的确认方式。有三种确认方式：</p>
<ul>
<li>自动确认：acknowledge=“none”<ul>
<li>自动确认是指，当消息一旦被 Consumer接收到，则自动确认收到，并将相应message从RabbitMQ的消息缓存中移除。但是在实际业务处理中，很可能消息接收到，业务处理出现异常，那么该下消息就会丢失。</li>
</ul>
</li>
<li>手动确认：acknowledge=“manual”<ul>
<li>如果设置了手动确认方式，则需要在业务处理成功后，调用channel.basicAck()，手动签收，如果出现异常，则调用channel.basicNack()方法，让其自动重新发送消息。</li>
</ul>
</li>
<li>根据异常情况确认：acknowledge=“auto”</li>
</ul>
<p><strong>spring-rabbitmq-consumer.xml：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    定义监听器--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">acknowledge</span>=<span class="string">"manual"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">"ackListener"</span> <span class="attr">queue-names</span>=<span class="string">"test_queue_confirm"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>AckListener：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itfang</span></span><br><span class="line"><span class="comment"> * Consumer ACK机制：</span></span><br><span class="line"><span class="comment"> * 1. 设置手动签收,acknowledge="manual"</span></span><br><span class="line"><span class="comment"> * 2. 让监听器实现ChannelAwareMessageListener接口</span></span><br><span class="line"><span class="comment"> * 3. 如果消息成功处理,则调用channel的basicAck()签收</span></span><br><span class="line"><span class="comment"> * 4. 如果消息处理失败,则调用channel的basicNack()拒绝签收,broker重新返送给consumer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AckListener</span> <span class="keyword">implements</span> <span class="title">ChannelAwareMessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> deliveryTag = message.getMessageProperties().getDeliveryTag();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//1. 接收转换消息</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            System.out.println(<span class="string">"业务逻辑处理...."</span>);</span><br><span class="line">            <span class="comment">//3. 手动签收</span></span><br><span class="line">            channel.basicAck(deliveryTag,<span class="keyword">true</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            channel.basicNack(deliveryTag,<span class="keyword">true</span>,<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h2 id="十四，RabbitMQ的高级特性——消费端限流"><a href="#十四，RabbitMQ的高级特性——消费端限流" class="headerlink" title="十四，RabbitMQ的高级特性——消费端限流"></a>十四，RabbitMQ的高级特性——消费端限流</h2><ol>
<li>确保ack机制为手动确认</li>
<li>设置<strong>&lt;rabbit:listener-container /&gt;</strong>标签的prefetch属性<ul>
<li>例如prefetch = 1；表示消费端每次从MQ拉取一条消息来消费，直到手动确认消费完毕后，才会继续拉取下一条消息。</li>
</ul>
</li>
</ol>
<p><strong>spring-rabbitmq-consumer.xml</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    定义监听器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">acknowledge</span>=<span class="string">"manual"</span> <span class="attr">prefetch</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">"qosListener"</span> <span class="attr">queue-names</span>=<span class="string">"test_queue_confirm"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>QosListener</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itfang</span></span><br><span class="line"><span class="comment"> * Consumre 限流机制；</span></span><br><span class="line"><span class="comment"> *  1. 确保ack机制为手动确认</span></span><br><span class="line"><span class="comment"> *  2. 设置**&lt;rabbit:listener-container /&gt;**标签的prefetch属性</span></span><br><span class="line"><span class="comment"> *       例如prefetch = 1；表示消费端每次从MQ拉取一条消息来消费，直到手动确认消费完毕后，才会继续拉取下一条消息。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QosListener</span> <span class="keyword">implements</span> <span class="title">ChannelAwareMessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 获取消息</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        <span class="comment">//2. 业务处理</span></span><br><span class="line">        System.out.println(<span class="string">"业务处理....."</span>);</span><br><span class="line">        <span class="comment">//3. 手动签收</span></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="十五，RabbitMQ的高级特性——TTL（Time-To-Live）"><a href="#十五，RabbitMQ的高级特性——TTL（Time-To-Live）" class="headerlink" title="十五，RabbitMQ的高级特性——TTL（Time To Live）"></a>十五，RabbitMQ的高级特性——TTL（Time To Live）</h2><ol>
<li><p>TTL全称Time To Live(存活时间/过期时间)，当消息到大存活时间后，还没有被消费，会被自动清除；RabbitMQ可以对消息设置过期时间，也可以对整个队列（Queue）设置过期时间。</p>
</li>
<li><p>TTL的两种设置方式：如果设置了消息的过期时间，也设置了队列的过期时间，它以时间短为准。队列过期后，会将队列所有消息全部移除。消息过期后,只有消息在队列顶端,才会判断其是否过期（移除掉）</p>
<ol>
<li><p>队列统一过期</p>
<p><strong>spring-rabbitmq-producer.xml</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    ttl--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">"test_queue_ttl"</span> <span class="attr">id</span>=<span class="string">"test_queue_ttl"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        设置queue的参数--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            x-message-ttl指队列的过期时间,value默认的类型为String,如果不是字符类型需要自己指定value-type--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"x-message-ttl"</span> <span class="attr">value</span>=<span class="string">"1000"</span> <span class="attr">value-type</span>=<span class="string">"java.lang.Integer"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">"test_exchange_ttl"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">"ttl.#"</span> <span class="attr">queue</span>=<span class="string">"test_queue_ttl"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ol>
<ol start="2">
<li><p>消息单独过期</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TTL:过期时间</span></span><br><span class="line"><span class="comment"> *  1. 队列统一过期</span></span><br><span class="line"><span class="comment"> *  2. 消息单独过期</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  如果设置了消息的过期时间，也设置了队列的过期时间，它以时间短为准。</span></span><br><span class="line"><span class="comment"> *  队列过期后，会将队列所有消息全部移除。</span></span><br><span class="line"><span class="comment"> *  消息过期后,只有消息在队列顶端,才会判断其是否过期（移除掉）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTTL</span><span class="params">()</span></span>&#123;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">//消息后处理对象,设置一些消息的参数信息</span></span><br><span class="line">    MessagePostProcessor messagePostProcessor = <span class="keyword">new</span> MessagePostProcessor() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Message <span class="title">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException </span>&#123;</span><br><span class="line">            <span class="comment">//1. 设置message的消息</span></span><br><span class="line">            message.getMessageProperties().setExpiration(<span class="string">"5000"</span>);<span class="comment">//消息的过期时间</span></span><br><span class="line">            <span class="comment">//2.  返回该消息</span></span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//消息单独过期</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">"test_exchange_ttl"</span>,<span class="string">"ttl.haha"</span>,<span class="string">"message,ttl...."</span>,messagePostProcessor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h2 id="十六，RabbitMQ的高级特性——死信队列"><a href="#十六，RabbitMQ的高级特性——死信队列" class="headerlink" title="十六，RabbitMQ的高级特性——死信队列"></a>十六，RabbitMQ的高级特性——死信队列</h2><ol>
<li><p>死信队列（DLX：Dead Letter Exchange 死信交换机），当消息成为Dead Message后，可以被重新发送到另一个交换机，这个交换机就是DLX。</p>
<p><img src="/2020/09/07/RabbitMQ/%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97.png" alt="死信队列"></p>
</li>
<li><p><strong>消息成为死信的三种情况</strong>：</p>
<ol>
<li>队列消息长度到大限制；</li>
<li>消费者拒接消费消息，basicNack/basicReject,并且不把消息重新放入原目标队列，requeue=false；</li>
<li>原队列存在消息过期设置，消息到达超时时间未被消费；</li>
</ol>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    死信队列：</span></span><br><span class="line"><span class="comment">        1. 声明正常的队列（test_queue_dlx）和交换机（test_exchange_dlx）</span></span><br><span class="line"><span class="comment">        2. 声明死信队列（queue_dlx）和死信交换机（exchange_dlx）</span></span><br><span class="line"><span class="comment">        3. 正常队列绑定死信交换机</span></span><br><span class="line"><span class="comment">            设置两个参数：</span></span><br><span class="line"><span class="comment">                * x-dead-letter-exchange：死信交换机的名称</span></span><br><span class="line"><span class="comment">                * x-dead-letter-routing-key：发送给死信交换机的routingKey</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    1. 声明正常的队列（test_queue_dlx）和交换机（test_exchange_dlx）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">"test_queue_dlx"</span> <span class="attr">name</span>=<span class="string">"test_queue_dlx"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        3. 正常队列绑定死信交换机--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span> &gt;</span></span><br><span class="line"><span class="comment">&lt;!--            3.1, x-dead-letter-exchange：死信交换机的名称--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"x-dead-letter-exchange"</span> <span class="attr">value</span>=<span class="string">"exchange_dlx"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            3.2, x-dead-letter-routin-key:发送给死信交换机的routingKey--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"x-dead-letter-routin-key"</span> <span class="attr">value</span>=<span class="string">"dlx.heheh"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            4.1, 设置过期时间--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"x-message-ttl"</span> <span class="attr">value</span>=<span class="string">"1000"</span> <span class="attr">value-type</span>=<span class="string">"java.lang.Integer"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            4.2, 设置队列的最大长度--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"x-message-ttl"</span> <span class="attr">value</span>=<span class="string">"1000"</span> <span class="attr">value-type</span>=<span class="string">"java.lang.Integer"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">"test_exchange_dlx"</span> <span class="attr">id</span>=<span class="string">"test_exchange_dlx"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">"test.dlx.#"</span> <span class="attr">queue</span>=<span class="string">"test_queue_dlx"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    2. 声明死信队列（queue_dlx）和死信交换机（exchange_dlx）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">"queue_dlx"</span> <span class="attr">name</span>=<span class="string">"queue_dlx"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">"exchange_dlx"</span> <span class="attr">id</span>=<span class="string">"exchange_dlx"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">"dlx.#"</span> <span class="attr">queue</span>=<span class="string">"queue_dlx"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="十七，RabbitMQ的高级特性——延迟队列"><a href="#十七，RabbitMQ的高级特性——延迟队列" class="headerlink" title="十七，RabbitMQ的高级特性——延迟队列"></a>十七，RabbitMQ的高级特性——延迟队列</h2><ol>
<li><p>延迟队列，即消息进入队列后不会立即被消费，只有到达指定时间后，才会被消费。</p>
<ul>
<li><p>使用场景：</p>
<ul>
<li>下单后，30分钟未支付，取消订单，回滚库存</li>
<li>新用户注册成功7天，发送短信问候</li>
</ul>
</li>
<li><p>RabbitMQ中未提供延迟队列功能，可以使用TTL+死信队列组合实现延迟队列的效果。</p>
<p><img src="/2020/09/07/RabbitMQ/%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97.png" alt="延迟队列"></p>
</li>
</ul>
</li>
</ol>
<h2 id="十八，RabbitMQ的高级特性——日志与监控"><a href="#十八，RabbitMQ的高级特性——日志与监控" class="headerlink" title="十八，RabbitMQ的高级特性——日志与监控"></a>十八，RabbitMQ的高级特性——日志与监控</h2><ol>
<li><p><strong>RabbitMQ日志</strong>：</p>
<ul>
<li>RabbitMQ默认日志存放路径：/var/log/rabbitmq/rabbit@[主机名].log</li>
<li>日志包含了RabbitMQ的版本号，Erlang的版本号，RabbitMQ服务节点名称，cookie的hash值，RabbitMQ配置文件地址，内存限制，磁盘限制，默认账号guest的创建以及权限配置等等。</li>
</ul>
</li>
<li><p><strong>rabbitmqctl管理和监控</strong></p>
<ul>
<li>查看队列：rabbitmqctl list_queue</li>
<li>查看交换机：rabbitmqctl list_exhanges</li>
<li>查看虚拟机：rabbitmqctl list_vhosts</li>
<li>查看用户：rabbitmqctl list_users</li>
<li>查看连接：rabbitmqctl list_connections</li>
<li>查看消费者信息：rabbitmqctl list_consumers</li>
<li>查看环境变量：rabbitmqctl environment</li>
<li>查看未被确认的队列：rabbitmqctl list_queues name messages_unacknowledged</li>
<li>查看单个队列的内存使用：rabbitmqctl list_queues name memory</li>
<li>查看准备就绪的队列：rabbitmqctl list_queues name messages_ready</li>
</ul>
</li>
</ol>
<h2 id="十九，RabbitMQ的高级特性——消息追踪"><a href="#十九，RabbitMQ的高级特性——消息追踪" class="headerlink" title="十九，RabbitMQ的高级特性——消息追踪"></a>十九，RabbitMQ的高级特性——消息追踪</h2><ol>
<li>Firehose插件<ul>
<li>​    firehose的机制是将生产者投递给rabbitmq的消息，rabbitmq投递给消费者的消息按照指定的格式发送给默认的exchange上。这个默认的exchange的名称为amq.rabbitmq.trace，它是一个topic类型的exchange。发送到这个exchange上的消息的routing key为publish.exchangename和deliver.queuename。其中exchangename和queuename为实际exchange和queue的名称，分别对应生产者投递到exchange的消息，和消费者从queue上获取的消息。</li>
<li>注意：打卡trace会影响消息写入功能，适当打开后请关闭。</li>
<li><strong>开启Firehost命令</strong>：rabbitmqctl trace_on</li>
<li><strong>关闭Firehost命令</strong>：rabbitmq trace_off</li>
</ul>
</li>
<li>rabbitmq_tracing插件<ul>
<li><strong>启用插件</strong>：rabbitmq-plugins enable rabbitmq_tracing</li>
</ul>
</li>
</ol>
<h2 id="二十，RabbitMQ应用问题——消息可靠性保障"><a href="#二十，RabbitMQ应用问题——消息可靠性保障" class="headerlink" title="二十，RabbitMQ应用问题——消息可靠性保障"></a>二十，RabbitMQ应用问题——消息可靠性保障</h2><ol>
<li><p><strong>消息可靠性保障——消息补偿</strong></p>
<ul>
<li><p>需求：确保消息发送成功</p>
<p><img src="/2020/09/07/RabbitMQ/%E6%B6%88%E6%81%AF%E8%A1%A5%E5%81%BF.png" alt="消息补偿"></p>
</li>
</ul>
</li>
</ol>
<h2 id="二十一，RabbitMQ应用问题——消息幂等性保障"><a href="#二十一，RabbitMQ应用问题——消息幂等性保障" class="headerlink" title="二十一，RabbitMQ应用问题——消息幂等性保障"></a>二十一，RabbitMQ应用问题——消息幂等性保障</h2><ol>
<li><p><strong>消息幂等性保障——乐观锁机制</strong>：</p>
<ul>
<li><p>幂等性指一次和多次请求某一个资源，对于资源本身应该具有同样的结果。也就是说，其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。在MQ中指，消费多条相同的消息，得到与消费该消息一次相同的结果。</p>
<p><img src="/2020/09/07/RabbitMQ/C:%5CUsers%5C92540%5CDesktop%5CmyselfBlog%5Chexo%5Csource_posts%5CRabbitMQ%5C%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7%E4%BF%9D%E9%9A%9C.png" alt="消息幂等性保障"></p>
</li>
</ul>
</li>
</ol>
<h2 id="二十二，RabbitMQ集群搭建——镜像队列"><a href="#二十二，RabbitMQ集群搭建——镜像队列" class="headerlink" title="二十二，RabbitMQ集群搭建——镜像队列"></a>二十二，RabbitMQ集群搭建——镜像队列</h2><p><img src="/2020/09/07/RabbitMQ/%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E7%9A%84%E5%8E%9F%E7%90%86%E5%9B%BE.png" alt="集群搭建的原理图"></p>
<ul>
<li><p>要想在队列节点宕机或故障也能正常应用，就要复制队列内容到集群里的每个节点，必须要创建镜像队列。镜像队列是基于普通的集群模式的，然后再添加一些策略，所以得先配置普通集群，然后才能设置镜像队列。</p>
</li>
<li><p>搭建镜像队列的两种方式：</p>
<ul>
<li><p>通过开启管理端网页Admin-&gt;Policies</p>
<p><img src="/2020/09/07/RabbitMQ/%E6%90%AD%E5%BB%BA%E9%95%9C%E5%83%8F%E9%98%9F%E5%88%97.png" alt="搭建镜像队列"></p>
</li>
<li><p>通过在终端输入命令：rabbitmqctl set_policy my_ha “^” ‘{“ha-mode”:”all”}’</p>
</li>
</ul>
</li>
</ul>
<h2 id="二十三，RabbitMQ集群搭建——负载均衡"><a href="#二十三，RabbitMQ集群搭建——负载均衡" class="headerlink" title="二十三，RabbitMQ集群搭建——负载均衡"></a>二十三，RabbitMQ集群搭建——负载均衡</h2><ol>
<li>负载均衡——HAProxy<ul>
<li>安装HAProxy</li>
<li>配置HAProxy</li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/07/RabbitMQ/" data-id="ckfmaqxhj0008kcuaaa8yat04" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Linux" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/09/Linux/" class="article-date">
  <time datetime="2020-08-09T13:16:56.000Z" itemprop="datePublished">2020-08-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/09/Linux/">Linux</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="一，Linux常用命令"><a href="#一，Linux常用命令" class="headerlink" title="一，Linux常用命令"></a><strong>一，Linux常用命令</strong></h5><ul>
<li><p><strong>cd</strong>：切换目录</p>
</li>
<li><ul>
<li><strong>cd app</strong>：切换到app目录</li>
<li><strong>cd ..</strong>：切换到上一层目录</li>
<li><strong>cd /</strong>：切换到系统根目录</li>
<li><strong>cd ~</strong>：切换到用户主目录</li>
<li><strong>cd -</strong>：切换到上一个所在目录</li>
</ul>
</li>
<li><p><strong>ls：</strong>列出文件列表</p>
</li>
<li><ul>
<li><strong>ls -a：</strong>显示所有文件或目录（包含隐藏文件）</li>
<li><strong>ls -l：</strong>缩写成ll，显示详细的权限信息</li>
</ul>
</li>
<li><p><strong>mkdir</strong>：用来创建子目录</p>
</li>
<li><ul>
<li><strong>mkdir app</strong>：在当前目录下创建app目录</li>
<li><strong>mkdir -p app2/test</strong>：级联创建app2以及test目录</li>
</ul>
</li>
<li><p><strong>rmdir</strong>：用来删除“空的子目录”</p>
</li>
<li><ul>
<li><strong>rmdir app</strong>：删除app目录</li>
</ul>
</li>
<li><p><strong>cat</strong>：用于显示文件的内容，格式：cat[参数]&lt;文件名&gt;</p>
</li>
<li><ul>
<li><strong>cat yum.conf</strong></li>
</ul>
</li>
<li><p><strong>more</strong>：用于要显示的内容会超过一个画面长度的情况。按空格键显示下一个画面，回车显示下一行内容，按q键退出查看</p>
</li>
<li><ul>
<li><strong>more yum.conf</strong></li>
</ul>
</li>
<li><p><strong>less</strong>：用法和more类似，不同的是less可以通过PgUp和PgDn进行上下翻页</p>
</li>
<li><ul>
<li><strong>less yum.conf</strong></li>
</ul>
</li>
<li><p><strong>tail：</strong>用于显示文件后几行的内容</p>
</li>
<li><ul>
<li><strong>tail -10  /etc/passwd：</strong>查看后10行数据</li>
<li><strong>tail -f catalina.log：</strong>动态查看日志</li>
<li><strong>Ctrl+c：</strong>结束查看</li>
</ul>
</li>
<li><p><strong>rm</strong>：删除文件</p>
</li>
<li><ul>
<li><strong>rm a.txt</strong>：删除a.txt文件，删除需要用户确认，y/n</li>
<li><strong>rm -f a.txt</strong>：不询问，直接删除</li>
<li><strong>rm -r a</strong>：递归删除a目录</li>
<li><strong>rm -rf a</strong>：不询问递归删除【慎用】</li>
<li><strong>rm -rf *</strong>：删除所有文件</li>
<li><strong>rm -rf /*</strong>：自杀</li>
</ul>
</li>
<li><p><strong>cp</strong>：可以将文件从一处复制到另一处。一般在使用命令时将一个文件复制成另一个文件或复制到某目录时，需要指定源文件名与目标文件名或目录</p>
</li>
<li><ul>
<li><strong>cp a.txt b.txt</strong>：将a.txt复制为b.txt</li>
<li><strong>cp a.txt ../</strong>：将a.txt文件复制到上一层目录中</li>
</ul>
</li>
<li><p><strong>mv</strong>：移动或者重命名</p>
</li>
<li><ul>
<li><strong>mv a.txt ../</strong>：将a.txt文件移动到上一层目录中</li>
<li><strong>mv a.txt b.txt</strong>：将a.txt文件重命名为b.txt</li>
</ul>
</li>
<li><p><strong>tar</strong>：位于/bin目录下，它能够将用户所指定的文件或目录打包成一个文件，但不能压缩。一般Linux上常用的压缩方式是选用tar将许多文件打包成一个文件，再以gzip压缩命名压缩成xxx.tar.gz（或称为xxx.tgz）的文件。</p>
</li>
<li><ul>
<li><p>常用参数</p>
</li>
<li><ul>
<li><strong>-c</strong>：创建一个新tar文件</li>
<li><strong>-v</strong>：显示运行过程的信息</li>
<li><strong>-f</strong>：指定文件名</li>
<li><strong>-z</strong>：调用gzip压缩命名进行压缩</li>
<li><strong>-t</strong>：查看压缩文件的内容</li>
<li><strong>-x</strong>：解开tar文件</li>
</ul>
</li>
<li><p><strong>tar -cvf xxx.tar ./*</strong>：打包</p>
</li>
<li><p><strong>tar -zcvf xxx.tar.gz ./*</strong>：打包并且压缩</p>
</li>
<li><p><strong>tar -xvf xxx.tar</strong>：解压</p>
</li>
<li><p><strong>tar -zxvf xxx.tar.gz -C /user/aaa：</strong>解压到/user/aaa目录下</p>
</li>
</ul>
</li>
<li><p><strong>find</strong>：用于查找符合条件的文件</p>
</li>
<li><ul>
<li><strong>find / -name “ins*“</strong>：查找文件名是以ins开头的文件</li>
<li><strong>find / -name “ins*“ -ls：</strong></li>
<li><strong>find / -user itfang -ls：</strong>查找用户itfang的文件</li>
<li><strong>find / -user itfang -type d -ls</strong>：查找用户itfang的目录</li>
<li><strong>find / -perm -777 -type d - ls</strong>：查找权限是777的文件</li>
</ul>
</li>
<li><p><strong>grep</strong>：查找文件里符合条件的字符串</p>
</li>
<li><ul>
<li><strong>grep lang anaconda-ks.cfg</strong>：在文件中查找lang</li>
<li><strong>grep lang anaconda-ks.cfg -color</strong>：高亮显示</li>
</ul>
</li>
<li><p><strong>pwd</strong>：显示当前所在目录</p>
</li>
<li><p><strong>touch</strong>：创建一个空文件</p>
</li>
<li><p><strong>clear/Ctrl+L</strong>：清屏</p>
</li>
<li><p><strong>rz</strong>：文件上传</p>
</li>
<li><p><strong>sz</strong>：文件下载</p>
</li>
<li><p><strong>主机名配置：</strong></p>
</li>
<li><ul>
<li><strong>hostname</strong>：查看主机名</li>
<li><strong>hostname xxx</strong>：修改主机名，但是重启后失效，如果想要永久生效，可以修改<strong>/etc/sysconfig/network</strong>文件</li>
</ul>
</li>
<li><p><strong>IP地址配置：</strong></p>
</li>
<li><ul>
<li><strong>ifconfig：</strong>查看（修改）ip地址（重启后失效）</li>
<li><strong>ifconfig eth0 192.168.12.22</strong>：修改ip地址，如果想要永久生效，可以修改<strong>/etc/sysconfig/network-scripts/ifcfg-eth0</strong>文件</li>
<li><strong>DEVICE=eth0：</strong>网卡名称</li>
<li><strong>BOOTPROTO=static</strong>：获取ip的方式（static/dhcp/bootp/none）</li>
<li><strong>HWADDR=00:0C:29:B5:B2:69：</strong>MAC地址</li>
<li><strong>IPADDR=192.168.177.129：</strong>ip地址</li>
<li><strong>NETMASK=255.255.255.0：</strong>子网掩码</li>
<li><strong>NETWORK=192.168.177.0</strong>：网络地址</li>
<li><strong>BROADCAST=192.168.0.255</strong>：广播地址</li>
<li><strong>NBOOT=yes：</strong>系统启动时是否设置此网络接口，设置为yes时，系统启动时激活此设备</li>
</ul>
</li>
<li><p><strong>网络服务管理：</strong></p>
</li>
<li><ul>
<li><strong>service network status：</strong>查看指定服务状态</li>
<li><strong>service network stop</strong>：停止指定服务</li>
<li><strong>service network start：</strong>启动指定服务</li>
<li><strong>service network restart：</strong>重启指定服务</li>
<li><strong>service –status -all：</strong>查看系统中所有后台服务</li>
<li><strong>netstar -nltp：</strong>查看系统中网络进程的端口监听情况</li>
<li><strong>service iptables status：</strong>查看防火墙状态</li>
<li><strong>service iptables stop</strong>：关闭防火墙</li>
<li><strong>service iptables start：</strong>启动防火墙</li>
<li><strong>service iptables off：</strong>禁止防火墙自启</li>
</ul>
</li>
</ul>
<h5 id="二，Linux的目录结构"><a href="#二，Linux的目录结构" class="headerlink" title="二，Linux的目录结构"></a><strong>二，Linux的目录结构</strong></h5><ul>
<li><strong>bin：</strong>存放二进制可执行文件</li>
<li><strong>sbin</strong>：存放二进制可执行文件，只用root才能访问</li>
<li><strong>etc</strong>：存放系统配置文件</li>
<li><strong>usr</strong>：用于存放共享的系统资源</li>
<li><strong>home</strong>：存放用户文件的根目录</li>
<li><strong>root</strong>：超级用户目录</li>
<li><strong>dev</strong>：用于存放设备文件</li>
<li><strong>lib</strong>：存放跟文件系统中的程序运行所需要的共享库及内核模块</li>
<li><strong>mnt</strong>：系统管理员安装临时文件系统的安装点</li>
<li><strong>boot</strong>：存放用于系统引导时使用的各种文件</li>
<li><strong>tmp：</strong>用于存放各种临时文件</li>
<li><strong>var</strong>：用于存放运行时需要改变数据的文件</li>
</ul>
<h5 id="三，Vim编辑器"><a href="#三，Vim编辑器" class="headerlink" title="三，Vim编辑器"></a><strong>三，Vim编辑器</strong></h5><ul>
<li><p>三种模式：<strong>命令行模式，插入模式，底行模式</strong> </p>
</li>
<li><ul>
<li><p>命令行模式：按<strong>ESC</strong>键</p>
</li>
<li><p>插入模式：按<strong>i，o，a</strong>键</p>
</li>
<li><ul>
<li><strong>i</strong>：在当前位置插入</li>
<li><strong>I</strong>：在当前行首插入</li>
<li><strong>a</strong>：在当前位置后插入</li>
<li><strong>A</strong>：在当前行尾插入</li>
<li><strong>o</strong>：在当前行之后插入一行</li>
<li><strong>O</strong>：在当前行之前插入一行</li>
</ul>
</li>
<li><p>底行模式：按：（冒号）</p>
</li>
</ul>
</li>
<li><p>打开文件：<strong>vim</strong> 文件名</p>
</li>
<li><p>退出：<strong>ESC-&gt;:q</strong></p>
</li>
<li><p>修改文件：<strong>输入i进入插入模式</strong></p>
</li>
<li><p>保存并退出：<strong>ESC-&gt;:wq</strong></p>
</li>
<li><p>不保存退出：<strong>ESC-&gt;:q!</strong></p>
</li>
<li><p>快捷键：</p>
</li>
<li><ul>
<li><strong>dd：</strong>快速删除一行</li>
<li><strong>yy：</strong>复制当前行</li>
<li><strong>nyy：</strong>从当前行向后复制几行</li>
<li><strong>p：</strong>粘贴</li>
<li><strong>R</strong>：替换</li>
</ul>
</li>
</ul>
<h5 id="四，重定向输出"><a href="#四，重定向输出" class="headerlink" title="四，重定向输出"></a><strong>四，重定向输出</strong></h5><ul>
<li><p>&gt;：重定向输出，覆盖原有内容</p>
</li>
<li><ul>
<li><strong>cat /etc/passwd &gt; a.txt：</strong>将passwd中的内容重定向到a.txt中</li>
</ul>
</li>
<li><p>&gt;&gt;：重定向输出，追加后结尾</p>
</li>
<li><ul>
<li><strong>cat /etc/passwd &gt;&gt; a.txt</strong>：将passwd重定向并追加输出到a.txt中</li>
</ul>
</li>
</ul>
<h5 id="五，系统管理命令"><a href="#五，系统管理命令" class="headerlink" title="五，系统管理命令"></a><strong>五，系统管理命令</strong></h5><ul>
<li><p><strong>ps</strong>：正在运行的某个进程的状态</p>
</li>
<li><ul>
<li><strong>ps -ed</strong>：查看所有进程</li>
<li><strong>ps -ef | grep ssh</strong>：查找某一进程</li>
<li><strong>kill 2868：</strong>杀掉2868编号的进程</li>
<li><strong>kill -9 2868</strong>：强制杀死进程</li>
</ul>
</li>
</ul>
<h5 id="六，管道"><a href="#六，管道" class="headerlink" title="六，管道 |"></a><strong>六，管道 |</strong></h5><ul>
<li><p>作用：将一个命令的输出用作另一个命令的输入</p>
</li>
<li><ul>
<li>ls –help | more ：分页查询帮助信息</li>
<li>ps -ef | grep java：查询名称中包含java的进程</li>
</ul>
</li>
</ul>
<h5 id="七，文件权限"><a href="#七，文件权限" class="headerlink" title="七，文件权限"></a><strong>七，文件权限</strong></h5><p><img src="/2020/08/09/Linux/5.png" alt="5"></p>
<ul>
<li><p>文件类型：</p>
</li>
<li><ul>
<li>-：表示文件</li>
<li>d：表示文件夹</li>
<li>l：表示连接</li>
</ul>
</li>
<li><p>权限类型：</p>
</li>
<li><ul>
<li>r：read 只读        4</li>
<li>w：write 只写        2</li>
<li>x：excute 执行        1</li>
</ul>
</li>
</ul>
<h5 id="八，文件权限管理"><a href="#八，文件权限管理" class="headerlink" title="八，文件权限管理"></a><strong>八，文件权限管理</strong></h5><ul>
<li><p><strong>chmod</strong>：变更文件或目录的权限，或可以通过权限类型代表的数字之和判断权限</p>
</li>
<li><ul>
<li><strong>u</strong>：代表当前用户</li>
<li><strong>g</strong>：代表当前组内的其他用户</li>
<li><strong>o</strong>：代表其他组内的用户</li>
<li><strong>chmod u=rwx,g=rx,o=rx a.txt</strong></li>
<li><strong>chmod 755 a.txt：其中 7=》rwx，5=》-wx</strong></li>
</ul>
</li>
</ul>
<h5 id="九，Linux系统的分为两大类"><a href="#九，Linux系统的分为两大类" class="headerlink" title="九，Linux系统的分为两大类"></a><strong>九，Linux系统的分为两大类</strong></h5><ul>
<li><strong>UBuntu使用apt-get来代替yum命令</strong></li>
</ul>
<p><img src="/2020/08/09/Linux/6.png" alt="6"></p>
<h5 id="十，Linux部署jdk"><a href="#十，Linux部署jdk" class="headerlink" title="十，Linux部署jdk"></a><strong>十，Linux部署jdk</strong></h5><ol>
<li>将下载好的jdk.tar.gz上传到Linux上</li>
<li>在Linux上安装jdk</li>
</ol>
<ul>
<li><strong>tar -xvf jdk-14.0.2_linux-x64_bin.tar.gz -C 目标路径</strong></li>
</ul>
<ol>
<li><p>配置JDK的环境变量</p>
<ol>
<li><p><strong>vim /etc/profile</strong>：</p>
</li>
<li><p>在末尾行添加并保存：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set java enviroment</span></span><br><span class="line"><span class="attr">JAVA_HOME</span>=<span class="string">/usr/local/jdk/jdk-14.0.2</span></span><br><span class="line"><span class="attr">CLASSPATH</span>=<span class="string">.:$JAVA_HOME/lib.tools.jar</span></span><br><span class="line"><span class="attr">PATH</span>=<span class="string">$JAVA_HOME/bin:$PATH</span></span><br><span class="line"><span class="attr">export</span> <span class="string">JAVA_HOME CLASSPATH PATH</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>source /etc/profile</strong>：使更改的配置立即生效</p>
</li>
</ol>
</li>
</ol>
<h5 id="十一，Linux部署mysql"><a href="#十一，Linux部署mysql" class="headerlink" title="十一，Linux部署mysql"></a><strong>十一，Linux部署mysql</strong></h5><p><a href="https://blog.csdn.net/atongmu2017/article/details/90610444" target="_blank" rel="noopener">mysql部署教程CSDN</a></p>
<h5 id="十二，Linux部署Tomcat"><a href="#十二，Linux部署Tomcat" class="headerlink" title="十二，Linux部署Tomcat"></a><strong>十二，Linux部署Tomcat</strong></h5><ol>
<li>将Tomcat上传到Linux上</li>
<li>在Linux上解压文件</li>
</ol>
<ul>
<li>​    <strong>tar -xvf apache-tomcat-8.5.57.tar.gz</strong>    </li>
</ul>
<ol start="3">
<li>进入解压出来的文件的bin目录下启动Tomcat</li>
</ol>
<ul>
<li>​    <strong>./ startup.sh</strong></li>
</ul>
<ul>
<li><p><strong>遇到正常启动且有打开8080端口却访问失败：</strong>    </p>
</li>
<li><ul>
<li><strong>在阿里云上的安全组添加8080端口的访问权限</strong></li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/09/Linux/" data-id="ckfmaqxh90002kcua4f5d8thd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-MybatisPlus" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/06/MybatisPlus/" class="article-date">
  <time datetime="2020-08-06T13:19:13.000Z" itemprop="datePublished">2020-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/06/MybatisPlus/">MybatisPlus</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="一，Mybatis-MP"><a href="#一，Mybatis-MP" class="headerlink" title="一，Mybatis-MP"></a><strong>一，Mybatis-MP</strong></h5><ol>
<li><strong>导入依赖</strong></li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>将UserMapper继承BaseMapper</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;  </span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>给映射的数据库的实体类起对应表名</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> Integer id;</span><br><span class="line"><span class="keyword">private</span> String username;</span><br><span class="line"><span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>使用MP中的MybatisSqlSessionFactoryBuilder构建</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String config = <span class="string">"mybatisConfig.xml"</span>;</span><br><span class="line">        InputStream is = Resources.getResourceAsStream(config);</span><br><span class="line">        SqlSessionFactoryBuilder factoryBuilder = <span class="keyword">new</span> MybatisSqlSessionFactoryBuilder();</span><br><span class="line">        SqlSessionFactory factory = factoryBuilder.build(is);</span><br><span class="line">        SqlSession sqlSession = factory.openSession();</span><br><span class="line">        UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">        System.out.println(users);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="二，spring-MP"><a href="#二，spring-MP" class="headerlink" title="二，spring-MP"></a><strong>二，spring-MP</strong></h5><ol>
<li><p><strong>导入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>添加MP提供的MybatisSqlSessionFactoryBean对象</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath*:*.properties"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:property-placeholder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.pool.DruidDataSource"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driver&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    这里使用MP提供的SqlSessionFactory,完成了spring和MP的整合--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    扫描mapper接口,使用的依然是Mybatis原生的扫描器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basePackage"</span> <span class="attr">value</span>=<span class="string">"com.itfang.www.mapper"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p><strong>给映射的数据库的实体类起对应表名</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><p><strong>编写UserMapper接口并继承BaseMapper</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="5">
<li><p><strong>运行测试结果</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ContextConfiguration</span>(<span class="title">locations</span> </span>= <span class="string">"classpath:applicationContext.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindALL</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">        System.out.println(users);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="三，springboot-MP"><a href="#三，springboot-MP" class="headerlink" title="三，springboot-MP"></a><strong>三，springboot-MP</strong></h5><ol>
<li><p><strong>添加启动器依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>给映射的数据库的实体类起对应表名</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p><strong>编写UserMapper接口并继承BaseMapper<User></User></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><p><strong>在启动器类上添加@MapperScan注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.itfang.www.mapper"</span>)<span class="comment">//设置mapper接口扫描包</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="5">
<li><p><strong>编写测试运行</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoApplicationTests</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      List&lt;User&gt; users = userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">      System.out.println(users);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="四，MP的一些注解"><a href="#四，MP的一些注解" class="headerlink" title="四，MP的一些注解"></a><strong>四，MP的一些注解</strong></h5><ul>
<li><p><strong>@TableId</strong>：设置插入数据库ID策略</p>
</li>
<li><p><strong>@TableField：</strong></p>
</li>
<li><ul>
<li><strong>value属性：</strong>设置表中字段和实体类属性的映射</li>
<li><strong>exist属性</strong>：当设置为false时，则意味着声明该属性在数据库中不存在对应字段</li>
<li><strong>select属性：</strong>当设置为false时，则意味着声明该属性不需要被查询出来</li>
</ul>
</li>
</ul>
<h5 id="五，MP使用selectPage方法"><a href="#五，MP使用selectPage方法" class="headerlink" title="五，MP使用selectPage方法"></a><strong>五，MP使用selectPage方法</strong></h5><ol>
<li><p><strong>配置分页插件</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"><span class="comment">//    配置分页插件</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PaginationInterceptor <span class="title">paginationInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PaginationInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>编写运行方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectPage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    wrapper.like(<span class="string">"username"</span>,<span class="string">"fan"</span>);</span><br><span class="line">    IPage&lt;User&gt; IPage = userMapper.selectPage(page, wrapper);</span><br><span class="line">    List&lt;User&gt; users = IPage.getRecords();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="六，MP的基本配置"><a href="#六，MP的基本配置" class="headerlink" title="六，MP的基本配置"></a><strong>六，MP的基本配置</strong></h5><ol>
<li><p><strong>ConfigLocation：在application.properties中开启</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定全局配置文件</span></span><br><span class="line"><span class="meta">mybatis-plus.config-location</span>=<span class="string">classpath:mybatis-config.xml</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>MapperLocations：MybatisMappers所对应的xml文件位置，如果在Mapper中有自定义方法（xml中有自定义实现），需要进行配置，    告诉Mapper所对应的XML文件位置</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定Mapper.xml文件路径</span></span><br><span class="line"><span class="meta">mybatis-plus.mapper-locations</span>=<span class="string">classpath*:mybatis/*.xml</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p><strong>TypeAliasesPackage：Mybatis别名包扫描路径，通过该属性可以给包中的类注册别名,注册后在mapper对应的xml文件中可以直接使用类名,而不是使用全限定类名</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#实体对象的扫描包</span></span><br><span class="line"><span class="meta">mybatis-plus.type-aliases-package</span>=<span class="string">com.itfang.www.pojo</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><p><strong>MapUnderscoreToCamelCase：是否开启自动驼峰命名规则（camel case）映射，即从经典数据库列名A_COLUMN（下划线命名）到经典Java属性名aColumn（驼峰命名）的类似映射</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关闭自动驼峰映射,该参数不能和mybatis-plus.config-localtion同时存在</span></span><br><span class="line"><span class="meta">mybatis-plus.configuration.map-underscore-to-camel-case</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="5">
<li><p><strong>CacheEnable：全局地开启或关闭配置文件中的所有映射器已经配置的任何缓存，默认为true</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mybatis-plus.configuration.cache-enabled</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="6">
<li><p><strong>IdType：全局默认主键类型，设置后，即可省略实体对象中的@TableId（type = IdType.AUTO）配置</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全局id的生成策略</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.db-config.id-type</span>=<span class="string">auto</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="7">
<li><p><strong>TablePrefix：表示前缀，全局配置后可以省略@TableName（）配置</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全局表名的前缀</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.db-config.table-prefix</span>=<span class="string">tb_</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="七-MP的条件构造器"><a href="#七-MP的条件构造器" class="headerlink" title="七,MP的条件构造器"></a><strong>七,MP的条件构造器</strong></h5><ol>
<li><strong>allEq()：</strong></li>
</ol>
<ul>
<li><strong>filter：</strong>过滤函数，是否允许字段传入比对条件中</li>
<li><strong>params：</strong>key为数据库字段名，value为字段值，是一个map集合</li>
<li><strong>null2Isnull：</strong>为true则在map的value为null时调用isNull方法，为false则忽略value为null的值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">testAllEq</span><span class="params">()</span></span>&#123;</span><br><span class="line">      Map&lt;String,String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      params.put(<span class="string">"username"</span>,<span class="string">"itfang"</span>);</span><br><span class="line">      params.put(<span class="string">"password"</span>, <span class="keyword">null</span>);</span><br><span class="line">      QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"><span class="comment">//    value为null的字段调用IsNull方法</span></span><br><span class="line">      wrapper.allEq(params);</span><br><span class="line"><span class="comment">//    value为null的字段忽略</span></span><br><span class="line">      wrapper.allEq(params, <span class="keyword">false</span>);</span><br><span class="line"><span class="comment">//    如果value为"username"或"password"的字段才加入比对</span></span><br><span class="line">      wrapper.allEq((k, v) -&gt; (k.equals(<span class="string">"username"</span>) || k.equals(<span class="string">"password"</span>)), params);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="八，MP的基本比较操作"><a href="#八，MP的基本比较操作" class="headerlink" title="八，MP的基本比较操作"></a><strong>八，MP的基本比较操作</strong></h5><ul>
<li><strong>eq：</strong>等于=</li>
<li><strong>ne：</strong>不等于&lt;&gt;</li>
<li><strong>gt：</strong>大于&gt;</li>
<li><strong>ge：</strong>大于等于&gt;=</li>
<li><strong>lt：</strong>小于&lt;</li>
<li><strong>le：</strong>小于等于&lt;=</li>
<li><strong>between</strong>:BETWEEN 值1 AND 值2</li>
<li><strong>notBetween</strong>：NOT BETWEEN 值1 AND 值2</li>
<li><strong>in</strong>：字段 IN(value.get（0），value.get（1）,….)</li>
<li><strong>notIn：</strong>字段 NOT IN（v0，v1,….）</li>
</ul>
<h5 id="九，MP的模糊查询"><a href="#九，MP的模糊查询" class="headerlink" title="九，MP的模糊查询"></a><strong>九，MP的模糊查询</strong></h5><ul>
<li><strong>like：</strong>LIKE ‘%值%’</li>
<li><strong>notLike：</strong>NOT LIKE ‘%值%’</li>
<li><strong>likeLeft：</strong>LIKE ‘%值’</li>
<li><strong>likeRight</strong>：LIKE ‘值%’</li>
</ul>
<h5 id="十，MP的排序"><a href="#十，MP的排序" class="headerlink" title="十，MP的排序"></a><strong>十，MP的排序</strong></h5><ul>
<li><strong>orderBy：</strong>ORDER BY 字段,….</li>
<li><strong>orderByAsc（正序）：</strong>ORDER BY 字段,….ASC</li>
<li><strong>orderByDesc（倒序）：</strong>ORDER BY 字段,….DESC</li>
</ul>
<h5 id="十一，MP的逻辑查询"><a href="#十一，MP的逻辑查询" class="headerlink" title="十一，MP的逻辑查询"></a><strong>十一，MP的逻辑查询</strong></h5><ul>
<li><strong>or：</strong>OR ，主动调用or表示紧接着下一个方法不是用and连接（不调用or则默认为使用and连接）</li>
<li><strong>and:：</strong>AND 嵌套</li>
</ul>
<h5 id="十二，MP之ActiveRecord（AR）"><a href="#十二，MP之ActiveRecord（AR）" class="headerlink" title="十二，MP之ActiveRecord（AR）"></a><strong>十二，MP之ActiveRecord（AR）</strong></h5><ul>
<li><p>ActiveRecord的主要思想：</p>
</li>
<li><ul>
<li>每一个数据库表对应床架一个类，类的每一个对象实例对应于数据库中表的一行记录；通常表的每个字段在类中都有响应的Field；</li>
<li>ActiveRecord同时负责把自己持久化，在ActiveRecord中封装了对数据库库的访问，即CURD；</li>
<li>ActiveRecord是一种领域模式（Domain Model），封装了部分业务逻辑；</li>
</ul>
</li>
<li><p>ActiveRecord的使用</p>
<ol>
<li><p><strong>将pojo实体类继承Model&lt;实体类名&gt;</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Major</span> <span class="keyword">extends</span> <span class="title">Model</span>&lt;<span class="title">Major</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String major;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ul>
<ol start="2">
<li><p><strong>直接使用实体类对象进行CRUD</strong>（<strong>但是仍然需要编写实体类的Mapper接口</strong>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringBootPandaApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Major major = <span class="keyword">new</span> Major();</span><br><span class="line">        List&lt;Major&gt; majors = major.selectAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="十三，MP的拦截器插件"><a href="#十三，MP的拦截器插件" class="headerlink" title="十三，MP的拦截器插件"></a><strong>十三，MP的拦截器插件</strong></h5><p>MyBatis允许在已映射语句执行过程中的某一点进行拦截调用，拦截的方法调用包括：</p>
<ol>
<li><strong>Executor</strong>【<strong>拦截执行器的方法</strong>】（update，query，flushStatements，commit，rollback，getTransaction，close，isClosed）</li>
<li><strong>ParameterHandler【拦截参数的处理】</strong>（getParameterObject，setParameters）</li>
<li><strong>ResultSetHandler【拦截结果集的处理】</strong>（handleResultSets，handleOutputParameters）</li>
<li><strong>StatamentHandler【拦截Sql语法构建的处理】</strong>（prepare,parameterize，batch,update,query）</li>
</ol>
<p><strong>拦截器的示例：</strong></p>
<ol>
<li><p><strong>自定义拦截器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义mybatisPlus拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Intercepts</span>(&#123;<span class="meta">@Signature</span>(</span><br><span class="line">        type = Executor<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">        <span class="title">method</span> </span>= <span class="string">"update"</span>,</span><br><span class="line">        args = &#123;MappedStatement<span class="class">.<span class="keyword">class</span>,<span class="title">Object</span>.<span class="title">class</span>&#125;</span></span><br><span class="line"><span class="class">)&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MyInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"><span class="comment">//        拦截方法,具体业务逻辑编写的位置</span></span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        创建target对象的代理类,目的是将当前拦截器加入到该对象中</span></span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target,<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        属性设置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><strong>将拦截器注入到spring容器中或配置mybatis-config.xml中</strong></li>
</ol>
<p><strong>注入到spring容器中：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyInterceptor <span class="title">myInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置到mybatis-config.xml中：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.itfang.www.plugins.MyInterceptor"</span>&gt;</span><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="十四，MP的执行分析插件"><a href="#十四，MP的执行分析插件" class="headerlink" title="十四，MP的执行分析插件"></a><strong>十四，MP的执行分析插件</strong></h5><p>在MP中提供了对SQL执行的分析的插件，可用作阻断全表更新，删除的操作，注意：该插件仅适用于开发环境，不适用于生产环境，当执行全表更新时，会抛出异常，这样有效防止了一些误操作</p>
<p><strong>springboot配置：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlExplainInterceptor <span class="title">sqlExplainInterceptor</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        SqlExplainInterceptor sqlExplainInterceptor = <span class="keyword">new</span> SqlExplainInterceptor();</span><br><span class="line">        List&lt;ISqlParser&gt; sqlParserList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//        攻击SQL阻断解析器,加入解析链</span></span><br><span class="line">        sqlParserList.add(<span class="keyword">new</span> BlockAttackSqlParser());</span><br><span class="line">        sqlExplainInterceptor.setSqlParserList(sqlParserList);</span><br><span class="line">        <span class="keyword">return</span> sqlExplainInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="十五，MP的性能执行分析插件"><a href="#十五，MP的性能执行分析插件" class="headerlink" title="十五，MP的性能执行分析插件"></a><strong>十五，MP的性能执行分析插件</strong></h5><p>性能分析拦截器，用于输出每条SQL语句及其执行时间，可以设置最大执行时间，超过时间会抛出异常，该插件只用于开发环境，不建议生产环境使用。</p>
<p><strong>springboot配置：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SQL 执行性能分析插件</span></span><br><span class="line"><span class="comment"> * 开发环境使用，线上不推荐。 maxTime 指的是 sql 最大执行时长</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 三种环境</span></span><br><span class="line"><span class="comment"> *      * dev：开发环境</span></span><br><span class="line"><span class="comment"> *      * test：测试环境</span></span><br><span class="line"><span class="comment"> *      * prod：生产环境</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Profile</span>(&#123;<span class="string">"dev"</span>,<span class="string">"test"</span>&#125;)<span class="comment">// 设置 dev test 环境开启</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PerformanceInterceptor <span class="title">performanceInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	PerformanceInterceptor performanceInterceptor = <span class="keyword">new</span> PerformanceInterceptor();</span><br><span class="line">	performanceInterceptor.setMaxTime(<span class="number">500</span>);<span class="comment">//ms，超过此处设置的ms则sql不执行</span></span><br><span class="line">	performanceInterceptor.setFormat(<span class="keyword">true</span>);</span><br><span class="line">	<span class="keyword">return</span> performanceInterceptor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置到mybatis-config.xml中：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.PerformanceInterceptor"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- maxTime 指的是 sql 最大执行时长 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTime"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--SQL是否格式化 默认false--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"format"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h5 id="十六，MP的乐观锁插件"><a href="#十六，MP的乐观锁插件" class="headerlink" title="十六，MP的乐观锁插件"></a><strong>十六，MP的乐观锁插件</strong></h5><ol>
<li><strong>适用场景</strong>：当要更新一条记录的时候，希望这条记录没有被别人更新；</li>
<li><strong>乐观锁实现的方式：</strong></li>
</ol>
<ul>
<li>取出记录时，带上当前version</li>
<li>更新时，带上这个version</li>
<li>执行更新时，set version = newVersion where version = oldVersion</li>
<li>如果version不对，就更新失败。</li>
</ul>
<p><strong>3. 乐观锁的使用：</strong></p>
<ol>
<li><strong>需要在数据库中实体类对应表中添加version字段</strong></li>
<li><strong>在实体类对象中添加version属性，并加上@Version注解</strong></li>
<li><strong>配置乐观锁插件：</strong></li>
</ol>
<p><strong>springboot配置：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> OptimisticLockerInterceptor <span class="title">optimisticLockerInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OptimisticLockerInterceptor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置到mybatis-config.xml中：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        乐观锁插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.baomidou.mybatisplus.extension.plugins.OptimisticLockerInterceptor"</span>&gt;</span><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p><strong>测试：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdata</span><span class="params">()</span></span>&#123;</span><br><span class="line">   User user = <span class="keyword">new</span> User();</span><br><span class="line">   user.setId(<span class="number">2</span>);  <span class="comment">//查询条件</span></span><br><span class="line">   user.setPassword(<span class="string">"123"</span>);   <span class="comment">//更新的数据</span></span><br><span class="line">   user.setVersion(<span class="number">1</span>);       <span class="comment">//当前的版本信息,mybatisPlus的乐观锁插件会根据你输入的版本信息为你在SQL语句中增加where version = #&#123;你输入的版本信息&#125;以及set version = #&#123;你输入的版本信息+1&#125;</span></span><br><span class="line">   <span class="keyword">int</span> result = <span class="keyword">this</span>.userMapper.updateById(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p><strong>乐观锁的特别说明：</strong></p>
<ul>
<li><strong>支持的数据类型只有:int,Integer,long,Long,Date,Timestamp,LocalDateTime</strong></li>
<li><strong>整数类型下 newVersion = oldVersion + 1</strong></li>
<li><strong>newVersion 会回写到entity中</strong></li>
<li><strong>仅支持updateById(id)与update（entity，wrapper）方法</strong></li>
<li><strong>在update（entity，wrapper）方法下，wrapper不能复用</strong></li>
</ul>
</li>
</ol>
</li>
</ol>
<h5 id="十七，MP的自动填充功能"><a href="#十七，MP的自动填充功能" class="headerlink" title="十七，MP的自动填充功能"></a><strong>十七，MP的自动填充功能</strong></h5><ul>
<li>插入或者更新数据时，希望有些字段可以自动填充数据，比如密码，version等</li>
</ul>
<ol>
<li><p><strong>添加@TableField注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Version</span></span><br><span class="line"><span class="meta">@TableField</span>(fill = FieldFill.DEFAULT)</span><br><span class="line"><span class="keyword">private</span> Integer version;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认不处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DEFAULT,</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入填充字段</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">INSERT,</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新填充字段</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">UPDATE,</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入和更新填充字段</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">INSERT_UPDATE</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写MyMetaObjectHandler实现MetaObjectHandler 接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title">MetaObjectHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        Object version = getFieldValByName(<span class="string">"version"</span>, metaObject);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == version)&#123;</span><br><span class="line"><span class="comment">//            字段为空,可以进行填充</span></span><br><span class="line">            setFieldValByName(<span class="string">"version"</span>,<span class="string">"1"</span>,metaObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h5 id="十八，MP的逻辑删除"><a href="#十八，MP的逻辑删除" class="headerlink" title="十八，MP的逻辑删除"></a><strong>十八，MP的逻辑删除</strong></h5><ul>
<li>逻辑删除就是将数据标记为删除，而并非真正的物理删除（非DELETE操作），查询时需要携带状态条件，确保被标记的数据不被查询到。这样做的目的就是避免数据被真正的删除。</li>
</ul>
<ol>
<li><p><strong>在数据库中增加deleted字段，用于表示数据是否被删除，1代表删除，0代表未删除</strong></p>
</li>
<li><p><strong>在实体类上的deleted属性添加@TableLogic注解</strong></p>
</li>
<li><p><strong>在application.properties</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#逻辑已删除值（默认值为1）</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.db-config.logic-delete-value</span>=<span class="string">1</span></span><br><span class="line"><span class="comment">#逻辑未删除值（默认值为0）</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.db-config.logic-not-delete-value</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleted</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.userMapper.deleteById(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h5 id="十九，MP的通用枚举"><a href="#十九，MP的通用枚举" class="headerlink" title="十九，MP的通用枚举"></a><strong>十九，MP的通用枚举</strong></h5><ol>
<li><p><strong>编写枚举类型并实现IEnum接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SexEnum implements IEnum&lt;Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    MAN(<span class="number">1</span>,<span class="string">"男"</span>),</span><br><span class="line">    WOMAN(<span class="number">2</span>,<span class="string">"女"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    SexEnum(<span class="keyword">int</span> value,String desc)&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>配置枚举类型扫描包</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#枚举扫描包</span></span><br><span class="line"><span class="meta">mybatis-plus.type-enums-package</span>=<span class="string">com.itfang.www.enums</span></span><br></pre></td></tr></table></figure>





</li>
</ol>
<h5 id="二十，MP的代码生成器"><a href="#二十，MP的代码生成器" class="headerlink" title="二十，MP的代码生成器"></a><strong>二十，MP的代码生成器</strong></h5><ol>
<li><p><strong>导入依赖包</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--添加模板引擎--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity-engine-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.freemarker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.29<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ibeetl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>beetl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.15.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--根据AutoGenerator导入所需要的依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据库 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- velocity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity-engine-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sfl4j日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写代码生成器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zh;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.AutoGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.DataSourceConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.GlobalConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.PackageConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.StrategyConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/12/3 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 全局配置</span></span><br><span class="line">        GlobalConfig config = <span class="keyword">new</span> GlobalConfig();</span><br><span class="line">        <span class="comment">// 是否支持AR模式</span></span><br><span class="line">        config.setActiveRecord(<span class="keyword">true</span>)</span><br><span class="line">                <span class="comment">// 作者</span></span><br><span class="line">                .setAuthor(<span class="string">"Bean"</span>)</span><br><span class="line">                <span class="comment">// 生成路径</span></span><br><span class="line">                .setOutputDir(<span class="string">"D:\\mybatisplus"</span>)</span><br><span class="line">                <span class="comment">// 文件覆盖</span></span><br><span class="line">                .setFileOverride(<span class="keyword">true</span>)</span><br><span class="line">                <span class="comment">// 主键策略</span></span><br><span class="line">                .setIdType(IdType.AUTO)</span><br><span class="line">　　　　　　　　　　<span class="comment">// 设置日期格式</span></span><br><span class="line">　　　　　　　　　　.setDateType(DateType.ONLY_DATE)</span><br><span class="line">                <span class="comment">// 设置生成的service接口的名字的首字母是否为I，默认Service是以I开头的</span></span><br><span class="line">                .setServiceName(<span class="string">"%sService"</span>)</span><br><span class="line">                <span class="comment">//生成基本的resultMap</span></span><br><span class="line">                .setBaseResultMap(<span class="keyword">true</span>)</span><br><span class="line">                <span class="comment">//生成基本的SQL片段</span></span><br><span class="line">                .setBaseColumnList(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 数据源配置</span></span><br><span class="line">        DataSourceConfig dsConfig = <span class="keyword">new</span> DataSourceConfig();</span><br><span class="line">        <span class="comment">// 设置数据库类型</span></span><br><span class="line">        dsConfig.setDbType(DbType.MYSQL)</span><br><span class="line">                .setDriverName(<span class="string">"com.mysql.jdbc.Driver"</span>)</span><br><span class="line">                .setUrl(<span class="string">"jdbc:mysql://localhost:3306/usercenter?useSSL=false"</span>)</span><br><span class="line">                .setUsername(<span class="string">"****"</span>)</span><br><span class="line">                .setPassword(<span class="string">"****"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 策略配置globalConfiguration中</span></span><br><span class="line">        StrategyConfig stConfig = <span class="keyword">new</span> StrategyConfig();</span><br><span class="line">        <span class="comment">//全局大写命名</span></span><br><span class="line">        stConfig.setCapitalMode(<span class="keyword">true</span>)</span><br><span class="line">                <span class="comment">// 数据库表映射到实体的命名策略</span></span><br><span class="line">                .setNaming(NamingStrategy.underline_to_camel)</span><br><span class="line">                <span class="comment">// 生成的表, 支持多表一起生成，以数组形式填写</span></span><br><span class="line">                .setInclude(<span class="string">"user_info"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 包名策略配置</span></span><br><span class="line">        PackageConfig pkConfig = <span class="keyword">new</span> PackageConfig();</span><br><span class="line">        pkConfig.setParent(<span class="string">"com.zh.usercenter"</span>)</span><br><span class="line">                .setMapper(<span class="string">"dao"</span>)</span><br><span class="line">                .setService(<span class="string">"service"</span>)</span><br><span class="line">                .setController(<span class="string">"controller"</span>)</span><br><span class="line">                .setEntity(<span class="string">"entity"</span>)</span><br><span class="line">                .setXml(<span class="string">"mapper"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 整合配置</span></span><br><span class="line">        AutoGenerator ag = <span class="keyword">new</span> AutoGenerator();</span><br><span class="line">        ag.setGlobalConfig(config)</span><br><span class="line">                .setDataSource(dsConfig)</span><br><span class="line">                .setStrategy(stConfig)</span><br><span class="line">                .setPackageInfo(pkConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 执行</span></span><br><span class="line">        ag.execute();</span><br><span class="line">　　　　　System.out.println(<span class="string">"======= 代码生成完毕 ========"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h5 id="二十一，快速开发工具——MybatisX"><a href="#二十一，快速开发工具——MybatisX" class="headerlink" title="二十一，快速开发工具——MybatisX"></a><strong>二十一，快速开发工具——MybatisX</strong></h5><p>MybatisX是一款基于IDEA的快速开发插件，可以直接在IDEA中搜索并安装</p>
<p>功能：</p>
<ul>
<li>Java和XML调回跳转</li>
<li>Mapper方法自动生成XML</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/06/MybatisPlus/" data-id="ckfmaqxhc0004kcua0exk9e7x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-IDEA快捷键" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/31/IDEA%E5%BF%AB%E6%8D%B7%E9%94%AE/" class="article-date">
  <time datetime="2020-07-31T13:52:21.000Z" itemprop="datePublished">2020-07-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/31/IDEA%E5%BF%AB%E6%8D%B7%E9%94%AE/">IDEA快捷键</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="IDEA快捷键"><a href="#IDEA快捷键" class="headerlink" title="IDEA快捷键"></a><strong>IDEA快捷键</strong></h2><p><strong>Ctrl+Z</strong>：撤销</p>
<p><strong>Ctrl+Shift+Z</strong>：重做</p>
<p><strong>Ctrl+X</strong>：剪贴</p>
<p><strong>Ctrl+C</strong>：复制</p>
<p><strong>Ctrl+V</strong>：粘贴</p>
<p><strong>Ctrl+Y</strong>：删除当前行</p>
<p><strong>Ctrl+D</strong>:复制当前行</p>
<p><strong>Ctrl+Shift+J</strong>：将选中的行合并成一行</p>
<p><strong>Ctrl+N</strong>：查找类文件</p>
<p><strong>Ctrl+Shift+N</strong>：查找文件</p>
<p><strong>Ctrl+G</strong>：定位到文件某一行</p>
<p><strong>Alt+向左箭头</strong>：返回上次光标位置</p>
<p><strong>Alt+向右箭头</strong>：返回至后一次光标位置</p>
<p><strong>Ctrl+Shift+Backspace</strong>：返回上次编辑位置</p>
<p><strong>Ctrl+Shift+反斜杠</strong>：返回后一次编辑位置</p>
<p><strong>Ctrl+B</strong>：定位至变量定义的位置</p>
<p><strong>Ctrl+Alt+B</strong>：定位至选中类或者方法的具体实现</p>
<p><strong>Ctrl+Shift+B</strong>:直接定位至光标所在变量的类型定义</p>
<p><strong>Ctrl+U</strong>：直接定位至当前方法override或者implements的方法定义处</p>
<p><strong>Ctrl+F12</strong>：显示当前文件的文件结构</p>
<p><strong>Ctrl+Alt+F12</strong>：显示当前文件的路径，并可以方便的将相关父路径打开</p>
<p><strong>Ctrl+H</strong>：显示当前类的继承层次</p>
<p><strong>Ctrl+Shift+H</strong>：显示当前方法的继承层次</p>
<p><strong>Ctrl+Alt+H</strong>：显示当前方法的调用层次</p>
<p><strong>F2</strong>：定位至下一个错误处</p>
<p><strong>Shift+F2</strong>：定位至前一个错误处</p>
<p><strong>Ctrl+Alt+向上箭头</strong>：查找前一个变量共现的地方</p>
<p><strong>Ctrl+Alt+向下箭头</strong>：查找下一个变量共现的地方</p>
<p><strong>Ctrl+=</strong>：展开代码</p>
<p><strong>Ctrl+-</strong>：收缩代码</p>
<p><strong>Ctrl+Alt+=</strong>：递归展开代码</p>
<p><strong>Ctrl+Alt+-</strong>：递归收缩代码</p>
<p><strong>Ctrl+Shift+=</strong>：展开所有代码</p>
<p><strong>Ctrl+Shift+-</strong>：收缩所有代码</p>
<p><strong>Ctrl+Shitft+向下箭头</strong>：将光标所在的代码块向下整体移动</p>
<p><strong>Ctrl+Shift+向上箭头</strong>：将光标所在的代码块向上整体移动</p>
<p><strong>Ctrl+Alt+Shift+向左箭头</strong>：将元素向左移动</p>
<p><strong>Ctrl+Alt+Shift+向右箭头</strong>：将元素向右移动</p>
<p><strong>Alt+Shift+向下箭头</strong>：将行向下移动</p>
<p><strong>Alt+Shift+向上箭头</strong>：将行向上移动</p>
<p><strong>Ctrl+F</strong>：在当前文件中查找</p>
<p><strong>Ctrl+R</strong>：替换字符串</p>
<p><strong>Ctrl+Shift+F</strong>:在全局文件中查找字符串</p>
<p><strong>Ctrl+Shift+R</strong>：在全局中替换字符串</p>
<p><strong>Alt+F7</strong>：查找当前变量的使用，并列表显示</p>
<p><strong>Ctrl+Alt+F7</strong>：查找当前变量的使用，并直接对话框提示</p>
<p><strong>Ctrl+F7</strong>：在文件中查找符号的使用</p>
<p><strong>Ctrl+Shift+F7</strong>：在文件中高亮显示变量的使用</p>
<p><strong>Ctrl+O</strong>：重写基类方法</p>
<p><strong>Ctrl+I</strong>：实现基类或接口中的方法</p>
<p><strong>Alt+Insert</strong>：产生构造方法，get/set方法等</p>
<p><strong>Ctrl+Alt+T</strong>：将选中的代码使用if，while，try/catch等包装</p>
<p><strong>Ctrl+Shitf+Delete</strong>：去除相关的包装代码</p>
<p><strong>Alt+/</strong>：自动完成</p>
<p><strong>Alt+Enter</strong>：自动提示完成，抛出异常</p>
<p><strong>Ctrl+J</strong>：插入Live Template 快速插入一行或者多行代码</p>
<p><strong>Ctrl+Alt+J</strong>：使用Live Template包装</p>
<p><strong>Ctrl+/</strong>：使用//注释</p>
<p><strong>Ctrl+Shift+/：使用/\</strong>/注释</p>
<p><strong>Ctrl+Alt+L</strong>：格式化代码</p>
<p><strong>Ctrl+Alt+I</strong>：自动缩进行</p>
<p><strong>Ctrl+Alt+O</strong>：优化import</p>
<p><strong>Ctrl+]</strong>：快速跳转至诸如{}围起来的代码块的结尾处</p>
<p><strong>Ctrl+[</strong>：快速跳转至诸如{}围起来的代码块的开头处</p>
<p><strong>Ctrl+Shift+Enter</strong>：将输入的if，for，函数等等补上{}或者；使代码语句完整</p>
<p><strong>Shift+Enter</strong>：在当前行的下方开始新行</p>
<p><strong>Ctrl+Alt+Enter</strong>：在当前行的上方插入新行</p>
<p><strong>Ctrl+Delete</strong>：删除光标所在至单词结尾处的所有字符</p>
<p><strong>Ctrl+Backspace</strong>：删除光标所在至单词开头处的所有字符</p>
<p><strong>Ctrl+向左箭头</strong>：将光标移至前一个单词</p>
<p><strong>Ctrl+向右箭头</strong>：将光标移至后一个单词</p>
<p><strong>Ctrl+向上箭头</strong>：向上滚动一行</p>
<p><strong>Ctrl+向下箭头</strong>：向下滚动一行</p>
<p><strong>Ctrl+W</strong>：选中整个单词</p>
<p><strong>Ctrl+Shift+U</strong>：切换大小写</p>
<p><strong>Shift+F6</strong>：重命名</p>
<p><strong>Ctrl+F6</strong>：更改函数签名</p>
<p><strong>Ctrl+Shift+F6</strong>：更改类型</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/31/IDEA%E5%BF%AB%E6%8D%B7%E9%94%AE/" data-id="ckfmaqxg90001kcua8xnfb1b6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-SpringBoot" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/29/SpringBoot/" class="article-date">
  <time datetime="2020-07-29T09:11:15.000Z" itemprop="datePublished">2020-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/29/SpringBoot/">SpringBoot</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="一，springBoot入门"><a href="#一，springBoot入门" class="headerlink" title="一，springBoot入门"></a><strong>一，springBoot入门</strong></h5><ol>
<li><strong>配置pom.xml文件，引入spring-boot-starter坐标</strong></li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itfang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springBoot入门<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>编写springboot的启动类</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * springboot工程都有一个启动引导类,这是工程的入口类</span></span><br><span class="line"><span class="comment"> * 并在引导类上添加<span class="doctag">@SpringBootApplication</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>编写控制器类</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"spring boot Hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="二，springboot的自动配置"><a href="#二，springboot的自动配置" class="headerlink" title="二，springboot的自动配置"></a>二，springboot的自动配置</h5><ul>
<li><p>​    springboot在启动的时候，从类路径下/META-INF/<code>spring.factories</code>获取指定的值；</p>
</li>
<li><p>将这些自动配置的类导入容器，自动配置就会生效，帮我们自动配置；</p>
</li>
<li><p>整合javaEE,解决方案和自动配置的东西都在<code>spring-boot-autoconfigure-2.2.0.RELEASE.jar</code>这个包下；</p>
</li>
<li><p>springboot会把所有需要导入的组件，以类名的方式返回，这些组件就会被添加到容器；</p>
</li>
<li><p>容器中也会存在非常多的<code>xxxAutoConfiguration</code>的文件（<code>@Bean</code>）,就是这些类给容器中导入了这个场景需要的所有组件，并自动配置，<code>@Configuration</code>,JavaConfig!</p>
</li>
<li><p>有了自动配置类，免去了我们手动编写配置文件的工作。</p>
</li>
</ul>
<h5 id="三，SpringBoot几个常用的注解"><a href="#三，SpringBoot几个常用的注解" class="headerlink" title="三，SpringBoot几个常用的注解"></a><strong>三，SpringBoot几个常用的注解</strong></h5><ul>
<li><strong>@Configuration：</strong>声明一个类作为配置类，代替xml文件</li>
<li><strong>@Bean</strong>：声明在方法上，将方法的返回值加入Bean容器，代替<bean>标签</bean></li>
<li><strong>@Value</strong>：属性注入</li>
<li><strong>@PropertySource：</strong>指定外部属性文件</li>
</ul>
<p>配置druid数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:jdbc.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;jdbc.driver&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;jdbc.url&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;jdbc.username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;jdbc.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driver);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(username);</span><br><span class="line">        dataSource.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="四，Spring-Boot属性注入方式"><a href="#四，Spring-Boot属性注入方式" class="headerlink" title="四，Spring Boot属性注入方式"></a><strong>四，Spring Boot属性注入方式</strong></h5><ol>
<li><p><strong>第一种：直接将@ConfigurationProperties编写在方法上</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// 声明要注入的属性前缀，SpringBoot会自动把相关属性通过set方法注入到DataSource中</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"jdbc"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>第二种：使用@ConfigurationProperties编写配置项类将配置文件中的配置项设置到对象中</strong></p>
</li>
<li><ol>
<li><p><strong>导入@ConfigurationProperties的依赖支持</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>创建配置项类JdbcProperties类，在该类名上m面添加@ConfigurationProperties；</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *ConfigurationProperties：从application配置文件中读取配置项</span></span><br><span class="line"><span class="comment"> *                              prefix：表示配置项的前缀</span></span><br><span class="line"><span class="comment"> *配置项类中的类变量名必须要与前缀之后的配置项名称保持相同（松散绑定）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"jdbc"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDriver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> driver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDriver</span><span class="params">(String driver)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.driver = driver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>将jdbc.properties修改名称为application.properties；</strong></p>
</li>
<li><p><strong>将JdbcProperties对象注入到JdbcConfig；</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(JdbcProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">JdbcConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(JdbcProperties jdbcProperties)</span> </span>&#123;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        dataSource.setDriverClassName(jdbcProperties.getDriver());</span><br><span class="line">        dataSource.setUrl(jdbcProperties.getUrl());</span><br><span class="line">        dataSource.setUsername(jdbcProperties.getUsername());</span><br><span class="line">        dataSource.setPassword(jdbcProperties.getPassword());</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ol>
<h5 id="五，多个yml配置文件"><a href="#五，多个yml配置文件" class="headerlink" title="五，多个yml配置文件"></a><strong>五，多个yml配置文件</strong></h5><ol>
<li><p>yml配置文件的特征</p>
<ol>
<li><p>树状层级结构展示配置项</p>
</li>
<li><p>配置项之间如果有关系的话需要分行空两格</p>
</li>
<li><p>配置项如果有值的话，那么需要在：之后空一格再写配置项值；</p>
</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbc:</span></span><br><span class="line">  <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/study?serverTimezone=UTC</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">it-fang</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="2">
<li>多个yml配置文件：在SpringBoot中是被允许的，这些配置文件的名称必须为application-xxx.yml，并且这些配置文件必须要在application.yml配置文件中激活之后才可以使用 。</li>
</ol>
<p><strong>application.yml:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbc:</span></span><br><span class="line">  <span class="attr">dirver:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">  <span class="string">url=jdbc:</span> <span class="string">mysql://127.0.0.1:3306/study?serverTimezone=UTC</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">it-fang</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#激活配置文件,需要指定其它配置文件的名称,def为指向application-def.yml文件</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">def</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>如果properties和yml配置文件同时存在SpringBoot项目中，那么这两类配置文件都有效。在两个配置文件中如果存在同名的配置项的话以properties文件的为主。</li>
</ol>
<h5 id="六，lombok的使用"><a href="#六，lombok的使用" class="headerlink" title="六，lombok的使用"></a><strong>六，lombok的使用</strong></h5><ul>
<li>@Data：自动提供getter和setter，hashcode，equals，toString等方法</li>
<li>@Getter：自动提供getter方法</li>
<li>@Setter：自动提供setter方法</li>
<li>@Slf4j：自动在bean中提供log变量，其实用的是slf4j的日志功能</li>
</ul>
<h5 id="七，springboot修改Tomcat端口"><a href="#七，springboot修改Tomcat端口" class="headerlink" title="七，springboot修改Tomcat端口"></a><strong>七，springboot修改Tomcat端口</strong></h5><p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改Tomcat的端口</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8090</span></span><br></pre></td></tr></table></figure>



<h5 id="八，springboot静态资源路径："><a href="#八，springboot静态资源路径：" class="headerlink" title="八，springboot静态资源路径："></a><strong>八，springboot静态资源路径：</strong></h5><ul>
<li>classpath:/META-INF/resources/    </li>
<li>classpath:/resources/</li>
<li>classpath:/static/   【常用】</li>
<li>classpath:/public</li>
</ul>
<h5 id="九，springboot整合springMVC拦截器"><a href="#九，springboot整合springMVC拦截器" class="headerlink" title="九，springboot整合springMVC拦截器"></a><strong>九，springboot整合springMVC拦截器</strong></h5><ol>
<li><p><strong>编写拦截器（实现HandlerInterceptor）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Myinterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"preHandle"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"postHandle"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"afterCompletion"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写配置类实现WebMvcConfigurer，在该类中添加各种组件；</strong></p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册拦截器</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Myinterceptor <span class="title">myinterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Myinterceptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加拦截器到springMVC拦截器链中</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span></span>&#123;</span><br><span class="line">        registry.addInterceptor(myinterceptor()).addPathPatterns(<span class="string">"/*"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="十，springboot扩展springMVC"><a href="#十，springboot扩展springMVC" class="headerlink" title="十，springboot扩展springMVC"></a>十，springboot扩展springMVC</h5><ol>
<li><p>编写一个@Configuration注解类，并且实现WebMvcConfigurer接口而且不能标注@EnableWebMvc注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果想要自定义一些定制化的功能,只要写这个组件,然后将它交给springboot,springboot会帮我们自动装配</span></span><br><span class="line"><span class="comment">//扩展springMVC</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    ViewResolver实现了视图解析器接口的类,我们就可以把它当做视图解析器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">myViewResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyViewResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    自定义一个自己的视图解析器MyViewResolver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyViewResolver</span> <span class="keyword">implements</span> <span class="title">ViewResolver</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="十一，springboot整合事务管理和连接池"><a href="#十一，springboot整合事务管理和连接池" class="headerlink" title="十一，springboot整合事务管理和连接池"></a><strong>十一，springboot整合事务管理和连接池</strong></h5><ol>
<li><p><strong>添加事务相关的启动器依赖，mysql相关依赖,并在application.yml配置文件中配置数据源</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<hr>
<p><strong><em>application.yml</em></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">mysql://127.0.0.1:3306/study?serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">data-username:</span> <span class="string">it-fang</span></span><br><span class="line">    <span class="attr">data-password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p><strong>编写业务层UserService使用事务注解@Transactional</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"保存用户"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="十二，springboot整合mybatis"><a href="#十二，springboot整合mybatis" class="headerlink" title="十二，springboot整合mybatis"></a><strong>十二，springboot整合mybatis</strong></h5><ol>
<li><p><strong>添加启动器依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置Mybatis：实体类别名包，日志，映射文件等；</strong></p>
</li>
</ol>
<p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis:</span></span><br><span class="line"><span class="comment">#  实体类别名包路径</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.itfang.www.pojo</span></span><br><span class="line"><span class="comment">#  映射文件路径</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p><strong>在启动器类上添加注解@MapperScan</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">//扫描mybatis所有的业务mapper接口</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.itfang.www.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="十三，springboot使用通用Mapper"><a href="#十三，springboot使用通用Mapper" class="headerlink" title="十三，springboot使用通用Mapper"></a><strong>十三，springboot使用通用Mapper</strong></h5><ol>
<li><p><strong>添加启动器依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>tk.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>改造UserMapper继承<code>Mapper&lt;User&gt;</code>;</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.itfang.www.pojo.User;</span><br><span class="line"><span class="keyword">import</span> tk.mybatis.mapper.common.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>修改启动引导类Application的Mapper扫描注解；</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.itfang.www.mapper"</span>)   <span class="comment">//使用tk.mybatis.spring.annotation.MapperScan下的注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>修改User实体类添加jpa注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"user"</span>)       <span class="comment">//指映射的数据库表名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span>         <span class="comment">//标记为主键</span></span><br><span class="line">    <span class="meta">@KeySql</span>(useGeneratedKeys = <span class="keyword">true</span>)     <span class="comment">//主键回填,默认值为false</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"username"</span>)      <span class="comment">//如果成员属性与表字段相同或在符合驼峰规则 user_name-&gt;userName,可以不使用这个注解.</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"password"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>改造UserService</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(Integer id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        <span class="comment">//选择性新增,如果属性为空则该属性不会出现在sql语句上</span></span><br><span class="line">        userMapper.insertSelective(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="十四，springboot整合Junit"><a href="#十四，springboot整合Junit" class="headerlink" title="十四，springboot整合Junit"></a><strong>十四，springboot整合Junit</strong></h5><ol>
<li><p><strong>添加启动器依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写测试类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="十五，springboot整合Redis"><a href="#十五，springboot整合Redis" class="headerlink" title="十五，springboot整合Redis"></a><strong>十五，springboot整合Redis</strong></h5><ol>
<li><p><strong>添加启动器依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置application.yml中修改Redis的连接参数；（Redis需要启动）</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">post:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写测试类应用RedisTemplate操作Redis</strong></p>
</li>
</ol>
<h5 id="十六，springboot项目部署"><a href="#十六，springboot项目部署" class="headerlink" title="十六，springboot项目部署"></a>十六，springboot项目部署</h5><ol>
<li><p><strong>需要添加打包组件将项目中的资源，配置，依赖包打到一个jar包中；可以使用maven的package</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>部署：java-jar 包名</strong></p>
</li>
</ol>
<h5 id="十七，JSR303校验"><a href="#十七，JSR303校验" class="headerlink" title="十七，JSR303校验"></a><strong>十七，JSR303校验</strong></h5><ol>
<li><p><strong>在POJO对象上面添加@Validated注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Email</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><strong>在类属性上面加入对应的格式校验注解</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotNull</span>(message=<span class="string">"名字不能为空"</span>)</span><br><span class="line"><span class="keyword">private</span> String userName;</span><br><span class="line"><span class="meta">@Max</span>(value=<span class="number">120</span>,message=<span class="string">"年龄最大不能查过120"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"><span class="meta">@Email</span>(message=<span class="string">"邮箱格式错误"</span>)</span><br><span class="line"><span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">空检查</span><br><span class="line"><span class="meta">@Null</span>       验证对象是否为<span class="keyword">null</span></span><br><span class="line"><span class="meta">@NotNull</span>    验证对象是否不为<span class="keyword">null</span>, 无法查检长度为<span class="number">0</span>的字符串</span><br><span class="line"><span class="meta">@NotBlank</span>   检查约束字符串是不是Null还有被Trim的长度是否大于<span class="number">0</span>,只对字符串,且会去掉前后空格.</span><br><span class="line"><span class="meta">@NotEmpty</span>   检查约束元素是否为NULL或者是EMPTY.</span><br><span class="line">    </span><br><span class="line">Booelan检查</span><br><span class="line"><span class="meta">@AssertTrue</span>     验证 Boolean 对象是否为 <span class="keyword">true</span>  </span><br><span class="line"><span class="meta">@AssertFalse</span>    验证 Boolean 对象是否为 <span class="keyword">false</span>  </span><br><span class="line">    </span><br><span class="line">长度检查</span><br><span class="line"><span class="meta">@Size</span>(min=, max=) 验证对象（Array,Collection,Map,String）长度是否在给定的范围之内  </span><br><span class="line"><span class="meta">@Length</span>(min=, max=) string is between min and max included.</span><br><span class="line"></span><br><span class="line">日期检查</span><br><span class="line"><span class="meta">@Past</span>       验证 Date 和 Calendar 对象是否在当前时间之前  </span><br><span class="line"><span class="meta">@Future</span>     验证 Date 和 Calendar 对象是否在当前时间之后  </span><br><span class="line"><span class="meta">@Pattern</span>    验证 String 对象是否符合正则表达式的规则</span><br></pre></td></tr></table></figure>



<h5 id="十八，springboot整合Thymeleaf"><a href="#十八，springboot整合Thymeleaf" class="headerlink" title="十八，springboot整合Thymeleaf"></a><strong>十八，springboot整合Thymeleaf</strong></h5><ol>
<li><p><strong>导入启动器依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>将html页面放在templates目录下</strong></p>
<p><img src="/2020/07/29/SpringBoot/4.png" alt></p>
</li>
<li><p><strong>将html页面导入thymeleaf名称空间和约束</strong></p>
</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--所有的html元素都可以被thymeleaf替换接管：th:元素名--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">"$&#123;msg&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="十九，springboot整合Security"><a href="#十九，springboot整合Security" class="headerlink" title="十九，springboot整合Security"></a><strong>十九，springboot整合Security</strong></h5><ol>
<li><p><strong>添加启动器依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>在配置类SecurityConfig类上标注@EnableWebSecurity并继承WebsecurityConfigurerAdapter类且重写其中需要的方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AOP:拦截器</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    链式编程</span></span><br><span class="line"><span class="comment">//    授权</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">//        首页所有人可以访问,功能页只有对应权限的人可以访问</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/"</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">"/level1/**"</span>).hasRole(<span class="string">"vip1"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/level2/**"</span>).hasRole(<span class="string">"vip2"</span>);</span><br><span class="line"><span class="comment">//        没有权限默认会调到登陆页面,需要开启登陆页面</span></span><br><span class="line"><span class="comment">//        login</span></span><br><span class="line"><span class="comment">//      开启注销功能,注册成功后跳转到指定页面</span></span><br><span class="line">        http.logout().logoutSuccessUrl(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    认证,springboot2.1.x可以直接使用,最新版本需要使用加密方式</span></span><br><span class="line"><span class="comment">//    密码编码：PasswordEncoder</span></span><br><span class="line"><span class="comment">//    在spring Security 5.0+新增了许多密码加密方式</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">//        正常情况下这些角色数据应该从数据库中获取</span></span><br><span class="line">        auth.inMemoryAuthentication().passwordEncoder(<span class="keyword">new</span> BCryptPasswordEncoder())</span><br><span class="line">                .withUser(<span class="string">"itfang"</span>).password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"123"</span>)).roles(<span class="string">"vip1"</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .withUser(<span class="string">"god"</span>).password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"123456"</span>)).roles(<span class="string">"vip2"</span>,<span class="string">"vip3"</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .withUser(<span class="string">"girl"</span>).password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"12345"</span>)).roles(<span class="string">"vip1"</span>,<span class="string">"vip2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>SpringBootSecurity几个常用的类</strong></p>
<ul>
<li><strong>WebSecurityConfigurerAdapter：自定义Security策略</strong></li>
<li><strong>AuthenticationManagerBuilder：自定义认证策略</strong></li>
<li><strong>@EnableWebSecurity：开启WebSecurity模式</strong></li>
</ul>
</li>
</ol>
<h5 id="二十，Shiro的三大核心组件"><a href="#二十，Shiro的三大核心组件" class="headerlink" title="二十，Shiro的三大核心组件"></a><strong>二十，Shiro的三大核心组件</strong></h5><ul>
<li><strong>Subject（代表了当前用户的安全操作）：</strong>即“当前操作用户”。但是，在Shiro中，Subject这一概念并不仅仅指人，也可以是第三方进程、后台帐户（Daemon Account）或其他类似事物。它仅仅意味着“当前跟软件交互的东西”。</li>
<li><strong>SecurityManager（管理所有用户的安全操作。）：</strong>它是Shiro框架的核心，典型的Facade模式，Shiro通过SecurityManager来管理内部组件实例，并通过它来提供安全管理的各种服务。</li>
<li><strong>Realm（实质上是一个安全相关的DAO）：</strong> Realm充当了Shiro与应用安全数据间的“桥梁”或者“连接器”。也就是说，当对用户执行认证（登录）和授权（访问控制）验证时，Shiro会从应用配置的Realm中查找用户及其权限信息。Realm实质上是一个安全相关的DAO：它封装了数据源的连接细节，并在需要时将相关数据提供给Shiro。当配置Shiro时，你必须至少指定一个Realm，用于认证和（或）授权。</li>
</ul>
<h5 id="二十一，springboot整合Shiro"><a href="#二十一，springboot整合Shiro" class="headerlink" title="二十一，springboot整合Shiro"></a><strong>二十一，springboot整合Shiro</strong></h5><ol>
<li><p><strong>添加启动器依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p><strong>编写控制器获取用户需要认证的信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(User user, Model model)</span></span>&#123;</span><br><span class="line"><span class="comment">//        获取当前的用户</span></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line"><span class="comment">//        封装用户的登陆数据</span></span><br><span class="line">        UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(user.getUsername(),user.getPassword());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(token);<span class="comment">//执行登陆方法,如果没有异常则证明登陆成功</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;<span class="comment">//用户名不存在</span></span><br><span class="line">            model.addAttribute(<span class="string">"msg"</span>,<span class="string">"用户名不存在"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IncorrectCredentialsException)&#123;<span class="comment">//密码错误</span></span><br><span class="line">            model.addAttribute(<span class="string">"msg"</span>,<span class="string">"密码错误"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p><strong>编写一个自定义的UserRealm类并继承AuthorizingRealm类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义的UserRealm</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"><span class="comment">//    授权</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"执行了授权方式"</span>);</span><br><span class="line"><span class="comment">//        拿到当前登陆的对象</span></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        User currentUser = (User) subject.getPrincipal();</span><br><span class="line"><span class="comment">//         设置当前用户的权限</span></span><br><span class="line">        SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        info.addStringPermission(currentUser.getPerms());</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//  认证</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"执行了认证方式"</span>);</span><br><span class="line"><span class="comment">//        模拟从数据库中获取用户名和密码</span></span><br><span class="line">        String username = <span class="string">"root"</span>;</span><br><span class="line">        String password = <span class="string">"12345"</span>;</span><br><span class="line"><span class="comment">//        正常情况下应该根据Token里的username来获得数据库中的User对象</span></span><br><span class="line">        User user = <span class="keyword">new</span> User(username,password,<span class="string">"user:add"</span>);</span><br><span class="line">        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) authenticationToken;</span><br><span class="line">        <span class="keyword">if</span> (!usernamePasswordToken.getUsername().equals(username))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//返回null,会自动抛出UnknownAccountException异常</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        密码认证交由Shiro处理</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(user,password,<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><p><strong>编写ShiroConfig配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"><span class="comment">//    1. 创建realm对象,需要自定义xxxRealm对象</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"userRealm"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserRealm <span class="title">getUserRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserRealm();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    2. 返回DefaultWebSecurityManager</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"securityManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">getDefaultWebSecurityManager</span><span class="params">(@Qualifier(<span class="string">"userRealm"</span>)</span>UserRealm userRealm)</span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line"><span class="comment">//        关联userRealm</span></span><br><span class="line">        securityManager.setRealm(userRealm);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    3.返回ShiroFilterFactoryBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">getShiroFilterFactoryBean</span><span class="params">(@Qualifier(<span class="string">"securityManager"</span>)</span> DefaultWebSecurityManager securityManager)</span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean filterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line"><span class="comment">//        设置安全管理器</span></span><br><span class="line">        filterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line"><span class="comment">//        添加shiro内置的拦截器</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            anon：无需认证就可以访问</span></span><br><span class="line"><span class="comment">            authc：必须认证才可以访问</span></span><br><span class="line"><span class="comment">            user：必须拥有“记住我”功能才能用</span></span><br><span class="line"><span class="comment">            perms：拥有对某个资源的权限才能用</span></span><br><span class="line"><span class="comment">            role：拥有某个角色才可以访问</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Map&lt;String ,String&gt; filterMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//        filterMap.put("/user/*","anon");</span></span><br><span class="line">        filterMap.put(<span class="string">"/user/add"</span>,<span class="string">"perms[user:add]"</span>);</span><br><span class="line">        filterMap.put(<span class="string">"/user/update"</span>,<span class="string">"perms[user:update]"</span>);</span><br><span class="line">        filterFactoryBean.setFilterChainDefinitionMap(filterMap);</span><br><span class="line"><span class="comment">//        设置登陆的请求</span></span><br><span class="line">        filterFactoryBean.setLoginUrl(<span class="string">"/toLogin"</span>);</span><br><span class="line"><span class="comment">//        设置未授权页面</span></span><br><span class="line">        filterFactoryBean.setUnauthorizedUrl(<span class="string">"/noauth"</span>);</span><br><span class="line">        <span class="keyword">return</span> filterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p><a href></a></p>
<h5 id="二十二，springboot基于Shiro的跨域配置"><a href="#二十二，springboot基于Shiro的跨域配置" class="headerlink" title="二十二，springboot基于Shiro的跨域配置"></a><strong>二十二，springboot基于Shiro的跨域配置</strong></h5><ol>
<li><p><strong>配置请求拦截器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(CorsFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">"CorsFilter"</span>);</span><br><span class="line">        HttpServletResponse response = (HttpServletResponse) res;</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">        <span class="comment">//跨域设置,谁来都放行,与设置成*效果相同,但是这里设置成*行不通,因此用该方法代替</span></span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, request.getHeader(<span class="string">"Origin"</span>));</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br><span class="line">        <span class="comment">//不能设置成*,否则跨域请求会失败</span></span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"POST,PUT, GET, OPTIONS, DELETE"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Max-Age"</span>, <span class="string">"3600"</span>);</span><br><span class="line">        <span class="comment">//我这里需要放行这三个header头部字段</span></span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"content-type,x-requested-with,token"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        response.setStatus(HttpStatus.OK.value());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            System.err.println("CrosFilter Error start");</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//            System.err.println("CrosFilter Error end");</span></span><br><span class="line"><span class="comment">//            if((e.getCause()+"").contains("UnauthorizedException"))&#123;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>加入shiro的过滤请求拦截链中</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Filter&gt; filters = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">filters.put(<span class="string">"authc"</span>,<span class="keyword">new</span> CorsFilter());</span><br><span class="line">filterFactoryBean.setFilters(filters);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>在前端的ajax请求中将withCredentials设置为true</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jQuery.ajax(&#123;</span><br><span class="line">    url: <span class="string">'http://localhost:8080/duty/sign'</span>,</span><br><span class="line">    xhrFields: &#123;</span><br><span class="line">        withCredentials:<span class="literal">true</span>,</span><br><span class="line">        useDefaultXhrHeader:<span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><a href="https://blog.csdn.net/qq_39743373/article/details/103895320" target="_blank" rel="noopener">解决shiro用户登陆问题</a></p>
<h5 id="二十三，springboot整合swagger"><a href="#二十三，springboot整合swagger" class="headerlink" title="二十三，springboot整合swagger"></a><strong>二十三，springboot整合swagger</strong></h5><ol>
<li><p><strong>导入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><strong>配置SwaggerConfig配置类</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2     <span class="comment">//开启Swagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    配置Swagger的Docket的bean实例</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">docket</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .enable(<span class="keyword">false</span>)      <span class="comment">//enable：是否启动swagger,如果为false,则swagger不能在浏览器中被访问</span></span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    RequestHandlerSelectors:配置要扫描接口的方式</span></span><br><span class="line"><span class="comment">                        basePackage：指定要扫描的包</span></span><br><span class="line"><span class="comment">                        any：扫描全部</span></span><br><span class="line"><span class="comment">                        none：不扫描</span></span><br><span class="line"><span class="comment">                        withClassAnnotation：扫描类上的注解,参数是一个注解的反射类</span></span><br><span class="line"><span class="comment">                            如.withClassAnnotation(GetMapping.class))</span></span><br><span class="line"><span class="comment">                        withMethodAnnotation：扫描方法上的注解</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                .apis(RequestHandlerSelectors.withMethodAnnotation(GetMapping<span class="class">.<span class="keyword">class</span>))</span></span><br><span class="line"><span class="class">                //<span class="title">paths</span>：指定过滤的路径</span></span><br><span class="line">                .paths(PathSelectors.ant("/itfang/**"))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    配置Swagger信息=apiInfo</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//        作者信息</span></span><br><span class="line">        Contact contact = <span class="keyword">new</span> Contact(<span class="string">"itfang"</span>,<span class="string">"博客地址"</span>,<span class="string">"925404321@qq.com"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfo(</span><br><span class="line">                <span class="string">"itfang的API文档"</span>,</span><br><span class="line">                <span class="string">"项目描述"</span>,</span><br><span class="line">                <span class="string">"v1.0版本"</span>,</span><br><span class="line">                <span class="string">"项目的url"</span>,</span><br><span class="line">                contact,</span><br><span class="line">                <span class="string">"Apache2.0"</span>,</span><br><span class="line">                <span class="string">"证件的url"</span>,</span><br><span class="line">                <span class="keyword">new</span> ArrayList&lt;&gt;()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/29/SpringBoot/" data-id="ckfmaqxhi0007kcua63dzdv00" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Redis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/29/Redis/" class="article-date">
  <time datetime="2020-07-29T09:00:00.000Z" itemprop="datePublished">2020-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/29/Redis/">Redis</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="一，redis支持的键值数据类型"><a href="#一，redis支持的键值数据类型" class="headerlink" title="一，redis支持的键值数据类型"></a><strong>一，redis支持的键值数据类型</strong></h5><ul>
<li>字符串类型    string</li>
<li>哈希类型        hash</li>
<li>列表类型        list</li>
<li>集合类型        set</li>
<li>有序集合类型    sortedset</li>
</ul>
<h5 id="二，redis的应用场景"><a href="#二，redis的应用场景" class="headerlink" title="二，redis的应用场景"></a><strong>二，redis的应用场景</strong></h5><ul>
<li>缓存（数据查询，短连接，新闻内容，商品内容等    ）</li>
<li>聊天室的在线好友列表</li>
<li>任务队列（秒杀，抢购，12306等）</li>
<li>应用排行榜</li>
<li>网站访问统计</li>
<li>数据过期处理（可以精确到毫秒）</li>
<li>分布式集群架构中的session分离</li>
</ul>
<h5 id="三，redis的文件"><a href="#三，redis的文件" class="headerlink" title="三，redis的文件"></a><strong>三，redis的文件</strong></h5><ul>
<li>redis-server.exe：Redis的服务器端</li>
<li>redis-cli.exe：Redis的客户端</li>
<li>redis.conf：Redis的配置文件</li>
</ul>
<h5 id="四，redis的命令操作"><a href="#四，redis的命令操作" class="headerlink" title="四，redis的命令操作"></a><strong>四，redis的命令操作</strong></h5><ul>
<li><p>字符串类型    string</p>
</li>
<li><ul>
<li>存储：set key value </li>
<li>获取：get key</li>
<li>删除：del key</li>
</ul>
</li>
<li><p>哈希类型        hash</p>
</li>
<li><ul>
<li><p>存储：hset  key field value</p>
</li>
<li><p>获取：</p>
</li>
<li><ul>
<li>hget key field：获取指定的field对应的值</li>
<li>hgetall key：获取所有的field和value</li>
</ul>
</li>
<li><p>删除：hdel key field</p>
</li>
</ul>
</li>
<li><p>列表类型        list：按照插入顺序排序，可以指定添加元素到列表头部（左边）或尾部（右边）【允许重复】</p>
</li>
<li><ul>
<li><p>存储：</p>
</li>
<li><ul>
<li>lpush key value：将元素加入列表左边</li>
<li>rpush key value：将元素加入列表右边</li>
</ul>
</li>
<li><p>获取：</p>
</li>
<li><ul>
<li>lrange key start end：范围获取</li>
</ul>
</li>
<li><p>删除：</p>
</li>
<li><ul>
<li>lpop key：删除列表最左边的元素，并将元素返回</li>
<li>rpop key：删除列表最右边的元素，并将元素返回</li>
</ul>
</li>
</ul>
</li>
<li><p>集合类型        set【不允许重复元素】</p>
</li>
<li><ul>
<li>存储：sadd key value</li>
<li>获取：smembers key：获取set集合中所有元素</li>
<li>删除：srem key vaue：删除set集合中的某个元素</li>
</ul>
</li>
<li><p>有序集合类型        sortedset【不允许重复元素，且元素有顺序】</p>
</li>
<li><ul>
<li><p>存储：zadd key score value</p>
</li>
<li><p>获取：</p>
</li>
<li><ul>
<li>zrange key start end</li>
<li>zrange key start end withscores：获取值和其对应的分数</li>
</ul>
</li>
<li><p>删除：zrem  key value</p>
</li>
</ul>
</li>
</ul>
<h5 id="五，Redis的通用命令"><a href="#五，Redis的通用命令" class="headerlink" title="五，Redis的通用命令"></a><strong>五，Redis的通用命令</strong></h5><ul>
<li>key *：获取数据库中的所有key</li>
<li>type key：获取key对应的数据类型</li>
<li>del key：删除指定的key value</li>
</ul>
<h5 id="六，Redis的持久化"><a href="#六，Redis的持久化" class="headerlink" title="六，Redis的持久化"></a><strong>六，Redis的持久化</strong></h5><ol>
<li><p>redis的持久化机制：默认方式</p>
<ol>
<li><p><strong>RDB：</strong>在一定的间隔时间中，检测key的变化情况，然后持久化数据</p>
<ol>
<li><p>编辑redis.conf文件</p>
<ul>
<li><p>save 900 1： after 900 sec (15 min) if at least 1 key changed</p>
</li>
<li><p>save 300 10：after 300 sec (5 min) if at least 10 keys changed</p>
</li>
<li><p>save 60 10000：after 60 sec if at least 10000 keys changed</p>
</li>
</ul>
</li>
</ol>
<ol start="2">
<li><p>重新启动Redis服务器，并指定配置文件名称</p>
<ul>
<li>../redis-service.exe redis.conf    </li>
</ul>
</li>
</ol>
</li>
<li><p><strong>AOF：</strong>日志记录 ，可以记录每一条命令的操作。可以每一次命令操作后，持久化数据</p>
<ol>
<li>编辑redis.conf文件<ul>
<li>appendonly no(关闭AOF)  —&gt;   appendonly yes（开启AOF）</li>
<li>appendfsync everysec：每隔一秒进行一次持久化</li>
<li>appendfsync always：每一次操作都进行持久化</li>
<li>appendfsync no：不进行持久化</li>
</ul>
<ol start="2">
<li>重新启动Redis服务器，并指定配置文件名称<ul>
<li>​    ../redis-service.exe redis.conf    </li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h5 id="七，Jedis的入门"><a href="#七，Jedis的入门" class="headerlink" title="七，Jedis的入门"></a><strong>七，Jedis的入门</strong></h5><ol>
<li><strong>导入依赖</strong></li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>编写Jedis程序</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取连接</span></span><br><span class="line">    Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">"localhost"</span>);</span><br><span class="line">    <span class="comment">//操作数据库</span></span><br><span class="line">    jedis.set(<span class="string">"username"</span>,<span class="string">"zhangsan"</span>);</span><br><span class="line">    <span class="comment">//关闭连接</span></span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="八，Jedis获取Redis的数据"><a href="#八，Jedis获取Redis的数据" class="headerlink" title="八，Jedis获取Redis的数据"></a><strong>八，Jedis获取Redis的数据</strong></h5><ul>
<li><p>字符串类型：string    </p>
</li>
<li><ul>
<li>存储：Jedis.set()</li>
<li>获取：Jedis.get()</li>
</ul>
</li>
<li><p>哈希类型：map</p>
</li>
<li><ul>
<li>存储：Jedis.hset()</li>
<li>获取：Jedis.hget()/Jedis.hgetAll()</li>
</ul>
</li>
<li><p>列表类型：list</p>
</li>
<li><ul>
<li>存储：Jedis.lpush()/Jedis.rpush()</li>
<li>获取：Jedis.lpop()/Jedis.rpop()；Jedis.lrange ()</li>
</ul>
</li>
<li><p>集合类型：set</p>
</li>
<li><ul>
<li>存储：Jedis.sadd()</li>
<li>获取：Jedis.smembers()</li>
</ul>
</li>
<li><p>有序集合类型：sortedset</p>
</li>
<li><ul>
<li>存储：Jedis.zadd()</li>
<li>获取：Jedis.zrange()</li>
</ul>
</li>
<li><p>特殊方法</p>
</li>
<li><ul>
<li>Jedis.setex（key，seconds，value）：使用该方法存储可以指定过期时间</li>
</ul>
</li>
</ul>
<h5 id="九，创建Jedis的连接池对象"><a href="#九，创建Jedis的连接池对象" class="headerlink" title="九，创建Jedis的连接池对象"></a><strong>九，创建Jedis的连接池对象</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//        0.创建Jedis的配置对象</span></span><br><span class="line">        JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        config.setMaxTotal(<span class="number">50</span>);</span><br><span class="line"><span class="comment">//        1. 创建Jedis的连接池对象</span></span><br><span class="line">        JedisPool jedisPool = <span class="keyword">new</span> JedisPool(config,<span class="string">"localhost"</span>,<span class="number">6379</span>);</span><br><span class="line"><span class="comment">//        2.获取连接</span></span><br><span class="line">        Jedis jedis = jedisPool.getResource();</span><br><span class="line"><span class="comment">//        3.操作数据库</span></span><br><span class="line">        jedis.set(<span class="string">"mylist"</span>,<span class="string">"asdf"</span>);</span><br><span class="line"><span class="comment">//        4.归还连接</span></span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h5 id="十，创建Redis的连接池工具类"><a href="#十，创建Redis的连接池工具类" class="headerlink" title="十，创建Redis的连接池工具类"></a><strong>十，创建Redis的连接池工具类</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JedisPool工具类</span></span><br><span class="line"><span class="comment"> *  加载配置文件,配置连接池参数</span></span><br><span class="line"><span class="comment"> *  提供获取连接的方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *读取配置文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        InputStream is = JedisUtils.class.getClassLoader().getResourceAsStream("jedis.properties");</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties.load(is);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取配置文件设置到config中</span></span><br><span class="line">        JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        config.setMaxTotal(Integer.parseInt(properties.getProperty(<span class="string">"moTotal"</span>)));</span><br><span class="line">        <span class="comment">//初始化JedisPool</span></span><br><span class="line">        jedisPool = <span class="keyword">new</span> JedisPool(config,properties.getProperty(<span class="string">"host"</span>),Integer.parseInt(properties.getProperty(<span class="string">"port"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title">getJedis</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jedisPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/29/Redis/" data-id="ckfmaqxhe0005kcua3kp615nf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-SSM整合" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/25/SSM%E6%95%B4%E5%90%88/" class="article-date">
  <time datetime="2020-07-25T09:07:18.000Z" itemprop="datePublished">2020-07-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/25/SSM%E6%95%B4%E5%90%88/">SSM整合</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p><strong>导入依赖pom.xml</strong></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;com.itfang&lt;/groupId&gt;
  &lt;artifactId&gt;ssm&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;war&lt;/packaging&gt;

  &lt;name&gt;ssm Maven Webapp&lt;/name&gt;
  &lt;!-- FIXME change it to the project&apos;s website --&gt;
  &lt;url&gt;http://www.example.com&lt;/url&gt;

  &lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
  &lt;/properties&gt;

  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
      &lt;version&gt;4.11&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
      &lt;version&gt;4.12&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;!--spring全家桶--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
      &lt;version&gt;5.2.6.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-tx&lt;/artifactId&gt;
      &lt;version&gt;5.2.6.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-web&lt;/artifactId&gt;
      &lt;version&gt;5.2.6.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-aop&lt;/artifactId&gt;
      &lt;version&gt;5.2.6.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
      &lt;version&gt;5.2.6.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-orm&lt;/artifactId&gt;
      &lt;version&gt;5.2.6.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;
      &lt;version&gt;5.2.6.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
      &lt;version&gt;5.2.6.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--aspect--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
      &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;
      &lt;version&gt;1.9.5&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--mybatis--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
      &lt;artifactId&gt;mybatis&lt;/artifactId&gt;
      &lt;version&gt;3.5.5&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;mysql&lt;/groupId&gt;
      &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
      &lt;version&gt;8.0.20&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--mybatis整合spring--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
      &lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt;
      &lt;version&gt;1.3.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--commons-dbcp io--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.mchange&lt;/groupId&gt;
      &lt;artifactId&gt;c3p0&lt;/artifactId&gt;
      &lt;version&gt;0.9.5.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;commons-dbcp&lt;/groupId&gt;
      &lt;artifactId&gt;commons-dbcp&lt;/artifactId&gt;
      &lt;version&gt;1.2.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;commons-pool&lt;/groupId&gt;
      &lt;artifactId&gt;commons-pool&lt;/artifactId&gt;
      &lt;version&gt;1.5.4&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--servlet--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
      &lt;artifactId&gt;jstl&lt;/artifactId&gt;
      &lt;version&gt;1.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;javax.servlet.jsp&lt;/groupId&gt;
      &lt;artifactId&gt;javax.servlet.jsp-api&lt;/artifactId&gt;
      &lt;version&gt;2.3.3&lt;/version&gt;
      &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
      &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;
      &lt;version&gt;3.1.0&lt;/version&gt;
      &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;!--el表达式--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;taglibs&lt;/groupId&gt;
      &lt;artifactId&gt;standard&lt;/artifactId&gt;
      &lt;version&gt;1.1.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--日志管理--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;log4j&lt;/groupId&gt;
      &lt;artifactId&gt;log4j&lt;/artifactId&gt;
      &lt;version&gt;1.2.17&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
      &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
      &lt;version&gt;1.7.30&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
      &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
      &lt;version&gt;1.7.30&lt;/version&gt;
    &lt;/dependency&gt;

  &lt;/dependencies&gt;

  &lt;build&gt;
    &lt;finalName&gt;ssm&lt;/finalName&gt;
    &lt;pluginManagement&gt;&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;
      &lt;plugins&gt;
        &lt;plugin&gt;
          &lt;artifactId&gt;maven-clean-plugin&lt;/artifactId&gt;
          &lt;version&gt;3.1.0&lt;/version&gt;
        &lt;/plugin&gt;
        &lt;!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_war_packaging --&gt;
        &lt;plugin&gt;
          &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
          &lt;version&gt;3.0.2&lt;/version&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
          &lt;version&gt;3.8.0&lt;/version&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
          &lt;version&gt;2.22.1&lt;/version&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
          &lt;version&gt;3.2.2&lt;/version&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;artifactId&gt;maven-install-plugin&lt;/artifactId&gt;
          &lt;version&gt;2.5.2&lt;/version&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
          &lt;artifactId&gt;maven-deploy-plugin&lt;/artifactId&gt;
          &lt;version&gt;2.8.2&lt;/version&gt;
        &lt;/plugin&gt;
      &lt;/plugins&gt;
    &lt;/pluginManagement&gt;
  &lt;/build&gt;
&lt;/project&gt;</code></pre></li>
<li><p><strong>导入约束和名称空间</strong></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;
       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;
       xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;
       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;
       xsi:schemaLocation=&quot;
        http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc
        https://www.springframework.org/schema/mvc/spring-mvc.xsd
        http://www.springframework.org/schema/context
        https://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/aop
        https://www.springframework.org/schema/aop/spring-aop.xsd
        http://www.springframework.org/schema/tx
        https://www.springframework.org/schema/tx/spring-tx.xsd&quot;&gt;
&lt;/beans&gt;</code></pre></li>
<li><p><strong>开启spring框架扫描包，并写好各个类的注解</strong></p>
<pre><code>&lt;!--    开启spring的注解扫描,并排除扫描到Controller--&gt;
    &lt;context:component-scan base-package=&quot;com.itfang.www&quot;&gt;
&lt;!--        配置哪些注解不扫描--&gt;
        &lt;context:exclude-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;
    &lt;/context:component-scan&gt;</code></pre></li>
<li><p><strong>配置springMVC的配置文件</strong></p>
<pre><code>&lt;!--    开启注解扫描,只扫描Controller--&gt;
    &lt;context:component-scan base-package=&quot;com.itfang.www&quot;&gt;
&lt;!--        配置只扫描哪些注解--&gt;
        &lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;
    &lt;/context:component-scan&gt;

&lt;!--    配置视图解析器--&gt;
    &lt;bean id=&quot;internalResourceViewResolver&quot; class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;
        &lt;property name=&quot;prefix&quot; value=&quot;/WEB-INF/pagas&quot;&gt;&lt;/property&gt;
        &lt;property name=&quot;suffix&quot; value=&quot;.jsp&quot;&gt;&lt;/property&gt;
    &lt;/bean&gt;

&lt;!--    过滤静态资源--&gt;
    &lt;mvc:resources mapping=&quot;/css/**&quot; location=&quot;/css/&quot;&gt;&lt;/mvc:resources&gt;
    &lt;mvc:resources mapping=&quot;/images/**&quot; location=&quot;/images/&quot;&gt;&lt;/mvc:resources&gt;
    &lt;mvc:resources mapping=&quot;/js/**&quot; location=&quot;/js/&quot;&gt;&lt;/mvc:resources&gt;

&lt;!--    开启springMVC注解的支持--&gt;
    &lt;mvc:annotation-driven&gt;&lt;/mvc:annotation-driven&gt;</code></pre></li>
<li><p><strong>在web.xml配置文件中配置前端控制器和解决中文乱码的过滤器，并加载springMVC的配置文件，并配置spring的监听器监听使用spring的IOC容器</strong></p>
<pre><code>&lt;!DOCTYPE web-app PUBLIC
 &quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;
 &quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot; &gt;

&lt;web-app&gt;
  &lt;display-name&gt;Archetype Created Web Application&lt;/display-name&gt;
&lt;!--  解决post请求中文乱码--&gt;
  &lt;filter&gt;
    &lt;filter-name&gt;characterEncodingFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;encoding&lt;/param-name&gt;
      &lt;param-value&gt;UTF-8&lt;/param-value&gt;
    &lt;/init-param&gt;
  &lt;/filter&gt;
  &lt;filter-mapping&gt;
    &lt;filter-name&gt;characterEncodingFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
  &lt;/filter-mapping&gt;
&lt;!--  配置前端控制器--&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
      &lt;param-value&gt;classpath*:springMVC.xml&lt;/param-value&gt;
    &lt;/init-param&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;!--  配置spring的监听器,默认只加载WEB-INF目录下的配置文件,否则需要自己设置配置文件路径--&gt;
  &lt;listener&gt;
    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
  &lt;/listener&gt;
  &lt;!--  设置配置文件路径--&gt;
  &lt;context-param&gt;
    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
    &lt;param-value&gt;classpath*:applicationContext.xml  &lt;/param-value&gt;
  &lt;/context-param&gt;
&lt;/web-app&gt;</code></pre></li>
<li><p><strong>在spring配置文件中配置spring整合mybatis,并配置spring的声明式事务管理</strong></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;
       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;
       xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;
       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;
       xsi:schemaLocation=&quot;
        http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc
        https://www.springframework.org/schema/mvc/spring-mvc.xsd
        http://www.springframework.org/schema/context
        https://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/aop
        https://www.springframework.org/schema/aop/spring-aop.xsd
        http://www.springframework.org/schema/tx
        https://www.springframework.org/schema/tx/spring-tx.xsd&quot;&gt;

&lt;!--    开启spring的注解扫描,并排除扫描到Controller--&gt;
    &lt;context:component-scan base-package=&quot;com.itfang.www&quot;&gt;
&lt;!--        配置哪些注解不扫描--&gt;
        &lt;context:exclude-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;
    &lt;/context:component-scan&gt;

&lt;!--    spring整合mybatis--&gt;
&lt;!--    配置连接池--&gt;
    &lt;bean id=&quot;dataSource&quot; class=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;&gt;
        &lt;property name=&quot;driverClass&quot; value=&quot;com.mysql.cj.jdbc.Driver&quot;&gt;&lt;/property&gt;
        &lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:mysql://127.0.0.1:3306/study?serverTimezone=UTC&quot;&gt;&lt;/property&gt;
        &lt;property name=&quot;user&quot; value=&quot;it-fang&quot;&gt;&lt;/property&gt;
        &lt;property name=&quot;password&quot; value=&quot;123456&quot;&gt;&lt;/property&gt;
    &lt;/bean&gt;
&lt;!--    配置SqlSessionFactory工厂--&gt;
    &lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;
        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt;
    &lt;/bean&gt;

&lt;!--    配置AccountDao接口所在包--&gt;
    &lt;bean id=&quot;mapperScanner&quot; class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;
        &lt;property name=&quot;basePackage&quot; value=&quot;com.itfang.www.dao&quot;&gt;&lt;/property&gt;
    &lt;/bean&gt;

&lt;!--    配置spring的声明式事务管理--&gt;
&lt;!--    配置事务管理器--&gt;
    &lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;&lt;/property&gt;
    &lt;/bean&gt;

&lt;!--    配置事务通知--&gt;
    &lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;transactionManager&quot;&gt;
        &lt;tx:attributes&gt;
            &lt;tx:method name=&quot;find*&quot; read-only=&quot;true&quot;/&gt;
            &lt;tx:method name=&quot;*&quot; isolation=&quot;DEFAULT&quot;&gt;&lt;/tx:method&gt;
        &lt;/tx:attributes&gt;
    &lt;/tx:advice&gt;

&lt;!--    配置AOP增强--&gt;
    &lt;aop:config&gt;
        &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* com.itfang.www.service.impl.*ServiceImpl.*(..))&quot;/&gt;
        &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;pt&quot;&gt;&lt;/aop:advisor&gt;
    &lt;/aop:config&gt;
&lt;/beans&gt;</code></pre></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/25/SSM%E6%95%B4%E5%90%88/" data-id="ckfmaqxhh0006kcuaf7by6kir" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/28/EasyExcel/">EasyExcel</a>
          </li>
        
          <li>
            <a href="/2020/09/11/MySQL%E6%B7%B1%E5%85%A5/">MySQL深入</a>
          </li>
        
          <li>
            <a href="/2020/09/07/Nginx/">Nginx</a>
          </li>
        
          <li>
            <a href="/2020/09/07/RabbitMQ/">RabbitMQ</a>
          </li>
        
          <li>
            <a href="/2020/08/09/Linux/">Linux</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 It-fang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>